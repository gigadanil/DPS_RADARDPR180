<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EASY RIDE ‚Äî RELIABLE</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=7f7db9e2-0eff-47d4-98d3-59b326552ed7&lang=ru_RU"></script>
    <style>
        :root { --blue: #007aff; --bg: #f2f2f7; --gray: #8e8e93; }
        body, html { width: 100%; height: 100%; margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: var(--bg); overflow: hidden; }
        #map { width: 100%; height: 100%; position: absolute; }
        .target { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); z-index: 2000; pointer-events: none; color: var(--blue); }
        .target svg { width: 45px; height: 45px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2)); }
        .bottom-ui { position: absolute; bottom: 20px; left: 0; right: 0; z-index: 1000; padding: 0 10px; }
        .action-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(15px); border-radius: 24px; padding: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); position: relative; }
        .action-card.hidden { display: none; }
        .action-card-close { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray); padding: 4px 8px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s; }
        .action-card-close:hover { background: #f0f0f5; color: #000; }
        .addr-label { font-size: 12px; color: #000; font-weight: 600; margin-bottom: 10px; display: block; text-align: center; }
        .type-selector { display: flex; justify-content: space-between; margin-bottom: 12px; gap: 6px; flex-wrap: wrap; }
        .type-btn { 
            border: none; background: none; cursor: pointer; display: flex; flex-direction: column; 
            align-items: center; gap: 6px; width: 31%; padding: 8px; border-radius: 14px; 
            transition: all 0.25s ease; position: relative;
        }
        .type-btn:active { transform: scale(0.95); }
        .icon-circle { 
            width: 54px; height: 54px; background: #f0f0f5; border-radius: 16px; display: flex; 
            align-items: center; justify-content: center; border: 3px solid transparent; 
            transition: all 0.25s ease; font-size: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .type-btn span { font-size: 11px; font-weight: 700; color: var(--gray); text-transform: uppercase; letter-spacing: 0.3px; }
        .type-btn:hover .icon-circle { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
        .type-btn.active { color: var(--blue); background: rgba(0, 122, 255, 0.08); }
        .type-btn.active .icon-circle { background: #fff; border-color: var(--blue); box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3); }
        
        /* –°—á—ë—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–∫ */
        .markers-counter { font-size: 11px; color: var(--gray); margin-bottom: 10px; text-align: center; padding: 8px; background: #f9f9f9; border-radius: 10px; }
        .counter-item { display: inline-block; margin: 0 6px; }
        .counter-item span:first-child { font-weight: 700; color: var(--blue); }
        .main-btn { width: 100%; background: var(--blue); color: white; border: none; border-radius: 16px; padding: 14px; font-size: 15px; font-weight: 800; cursor: pointer; }
        .b-cont { font-size: 14px; line-height: 1.4; min-width: 170px; }
        .b-poll { display: flex; gap: 8px; margin-top: 10px; }
        .b-poll-btn { flex: 1; border: none; border-radius: 8px; padding: 8px; cursor: pointer; background: #f0f0f5; font-weight: bold; }
        .b-del { color: #ff3b30; border: none; background: none; font-size: 11px; margin-top: 12px; width: 100%; cursor: pointer; font-weight: bold; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è –∏ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ */
        .profile-btn { position: absolute; top: 15px; right: 15px; z-index: 1500; width: 45px; height: 45px; border-radius: 50%; background: white; border: 2px solid var(--blue); cursor: pointer; font-size: 22px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .profile-btn:hover { transform: scale(1.05); }
        /* –ö–Ω–æ–ø–∫–∞ "–ì–¥–µ —è" */
        .loc-btn { position: absolute; top: 15px; right: 70px; z-index: 1500; width: 45px; height: 45px; border-radius: 50%; background: white; border: 2px solid var(--blue); cursor: pointer; font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        .loc-btn:hover { transform: scale(1.05); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2500; overflow-y: auto; }
        .modal.active { display: block; }
        .modal-content { background: white; border-radius: 20px; margin: 20px; padding: 20px; max-width: 500px; margin-left: auto; margin-right: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: var(--gray); }
        
        /* –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å */
        .admin-btn { position: absolute; top: 15px; left: 15px; z-index: 1500; width: 45px; height: 45px; border-radius: 50%; background: #ff9500; border: 2px solid white; cursor: pointer; font-size: 22px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
        .admin-btn.visible { display: block; }
        .admin-btn:hover { transform: scale(1.05); }
        
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .admin-table th, .admin-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; font-size: 12px; }
        .admin-table th { background: #f0f0f5; font-weight: 600; }
        .admin-table tr:hover { background: #f9f9f9; }
        
        .delete-btn { background: #ff3b30; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .delete-btn:hover { background: #e63027; }
        
        .admin-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .admin-stat-card { background: #f0f0f5; border-radius: 12px; padding: 15px; text-align: center; }
        .admin-stat-card .value { font-size: 28px; font-weight: 800; color: var(--blue); }
        .admin-stat-card .label { font-size: 12px; color: var(--gray); margin-top: 5px; }
        
        /* –ß–∞—Ç */
        .chat-btn { position: absolute; bottom: 100px; right: 15px; z-index: 1500; width: 50px; height: 50px; border-radius: 50%; background: var(--blue); border: 2px solid white; cursor: pointer; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .chat-btn:hover { transform: scale(1.05); }
        
        .chat-messages { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; max-height: 400px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 12px; }
        .chat-message { padding: 10px 12px; border-radius: 10px; font-size: 13px; max-width: 80%; word-wrap: break-word; }
        .chat-message.own { background: var(--blue); color: white; margin-left: auto; }
        .chat-message.other { background: white; border: 1px solid #ddd; }
        .chat-message-author { font-size: 11px; font-weight: 600; margin-bottom: 3px; opacity: 0.8; }
        .chat-message-photo { max-width: 200px; border-radius: 8px; margin-top: 5px; cursor: pointer; }
        .chat-message-time { font-size: 10px; opacity: 0.7; margin-top: 3px; }
        
        .chat-input-group { display: flex; gap: 8px; }
        .chat-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; box-sizing: border-box; }
        .chat-send-btn { background: var(--blue); color: white; border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; }
        .chat-send-btn:hover { background: #0051d5; }
        
        .chat-photo-upload { position: relative; }
        .chat-photo-input { display: none; }
        .chat-photo-btn { background: #f0f0f5; color: var(--blue); border: none; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 16px; }
        .chat-photo-btn:hover { background: #e0e0e5; }
        
        /* –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
        .registration-form input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; box-sizing: border-box; }
        .registration-form label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; color: #000; }
        .registration-form .form-group { margin-bottom: 15px; }
        
        /* –°—Ç–∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è */
        .profile-header { text-align: center; margin-bottom: 20px; }
        .profile-avatar { width: 80px; height: 80px; background: var(--blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 40px; margin: 0 auto 15px; }
        .profile-name { font-size: 20px; font-weight: 800; color: #000; margin-bottom: 5px; }
        .profile-name.trusted { color: #b8860b; text-shadow: 0 1px 0 rgba(0,0,0,0.15); }
        .profile-id { font-size: 12px; color: var(--gray); }
        
        /* –†–µ–π—Ç–∏–Ω–≥ */
        .rating-card { background: linear-gradient(135deg, var(--blue), #5ac8fa); border-radius: 15px; padding: 15px; color: white; margin-bottom: 15px; }
        .rating-value { font-size: 36px; font-weight: 800; }
        .rating-label { font-size: 12px; opacity: 0.9; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-item { background: #f0f0f5; border-radius: 12px; padding: 12px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: 800; color: var(--blue); }
        .stat-label { font-size: 11px; color: var(--gray); margin-top: 5px; }
    </style>
</head>
<body>
    <div class="target"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 0 1 0-5 2.5 2.5 0 0 1 0 5z"/></svg></div>
    <div id="map"></div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ —á–∞—Ç–∞ -->
    <button class="chat-btn" onclick="openChatModal()">üí¨</button>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ -->
    <div id="chatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">–û–±—â–∏–π —á–∞—Ç</h2>
                <button class="modal-close" onclick="closeChatModal()">‚úï</button>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div style="text-align: center; color: var(--gray); padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
            </div>
            
            <div class="chat-input-group">
                <input type="text" id="chatInput" class="chat-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="500">
                <div class="chat-photo-upload">
                    <input type="file" id="chatPhotoInput" class="chat-photo-input" accept="image/*">
                    <button class="chat-photo-btn" onclick="document.getElementById('chatPhotoInput').click()">üì∑</button>
                </div>
                <button class="chat-send-btn" onclick="sendChatMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –∞–¥–º–∏–Ω–∞ -->
    <button class="admin-btn" id="adminBtn" onclick="openAdminModal()">‚öôÔ∏è</button>
    <!-- –ö–Ω–æ–ø–∫–∞ '–ì–¥–µ —è' -->
    <button class="loc-btn" id="locBtn" onclick="centerOnMyLocation()" title="–ì–¥–µ —è">üìç</button>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
                <button class="modal-close" onclick="closeAdminModal()">‚úï</button>
            </div>
            
            <div class="admin-stats">
                <div class="admin-stat-card">
                    <div class="label">–í—Å–µ–≥–æ –≤–æ–¥–∏—Ç–µ–ª–µ–π</div>
                    <div class="value" id="admin-drivers-count">0</div>
                </div>
                <div class="admin-stat-card">
                    <div class="label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–∫</div>
                    <div class="value" id="admin-markers-count">0</div>
                </div>
            </div>
            
            <h3 style="margin-top: 20px; margin-bottom: 10px; font-size: 14px;">–°–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π</h3>
            <div style="overflow-x: auto; max-height: 300px; overflow-y: auto;">
                <table class="admin-table" id="admin-drivers-table">
                    <thead>
                        <tr>
                            <th>–ò–º—è</th>
                            <th>–ê–≤—Ç–æ</th>
                            <th>–ù–æ–º–µ—Ä</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody id="admin-drivers-body">
                        <tr><td colspan="5" style="text-align: center; color: var(--gray);">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <h3 style="margin-top: 20px; margin-bottom: 10px; font-size: 14px;">–ê–∫—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–∫–∏</h3>
            <div style="overflow-x: auto; max-height: 300px; overflow-y: auto;">
                <table class="admin-table" id="admin-markers-table">
                    <thead>
                        <tr>
                            <th>–¢–∏–ø</th>
                            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                            <th>–õ–∞–π–∫–∏</th>
                            <th>–î–∏–∑–ª–∞–π–∫–∏</th>
                            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody id="admin-markers-body">
                        <tr><td colspan="5" style="text-align: center; color: var(--gray);">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <button class="main-btn" onclick="closeAdminModal()" style="margin-top: 20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –æ–± –∞–≤—Ç–æ) -->
    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">–ó–∞–≤–µ—Ä—à–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</h2>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <div class="profile-avatar">üë§</div>
                <div class="profile-name" id="reg-user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <form class="registration-form" onsubmit="registerDriver(event)">
                <div class="form-group">
                    <label>–ú–∞—Ä–∫–∞/–ú–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è:</label>
                    <input type="text" id="driver-car" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Toyota Camry">
                </div>
                <div class="form-group">
                    <label>–ù–æ–º–µ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª—è:</label>
                    <input type="text" id="driver-plate" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: A123BC 77">
                </div>
                <button type="submit" class="main-btn" style="margin-top: 15px;">–ó–ê–í–ï–†–®–ò–¢–¨</button>
            </form>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
                <button class="modal-close" onclick="closeProfileModal()">‚úï</button>
            </div>
            <div class="profile-header">
                <div class="profile-avatar">üë§</div>
                <div class="profile-name" id="profile-name-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="profile-id" id="profile-car-text"></div>
                <div class="profile-id" id="profile-plate-text"></div>
            </div>
            
            <div class="rating-card">
                <div class="rating-label">–í–∞—à —Ä–µ–π—Ç–∏–Ω–≥</div>
                <div class="rating-value" id="profile-rating">0.0</div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="profile-marks-count">0</div>
                    <div class="stat-label">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ—Ç–æ–∫</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="profile-votes-sum">0</div>
                    <div class="stat-label">–ü–æ–ª–µ–∑–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="profile-likes">0</div>
                    <div class="stat-label">–õ–∞–π–∫–æ–≤</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="profile-dislikes">0</div>
                    <div class="stat-label">–î–∏–∑–ª–∞–π–∫–æ–≤</div>
                </div>
            </div>
            
            <div style="background: #f9f9f9; border-radius: 12px; padding: 12px; margin-bottom: 15px; text-align: center;">
                <div style="font-size: 12px; color: var(--gray); margin-bottom: 5px;">–°—Ç–∞—Ç—É—Å</div>
                <div id="profile-trust-status" style="font-size: 16px; font-weight: 800; color: var(--blue);">üéØ –û–±—ã—á–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å</div>
            </div>
            
            <button class="main-btn" onclick="openRatingsModal()" style="margin-bottom: 10px; background: #34c759;">–ì–õ–û–ë–ê–õ–¨–ù–´–ô –†–ï–ô–¢–ò–ù–ì</button>
            <button class="main-btn" onclick="logout()">–í–´–ô–¢–ò</button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞ -->
    <div id="ratingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">üèÜ –†–µ–π—Ç–∏–Ω–≥ –≤–æ–¥–∏—Ç–µ–ª–µ–π</h2>
                <button class="modal-close" onclick="closeRatingsModal()">‚úï</button>
            </div>
            
            <div style="font-size: 12px; color: var(--gray); margin-bottom: 15px; text-align: center;">
                –í–æ–¥–∏—Ç–µ–ª–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ —Å—É–º–º–µ –ª–∞–π–∫–æ–≤. ‚≠ê = –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å (20+ –ª–∞–π–∫–æ–≤)
            </div>
            
            <div style="max-height: 500px; overflow-y: auto;">
                <div id="ratingsList" style="text-align: center; color: var(--gray);">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</div>
            </div>
            
            <button class="main-btn" onclick="closeRatingsModal()" style="margin-top: 15px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <div class="bottom-ui">
        <div class="action-card" id="actionCard">
            <button class="action-card-close" onclick="toggleActionCard()">‚úï</button>
            <span class="addr-label" id="addr-text">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞...</span>
            <div class="markers-counter" id="markersCounter">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="type-selector">
                <button onclick="setType('dps', this)" class="type-btn active"><div class="icon-circle">üëÆ</div><span>–î–ü–°</span></button>
                <button onclick="setType('patrol', this)" class="type-btn"><div class="icon-circle">üöî</div><span>–†–µ–π–¥</span></button>
                <button onclick="setType('camera', this)" class="type-btn"><div class="icon-circle">üì∏</div><span>–ö–∞–º–µ—Ä–∞</span></button>
                <button onclick="setType('dtp', this)" class="type-btn"><div class="icon-circle">üí•</div><span>–î–¢–ü</span></button>
                <button onclick="setType('works', this)" class="type-btn"><div class="icon-circle">üöß</div><span>–†–∞–±–æ—Ç—ã</span></button>
                <button onclick="setType('sos', this)" class="type-btn"><div class="icon-circle">üÜò</div><span>SOS</span></button>
            </div>
            <input type="text" id="m-comm" style="width:100%; margin-bottom:10px; border-radius:10px; border:1px solid #ddd; padding:8px; box-sizing: border-box;" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
            <button class="main-btn" onclick="addPoint()">–û–¢–ü–†–ê–í–ò–¢–¨</button>
        </div>
    </div>
<script>
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    const SUPABASE_URL = "https://phazbjchjhsruwalddis.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBoYXpiamNoamhzcnV3YWxkZGlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNDcyNjQsImV4cCI6MjA4NTcyMzI2NH0.juQSLL03uRb6ImiCul_UOOE4OwY3mXy-AuItwt2u9ds";
    // –ö–ª–∏–µ–Ω—Ç Supabase –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
    const _sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    // –ò–∫–æ–Ω–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –º–∞—Ä–∫–µ—Ä–æ–≤ (–î–ü–°, –†–µ–π–¥, –ö–∞–º–µ—Ä–∞, –î–¢–ü, –†–∞–±–æ—Ç—ã, SOS)
    const MAP_ICONS = { dps: 'üëÆ', patrol: 'üöî', camera: 'üì∏', dtp: 'üí•', works: 'üöß', sos: 'üÜò' };
    // ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram –∏–ª–∏ "guest" –µ—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
    const uid = window.Telegram?.WebApp?.initDataUnsafe?.user?.id?.toString() || "guest";
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç—ã –∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –º–∞—Ä–∫–µ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –î–ü–°)
    let myMap, selectedType = 'dps';
    // –¢–µ–∫—É—â–µ–µ GPS –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let userLocation = null;
    // ID –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è GPS (–¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è)
    let gpsWatchId = null;
    // –ú–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ
    let userLocationMarker = null;
    // –§–ª–∞–≥ –∞–≤—Ç–æ—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è: –µ—Å–ª–∏ true ‚Äî –∫–∞—Ä—Ç–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ GPS
    let autoFollow = true;
    // –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let currentDriver = null;
    // ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π ID Telegram)
    const ADMIN_ID = "5118431735";
    // –ü–æ—Ä–æ–≥ –ª–∞–π–∫–æ–≤ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å"
    const TRUST_LIKES_THRESHOLD = 20; // –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    // –ü–æ—Ä–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π "—É–µ—Ö–∞–ª–∏" –¥–ª—è –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏
    const MARKER_LEAVE_THRESHOLD = 3; // –µ—Å–ª–∏ 3 —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞–∂–∞–ª–∏ "–£–µ—Ö–∞–ª–∏" - –º–µ—Ç–∫–∞ —É–¥–∞–ª—è–µ—Ç—Å—è
    // –§–ª–∞–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    let isAdmin = false;
    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
    let selectedChatPhoto = null;
    // –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É–∂–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –∑–≤—É–∫)
    let notifiedMarkers = new Set();
    // –§–ª–∞–≥ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –Ω–∏–∂–Ω–µ–≥–æ –≤–∏–¥–∂–µ—Ç–∞
    let actionCardVisible = true;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –Ω–∏–∂–Ω–µ–≥–æ –≤–∏–¥–∂–µ—Ç–∞
    function toggleActionCard() {
        actionCardVisible = !actionCardVisible;
        const card = document.getElementById('actionCard');
        if (actionCardVisible) {
            card.classList.remove('hidden');
        } else {
            card.classList.add('hidden');
        }
    }

    // –ì—Ä–∞–Ω–∏—Ü—ã –î–æ–Ω–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ –î–ù–† (–ø—Ä–∏–º–µ—Ä–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)
    const DONETSK_REGION = {
        north: 49.2,    // –°–µ–≤–µ—Ä–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
        south: 47.3,    // –Æ–∂–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
        west: 36.4,     // –ó–∞–ø–∞–¥–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
        east: 40.4      // –í–æ—Å—Ç–æ—á–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
    };

    // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ GPS –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
    function initGPS() {
        if (!navigator.geolocation) {
            console.warn('Geolocation –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º');
            return;
        }
        
        // –û–ø—Ü–∏–∏ –¥–ª—è geolocation
        const options = {
            enableHighAccuracy: true, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã—Å–æ–∫—É—é —Ç–æ—á–Ω–æ—Å—Ç—å
            timeout: 10000,
            maximumAge: 0
        };
        
        // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
        gpsWatchId = navigator.geolocation.watchPosition(
            (position) => {
                // –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                const { latitude, longitude, accuracy } = position.coords;
                userLocation = [latitude, longitude];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ
                updateUserLocationMarker();
                // –ï—Å–ª–∏ –∞–≤—Ç–æ—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ ‚Äî —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                if (autoFollow && myMap && userLocation) {
                    try { myMap.setCenter(userLocation, 17); } catch (e) { console.warn(e); }
                }
                console.log(`üìç GPS: ${latitude.toFixed(4)}, ${longitude.toFixed(4)} (—Ç–æ—á–Ω–æ—Å—Ç—å: ${accuracy.toFixed(0)}–º)`);
            },
            (error) => {
                // –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                console.warn('–û—à–∏–±–∫–∞ GPS:', error.message);
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        console.warn('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ GPS –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ');
                        break;
                    case error.POSITION_UNAVAILABLE:
                        console.warn('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
                        break;
                    case error.TIMEOUT:
                        console.warn('–ò—Å—Ç–µ–∫–ª–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è GPS');
                        break;
                }
            },
            options
        );
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ
    function updateUserLocationMarker() {
        if (!userLocation || !myMap) return;
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if (userLocationMarker) {
            myMap.geoObjects.remove(userLocationMarker);
        }
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä (—Å–∏–Ω–∏–π –∫—Ä—É–≥ —Å –ø—É–ª—å—Å–∞—Ü–∏–µ–π)
        userLocationMarker = new ymaps.Placemark(userLocation, 
            { 
                hintContent: '–í—ã –∑–¥–µ—Å—å',
                balloonContent: 'üìç –í–∞—à–µ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ'
            },
            {
                iconLayout: 'default#image',
                iconImageHref: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSI4IiBmaWxsPSIjMDA3YWZmIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=',
                iconImageSize: [32, 32],
                iconImageOffset: [-16, -16],
                zIndex: 1000
            }
        );
        
        myMap.geoObjects.add(userLocationMarker);
        
        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ —Ç–µ–∫—É—â–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ (–µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —Ä–∞–∑)
        if (!myMap.lastUserLocationUpdate) {
            myMap.setCenter(userLocation, 17);
            myMap.lastUserLocationUpdate = true;
        }
    }
    
    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç –∫–∞—Ä—Ç—É –Ω–∞ —Ç–µ–∫—É—â–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –∏ –≤–∫–ª—é—á–∞–µ—Ç –∞–≤—Ç–æ—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
    function centerOnMyLocation() {
        if (!userLocation) {
            alert('–ü–æ–∑–∏—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –í–∫–ª—é—á–∏—Ç–µ GPS.');
            return;
        }
        autoFollow = true;
        try { myMap.setCenter(userLocation, 17); } catch (e) { console.warn(e); }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏ (—Ñ–æ—Ä–º—É–ª–∞ –≥–∞–≤–µ—Ä—Å–∏–Ω—É—Å–æ–≤)
    // coords1 –∏ coords2 - –º–∞—Å—Å–∏–≤—ã [—à–∏—Ä–æ—Ç–∞, –¥–æ–ª–≥–æ—Ç–∞]
    // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –º–µ—Ç—Ä–∞—Ö
    function calculateDistance(coords1, coords2) {
        const R = 6371000; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –º–µ—Ç—Ä–∞—Ö
        const lat1 = coords1[0] * Math.PI / 180;
        const lat2 = coords2[0] * Math.PI / 180;
        const deltaLat = (coords2[0] - coords1[0]) * Math.PI / 180;
        const deltaLon = (coords2[1] - coords1[1]) * Math.PI / 180;
        
        const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
                  Math.cos(lat1) * Math.cos(lat2) * Math.sin(deltaLon / 2) * Math.sin(deltaLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function playAlertSound() {
        try {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Web Audio API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Å—Ç–æ–≥–æ –∑–≤—É–∫–∞ "–±–∏–ø"
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800; // –ß–∞—Å—Ç–æ—Ç–∞ –∑–≤—É–∫–∞ –≤ Hz
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏ –∑–≤—É–∫–∞:', e?.message);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –∑–∞–±–∞–Ω–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    async function isUserBanned(userId) {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ bans
            const { data: banned, error } = await _sb.from('bans').select('user_id').eq('user_id', userId).maybeSingle();
            if (error && error.code !== 'PGRST116') { // PGRST116 - —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –±–∞–Ω—è:', error?.message);
                return false;
            }
            return banned ? true : false;
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –±–∞–Ω—è:', e?.message || e);
            return false;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    async function initApp() {
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ Telegram
        const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
        if (!tgUser) {
            alert('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞');
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–∞–Ω–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        const isBanned = await isUserBanned(uid);
        if (isBanned) {
            alert('‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
        isAdmin = String(tgUser.id) === String(ADMIN_ID);
        if (isAdmin) {
            document.getElementById('adminBtn').classList.add('visible');
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏)
        try {
            const { data: driver } = await _sb.from('drivers').select('user_id,name,car_model,car_plate').eq('user_id', uid).maybeSingle();
            if (!driver) {
                // –ï—Å–ª–∏ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ–± –∞–≤—Ç–æ
                document.getElementById('reg-user-name').textContent = (tgUser.first_name || '') + ' ' + (tgUser.last_name || '');
                openRegistrationModal();
            } else {
                // –ï—Å–ª–∏ –¥–∞, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
                currentDriver = driver;
            }
        } catch (e) {
            // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ drivers –ø–∞–¥–∞–µ—Ç –∏–∑-–∑–∞ –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ö–µ–º—ã, –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∂–µ–º —Ñ–æ—Ä–º—É
            console.warn('drivers table read failed:', e.message || e);
            document.getElementById('reg-user-name').textContent = (tgUser.first_name || '') + ' ' + (tgUser.last_name || '');
            openRegistrationModal();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –º–∞—Ä–∫–µ—Ä–∞
    // t - —Ç–∏–ø –º–∞—Ä–∫–µ—Ä–∞, el - —ç–ª–µ–º–µ–Ω—Ç –∫–Ω–æ–ø–∫–∏
    function setType(t, el) {
        selectedType = t;
        // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å active —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å active –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–µ
        el.classList.add('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    function openRegistrationModal() {
        document.getElementById('registrationModal').classList.add('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    function closeRegistrationModal() {
        document.getElementById('registrationModal').classList.remove('active');
    }

    // –§—É–Ω–∫—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è (–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ—Ä—É—Ç—Å—è –∏–∑ Telegram)
    async function registerDriver(event) {
        event.preventDefault();

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ Telegram
        const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
        const name = (tgUser?.first_name || '') + ' ' + (tgUser?.last_name || '');
        const car = document.getElementById('driver-car').value;
        const plate = document.getElementById('driver-plate').value;

        // –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –∫—ç—à–∞ —Å—Ö–µ–º—ã Supabase
        try {
            const { error } = await _sb.from('drivers').insert([{
                user_id: uid,
                name: name,
                car_model: car,
                car_plate: plate
            }]);

            if (!error) {
                // –°–æ–∑–¥–∞—ë–º –ª–æ–∫–∞–ª—å–Ω—É—é –∫–æ–ø–∏—é –ø—Ä–æ—Ñ–∏–ª—è (—Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ –¥–ª—è UI)
                currentDriver = {
                    user_id: uid,
                    name: name,
                    car_model: car,
                    car_plate: plate,
                    votes_up: 0,
                    votes_down: 0,
                    markers_count: 0
                };
                closeRegistrationModal();
                alert('–°–ø–∞—Å–∏–±–æ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, ' + name + '! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –º–µ—Ç–∫–∏.');
            } else {
                alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + (error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + (e?.message || e));
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    async function openProfileModal() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–æ—Ñ–∏–ª—è (–Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏)
        try {
            const { data: driver } = await _sb.from('drivers').select('user_id,name,car_model,car_plate').eq('user_id', uid).maybeSingle();
            if (driver) currentDriver = driver;
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ drivers, –ø—Ä–∏–º–µ–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ/Telegram –¥–∞–Ω–Ω—ã–µ:', e?.message || e);
        }

        if (!currentDriver) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ—Ç
            openRegistrationModal();
            return;
        }

        // –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Ç–∞–±–ª–∏—Ü—ã markers, —á—Ç–æ–±—ã –Ω–µ –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ –≤ drivers
        let marks_count = 0, likes = 0, dislikes = 0;
        try {
            const { data: markers } = await _sb.from('markers').select('votes_up,votes_down').eq('author_id', uid);
            if (markers) {
                marks_count = markers.length;
                markers.forEach(m => {
                    likes += m.votes_up || 0;
                    dislikes += m.votes_down || 0;
                });
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á—ë—Ç–µ –º–∞—Ä–∫–µ—Ä–æ–≤:', e?.message || e);
        }

        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        const displayName = currentDriver.name || ((window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name) || '');
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º –≤–æ–¥–∏—Ç–µ–ª–µ–º" –ø–æ —Å—É–º–º–µ –ª–∞–π–∫–æ–≤
        const isTrusted = (likes >= (typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20));
        const profileNameEl = document.getElementById('profile-name-text');
        profileNameEl.textContent = (isTrusted ? '‚≠ê ' : '') + displayName;
        if (isTrusted) profileNameEl.classList.add('trusted'); else profileNameEl.classList.remove('trusted');
        document.getElementById('profile-car-text').textContent = currentDriver.car_model || '';
        document.getElementById('profile-plate-text').textContent = currentDriver.car_plate || '';
        const rating = marks_count ? ((likes - dislikes) / marks_count) : 0;
        document.getElementById('profile-rating').textContent = rating.toFixed(1);
        document.getElementById('profile-marks-count').textContent = marks_count;
        document.getElementById('profile-votes-sum').textContent = (likes + dislikes);
        document.getElementById('profile-likes').textContent = likes;
        document.getElementById('profile-dislikes').textContent = dislikes;
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –¥–æ–≤–µ—Ä–∏—è
        const trustStatusEl = document.getElementById('profile-trust-status');
        if (isTrusted) {
            trustStatusEl.innerHTML = '‚≠ê –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å';
            trustStatusEl.style.color = '#b8860b';
        } else {
            trustStatusEl.innerHTML = `üéØ –û–±—ã—á–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å (${likes}/${typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20} –ª–∞–π–∫–æ–≤)`;
            trustStatusEl.style.color = 'var(--blue)';
        }

        // –ü–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ drivers (–µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∏ –µ—Å—Ç—å)
        try {
            await _sb.from('drivers').upsert([
                { user_id: uid, likes_sum: likes, is_trusted: isTrusted }
            ], { onConflict: 'user_id' });
        } catch (e) {
            // –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –∏–ª–∏ –∫–æ–ª–æ–Ω–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ –≤ drivers (–≤–æ–∑–º–æ–∂–Ω–æ, –∫–æ–ª–æ–Ω–∫–∏ likes_sum/is_trusted –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç):', e?.message || e);
        }

        document.getElementById('profileModal').classList.add('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    function closeProfileModal() {
        document.getElementById('profileModal').classList.remove('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∞ —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º –≤–æ–¥–∏—Ç–µ–ª–µ–π
    async function openRatingsModal() {
        const ratingsList = document.getElementById('ratingsList');
        ratingsList.innerHTML = '<div style="color: var(--gray);">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</div>';
        
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π
            const { data: drivers } = await _sb.from('drivers').select('user_id,name,car_model,car_plate,likes_sum,is_trusted');
            
            if (!drivers || drivers.length === 0) {
                ratingsList.innerHTML = '<div style="color: var(--gray); padding: 20px;">–í–æ–¥–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                document.getElementById('ratingsModal').classList.add('active');
                return;
            }
            
            // –°—á–∏—Ç–∞–µ–º –ª–∞–π–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è (–µ—Å–ª–∏ likes_sum –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
            let driverStats = [];
            for (const d of drivers) {
                let likesSum = d.likes_sum || 0;
                let isTrusted = d.is_trusted || false;
                
                // –ï—Å–ª–∏ likes_sum –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω, —Å—á–∏—Ç–∞–µ–º –∏–∑ markers
                if (!d.likes_sum) {
                    const { data: markers } = await _sb.from('markers').select('votes_up').eq('author_id', d.user_id);
                    if (markers) {
                        likesSum = markers.reduce((sum, m) => sum + (m.votes_up || 0), 0);
                    }
                    isTrusted = likesSum >= (typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20);
                }
                
                driverStats.push({
                    user_id: d.user_id,
                    name: d.name || '–ê–Ω–æ–Ω–∏–º',
                    car_model: d.car_model || 'N/A',
                    likes: likesSum,
                    is_trusted: isTrusted
                });
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ª–∞–π–∫–∞–º (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
            driverStats.sort((a, b) => b.likes - a.likes);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML
            let html = '';
            driverStats.forEach((driver, idx) => {
                const medal = idx === 0 ? 'ü•á' : (idx === 1 ? 'ü•à' : (idx === 2 ? 'ü•â' : ''));
                const trustBadge = driver.is_trusted ? ' ‚≠ê' : '';
                html += `
                    <div style="padding: 12px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: #000; font-size: 14px;">${medal} ${driver.name}${trustBadge}</div>
                            <div style="font-size: 11px; color: var(--gray);">${driver.car_model}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 800; color: var(--blue); font-size: 16px;">${driver.likes}</div>
                            <div style="font-size: 11px; color: var(--gray);">–ª–∞–π–∫–æ–≤</div>
                        </div>
                    </div>
                `;
            });
            
            ratingsList.innerHTML = html;
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ–π—Ç–∏–Ω–≥–∞:', e?.message || e);
            ratingsList.innerHTML = '<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞</div>';
        }
        
        document.getElementById('ratingsModal').classList.add('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞
    function closeRatingsModal() {
        document.getElementById('ratingsModal').classList.remove('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
    function logout() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
            currentDriver = null;
            closeProfileModal();
            openRegistrationModal();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    async function openAdminModal() {
        if (!isAdmin) {
            alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏');
            return;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π
        try {
            const { data: drivers } = await _sb.from('drivers').select('user_id,name,car_model,car_plate');
            const tbody = document.getElementById('admin-drivers-body');
            tbody.innerHTML = '';
            if (drivers && drivers.length > 0) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–±–∞–Ω–Ω–µ–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                let bannedIds = new Set();
                try {
                    const { data: bans } = await _sb.from('bans').select('user_id');
                    if (bans) {
                        bans.forEach(b => bannedIds.add(b.user_id.toString()));
                    }
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –±–∞–Ω–æ–≤ (–≤–æ–∑–º–æ–∂–Ω–æ, —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç):', e?.message);
                }
                
                // –°–æ–±–µ—Ä–µ–º —Å–ø–∏—Å–æ–∫ ID –≤–æ–¥–∏—Ç–µ–ª–µ–π –∏ –ø–æ–¥—Å—á–∏—Ç–∞–µ–º –ª–∞–π–∫–∏ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
                const driverIds = drivers.map(d => d.user_id.toString());
                let likesMap = {};
                try {
                    const { data: likesRows } = await _sb.from('markers').select('author_id,votes_up').in('author_id', driverIds);
                    if (likesRows) {
                        likesRows.forEach(r => {
                            const id = r.author_id.toString();
                            likesMap[id] = (likesMap[id] || 0) + (r.votes_up || 0);
                        });
                    }
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–∞–π–∫–∏ –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π:', e?.message || e);
                }

                drivers.forEach(d => {
                    const isBanned = bannedIds.has(d.user_id.toString());
                    const statusBadge = isBanned ? 'üö´ –ó–ê–ë–ê–ù' : '‚úÖ';
                    const statusStyle = isBanned ? 'background: #ff3b30; color: white;' : '';
                    const likes = likesMap[d.user_id.toString()] || 0;
                    const isTrustedDriver = likes >= (typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20);
                    const nameCell = `${isTrustedDriver ? '‚≠ê ' : ''}${d.name || 'N/A'}`;
                    const row = `<tr style="${statusStyle}">
                        <td>${nameCell}</td>
                        <td>${d.car_model || 'N/A'}</td>
                        <td>${d.car_plate || 'N/A'}</td>
                        <td>${statusBadge}</td>
                        <td style="display: flex; gap: 5px;">
                            <button class="delete-btn" onclick="${isBanned ? `unbanDriver('${d.user_id}', '${d.name || 'N/A'}')` : `banDriver('${d.user_id}', '${d.name || 'N/A'}')`}" style="background: ${isBanned ? '#34c759' : '#ff9500'};">${isBanned ? '‚úÖ –†–∞–∑–±–∞–Ω' : 'üö´ –ó–∞–±–∞–Ω'}</button>
                            <button class="delete-btn" onclick="deleteDriver('${d.user_id}')">–£–¥–∞–ª–∏—Ç—å</button>
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
                document.getElementById('admin-drivers-count').textContent = drivers.length;
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--gray);">–í–æ–¥–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–æ–¥–∏—Ç–µ–ª–µ–π:', e?.message || e);
            document.getElementById('admin-drivers-body').innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
        try {
            const { data: markers } = await _sb.from('markers').select('*').gt('exp', Date.now());
            const tbody = document.getElementById('admin-markers-body');
            tbody.innerHTML = '';
            if (markers && markers.length > 0) {
                markers.forEach(m => {
                    const row = `<tr>
                        <td>${MAP_ICONS[m.type] || '?'}</td>
                        <td>${m.comment || '–±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}</td>
                        <td>${m.votes_up || 0}</td>
                        <td>${m.votes_down || 0}</td>
                        <td><button class="delete-btn" onclick="deleteMarkerAdmin(${m.id})">–£–¥–∞–ª–∏—Ç—å</button></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
                document.getElementById('admin-markers-count').textContent = markers.length;
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--gray);">–ê–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–∫ –Ω–µ—Ç</td></tr>';
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞—Ä–∫–µ—Ä–æ–≤:', e?.message || e);
            document.getElementById('admin-markers-body').innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
        }

        document.getElementById('adminModal').classList.add('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    function closeAdminModal() {
        document.getElementById('adminModal').classList.remove('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–±–∞–Ω–∞) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function banDriver(driverId, driverName) {
        if (!isAdmin) {
            alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
            return;
        }

        if (confirm(`–ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${driverName}"? –û–Ω –±–æ–ª—å—à–µ –Ω–µ —Å–º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.`)) {
            try {
                // –ü—ã—Ç–∞–µ–º—Å—è –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü—É bans
                const { error } = await _sb.from('bans').insert([{ user_id: driverId }]);
                
                if (error && error.code === 'PGRST116') {
                    // –¢–∞–±–ª–∏—Ü–∞ bans –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å is_banned –≤ drivers
                    const { error: updateError } = await _sb.from('drivers').update({ is_banned: true }).eq('user_id', driverId);
                    if (updateError) {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ: ' + (updateError?.message || '—Ç–∞–±–ª–∏—Ü–∞ bans –Ω–µ —Å–æ–∑–¥–∞–Ω–∞'));
                        console.log('–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É bans –≤ Supabase —Å –∫–æ–ª–æ–Ω–∫–æ–π user_id (BIGINT PRIMARY KEY)');
                        return;
                    }
                } else if (error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ: ' + (error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    return;
                }
                
                alert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ' + driverName + ' —É—Å–ø–µ—à–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
                openAdminModal(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ: ' + (e?.message || e));
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function unbanDriver(driverId, driverName) {
        if (!isAdmin) {
            alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
            return;
        }

        if (confirm(`–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${driverName}"?`)) {
            try {
                // –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã bans
                const { error } = await _sb.from('bans').delete().eq('user_id', driverId);
                
                if (error && error.code === 'PGRST116') {
                    // –¢–∞–±–ª–∏—Ü–∞ bans –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å is_banned –≤ drivers
                    const { error: updateError } = await _sb.from('drivers').update({ is_banned: false }).eq('user_id', driverId);
                    if (updateError) {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ: ' + (updateError?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                        return;
                    }
                } else if (error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ: ' + (error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    return;
                }
                
                alert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ' + driverName + ' —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
                openAdminModal(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ: ' + (e?.message || e));
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—è (–∞–¥–º–∏–Ω)
    async function deleteDriver(driverId) {
        if (!isAdmin) {
            alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
            return;
        }

        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —Ç–∞–∫–∂–µ —É–¥–∞–ª–∏—Ç –≤—Å–µ –º–µ—Ç–∫–∏ —ç—Ç–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è')) {
            try {
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ –º–µ—Ç–∫–∏ –≤–æ–¥–∏—Ç–µ–ª—è
                await _sb.from('markers').delete().eq('author_id', driverId);
                // –£–¥–∞–ª—è–µ–º –≤–æ–¥–∏—Ç–µ–ª—è
                await _sb.from('drivers').delete().eq('user_id', driverId);
                // –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å –∏–∑ –±–∞–Ω–∞ (–µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
                try {
                    await _sb.from('bans').delete().eq('user_id', driverId);
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ bans (–≤–æ–∑–º–æ–∂–Ω–æ, —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç):', e?.message);
                }
                alert('–í–æ–¥–∏—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
                openAdminModal(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + (e?.message || e));
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ (–∞–¥–º–∏–Ω)
    async function deleteMarkerAdmin(markerId) {
        if (!isAdmin) {
            alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
            return;
        }

        if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–µ—Ç–∫—É?')) {
            try {
                await _sb.from('markers').delete().eq('id', markerId);
                alert('–ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
                openAdminModal(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                loadMarkers(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + (e?.message || e));
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞
    async function openChatModal() {
        if (!currentDriver) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é');
            openRegistrationModal();
            return;
        }

        document.getElementById('chatModal').classList.add('active');
        await loadChatMessages();
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        chatUpdateInterval = setInterval(loadChatMessages, 2000);
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞
    function closeChatModal() {
        document.getElementById('chatModal').classList.remove('active');
        if (chatUpdateInterval) clearInterval(chatUpdateInterval);
    }

    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞
    let chatUpdateInterval = null;

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞
    async function loadChatMessages() {
        try {
            const { data: messages } = await _sb.from('messages').select('*').order('created_at', { ascending: true }).limit(100);
            const container = document.getElementById('chatMessages');
            
            if (!messages || messages.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--gray); padding: 20px;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
                return;
            }

            container.innerHTML = '';
            messages.forEach(msg => {
                const isOwn = String(msg.author_id) === String(uid);
                const messageEl = document.createElement('div');
                messageEl.className = `chat-message ${isOwn ? 'own' : 'other'}`;
                
                let photoHTML = '';
                if (msg.photo_url) {
                    photoHTML = `<img src="${msg.photo_url}" class="chat-message-photo" onclick="window.open('${msg.photo_url}', '_blank')">`;
                }
                
                const timestamp = new Date(msg.created_at).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                
                messageEl.innerHTML = `
                    ${!isOwn ? `<div class="chat-message-author">${msg.author_name || '–ê–Ω–æ–Ω–∏–º'}</div>` : ''}
                    <div>${msg.text || ''}</div>
                    ${photoHTML}
                    <div class="chat-message-time">${timestamp}</div>
                `;
                container.appendChild(messageEl);
            });
            
            // –°–∫—Ä–æ–ª–∏–º –≤–Ω–∏–∑ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            container.scrollTop = container.scrollHeight;
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π:', e?.message || e);
            document.getElementById('chatMessages').innerHTML = '<div style="text-align: center; color: red; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
    async function sendChatMessage() {
        const messageText = document.getElementById('chatInput').value.trim();
        
        if (!messageText && !selectedChatPhoto) {
            alert('–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ');
            return;
        }

        let photoURL = null;

        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –≤ Supabase Storage
        if (selectedChatPhoto) {
            try {
                const fileName = `chat-photos/${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                const { error: uploadError } = await _sb.storage.from('chat').upload(fileName, selectedChatPhoto);
                
                if (uploadError) throw uploadError;
                
                // –ü–æ–ª—É—á–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π URL —Ñ–æ—Ç–æ
                const { data } = _sb.storage.from('chat').getPublicUrl(fileName);
                photoURL = data.publicUrl;
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ:', e?.message || e);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ. –°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–µ–∑ —Ñ–æ—Ç–æ.');
            }
        }

        // –í—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ë–î
        try {
            const { error } = await _sb.from('messages').insert([{
                author_id: uid,
                author_name: currentDriver.name,
                text: messageText,
                photo_url: photoURL,
                created_at: new Date().toISOString()
            }]);

            if (!error) {
                document.getElementById('chatInput').value = '';
                selectedChatPhoto = null;
                await loadChatMessages();
            } else {
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (e?.message || e));
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è —á–∞—Ç–∞
    document.addEventListener('change', function(e) {
        if (e.target.id === 'chatPhotoInput') {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB –ª–∏–º–∏—Ç
                    alert('–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è (–º–∞–∫—Å–∏–º—É–º 5MB)');
                    e.target.value = '';
                    return;
                }
                selectedChatPhoto = file;
                alert('–§–æ—Ç–æ –≤—ã–±—Ä–∞–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–≥–æ –≤–º–µ—Å—Ç–µ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º.');
            }
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –∑–∞ –º–∞—Ä–∫–µ—Ä (–ª–∞–π–∫/–¥–∏–∑–ª–∞–π–∫)
    window.vote = async (id, isUp) => {
        try {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –º–∞—Ä–∫–µ—Ä –∏–∑ –ë–î
            const { data: current } = await _sb.from('markers').select('*').eq('id', id).single();
            if (!current) return;
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ª–∞–π–∫–æ–≤ –∏–ª–∏ –¥–∏–∑–ª–∞–π–∫–æ–≤
            const upd = isUp ? { votes_up: (current.votes_up || 0) + 1 } : { votes_down: (current.votes_down || 0) + 1 };
            await _sb.from('markers').update(upd).eq('id', id);

            // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ–º —Å—É–º–º–∞—Ä–Ω—ã–µ –ª–∞–π–∫–∏ –∞–≤—Ç–æ—Ä–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–∏–º –≤ drivers
            try {
                const authorId = current.author_id;
                const { data: authorMarkers } = await _sb.from('markers').select('votes_up').eq('author_id', authorId);
                let likesSum = 0;
                if (authorMarkers && authorMarkers.length) likesSum = authorMarkers.reduce((s, r) => s + (r.votes_up || 0), 0);
                const isTrusted = likesSum >= (typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20);
                // –ü—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å/–≤—Å—Ç–∞–≤–∏—Ç—å –≤ drivers (–≥—Ä–µ–π—Å—Ñ—É–ª ‚Äî –µ—Å–ª–∏ –∫–æ–ª–æ–Ω–æ–∫ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º)
                try {
                    await _sb.from('drivers').upsert([{ user_id: authorId, likes_sum: likesSum, is_trusted: isTrusted }], { onConflict: 'user_id' });
                } catch (err) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å drivers.likes_sum/is_trusted:', err?.message || err);
                }
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á—ë—Ç–µ –ª–∞–π–∫–æ–≤ –∞–≤—Ç–æ—Ä–∞:', e?.message || e);
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–∞—Ä–∫–µ—Ä–∞:', e?.message || e);
        }

        // –ü–µ—Ä–µ—Å—á—ë—Ç —Ä–µ–π—Ç–∏–Ω–≥–∞ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è (–∏–∑ —Ç–∞–±–ª–∏—Ü—ã markers)
        loadMarkers();
    };

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –º–µ—Ç–∫–∏ (–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ "–°—Ç–æ—è—Ç" –∏–ª–∏ "–£–µ—Ö–∞–ª–∏")
    window.confirmMarker = async (markerId, status) => {
        // status: 'stay' –∏–ª–∏ 'leave'
        if (!uid || uid === 'guest') {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ Telegram');
            return;
        }

        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª –ª–∏ —É–∂–µ —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞ —ç—Ç—É –º–µ—Ç–∫—É
            const { data: existing } = await _sb.from('marker_confirmations')
                .select('id').eq('marker_id', markerId).eq('user_id', uid).maybeSingle();
            
            if (existing) {
                alert(`–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ —ç—Ç—É –º–µ—Ç–∫—É. –û–¥–∏–Ω –≥–æ–ª–æ—Å –Ω–∞ –º–µ—Ç–∫—É.`);
                return;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ–ª–æ—Å –≤ —Ç–∞–±–ª–∏—Ü—É marker_confirmations
            const { error: insertError } = await _sb.from('marker_confirmations').insert([{
                marker_id: markerId,
                user_id: uid,
                status: status,
                created_at: new Date().toISOString()
            }]);

            if (insertError && insertError.code === 'PGRST116') {
                // –¢–∞–±–ª–∏—Ü–∞ marker_confirmations –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—á—ë—Ç—á–∏–∫ –≤ markers
                console.warn('–¢–∞–±–ª–∏—Ü–∞ marker_confirmations –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π —Å—á—ë—Ç—á–∏–∫');
                const { data: marker } = await _sb.from('markers').select('leave_confirmations').eq('id', markerId).single();
                if (marker) {
                    const newCount = (status === 'leave') ? ((marker.leave_confirmations || 0) + 1) : (marker.leave_confirmations || 0);
                    await _sb.from('markers').update({ leave_confirmations: newCount }).eq('id', markerId);
                    
                    // –ï—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π - —É–¥–∞–ª—è–µ–º –º–µ—Ç–∫—É
                    if (newCount >= (typeof MARKER_LEAVE_THRESHOLD !== 'undefined' ? MARKER_LEAVE_THRESHOLD : 3)) {
                        await _sb.from('markers').delete().eq('id', markerId);
                        alert(`‚úÖ –ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞ - ${newCount} —á–µ–ª–æ–≤–µ–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ —á—Ç–æ –æ–±—ä–µ–∫—Ç —É–µ—Ö–∞–ª.`);
                        myMap.balloon.close();
                        loadMarkers();
                        return;
                    }
                }
            } else if (!insertError) {
                // –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–∏–ª–∏ –∑–∞–ø–∏—Å—å, —Å—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ "leave" –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
                const { data: confirmations } = await _sb.from('marker_confirmations')
                    .select('id').eq('marker_id', markerId).eq('status', 'leave');
                
                const leaveCount = (confirmations ? confirmations.length : 0);
                
                // –ï—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π - —É–¥–∞–ª—è–µ–º –º–µ—Ç–∫—É
                if (leaveCount >= (typeof MARKER_LEAVE_THRESHOLD !== 'undefined' ? MARKER_LEAVE_THRESHOLD : 3)) {
                    await _sb.from('markers').delete().eq('id', markerId);
                    alert(`‚úÖ –ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞ - ${leaveCount} —á–µ–ª–æ–≤–µ–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ —á—Ç–æ –æ–±—ä–µ–∫—Ç —É–µ—Ö–∞–ª.`);
                    myMap.balloon.close();
                    loadMarkers();
                    return;
                }
                
                // –ò–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å—á—ë—Ç—á–∏–∫
                alert(`‚úÖ –í–∞—à –≥–æ–ª–æ—Å —É—á—Ç—ë–Ω (${leaveCount}/${typeof MARKER_LEAVE_THRESHOLD !== 'undefined' ? MARKER_LEAVE_THRESHOLD : 3} –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è)`);
                loadMarkers(); // –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É —Å –Ω–æ–≤—ã–º —Å—á—ë—Ç—á–∏–∫–æ–º
            } else if (insertError) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏: ' + (insertError.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –º–µ—Ç–∫–∏:', e?.message || e);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏: ' + (e?.message || e));
        }
    };

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∞)
    window.delMarker = async (id) => {
        if (confirm("–£–¥–∞–ª–∏—Ç—å –≤–∞—à—É –º–µ—Ç–∫—É?")) {
            await _sb.from('markers').delete().eq('id', id);
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–∏–π –±–∞–ª—É–Ω
            myMap.balloon.close();
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–∞—Ä–∫–µ—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ
            loadMarkers();
        }
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã
    ymaps.ready(() => {
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å —Ü–µ–Ω—Ç—Ä–æ–º –∏ —É—Ä–æ–≤–Ω–µ–º –∑—É–º–∞
        myMap = new ymaps.Map("map", { center: [48.01, 37.80], zoom: 16, controls: [] });
        
        // –†–∏—Å—É–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –î–æ–Ω–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ –î–ù–†
        const donetskBoundary = new ymaps.Rectangle([
            [DONETSK_REGION.south, DONETSK_REGION.west],
            [DONETSK_REGION.north, DONETSK_REGION.east]
        ], {}, {
            fillColor: '#0066ff33',
            strokeColor: '#007aff',
            strokeWidth: 2,
            strokeOpacity: 0.7
        });
        myMap.geoObjects.add(donetskBoundary);
        
        // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã –æ–±–Ω–æ–≤–ª—è–µ–º –∞–¥—Ä–µ—Å
        myMap.events.add('actionend', () => {
            ymaps.geocode(myMap.getCenter()).then(res => {
                const obj = res.geoObjects.get(0);
                document.getElementById('addr-text').innerText = obj ? obj.getAddressLine() : "–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ";
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤ –∫–∞–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ –Ω–∞—Ö–æ–¥–∏–º—Å—è
                const coords = myMap.getCenter();
                if (isInDonetskRegion(coords)) {
                    document.getElementById('addr-text').style.color = '#34c759';
                } else {
                    document.getElementById('addr-text').style.color = '#ff3b30';
                }
            });
        });
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–¥–≤–∏–≥–∞—Ç—å –∫–∞—Ä—Ç—É ‚Äî –æ—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
        myMap.events.add('actionstart', () => {
            autoFollow = false;
        });
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é)
        initApp();
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º GPS –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
        initGPS();
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
        loadMarkers();
        // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        setInterval(loadMarkers, 10000);
    });

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –≤ –î–æ–Ω–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏
    function isInDonetskRegion(coords) {
        if (!coords || coords.length < 2) return false;
        const lat = coords[0];
        const lon = coords[1];
        
        return lat >= DONETSK_REGION.south && 
               lat <= DONETSK_REGION.north && 
               lon >= DONETSK_REGION.west && 
               lon <= DONETSK_REGION.east;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π —Ç–æ—á–∫–∏ (–º–∞—Ä–∫–µ—Ä–∞) –Ω–∞ –∫–∞—Ä—Ç—É
    async function addPoint() {
        if (!currentDriver) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é');
            openRegistrationModal();
            return;
        }

        // –ë–µ—Ä—ë–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã ‚Äî —Ç–∞–∫ –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–∫–∏ –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ
        // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–∫—É –∏–º–µ–Ω–Ω–æ –ø–æ GPS, —Å–Ω–∞—á–∞–ª–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–π—Ç–µ –∫–∞—Ä—Ç—É –Ω–∞ —Å–≤–æ—ë–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏
        const coords = myMap.getCenter();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ –î–æ–Ω–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ –î–ù–†
        if (!isInDonetskRegion(coords)) {
            alert('‚õî –ú–µ—Ç–∫–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –≤ –î–ù–†.\n\n–¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ' + coords[0].toFixed(2) + '¬∞N, ' + coords[1].toFixed(2) + '¬∞E');
            return;
        }

        // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä –≤ –ë–î
        try {
            const { error } = await _sb.from('markers').insert([{
                coords: coords, // –¶–µ–Ω—Ç—Ä —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç—ã
                ts: Date.now(), // –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
                exp: Date.now() + 7200000, // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –º–∞—Ä–∫–µ—Ä–∞ (2 —á–∞—Å–∞)
                type: selectedType, // –¢–∏–ø –º–∞—Ä–∫–µ—Ä–∞ (–î–ü–°, –†–µ–π–¥ –∏ —Ç.–¥.)
                comment: document.getElementById('m-comm').value, // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                author_id: uid // ID –∞–≤—Ç–æ—Ä–∞ –º–∞—Ä–∫–µ—Ä–∞
            }]);

            if (!error) {
                // –ü–æ–ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ drivers, –Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                try {
                    await _sb.from('drivers').update({ markers_count: (currentDriver.markers_count || 0) + 1 }).eq('user_id', uid);
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å markers_count –≤ drivers (–≤–æ–∑–º–æ–∂–Ω–æ, –∫–æ–ª–æ–Ω–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç):', e?.message || e);
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                currentDriver.markers_count = (currentDriver.markers_count || 0) + 1;

                // –ï—Å–ª–∏ –Ω–µ—Ç –æ—à–∏–±–∫–∏, –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã
                document.getElementById('m-comm').value = '';
                alert('‚úÖ –ú–µ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                loadMarkers();
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–µ—Ç–∫–∏:', e?.message || e);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–µ—Ç–∫–∏: ' + (e?.message || e));
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ —Å –∫–∞—Ä—Ç—ã
    async function loadMarkers() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –∏—Å—Ç–µ–∫–ª–∏ (exp > —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è)
        const { data: markers } = await _sb.from('markers').select('*').gt('exp', Date.now());
        if(!markers || !myMap) return;
        
        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –º–µ—Ç–∫–∏ –ø–æ —Ç–∏–ø–∞–º
        const typeCounts = {};
        markers.forEach(m => {
            typeCounts[m.type] = (typeCounts[m.type] || 0) + 1;
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ –≤ UI
        const counterEl = document.getElementById('markersCounter');
        if (counterEl) {
            const typeNames = { dps: '–î–ü–°', patrol: '–†–µ–π–¥', camera: '–ö–∞–º–µ—Ä–∞', dtp: '–î–¢–ü', works: '–†–∞–±–æ—Ç—ã', sos: 'SOS' };
            let counterHTML = '–ê–∫—Ç–∏–≤–Ω—ã–µ: ';
            let hasCounters = false;
            for (const [type, count] of Object.entries(typeCounts)) {
                if (count > 0) {
                    counterHTML += `<span class="counter-item"><span>${count}</span> ${typeNames[type] || type}</span>`;
                    hasCounters = true;
                }
            }
            if (!hasCounters) {
                counterHTML = '‚úÖ –û–ø–∞—Å–Ω–æ—Å—Ç–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
            }
            counterEl.innerHTML = counterHTML;
        }
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã —Å –∫–∞—Ä—Ç—ã
        myMap.geoObjects.removeAll();
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã (—Ü–µ–Ω—Ç—Ä)
        const userCoords = myMap.getCenter();

        // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º –∫–∞—Ä—Ç—É –¥–æ–≤–µ—Ä–∏—è –¥–ª—è –∞–≤—Ç–æ—Ä–æ–≤ –º–∞—Ä–∫–µ—Ä–æ–≤ (—á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ—Ä–∞ –æ—Ç–¥–µ–ª—å–Ω–æ)
        const authorIds = Array.from(new Set(markers.map(m => String(m.author_id))));
        let trustMap = {};
        try {
            // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü—ã drivers (–µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–ª–æ–Ω–∫–∏ likes_sum/is_trusted)
            const { data: driversInfo } = await _sb.from('drivers').select('user_id,likes_sum,is_trusted').in('user_id', authorIds);
            if (driversInfo) {
                driversInfo.forEach(d => {
                    const id = String(d.user_id);
                    if (typeof d.is_trusted !== 'undefined' && d.is_trusted !== null) {
                        trustMap[id] = !!d.is_trusted;
                    } else if (typeof d.likes_sum !== 'undefined' && d.likes_sum !== null) {
                        trustMap[id] = (d.likes_sum >= (typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20));
                    }
                });
            }
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ drivers –¥–ª—è –∞–≤—Ç–æ—Ä–æ–≤ (–≤–æ–∑–º–æ–∂–Ω–æ, —Ç–∞–±–ª–∏—Ü–∞/–∫–æ–ª–æ–Ω–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç):', e?.message || e);
        }

        // –î–ª—è –∞–≤—Ç–æ—Ä–æ–≤ –±–µ–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ—Å—á–∏—Ç–∞–µ–º —Å—É–º–º–∞—Ä–Ω—ã–µ –ª–∞–π–∫–∏ –ø–æ –≤—Å–µ–º –º–µ—Ç–∫–∞–º
        const missingAuthors = authorIds.filter(id => typeof trustMap[id] === 'undefined');
        if (missingAuthors.length > 0) {
            try {
                const { data: allMarkers } = await _sb.from('markers').select('author_id,votes_up').in('author_id', missingAuthors);
                const sumMap = {};
                if (allMarkers) {
                    allMarkers.forEach(r => {
                        const id = String(r.author_id);
                        sumMap[id] = (sumMap[id] || 0) + (r.votes_up || 0);
                    });
                }
                missingAuthors.forEach(id => {
                    const likes = sumMap[id] || 0;
                    trustMap[id] = likes >= (typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20);
                });
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Å—á–∏—Ç–∞—Ç—å —Å—É–º–º–∞—Ä–Ω—ã–µ –ª–∞–π–∫–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–æ–≤:', e?.message || e);
            }
        }

        // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞ —Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –Ω–∞ –∫–∞—Ä—Ç–µ
        markers.forEach(m => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–æ–º –º–∞—Ä–∫–µ—Ä–∞
            const isOwner = String(m.author_id) === String(uid);
            
            // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π "—É–µ—Ö–∞–ª–∏" (–≥—Ä–µ–π—Å—Ñ—É–ª - –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –±–µ—Ä—ë–º –∏–∑ —Å—á—ë—Ç—á–∏–∫–∞ –≤ markers)
            let leaveCount = m.leave_confirmations || 0;
            const confirmThreshold = typeof MARKER_LEAVE_THRESHOLD !== 'undefined' ? MARKER_LEAVE_THRESHOLD : 3;
            const confirmationBar = leaveCount > 0 ? `<div style="margin-top: 8px; font-size: 11px; color: #666;">üöó –£–µ—Ö–∞–ª–∏: ${leaveCount}/${confirmThreshold}</div>` : '';
            
            // HTML –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –æ–∫–Ω–∞ –º–∞—Ä–∫–µ—Ä–∞
            const bHtml = `<div class="b-cont">
                <strong>${m.comment || '–ú–µ—Ç–∫–∞'}</strong>
                <div class="b-poll">
                    <button class="b-poll-btn" onclick="window.vote(${m.id}, true)">üëç ${m.votes_up || 0}</button>
                    <button class="b-poll-btn" onclick="window.vote(${m.id}, false)">üëé ${m.votes_down || 0}</button>
                </div>
                <div style="margin-top: 8px; display: flex; gap: 5px;">
                    <button class="b-poll-btn" onclick="window.confirmMarker(${m.id}, 'stay')" style="flex: 1; background: #34c759; color: white; font-weight: bold;">‚úÖ –°—Ç–æ—è—Ç</button>
                    <button class="b-poll-btn" onclick="window.confirmMarker(${m.id}, 'leave')" style="flex: 1; background: #ff3b30; color: white; font-weight: bold;">üöó –£–µ—Ö–∞–ª–∏</button>
                </div>
                ${confirmationBar}
                ${isOwner ? `<button class="b-del" onclick="window.delMarker(${m.id})">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
            </div>`;
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ–≤–µ—Ä–∏–µ –∞–≤—Ç–æ—Ä–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∑–≤–µ–∑–¥–æ—á–∫—É –∫ –∏–∫–æ–Ω–∫–µ, –µ—Å–ª–∏ –æ–Ω –ø—Ä–æ–≤–µ—Ä–µ–Ω
            const authorId = String(m.author_id);
            const isTrustedAuthor = !!trustMap[authorId];
            const iconInner = `<div style="background:white; border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center; border:2px solid ${isTrustedAuthor ? '#b8860b' : 'var(--blue)'}; font-size:18px; position: relative;">${MAP_ICONS[m.type]}${isTrustedAuthor ? '<span style=\"position:absolute; top:-6px; right:-6px; font-size:12px;\">‚≠ê</span>' : ''}</div>`;
            // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä —Å –∏–∫–æ–Ω–∫–æ–π –∏ –±–∞–ª—É–Ω–æ–º
            const p = new ymaps.Placemark(m.coords, { balloonContent: bHtml, iconContent: iconInner }, 
            { iconLayout: 'default#imageWithContent', iconImageHref: '', iconImageSize: [30, 30], iconImageOffset: [-15, -15] });
            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç—É
            myMap.geoObjects.add(p);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –æ–ø–∞—Å–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ (–∫–∞–º–µ—Ä—ã –∏ –î–ü–°)
            if ((m.type === 'camera' || m.type === 'dps') && m.coords && Array.isArray(m.coords)) {
                const distance = calculateDistance(userCoords, m.coords);
                
                // –ï—Å–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–Ω—å—à–µ 500 –º–µ—Ç—Ä–æ–≤ –∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —Ä–∞–∑, –∏–∑–¥–∞–µ–º –∑–≤—É–∫
                if (distance < 500 && !notifiedMarkers.has(m.id)) {
                    notifiedMarkers.add(m.id);
                    playAlertSound();
                    console.log(`‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! ${m.type === 'camera' ? '–ö–∞–º–µ—Ä–∞' : '–î–ü–°'} –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ ${distance.toFixed(0)}–º`);
                }
            }
            
            // –û—á–∏—â–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –¥–∞–ª–µ–∫–æ (–±–æ–ª–µ–µ 1000–º)
            if (notifiedMarkers.has(m.id)) {
                const distance = calculateDistance(userCoords, m.coords);
                if (distance > 1000) {
                    notifiedMarkers.delete(m.id);
                }
            }
        });
    }
</script>
</body>
</html>

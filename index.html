<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EASY RIDE ‚Äî RELIABLE</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=7f7db9e2-0eff-47d4-98d3-59b326552ed7&lang=ru_RU"></script>
    <style>
        :root { --blue: #007aff; --bg: #f2f2f7; --gray: #8e8e93; }
        body, html { width: 100%; height: 100%; margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: var(--bg); overflow: hidden; }
        
        /* –≠–∫—Ä–∞–Ω –∑–∞—â–∏—Ç—ã –æ—Ç –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ */
        #accessDenied {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 99999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 20px;
            text-align: center;
        }
        #accessDenied.active {
            display: flex;
        }
        .access-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: shake 0.5s infinite;
        }
        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }
        .access-title {
            color: white;
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 15px;
        }
        .access-message {
            color: rgba(255,255,255,0.9);
            font-size: 16px;
            line-height: 1.5;
            max-width: 400px;
        }
        .access-btn {
            margin-top: 25px;
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 35px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        .access-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        #map { width: 100%; height: 100%; position: absolute; }
        .target {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%);
            z-index: 9999;
            pointer-events: none;
            font-size: 40px;
            transition: visibility 0.2s, opacity 0.2s;
            visibility: visible;
            opacity: 1;
        }
        .bottom-ui { position: absolute; bottom: 10px; left: 0; right: 0; z-index: 1000; padding: 0 8px; }
        .action-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(15px); border-radius: 24px; padding: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); position: relative; }
        .action-card.hidden { display: none; }
        .action-card-close { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray); padding: 4px 8px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s; }
        .action-card-close:hover { background: #f0f0f5; color: #000; }
        .open-action-btn { position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%); width: 48px; height: 48px; border-radius: 50%; background: white; border: 2px solid var(--blue); z-index: 1600; display: none; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); cursor: pointer; }
        .open-action-btn.visible { display: flex; }
        .addr-label { font-size: 12px; color: #000; font-weight: 600; margin-bottom: 10px; display: block; text-align: center; }
        .type-selector { display: flex; justify-content: space-between; margin-bottom: 12px; gap: 6px; flex-wrap: wrap; }
        .type-btn { 
            border: none; background: none; cursor: pointer; display: flex; flex-direction: column; 
            align-items: center; gap: 6px; width: 31%; padding: 8px; border-radius: 14px; 
            transition: all 0.25s ease; position: relative;
        }
        .type-btn:active { transform: scale(0.95); }
        .icon-circle { 
            width: 54px; height: 54px; background: #f0f0f5; border-radius: 16px; display: flex; 
            align-items: center; justify-content: center; border: 3px solid transparent; 
            transition: all 0.25s ease; font-size: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .type-btn span { font-size: 11px; font-weight: 700; color: var(--gray); text-transform: uppercase; letter-spacing: 0.3px; }
        .type-btn:hover .icon-circle { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
        .type-btn.active { color: var(--blue); background: rgba(0, 122, 255, 0.08); }
        .type-btn.active .icon-circle { background: #fff; border-color: var(--blue); box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3); }
        
        /* –°—á—ë—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–∫ */
        .markers-counter { font-size: 11px; color: var(--gray); margin-bottom: 10px; text-align: center; padding: 8px; background: #f9f9f9; border-radius: 10px; }
        .counter-item { display: inline-block; margin: 0 6px; }
        .counter-item span:first-child { font-weight: 700; color: var(--blue); }
        .main-btn { width: 100%; background: var(--blue); color: white; border: none; border-radius: 16px; padding: 14px; font-size: 15px; font-weight: 800; cursor: pointer; }
        .b-cont { font-size: 14px; line-height: 1.4; min-width: 170px; }
        .b-poll { display: flex; gap: 8px; margin-top: 10px; }
        .b-poll-btn { flex: 1; border: none; border-radius: 8px; padding: 8px; cursor: pointer; background: #f0f0f5; font-weight: bold; }
        .b-del { color: #ff3b30; border: none; background: none; font-size: 11px; margin-top: 12px; width: 100%; cursor: pointer; font-weight: bold; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è –∏ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ */
        .profile-btn { position: absolute; top: 15px; right: 15px; z-index: 1500; width: 45px; height: 45px; border-radius: 50%; background: white; border: 2px solid var(--blue); cursor: pointer; font-size: 22px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .profile-btn:hover { transform: scale(1.05); }
        /* –ö–Ω–æ–ø–∫–∞ "–ì–¥–µ —è" */
        .loc-btn { position: absolute; top: 15px; right: 70px; z-index: 1500; width: 45px; height: 45px; border-radius: 50%; background: white; border: 2px solid var(--blue); cursor: pointer; font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        .loc-btn:hover { transform: scale(1.05); }
        .follow-toggle { position: absolute; top: 15px; right: 120px; z-index: 1500; width: 40px; height: 40px; border-radius: 50%; background: white; border: 2px solid #34c759; cursor: pointer; font-size: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        .follow-toggle.inactive { background: #fff; border-color: #ccc; color: #888; }
        .follow-toggle.active { background: #34c759; color: white; border-color: #34c759; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2500; overflow-y: auto; }
        .modal.active { display: block; }
        .modal-content { background: white; border-radius: 20px; margin: 20px; padding: 20px; max-width: 500px; margin-left: auto; margin-right: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: var(--gray); }
        
        /* –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å */
        .admin-btn { position: absolute; top: 15px; left: 15px; z-index: 1500; width: 45px; height: 45px; border-radius: 50%; background: #ff9500; border: 2px solid white; cursor: pointer; font-size: 22px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
        .admin-btn.visible { display: block; }
        .admin-btn:hover { transform: scale(1.05); }
        
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .admin-table th, .admin-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; font-size: 12px; }
        .admin-table th { background: #f0f0f5; font-weight: 600; }
        .admin-table tr:hover { background: #f9f9f9; }
        
        .delete-btn { background: #ff3b30; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .delete-btn:hover { background: #e63027; }
        
        /* –ö–Ω–æ–ø–∫–∞ —Ä–∞–∑–±–∞–Ω–∞ */
        .unban-btn { background: #34c759; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: bold; margin-left: 5px; }
        .unban-btn:hover { background: #2fb350; }
        
        .admin-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .admin-stat-card { background: #f0f0f5; border-radius: 12px; padding: 15px; text-align: center; }
        .admin-stat-card .value { font-size: 28px; font-weight: 800; color: var(--blue); }
        .admin-stat-card .label { font-size: 12px; color: var(--gray); margin-top: 5px; }
        
        /* –ö–Ω–æ–ø–∫–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ */
        .moderation-section { margin-top: 20px; padding-top: 20px; border-top: 2px solid #f0f0f5; }
        .moderation-title { font-size: 14px; font-weight: 700; color: #333; margin-bottom: 12px; text-align: center; }
        .moderation-buttons { display: flex; gap: 10px; }
        .mod-btn { flex: 1; border: none; padding: 12px; border-radius: 12px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .mod-btn:active { transform: scale(0.95); }
        .mod-btn-temp { background: #ff9500; color: white; }
        .mod-btn-temp:hover { background: #e68600; }
        .mod-btn-perm { background: #ff3b30; color: white; }
        .mod-btn-perm:hover { background: #e63027; }
        .mod-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –±–∞–Ω–∞ */
        .ban-duration-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 3000; align-items: center; justify-content: center; }
        .ban-duration-modal.active { display: flex; }
        .ban-duration-content { background: white; border-radius: 20px; padding: 25px; max-width: 350px; width: 90%; }
        .ban-duration-title { font-size: 18px; font-weight: 700; margin-bottom: 15px; text-align: center; }
        .ban-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .ban-option { background: #f0f0f5; border: 2px solid transparent; padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; font-size: 13px; font-weight: 600; transition: all 0.2s; }
        .ban-option:hover { background: #e5e5ea; }
        .ban-option.selected { background: #fff; border-color: #ff9500; color: #ff9500; }
        .ban-option .duration { display: block; font-size: 16px; font-weight: 700; margin-bottom: 4px; }
        .ban-option .label { display: block; font-size: 11px; color: var(--gray); }
        .ban-actions { display: flex; gap: 10px; }
        .ban-confirm-btn, .ban-cancel-btn { flex: 1; border: none; padding: 12px; border-radius: 12px; font-size: 14px; font-weight: 700; cursor: pointer; }
        .ban-confirm-btn { background: #ff9500; color: white; }
        .ban-cancel-btn { background: #f0f0f5; color: #333; }
        
        /* –ß–∞—Ç */
        .chat-btn { position: absolute; bottom: 100px; right: 15px; z-index: 1500; width: 50px; height: 50px; border-radius: 50%; background: var(--blue); border: 2px solid white; cursor: pointer; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        .chat-btn:hover { transform: scale(1.05); }
        .chat-btn:active { transform: scale(0.95); }
        
        .unread-badge { 
            position: absolute; 
            top: -5px; 
            right: -5px; 
            background: #ff3b30; 
            color: white; 
            border-radius: 50%; 
            width: 22px; 
            height: 22px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 11px; 
            font-weight: 800; 
            border: 2px solid white;
            display: none;
        }
        .unread-badge.visible {
            display: flex;
        }
        
        .chat-modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.5); 
            z-index: 2600; 
        }
        .chat-modal.active { display: block; }
        
        .chat-container { 
            position: absolute; 
            top: 0; 
            right: 0; 
            width: 100%; 
            max-width: 400px; 
            height: 100%; 
            background: white; 
            display: flex; 
            flex-direction: column; 
            box-shadow: -5px 0 20px rgba(0,0,0,0.2);
        }
        
        .chat-header { 
            background: var(--blue); 
            color: white; 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chat-header-title { 
            font-size: 18px; 
            font-weight: 700; 
        }
        
        .chat-close-btn { 
            background: none; 
            border: none; 
            color: white; 
            font-size: 26px; 
            cursor: pointer; 
            padding: 0; 
            width: 30px; 
            height: 30px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }
        
        .chat-messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            background: #f8f8f8;
        }
        
        .chat-message { 
            margin-bottom: 12px; 
            display: flex; 
            flex-direction: column;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chat-message.own { 
            align-items: flex-end; 
        }
        
        .chat-message.other { 
            align-items: flex-start; 
        }
        
        .message-author { 
            font-size: 11px; 
            color: var(--gray); 
            margin-bottom: 4px; 
            padding: 0 8px;
        }
        
        .message-bubble { 
            max-width: 75%; 
            padding: 10px 14px; 
            border-radius: 18px; 
            word-wrap: break-word;
            position: relative;
        }
        
        .chat-message.own .message-bubble { 
            background: var(--blue); 
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.other .message-bubble { 
            background: white; 
            color: #000;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .message-time { 
            font-size: 10px; 
            margin-top: 4px; 
            opacity: 0.7;
            padding: 0 8px;
        }
        
        .chat-input-container { 
            padding: 12px; 
            background: white; 
            border-top: 1px solid #e5e5ea;
            display: flex;
            gap: 10px;
        }
        
        .chat-input { 
            flex: 1; 
            border: 1px solid #e5e5ea; 
            border-radius: 20px; 
            padding: 10px 16px; 
            font-size: 15px; 
            outline: none;
            resize: none;
            max-height: 100px;
            min-height: 40px;
            font-family: -apple-system, sans-serif;
        }
        
        .chat-input:focus { 
            border-color: var(--blue); 
        }
        
        .chat-send-btn { 
            background: var(--blue); 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            font-size: 18px;
            transition: all 0.2s;
        }
        
        .chat-send-btn:hover { 
            background: #0056b3;
            transform: scale(1.05);
        }
        
        .chat-send-btn:active { 
            transform: scale(0.95); 
        }
        
        .chat-send-btn:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        
        .no-messages { 
            text-align: center; 
            color: var(--gray); 
            padding: 40px 20px; 
            font-size: 14px;
        }
        
        .typing-indicator {
            display: none;
            padding: 10px 14px;
            background: white;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            max-width: 60px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .typing-indicator.active {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--gray);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –∑–∞—â–∏—Ç—ã –¥–æ—Å—Ç—É–ø–∞ -->
    <div id="accessDenied">
        <div class="access-icon">üîí</div>
        <div class="access-title">–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</div>
        <div class="access-message">
            –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram Mini App.<br>
            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ –≤ Telegram.
        </div>
        <button class="access-btn" onclick="window.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="mapContainer" style="display: none;">
        <div id="map"></div>
        <div class="target" id="crosshair">üìç</div>

        <!-- –ö–Ω–æ–ø–∫–∞ —á–∞—Ç–∞ -->
        <button class="chat-btn" onclick="openChat()" title="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç">
            üí¨
            <span class="unread-badge" id="unreadBadge">0</span>
        </button>

        <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
        <button class="profile-btn" onclick="openProfile()">üë§</button>

        <!-- –ö–Ω–æ–ø–∫–∞ "–ì–¥–µ —è" -->
        <button class="loc-btn" onclick="centerOnUser()" title="–ü–æ–∫–∞–∑–∞—Ç—å –º–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ">üìç</button>

        <!-- –ö–Ω–æ–ø–∫–∞ —Å–ª–µ–∂–µ–Ω–∏—è –∑–∞ –ø–æ–∑–∏—Ü–∏–µ–π -->
        <button class="follow-toggle inactive" id="followBtn" onclick="toggleFollow()" title="–°–ª–µ–∂–µ–Ω–∏–µ –∑–∞ –ø–æ–∑–∏—Ü–∏–µ–π">üéØ</button>

        <!-- –ö–Ω–æ–ø–∫–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º) -->
        <button class="admin-btn" id="adminBtn" onclick="openAdminPanel()">‚öôÔ∏è</button>

        <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="bottom-ui">
            <div class="action-card" id="actionCard">
                <button class="action-card-close" onclick="toggleActionCard()">√ó</button>
                
                <!-- –°—á—ë—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–∫ -->
                <div class="markers-counter" id="markersCounter">
                    <div class="counter-item">üìç <span id="countPolice">0</span> –ü–æ–ª–∏—Ü–∏—è</div>
                    <div class="counter-item">üö® <span id="countAccident">0</span> –î–¢–ü</div>
                    <div class="counter-item">üöß <span id="countRoadwork">0</span> –†–µ–º–æ–Ω—Ç</div>
                </div>

                <span class="addr-label" id="addressLabel">–û–ø—Ä–µ–¥–µ–ª—è—é –∞–¥—Ä–µ—Å...</span>
                
                <div class="type-selector">
                    <button class="type-btn" data-type="police" onclick="selectType('police')">
                        <div class="icon-circle">üëÆ</div>
                        <span>–ü–æ–ª–∏—Ü–∏—è</span>
                    </button>
                    <button class="type-btn" data-type="accident" onclick="selectType('accident')">
                        <div class="icon-circle">üö®</div>
                        <span>–î–¢–ü</span>
                    </button>
                    <button class="type-btn" data-type="roadwork" onclick="selectType('roadwork')">
                        <div class="icon-circle">üöß</div>
                        <span>–†–µ–º–æ–Ω—Ç</span>
                    </button>
                </div>
                <button class="main-btn" id="placeBtn" onclick="placeMarker()">üìç –û—Ç–º–µ—Ç–∏—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">–ü—Ä–æ—Ñ–∏–ª—å</h2>
                <button class="modal-close" onclick="closeProfile()">√ó</button>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 60px; margin-bottom: 10px;">üë§</div>
                <div style="font-size: 18px; font-weight: 700; margin-bottom: 5px;" id="profileName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div style="font-size: 13px; color: var(--gray);" id="profileId">ID: ...</div>
            </div>
            <div style="background: #f0f0f5; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: var(--gray); font-size: 13px;">–í–∞—à–∏—Ö –º–µ—Ç–æ–∫:</span>
                    <span style="font-weight: 700; font-size: 15px; color: var(--blue);" id="profileMarkers">0</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--gray); font-size: 13px;">–û—Ü–µ–Ω–æ–∫ –ø–æ–ª—É—á–µ–Ω–æ:</span>
                    <span style="font-weight: 700; font-size: 15px; color: #34c759;" id="profileVotes">0 üëç</span>
                </div>
            </div>
            <button class="main-btn" onclick="closeProfile()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ -->
    <div class="modal" id="adminModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 style="margin: 0;">–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
                <button class="modal-close" onclick="closeAdminPanel()">√ó</button>
            </div>
            
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="admin-stats">
                <div class="admin-stat-card">
                    <div class="value" id="adminTotalMarkers">0</div>
                    <div class="label">–í—Å–µ–≥–æ –º–µ—Ç–æ–∫</div>
                </div>
                <div class="admin-stat-card">
                    <div class="value" id="adminTotalUsers">0</div>
                    <div class="label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∏ -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #f0f0f5;">
                <button id="tabMarkers" class="tab-btn active" onclick="switchAdminTab('markers')" style="flex: 1; border: none; background: none; padding: 12px; cursor: pointer; font-weight: 700; border-bottom: 3px solid var(--blue);">–ú–µ—Ç–∫–∏</button>
                <button id="tabBans" class="tab-btn" onclick="switchAdminTab('bans')" style="flex: 1; border: none; background: none; padding: 12px; cursor: pointer; font-weight: 700; border-bottom: 3px solid transparent; color: var(--gray);">–ë–∞–Ω—ã</button>
            </div>

            <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–∫–∏ "–ú–µ—Ç–∫–∏" -->
            <div id="adminMarkersContent">
                <div style="overflow-x: auto;">
                    <table class="admin-table" id="adminMarkersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ê–≤—Ç–æ—Ä</th>
                                <th>–¢–∏–ø</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>üëç/üëé</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="adminMarkersBody">
                            <tr><td colspan="6" style="text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–∫–∏ "–ë–∞–Ω—ã" -->
            <div id="adminBansContent" style="display: none;">
                <div style="overflow-x: auto;">
                    <table class="admin-table" id="adminBansTable">
                        <thead>
                            <tr>
                                <th>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</th>
                                <th>–¢–∏–ø –±–∞–Ω–∞</th>
                                <th>–î–æ</th>
                                <th>–ó–∞–±–∞–Ω–∏–ª</th>
                                <th>–î–∞—Ç–∞ –±–∞–Ω–∞</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="adminBansBody">
                            <tr><td colspan="6" style="text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="modal" id="moderatorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">–ú–æ–¥–µ—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                <button class="modal-close" onclick="closeModerationModal()">√ó</button>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 60px; margin-bottom: 10px;">üë§</div>
                <div style="font-size: 18px; font-weight: 700; margin-bottom: 5px;" id="modUserName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                <div style="font-size: 13px; color: var(--gray);" id="modUserId">ID: ...</div>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏ -->
            <div class="moderation-section">
                <div class="moderation-title">üõ°Ô∏è –î–µ–π—Å—Ç–≤–∏—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞</div>
                <div class="moderation-buttons">
                    <button class="mod-btn mod-btn-temp" onclick="openBanDurationModal()">
                        ‚è∞ –í—Ä–µ–º–µ–Ω–Ω—ã–π –±–∞–Ω
                    </button>
                    <button class="mod-btn mod-btn-perm" onclick="banUserPermanent()">
                        üö´ –ü–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω—ã–π –±–∞–Ω
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –±–∞–Ω–∞ -->
    <div class="ban-duration-modal" id="banDurationModal">
        <div class="ban-duration-content">
            <div class="ban-duration-title">‚è∞ –í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–∞–Ω–∞</div>
            <div class="ban-options" id="banOptions">
                <div class="ban-option" data-hours="1" onclick="selectBanDuration(1)">
                    <span class="duration">1 —á–∞—Å</span>
                    <span class="label">–ú—è–≥–∫–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</span>
                </div>
                <div class="ban-option" data-hours="3" onclick="selectBanDuration(3)">
                    <span class="duration">3 —á–∞—Å–∞</span>
                    <span class="label">–ö–æ—Ä–æ—Ç–∫–∏–π –±–∞–Ω</span>
                </div>
                <div class="ban-option" data-hours="12" onclick="selectBanDuration(12)">
                    <span class="duration">12 —á–∞—Å–æ–≤</span>
                    <span class="label">–ü–æ–ª–¥–Ω—è</span>
                </div>
                <div class="ban-option selected" data-hours="24" onclick="selectBanDuration(24)">
                    <span class="duration">24 —á–∞—Å–∞</span>
                    <span class="label">–°—É—Ç–∫–∏</span>
                </div>
                <div class="ban-option" data-hours="72" onclick="selectBanDuration(72)">
                    <span class="duration">3 –¥–Ω—è</span>
                    <span class="label">–°–µ—Ä—å—ë–∑–Ω–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ</span>
                </div>
                <div class="ban-option" data-hours="168" onclick="selectBanDuration(168)">
                    <span class="duration">–ù–µ–¥–µ–ª—è</span>
                    <span class="label">–°—Ç—Ä–æ–≥–æ–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ</span>
                </div>
            </div>
            <div class="ban-actions">
                <button class="ban-cancel-btn" onclick="closeBanDurationModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="ban-confirm-btn" onclick="confirmTemporaryBan()">–ó–∞–±–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-header-title">üí¨ –û–±—â–∏–π —á–∞—Ç</div>
                <button class="chat-close-btn" onclick="closeChat()">√ó</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="no-messages">–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</div>
            </div>
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            <div class="chat-input-container">
                <textarea class="chat-input" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                <button class="chat-send-btn" id="chatSendBtn" onclick="sendMessage()">
                    ‚û§
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // –ó–ê–©–ò–¢–ê –û–¢ –ü–†–Ø–ú–û–ì–û –î–û–°–¢–£–ü–ê
        // ============================================
        
        function checkTelegramAccess() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Telegram Web App API
            if (typeof Telegram === 'undefined' || !Telegram.WebApp || !Telegram.WebApp.initData) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
                document.getElementById('accessDenied').classList.add('active');
                document.getElementById('mapContainer').style.display = 'none';
                return false;
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å initData
            const initData = Telegram.WebApp.initData;
            if (!initData || initData.length < 10) {
                document.getElementById('accessDenied').classList.add('active');
                document.getElementById('mapContainer').style.display = 'none';
                return false;
            }
            
            // –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            document.getElementById('accessDenied').classList.remove('active');
            document.getElementById('mapContainer').style.display = 'block';
            return true;
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (!checkTelegramAccess()) {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
            throw new Error('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram');
        }

        // ============================================
        // –û–°–ù–û–í–ù–û–ô –ö–û–î –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // ============================================
        
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const SUPABASE_URL = 'https://yvgahtwrvnylzzabewje.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2Z2FodHdydm55bHp6YWJld2plIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg4NTcwODksImV4cCI6MjA1NDQzMzA4OX0.4qDOCjrWVbLRCYU3nwSPOk_xfvw5cD1yWIXs-UjMDRQ';
        const _sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let uid = tg.initDataUnsafe?.user?.id || Math.floor(Math.random()*1000000);
        let userName = tg.initDataUnsafe?.user?.first_name || '–ê–Ω–æ–Ω–∏–º';
        let myMap, myPlacemark, selectedType = 'police', centerCoords = [55.753215, 37.622504], currentAddress = '';
        let markers = [];
        let openBalloons = [];
        let userMarkerCount = 0;
        let totalVotes = 0;
        let followMode = false;
        let userPositionMarker = null;
        let watchId = null;

        // ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤
        const ADMIN_IDS = [7127699071];
        const MODERATOR_IDS = [7127699071]; 
        const isAdmin = ADMIN_IDS.includes(uid);
        const isModerator = MODERATOR_IDS.includes(uid) || isAdmin;

        if (isAdmin) {
            document.getElementById('adminBtn').classList.add('visible');
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–≥–æ –º–æ–¥–µ—Ä–∏—Ä—É–µ–º
        let currentModeratingUserId = null;

        // –í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–∞–Ω–∞ (–≤ —á–∞—Å–∞—Ö)
        let selectedBanHours = 24;

        // –ß–∞—Ç
        let chatSubscription = null;
        let lastMessageId = 0;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–∞–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        async function checkIfBanned() {
            try {
                const userIdString = String(uid);
                const { data, error } = await _sb
                    .from('bans')
                    .select('*')
                    .eq('user_id', userIdString)
                    .maybeSingle();

                if (error && error.code !== 'PGRST116') {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–Ω–∞:', error);
                    return false;
                }

                if (data) {
                    const bannedUntil = new Date(data.banned_until);
                    const now = new Date();
                    
                    if (now < bannedUntil) {
                        const timeLeft = bannedUntil - now;
                        const hoursLeft = Math.ceil(timeLeft / (1000 * 60 * 60));
                        alert(`‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –¥–æ ${bannedUntil.toLocaleString('ru-RU')}.\n–û—Å—Ç–∞–ª–æ—Å—å –ø—Ä–∏–º–µ—Ä–Ω–æ ${hoursLeft} —á.`);
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –±–∞–Ω–∞:', error);
                return false;
            }
        }

        ymaps.ready(async function() {
            const isBanned = await checkIfBanned();
            if (isBanned) {
                document.getElementById('placeBtn').disabled = true;
                document.getElementById('placeBtn').textContent = 'üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã';
                document.getElementById('placeBtn').style.background = '#ff3b30';
            }

            myMap = new ymaps.Map('map', {
                center: centerCoords,
                zoom: 13,
                controls: []
            });

            myMap.events.add('actionend', updateAddress);
            myMap.events.add('click', function() {
                closeAllBalloons();
            });

            await refreshMarkers();
            loadUserStats();
            subscribeToMarkers();
            subscribeToChat();
        });

        async function updateAddress() {
            const c = myMap.getCenter();
            centerCoords = c;
            try {
                const res = await ymaps.geocode(c, { kind: 'house', results: 1 });
                const obj = res.geoObjects.get(0);
                currentAddress = obj ? obj.getAddressLine() : '–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω';
            } catch {
                currentAddress = '–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω';
            }
            document.getElementById('addressLabel').textContent = currentAddress;
        }

        function selectType(type) {
            selectedType = type;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.type-btn[data-type="${type}"]`).classList.add('active');
        }

        async function placeMarker() {
            const isBanned = await checkIfBanned();
            if (isBanned) {
                alert('‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —Ä–∞–∑–º–µ—â–∞—Ç—å –º–µ—Ç–∫–∏, —Ç–∞–∫ –∫–∞–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.');
                return;
            }

            const icon = { police: 'üëÆ', accident: 'üö®', roadwork: 'üöß' }[selectedType];
            const { error } = await _sb.from('markers').insert({
                lat: centerCoords[0],
                lng: centerCoords[1],
                type: selectedType,
                author: userName,
                author_id: String(uid),
                address: currentAddress
            });

            if (!error) {
                await refreshMarkers();
                await loadUserStats();
                alert(`${icon} –ú–µ—Ç–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∞!`);
            } else {
                console.error(error);
                alert('–û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –º–µ—Ç–∫–∏');
            }
        }

        async function refreshMarkers() {
            try {
                const { data, error } = await _sb
                    .from('markers')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                myMap.geoObjects.removeAll();
                markers = data || [];

                let countPolice = 0, countAccident = 0, countRoadwork = 0;

                markers.forEach(m => {
                    const icon = { police: 'üëÆ', accident: 'üö®', roadwork: 'üöß' }[m.type] || 'üìç';
                    if (m.type === 'police') countPolice++;
                    if (m.type === 'accident') countAccident++;
                    if (m.type === 'roadwork') countRoadwork++;

                    const pm = new ymaps.Placemark([m.lat, m.lng], {}, {
                        iconLayout: 'default#image',
                        iconImageHref: `data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><text x="20" y="30" font-size="30" text-anchor="middle">${icon}</text></svg>`)}`,
                        iconImageSize: [40, 40],
                        iconImageOffset: [-20, -40]
                    });

                    pm.events.add('click', function(e) {
                        e.preventDefault();
                        closeAllBalloons();
                        openMarkerBalloon(m, pm);
                    });

                    myMap.geoObjects.add(pm);
                });

                document.getElementById('countPolice').textContent = countPolice;
                document.getElementById('countAccident').textContent = countAccident;
                document.getElementById('countRoadwork').textContent = countRoadwork;

                if (userPositionMarker) {
                    myMap.geoObjects.add(userPositionMarker);
                }

            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–æ–∫:', err);
            }
        }

        function openMarkerBalloon(m, pm) {
            const typeLabel = { police: '–ü–æ–ª–∏—Ü–∏—è', accident: '–î–¢–ü', roadwork: '–†–µ–º–æ–Ω—Ç' }[m.type];
            const icon = { police: 'üëÆ', accident: 'üö®', roadwork: 'üöß' }[m.type];
            const upvotes = m.upvotes || 0;
            const downvotes = m.downvotes || 0;

            let actionsHtml = `
                <div class="b-poll">
                    <button class="b-poll-btn" onclick="voteMarker(${m.id}, 'up')">üëç ${upvotes}</button>
                    <button class="b-poll-btn" onclick="voteMarker(${m.id}, 'down')">üëé ${downvotes}</button>
                </div>
            `;

            const canModerate = isModerator && String(m.author_id) !== String(uid);
            if (canModerate) {
                actionsHtml += `<button class="b-poll-btn" style="background: #ff9500; color: white; margin-top: 8px;" onclick="openModerationModal(${m.author_id}, '${m.author.replace(/'/g, "\\'")}')">üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ü–∏—è</button>`;
            }

            const canDelete = (String(m.author_id) === String(uid)) || isAdmin;
            if (canDelete) {
                actionsHtml += `<button class="b-del" onclick="deleteMarker(${m.id})">üóë –£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫—É</button>`;
            }

            const content = `
                <div class="b-cont">
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">${icon} ${typeLabel}</div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 10px;">üìç ${m.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
                    <div style="font-size: 11px; color: #999; margin-bottom: 4px;">üë§ ${m.author}</div>
                    <div style="font-size: 10px; color: #aaa;">${new Date(m.created_at).toLocaleString('ru-RU')}</div>
                    ${actionsHtml}
                </div>
            `;

            const balloon = new ymaps.Balloon(myMap);
            balloon.open(pm.geometry.getCoordinates(), content);
            openBalloons.push(balloon);
        }

        function closeAllBalloons() {
            openBalloons.forEach(b => b.close());
            openBalloons = [];
        }

        async function voteMarker(markerId, voteType) {
            const marker = markers.find(m => m.id === markerId);
            if (!marker) return;

            const newUpvotes = voteType === 'up' ? (marker.upvotes || 0) + 1 : (marker.upvotes || 0);
            const newDownvotes = voteType === 'down' ? (marker.downvotes || 0) + 1 : (marker.downvotes || 0);

            const { error } = await _sb.from('markers').update({
                upvotes: newUpvotes,
                downvotes: newDownvotes
            }).eq('id', markerId);

            if (!error) {
                await refreshMarkers();
            }
        }

        async function deleteMarker(markerId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–µ—Ç–∫—É?')) return;
            const { error } = await _sb.from('markers').delete().eq('id', markerId);
            if (!error) {
                await refreshMarkers();
                await loadUserStats();
            }
        }

        function subscribeToMarkers() {
            _sb.channel('public:markers')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'markers' }, () => {
                    refreshMarkers();
                })
                .subscribe();
        }

        async function loadUserStats() {
            const userIdString = String(uid);
            const { data: userMarkers, error: markerError } = await _sb
                .from('markers')
                .select('*')
                .eq('author_id', userIdString);

            if (!markerError && userMarkers) {
                userMarkerCount = userMarkers.length;
                totalVotes = userMarkers.reduce((sum, m) => sum + (m.upvotes || 0), 0);
                
                document.getElementById('profileMarkers').textContent = userMarkerCount;
                document.getElementById('profileVotes').textContent = `${totalVotes} üëç`;
            }
        }

        function toggleActionCard() {
            const card = document.getElementById('actionCard');
            const btn = document.getElementById('openActionBtn');
            const isHidden = card.classList.contains('hidden');
            
            if (isHidden) {
                card.classList.remove('hidden');
                btn.classList.remove('visible');
            } else {
                card.classList.add('hidden');
                btn.classList.add('visible');
            }
        }

        function openProfile() {
            document.getElementById('profileName').textContent = userName;
            document.getElementById('profileId').textContent = `ID: ${uid}`;
            document.getElementById('profileModal').classList.add('active');
        }

        function closeProfile() {
            document.getElementById('profileModal').classList.remove('active');
        }

        function centerOnUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const coords = [position.coords.latitude, position.coords.longitude];
                        myMap.setCenter(coords, 15, { duration: 500 });
                        
                        if (userPositionMarker) {
                            myMap.geoObjects.remove(userPositionMarker);
                        }
                        
                        userPositionMarker = new ymaps.Placemark(coords, {}, {
                            iconLayout: 'default#image',
                            iconImageHref: `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30"><circle cx="15" cy="15" r="10" fill="#007aff" stroke="white" stroke-width="3"/></svg>')}`,
                            iconImageSize: [30, 30],
                            iconImageOffset: [-15, -15]
                        });
                        
                        myMap.geoObjects.add(userPositionMarker);
                    },
                    (error) => {
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
                        console.error(error);
                    }
                );
            } else {
                alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
            }
        }

        function toggleFollow() {
            followMode = !followMode;
            const btn = document.getElementById('followBtn');
            
            if (followMode) {
                btn.classList.remove('inactive');
                btn.classList.add('active');
                startFollowingPosition();
            } else {
                btn.classList.remove('active');
                btn.classList.add('inactive');
                stopFollowingPosition();
            }
        }

        function startFollowingPosition() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const coords = [position.coords.latitude, position.coords.longitude];
                        myMap.setCenter(coords, myMap.getZoom());
                        
                        if (userPositionMarker) {
                            myMap.geoObjects.remove(userPositionMarker);
                        }
                        
                        userPositionMarker = new ymaps.Placemark(coords, {}, {
                            iconLayout: 'default#image',
                            iconImageHref: `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30"><circle cx="15" cy="15" r="10" fill="#007aff" stroke="white" stroke-width="3"/></svg>')}`,
                            iconImageSize: [30, 30],
                            iconImageOffset: [-15, -15]
                        });
                        
                        myMap.geoObjects.add(userPositionMarker);
                    },
                    (error) => {
                        console.error('–û—à–∏–±–∫–∞ —Å–ª–µ–∂–µ–Ω–∏—è –∑–∞ –ø–æ–∑–∏—Ü–∏–µ–π:', error);
                        followMode = false;
                        document.getElementById('followBtn').classList.remove('active');
                        document.getElementById('followBtn').classList.add('inactive');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }

        function stopFollowingPosition() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }

        async function openAdminPanel() {
            document.getElementById('adminModal').classList.add('active');
            await loadAdminStats();
            await loadAdminMarkers();
        }

        function closeAdminPanel() {
            document.getElementById('adminModal').classList.remove('active');
        }

        function switchAdminTab(tab) {
            document.getElementById('tabMarkers').classList.remove('active');
            document.getElementById('tabBans').classList.remove('active');
            document.getElementById('adminMarkersContent').style.display = 'none';
            document.getElementById('adminBansContent').style.display = 'none';

            document.getElementById('tabMarkers').style.borderBottom = '3px solid transparent';
            document.getElementById('tabBans').style.borderBottom = '3px solid transparent';
            document.getElementById('tabMarkers').style.color = 'var(--gray)';
            document.getElementById('tabBans').style.color = 'var(--gray)';

            if (tab === 'markers') {
                document.getElementById('tabMarkers').classList.add('active');
                document.getElementById('adminMarkersContent').style.display = 'block';
                document.getElementById('tabMarkers').style.borderBottom = '3px solid var(--blue)';
                document.getElementById('tabMarkers').style.color = '#000';
                loadAdminMarkers();
            } else if (tab === 'bans') {
                document.getElementById('tabBans').classList.add('active');
                document.getElementById('adminBansContent').style.display = 'block';
                document.getElementById('tabBans').style.borderBottom = '3px solid var(--blue)';
                document.getElementById('tabBans').style.color = '#000';
                loadAdminBans();
            }
        }

        async function loadAdminStats() {
            const { data: allMarkers } = await _sb.from('markers').select('*');
            const { data: allUsers } = await _sb.from('markers').select('author_id');
            
            const uniqueUsers = new Set((allUsers || []).map(u => u.author_id));
            
            document.getElementById('adminTotalMarkers').textContent = (allMarkers || []).length;
            document.getElementById('adminTotalUsers').textContent = uniqueUsers.size;
        }

        async function loadAdminMarkers() {
            const { data, error } = await _sb
                .from('markers')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);

            const tbody = document.getElementById('adminMarkersBody');
            
            if (error || !data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(m => `
                <tr>
                    <td>${m.id}</td>
                    <td>${m.author} (${m.author_id})</td>
                    <td>${{ police: 'üëÆ –ü–æ–ª–∏—Ü–∏—è', accident: 'üö® –î–¢–ü', roadwork: 'üöß –†–µ–º–æ–Ω—Ç' }[m.type]}</td>
                    <td>${new Date(m.created_at).toLocaleString('ru-RU')}</td>
                    <td>${m.upvotes || 0} / ${m.downvotes || 0}</td>
                    <td>
                        <button class="delete-btn" onclick="adminDeleteMarker(${m.id})">–£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadAdminBans() {
            const { data, error } = await _sb
                .from('bans')
                .select('*')
                .order('created_at', { ascending: false });

            const tbody = document.getElementById('adminBansBody');
            
            if (error || !data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–∞–Ω–æ–≤</td></tr>';
                return;
            }

            const now = new Date();
            tbody.innerHTML = data.map(b => {
                const bannedUntil = new Date(b.banned_until);
                const isActive = now < bannedUntil;
                const statusColor = isActive ? '#ff3b30' : '#34c759';
                const statusText = isActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ò—Å—Ç—ë–∫';
                
                return `
                <tr style="background: ${isActive ? '#fff5f5' : '#f5fff5'}">
                    <td>${b.user_id}</td>
                    <td>
                        ${b.ban_type === 'temp' ? '‚è∞ –í—Ä–µ–º–µ–Ω–Ω—ã–π' : 'üö´ –ü–µ—Ä–º–∞–Ω–µ–Ω—Ç'}
                        <br>
                        <span style="color: ${statusColor}; font-weight: bold; font-size: 10px;">${statusText}</span>
                    </td>
                    <td>${bannedUntil.toLocaleString('ru-RU')}</td>
                    <td>${b.banned_by}</td>
                    <td>${new Date(b.created_at).toLocaleString('ru-RU')}</td>
                    <td>
                        ${isActive ? `<button class="unban-btn" onclick="unbanUser('${b.user_id}')">–†–∞–∑–±–∞–Ω–∏—Ç—å</button>` : ''}
                    </td>
                </tr>
            `}).join('');
        }

        async function adminDeleteMarker(markerId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–µ—Ç–∫—É?')) return;
            const { error } = await _sb.from('markers').delete().eq('id', markerId);
            if (!error) {
                await loadAdminMarkers();
                await loadAdminStats();
                await refreshMarkers();
            }
        }

        // ============================================
        // –§–£–ù–ö–¶–ò–Ø –†–ê–ó–ë–ê–ù–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
        // ============================================
        
        async function unbanUser(userId) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}?`)) {
                return;
            }

            try {
                const { error } = await _sb
                    .from('bans')
                    .delete()
                    .eq('user_id', userId);

                if (error) {
                    throw error;
                }

                alert(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–±–∞–Ω–µ–Ω`);
                await loadAdminBans(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –±–∞–Ω–æ–≤
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–∞–Ω–µ:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Ä–∞–∑–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        }

        function openModerationModal(userId, userName) {
            currentModeratingUserId = userId;
            document.getElementById('modUserName').textContent = userName;
            document.getElementById('modUserId').textContent = `ID: ${userId}`;
            document.getElementById('moderatorModal').classList.add('active');
        }

        function closeModerationModal() {
            document.getElementById('moderatorModal').classList.remove('active');
            currentModeratingUserId = null;
        }

        function openBanDurationModal() {
            document.getElementById('moderatorModal').classList.remove('active');
            document.getElementById('banDurationModal').classList.add('active');
        }

        function closeBanDurationModal() {
            document.getElementById('banDurationModal').classList.remove('active');
            document.getElementById('moderatorModal').classList.add('active');
        }

        function selectBanDuration(hours) {
            selectedBanHours = hours;
            document.querySelectorAll('.ban-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`.ban-option[data-hours="${hours}"]`).classList.add('selected');
        }

        async function confirmTemporaryBan() {
            if (!currentModeratingUserId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏');
                return;
            }

            const userName = document.getElementById('modUserName').textContent;
            
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –Ω–∞ ${selectedBanHours} —á?`)) {
                return;
            }

            try {
                const bannedUntil = new Date(Date.now() + selectedBanHours * 60 * 60 * 1000).toISOString();
                const userIdString = String(currentModeratingUserId);
                const adminIdString = String(uid);

                const { data: existingBan, error: fetchError } = await _sb
                    .from('bans')
                    .select('*')
                    .eq('user_id', userIdString)
                    .maybeSingle();

                if (fetchError && fetchError.code !== 'PGRST116') {
                    throw fetchError;
                }

                if (existingBan) {
                    const { error } = await _sb
                        .from('bans')
                        .update({
                            banned_until: bannedUntil,
                            ban_type: 'temp',
                            banned_by: adminIdString,
                            updated_at: new Date().toISOString()
                        })
                        .eq('user_id', userIdString);

                    if (error) throw error;
                } else {
                    const { error } = await _sb
                        .from('bans')
                        .insert({
                            user_id: userIdString,
                            banned_until: bannedUntil,
                            ban_type: 'temp',
                            banned_by: adminIdString,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });

                    if (error) throw error;
                }

                alert(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${userName}" –∑–∞–±–∞–Ω–µ–Ω –Ω–∞ ${selectedBanHours} —á`);
                closeBanDurationModal();
                closeModerationModal();

                if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–µ—Ç–∫–∏ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–∞—Ä—Ç—ã?')) {
                    const { error: deleteError } = await _sb
                        .from('markers')
                        .delete()
                        .eq('author_id', userIdString);

                    if (deleteError) {
                        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫:', deleteError);
                    } else {
                        alert('‚úÖ –ú–µ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª–µ–Ω—ã');
                        await refreshMarkers();
                    }
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–∞–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                alert('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                document.getElementById('moderatorModal').classList.add('active');
            }
        }

        async function banUserPermanent() {
            if (!currentModeratingUserId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏');
                return;
            }

            const userName = document.getElementById('modUserName').textContent;
            
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ù–ê–í–°–ï–ì–î–ê –∑–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}"?`)) return;

            try {
                const bannedUntil = new Date('2099-12-31').toISOString();
                const userIdString = String(currentModeratingUserId);
                const adminIdString = String(uid);

                const { data: existingBan, error: fetchError } = await _sb
                    .from('bans')
                    .select('*')
                    .eq('user_id', userIdString)
                    .maybeSingle();

                if (fetchError && fetchError.code !== 'PGRST116') {
                    throw fetchError;
                }

                if (existingBan) {
                    const { error } = await _sb
                        .from('bans')
                        .update({
                            banned_until: bannedUntil,
                            ban_type: 'perm',
                            banned_by: adminIdString,
                            updated_at: new Date().toISOString()
                        })
                        .eq('user_id', userIdString);

                    if (error) throw error;
                } else {
                    const { error } = await _sb
                        .from('bans')
                        .insert({
                            user_id: userIdString,
                            banned_until: bannedUntil,
                            ban_type: 'perm',
                            banned_by: adminIdString,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });

                    if (error) throw error;
                }

                alert(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${userName}" –∑–∞–±–∞–Ω–µ–Ω –Ω–∞–≤—Å–µ–≥–¥–∞`);
                closeModerationModal();

                if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–µ—Ç–∫–∏ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–∞—Ä—Ç—ã?')) {
                    const { error: deleteError } = await _sb
                        .from('markers')
                        .delete()
                        .eq('author_id', userIdString);

                    if (deleteError) {
                        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫:', deleteError);
                    } else {
                        alert('‚úÖ –ú–µ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª–µ–Ω—ã');
                        await refreshMarkers();
                    }
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–∞–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –±–∞–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        }

        document.getElementById('moderatorModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModerationModal();
            }
        });

        document.getElementById('banDurationModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeBanDurationModal();
            }
        });

        // ============================================
        // –ß–ê–¢
        // ============================================

        function openChat() {
            document.getElementById('chatModal').classList.add('active');
            loadChatMessages();
            resetUnreadBadge();
        }

        function closeChat() {
            document.getElementById('chatModal').classList.remove('active');
        }

        async function loadChatMessages() {
            try {
                const { data, error } = await _sb
                    .from('chat_messages')
                    .select('*')
                    .order('created_at', { ascending: true })
                    .limit(100);

                if (error) throw error;

                const messagesContainer = document.getElementById('chatMessages');
                
                if (!data || data.length === 0) {
                    messagesContainer.innerHTML = '<div class="no-messages">–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</div>';
                    return;
                }

                messagesContainer.innerHTML = data.map(msg => {
                    const isOwn = String(msg.author_id) === String(uid);
                    const messageClass = isOwn ? 'own' : 'other';
                    const time = new Date(msg.created_at).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                    
                    return `
                        <div class="chat-message ${messageClass}">
                            ${!isOwn ? `<div class="message-author">${msg.author_name}</div>` : ''}
                            <div class="message-bubble">${escapeHtml(msg.message)}</div>
                            <div class="message-time">${time}</div>
                        </div>
                    `;
                }).join('');

                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                if (data.length > 0) {
                    lastMessageId = Math.max(...data.map(m => m.id));
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            const isBanned = await checkIfBanned();
            if (isBanned) {
                alert('‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è, —Ç–∞–∫ –∫–∞–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.');
                return;
            }

            try {
                const { error } = await _sb
                    .from('chat_messages')
                    .insert({
                        message: message,
                        author_name: userName,
                        author_id: String(uid),
                        created_at: new Date().toISOString()
                    });

                if (error) throw error;

                input.value = '';
                input.style.height = 'auto';
                await loadChatMessages();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
            }
        }

        function subscribeToChat() {
            chatSubscription = _sb
                .channel('public:chat_messages')
                .on('postgres_changes', { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'chat_messages' 
                }, (payload) => {
                    const isChatOpen = document.getElementById('chatModal').classList.contains('active');
                    
                    if (isChatOpen) {
                        loadChatMessages();
                    } else {
                        if (String(payload.new.author_id) !== String(uid)) {
                            incrementUnreadBadge();
                        }
                    }
                })
                .subscribe();
        }

        function incrementUnreadBadge() {
            const badge = document.getElementById('unreadBadge');
            const currentCount = parseInt(badge.textContent) || 0;
            badge.textContent = currentCount + 1;
            badge.classList.add('visible');
        }

        function resetUnreadBadge() {
            const badge = document.getElementById('unreadBadge');
            badge.textContent = '0';
            badge.classList.remove('visible');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        document.getElementById('chatInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });

        document.getElementById('chatModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeChat();
            }
        });
    </script>

    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–∏–∂–Ω–µ–≥–æ –≤–∏–¥–∂–µ—Ç–∞ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–æ–≥–¥–∞ –æ–Ω –∑–∞–∫—Ä—ã—Ç) -->
    <button id="openActionBtn" class="open-action-btn" onclick="toggleActionCard()">‚ñ≤</button>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#212121">
    <link rel="manifest" href="manifest.json">
    <title>EASY RIDE ‚Äî RELIABLE</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=7f7db9e2-0eff-47d4-98d3-59b326552ed7&lang=ru_RU"></script>
    <style>
        :root { --blue: #007aff; --bg: #f2f2f7; --gray: #8e8e93;
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --safe-area-inset-left: env(safe-area-inset-left);
            --safe-area-inset-right: env(safe-area-inset-right); }
        body, html { width: 100%; height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); overflow: hidden; }
        
        /* –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏–µ —Ç–∞–ø-—Ä–µ–∞–∫—Ü–∏–π */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        body, html {
            position: fixed;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* ============= –≠–ö–†–ê–ù –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø ============= */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        #splashScreen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        .splash-logo {
            width: 180px;
            height: 180px;
            margin-bottom: 30px;
            animation: logoFadeIn 0.8s ease-out, logoPulse 2s ease-in-out infinite 1s;
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.3));
        }
        
        .splash-greeting {
            color: white;
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
            animation: textFadeIn 1s ease-out 0.3s both;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .splash-username {
            color: rgba(255,255,255,0.9);
            font-size: 18px;
            font-weight: 500;
            text-align: center;
            animation: textFadeIn 1s ease-out 0.5s both;
            text-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .splash-loader {
            margin-top: 40px;
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes logoFadeIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        @keyframes logoPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        @keyframes textFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ============= –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –ë–ê–ù–ï ============= */
        .ban-notice { 
            display: none;
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.9); 
            z-index: 9999; 
            align-items: center; 
            justify-content: center;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        .ban-notice.active { display: flex; }
        
        .ban-notice-content { 
            background: white; 
            border-radius: 24px; 
            padding: 30px; 
            max-width: 400px; 
            width: 90%; 
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        
        .ban-notice-icon { 
            font-size: 64px; 
            margin-bottom: 20px; 
        }
        
        .ban-notice-title { 
            font-size: 24px; 
            font-weight: 800; 
            color: #ff3b30; 
            margin-bottom: 15px; 
        }
        
        .ban-notice-message { 
            font-size: 16px; 
            color: #333; 
            line-height: 1.5; 
            margin-bottom: 20px; 
        }
        
        .ban-notice-time { 
            font-size: 14px; 
            color: var(--gray); 
            margin-bottom: 25px; 
        }
        
        .unban-request-btn {
            width: 100%;
            background: var(--blue);
            color: white;
            border: none;
            border-radius: 14px;
            padding: 16px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .unban-request-btn:active { transform: scale(0.98); }
        
        .unban-request-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .unban-status {
            font-size: 13px;
            color: #34c759;
            margin-top: 10px;
            font-weight: 600;
        }
        #map { width: 100%; height: 100%; position: absolute; }
        .target {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            pointer-events: none;
            width: 30px;
            height: 30px;
            transition: visibility 0.2s, opacity 0.2s;
            visibility: visible;
            opacity: 1;
        }
        .target::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            border: 2px solid var(--blue);
            background: rgba(255,255,255,0.92);
            box-shadow: 0 4px 12px rgba(0,0,0,0.18);
        }
        .target::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff3b30;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 0 2px rgba(255,255,255,0.95);
        }
        .bottom-ui { position: absolute; bottom: calc(10px + var(--safe-area-inset-bottom)); left: 0; right: 0; z-index: 1000; padding: 0 8px; }
        .action-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(15px); border-radius: 24px; padding: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); position: relative; }
        .action-card.hidden { display: none; }
        .action-card-close { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray); padding: 4px 8px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s; }
        .action-card-close:active { background: #f0f0f5; color: #000; }
        .open-action-btn { position: fixed; bottom: calc(18px + var(--safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); width: 48px; height: 48px; border-radius: 50%; background: white; border: 2px solid var(--blue); z-index: 1600; display: none; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); cursor: pointer; }
        .open-action-btn.visible { display: flex; }
        .addr-label { font-size: 12px; color: #000; font-weight: 600; margin-bottom: 10px; display: block; text-align: center; }
        .type-selector { display: flex; justify-content: space-between; margin-bottom: 12px; gap: 6px; flex-wrap: wrap; }
        .type-btn { 
            border: none; background: none; cursor: pointer; display: flex; flex-direction: column; 
            align-items: center; gap: 6px; width: 31%; padding: 8px; border-radius: 14px; 
            transition: all 0.25s ease; position: relative;
        }
        .type-btn:active { transform: scale(0.95); }
        .icon-circle { 
            width: 54px; height: 54px; background: #f0f0f5; border-radius: 16px; display: flex; 
            align-items: center; justify-content: center; border: 3px solid transparent; 
            transition: all 0.25s ease; font-size: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .type-btn span { font-size: 11px; font-weight: 700; color: var(--gray); text-transform: uppercase; letter-spacing: 0.3px; }
        .type-btn:hover .icon-circle { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
        .type-btn.active { color: var(--blue); background: rgba(0, 122, 255, 0.08); }
        .type-btn.active .icon-circle { background: #fff; border-color: var(--blue); box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3); }
        .type-tabs { display: flex; gap: 6px; margin-bottom: 8px; }
        .type-tab-btn { flex: 1; border: 1px solid #d9d9df; background: #f5f5f9; color: #666; border-radius: 10px; padding: 8px 10px; font-size: 11px; font-weight: 800; cursor: pointer; }
        .type-tab-btn.active { background: #fff; color: var(--blue); border-color: var(--blue); }
        .type-group { display: none; width: 100%; gap: 6px; flex-wrap: wrap; }
        .type-group.active { display: flex; }
        .type-group-title { width: 100%; font-size: 11px; font-weight: 800; margin: 4px 0 2px 0; }
        .type-group-title.patrol { color: var(--blue); }
        .type-group-title.help { color: #34c759; }
        
        /* –°—á—ë—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–∫ */
        .markers-counter { font-size: 11px; color: var(--gray); margin-bottom: 10px; text-align: center; padding: 8px; background: #f9f9f9; border-radius: 10px; }
        .counter-item { display: inline-block; margin: 0 6px; }
        .counter-item span:first-child { font-weight: 700; color: var(--blue); }

        /* –ü–æ–≥–æ–¥–Ω—ã–π –≤–∏–¥–∂–µ—Ç (1 —Å—Ç—Ä–æ–∫–∞) */
        .weather-widget { font-size: 11px; color: var(--gray); margin-bottom: 10px; text-align: center; padding: 8px; background: #f9f9f9; border-radius: 10px; }
        .weather-widget .weather-warn { font-weight: 800; }
        .main-btn { width: 100%; background: var(--blue); color: white; border: none; border-radius: 16px; padding: 14px; font-size: 15px; font-weight: 800; cursor: pointer; }
        .b-cont { font-size: 14px; line-height: 1.4; min-width: 170px; }
        .b-poll { display: flex; gap: 8px; margin-top: 10px; }
        .b-poll-btn { flex: 1; border: none; border-radius: 8px; padding: 8px; cursor: pointer; background: #f0f0f5; font-weight: bold; }
        .b-del { color: #ff3b30; border: none; background: none; font-size: 11px; margin-top: 12px; width: 100%; cursor: pointer; font-weight: bold; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è –∏ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ */
        .profile-btn { position: absolute; top: calc(15px + var(--safe-area-inset-top)); right: calc(15px + var(--safe-area-inset-right)); z-index: 1500; width: 45px; height: 45px; border-radius: 50%; background: white; border: 2px solid var(--blue); cursor: pointer; font-size: 22px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .profile-btn:active { transform: scale(1.05); }
        /* –ö–Ω–æ–ø–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –±–∞–≥–µ */
        .feedback-btn { position: absolute; top: calc(15px + var(--safe-area-inset-top)); right: calc(70px + var(--safe-area-inset-right)); z-index: 1500; width: 45px; height: 45px; border-radius: 50%; background: white; border: 2px solid #dc3545; cursor: pointer; font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .feedback-btn:active { transform: scale(1.05); }
        /* –ö–Ω–æ–ø–∫–∞ "–ì–¥–µ —è" */
        .loc-btn { position: absolute; top: calc(15px + var(--safe-area-inset-top)); right: calc(125px + var(--safe-area-inset-right)); z-index: 1500; width: 45px; height: 45px; border-radius: 50%; background: white; border: 2px solid var(--blue); cursor: pointer; font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        .loc-btn:active { transform: scale(1.05); }
        .follow-toggle { position: absolute; top: calc(15px + var(--safe-area-inset-top)); right: calc(180px + var(--safe-area-inset-right)); z-index: 1500; width: 40px; height: 40px; border-radius: 50%; background: white; border: 2px solid #34c759; cursor: pointer; font-size: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        .follow-toggle.inactive { background: #fff; border-color: #ccc; color: #888; }
        .follow-toggle.active { background: #34c759; color: white; border-color: #34c759; }
        .follow-icon { display: inline-flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
        .follow-badge { position: absolute; bottom: -2px; right: -2px; width: 16px; height: 16px; border-radius: 50%; background: #111; color: #fff; font-size: 9px; font-weight: 800; display: flex; align-items: center; justify-content: center; border: 2px solid #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.25); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2500; overflow-y: auto; }
        .modal.active { display: block; }
        .modal-content { background: white; border-radius: 20px; margin: 20px; padding: 20px; max-width: 500px; margin-left: auto; margin-right: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: var(--gray); }
        
        /* –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å */
        .admin-btn { position: absolute; top: calc(15px + var(--safe-area-inset-top)); left: calc(15px + var(--safe-area-inset-left)); z-index: 1500; width: 45px; height: 45px; border-radius: 50%; background: #ff9500; border: 2px solid white; cursor: pointer; font-size: 22px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
        .admin-btn.visible { display: block; }
        .admin-btn:active { transform: scale(1.05); }
        
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .admin-table th, .admin-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; font-size: 12px; }
        .admin-table th { background: #f0f0f5; font-weight: 600; }
        .admin-table tr:hover { background: #f9f9f9; }
        
        .delete-btn { background: #ff3b30; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .delete-btn:active { background: #e63027; }
        
        .admin-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .admin-stat-card { background: #f0f0f5; border-radius: 12px; padding: 15px; text-align: center; }
        .admin-stat-card .value { font-size: 28px; font-weight: 800; color: var(--blue); }
        .admin-stat-card .label { font-size: 12px; color: var(--gray); margin-top: 5px; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Ä–∞–∑–±–∞–Ω */
        .filter-btn { transition: all 0.2s; }
        .filter-btn:active { transform: scale(0.95); }
        .filter-btn.active { opacity: 1; }
        .filter-btn:not(.active) { opacity: 0.6; }
        
        /* –ö–Ω–æ–ø–∫–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ */
        .moderation-section { margin-top: 20px; padding-top: 20px; border-top: 2px solid #f0f0f5; }
        .moderation-title { font-size: 14px; font-weight: 700; color: #333; margin-bottom: 12px; text-align: center; }
        .moderation-buttons { display: flex; gap: 10px; }
        .mod-btn { flex: 1; border: none; padding: 12px; border-radius: 12px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .mod-btn:active { transform: scale(0.95); }
        .mod-btn-temp { background: #ff9500; color: white; }
        .mod-btn-temp:hover { background: #e68600; }
        .mod-btn-perm { background: #ff3b30; color: white; }
        .mod-btn-perm:hover { background: #e63027; }
        .mod-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –±–∞–Ω–∞ */
        .ban-duration-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 3000; align-items: center; justify-content: center; }
        .ban-duration-modal.active { display: flex; }
        .ban-duration-content { background: white; border-radius: 20px; padding: 25px; max-width: 350px; width: 90%; }
        .ban-duration-title { font-size: 18px; font-weight: 700; margin-bottom: 15px; text-align: center; }
        .ban-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .ban-option { background: #f0f0f5; border: 2px solid transparent; padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; font-size: 13px; font-weight: 600; transition: all 0.2s; }
        .ban-option:hover { background: #e5e5ea; }
        .ban-option.selected { background: #fff; border-color: #ff9500; color: #ff9500; }
        .ban-option .duration { display: block; font-size: 16px; font-weight: 700; margin-bottom: 4px; }
        .ban-option .label { display: block; font-size: 11px; color: var(--gray); }
        .ban-actions { display: flex; gap: 10px; }
        .ban-confirm-btn, .ban-cancel-btn { flex: 1; border: none; padding: 12px; border-radius: 12px; font-size: 14px; font-weight: 700; cursor: pointer; }
        .ban-confirm-btn { background: #ff9500; color: white; }
        .ban-cancel-btn { background: #f0f0f5; color: #333; }
        
        /* –ß–∞—Ç */
        .chat-btn { position: absolute; bottom: calc(100px + var(--safe-area-inset-bottom)); right: calc(15px + var(--safe-area-inset-right)); z-index: 1500; width: 50px; height: 50px; border-radius: 50%; background: var(--blue); border: 2px solid white; cursor: pointer; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        .chat-btn:hover { transform: scale(1.05); }
        .chat-btn:active { transform: scale(0.95); }
        .fab-chat { bottom: calc(100px + var(--safe-area-inset-bottom)); }
        .fab-heatmap { bottom: calc(220px + var(--safe-area-inset-bottom)); }
        .fab-heatmap-patrol { bottom: calc(160px + var(--safe-area-inset-bottom)); }
        .fab-ptt { bottom: calc(130px + var(--safe-area-inset-bottom)); }
        .fab-notif { bottom: calc(280px + var(--safe-area-inset-bottom)); }
        .fab-activity { bottom: calc(340px + var(--safe-area-inset-bottom)); }
        @media (max-height: 760px) {
            .fab-heatmap { bottom: calc(205px + var(--safe-area-inset-bottom)); }
            .fab-heatmap-patrol { bottom: calc(150px + var(--safe-area-inset-bottom)); }
            .fab-ptt { bottom: calc(125px + var(--safe-area-inset-bottom)); }
            .fab-notif { bottom: calc(260px + var(--safe-area-inset-bottom)); }
            .fab-activity { bottom: calc(315px + var(--safe-area-inset-bottom)); }
        }
        .ptt-btn { background: #34c759; font-size: 20px; }
        .ptt-hold-btn {
            width: 100%;
            height: 68px;
            border-radius: 16px;
            border: none;
            background: #34c759;
            color: #fff;
            font-size: 16px;
            font-weight: 800;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
        }
        .ptt-hold-btn.disabled { background: #9ca3af; cursor: not-allowed; }
        .ptt-hold-btn.busy { background: #6b7280; cursor: not-allowed; }
        .ptt-status { font-size: 12px; color: #111; margin-top: 10px; text-align:center; }
        .ptt-sub { font-size: 11px; color: var(--gray); margin-top: 6px; text-align:center; }
        .ptt-actions { display:flex; gap:10px; margin-top: 12px; }
        .ptt-complain {
            flex: 1;
            height: 44px;
            border-radius: 12px;
            border: 1px solid #ddd;
            background: #fff;
            font-weight: 800;
            cursor: pointer;
        }
        .ptt-complain:disabled { opacity: 0.5; cursor: not-allowed; }
        .notif-btn { background: #5856d6; }
        .notif-badge { position: absolute; top: -4px; right: -4px; min-width: 18px; height: 18px; border-radius: 9px; background: #ff3b30; color: #fff; font-size: 10px; font-weight: 800; line-height: 18px; text-align: center; border: 2px solid #fff; display: none; padding: 0 4px; box-sizing: border-box; }
        .notif-toast-wrap { position: absolute; top: calc(58px + var(--safe-area-inset-top)); left: 50%; transform: translateX(-50%); z-index: 1900; width: min(92vw, 440px); pointer-events: none; }
        .notif-toast { background: rgba(17,17,17,0.95); color: #fff; border-radius: 12px; padding: 10px 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.25); font-size: 12px; margin-bottom: 8px; opacity: 0; transform: translateY(-8px); transition: all .2s ease; }
        .notif-toast.visible { opacity: 1; transform: translateY(0); }
        .notif-row { display: flex; gap: 10px; align-items: flex-start; padding: 10px; border: 1px solid #ececf1; border-radius: 12px; margin-bottom: 8px; background: #fff; cursor: pointer; }
        .notif-row.unread { border-color: #cfe1ff; background: #f7fbff; }
        .notif-icon { font-size: 20px; line-height: 1; }
        .notif-title { font-size: 13px; font-weight: 700; color: #111; }
        .notif-body { font-size: 12px; color: #555; margin-top: 2px; }
        .notif-time { font-size: 10px; color: #999; margin-top: 4px; }
        .heatmap-toggle-btn { background: #ff9f0a; font-size: 18px; }
        .heatmap-toggle-btn.active { background: #ff3b30; box-shadow: 0 0 0 3px rgba(255,59,48,0.18), 0 8px 22px rgba(255,59,48,0.28); }
        .activity-btn { background: #007aff; font-size: 18px; }
        #mapDimmingOverlay {
            position: absolute;
            inset: 0;
            z-index: 1200;
            pointer-events: none;
            background: rgba(28, 28, 30, 0.30);
            opacity: 0;
            transition: opacity .25s ease;
            backdrop-filter: grayscale(0.55) contrast(0.9);
        }
        #mapDimmingOverlay.active { opacity: 1; }
        
        .chat-messages { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; max-height: 400px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 12px; }
        .chat-message { padding: 10px 12px; border-radius: 10px; font-size: 13px; max-width: 80%; word-wrap: break-word; }
        .chat-message.own { background: var(--blue); color: white; margin-left: auto; }
        .chat-message.other { background: white; border: 1px solid #ddd; }
        .chat-message-author { font-size: 11px; font-weight: 600; margin-bottom: 3px; opacity: 0.8; }
        .chat-message-photo { max-width: 200px; border-radius: 8px; margin-top: 5px; cursor: pointer; }
        .chat-message-time { font-size: 10px; opacity: 0.7; margin-top: 3px; }
        
        .chat-input-group { display: flex; gap: 8px; }
        .chat-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; box-sizing: border-box; }
        .chat-send-btn { background: var(--blue); color: white; border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; }
        .chat-send-btn:hover { background: #0051d5; }
        
        .chat-photo-upload { position: relative; }
        .chat-photo-input { display: none; }
        .chat-photo-btn { background: #f0f0f5; color: var(--blue); border: none; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 16px; }
        .chat-photo-btn:hover { background: #e0e0e5; }
        
        /* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
        .chat-context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            min-width: 180px;
            padding: 8px 0;
        }
        .chat-context-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chat-context-menu-item:hover { background: #f0f0f5; }
        .chat-context-menu-item.delete { color: #ff3b30; }
        .chat-context-menu-item.report { color: #ff9500; }
        
        /* –ú–µ–Ω—é –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞ */
        .moderator-menu {
            animation: slideIn 0.15s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
        .registration-form input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; box-sizing: border-box; }
        .registration-form label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; color: #000; }
        .registration-form .form-group { margin-bottom: 15px; }
        
        /* –°—Ç–∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è */
        .profile-header { text-align: center; margin-bottom: 20px; }
        .profile-avatar { width: 80px; height: 80px; background: var(--blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 40px; margin: 0 auto 15px; }
        .profile-name { font-size: 20px; font-weight: 800; color: #000; margin-bottom: 5px; }
        .profile-name.trusted { color: #b8860b; text-shadow: 0 1px 0 rgba(0,0,0,0.15); }
        .profile-id { font-size: 12px; color: var(--gray); }
        
        /* –£—Ä–æ–≤–µ–Ω—å –≤–∑–∞–∏–º–æ–≤—ã—Ä—É—á–∫–∏ */
        .rating-card { background: linear-gradient(135deg, var(--blue), #5ac8fa); border-radius: 15px; padding: 15px; color: white; margin-bottom: 15px; }
        .rating-value { font-size: 36px; font-weight: 800; }
        .rating-label { font-size: 12px; opacity: 0.9; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-item { background: #f0f0f5; border-radius: 12px; padding: 12px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: 800; color: var(--blue); }
        .stat-label { font-size: 11px; color: var(--gray); margin-top: 5px; }
        
        /* –°—Ç–∏–ª–∏ –ª–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π */
        .activity-item { padding: 10px; border-bottom: 1px solid #e0e0e0; font-size: 12px; line-height: 1.4; }
        .activity-item:last-child { border-bottom: none; }
        .activity-time { font-size: 10px; color: var(--gray); margin-top: 4px; }
        .activity-icon { margin-right: 6px; }

        /* –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
        .activity-heatmap { background: #f9f9f9; border-radius: 14px; padding: 12px; border: 1px solid #e6e6ea; margin-bottom: 12px; }
        .heatmap-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 8px; }
        .heatmap-title { font-size: 13px; font-weight: 800; color: #111; }
        .heatmap-toggle { display: inline-flex; background: #fff; border-radius: 10px; border: 1px solid #e0e0e0; overflow: hidden; }
        .heatmap-toggle button { border: none; background: none; padding: 6px 10px; font-size: 11px; font-weight: 700; cursor: pointer; color: #666; }
        .heatmap-toggle button.active { background: var(--blue); color: #fff; }
        .heatmap-legend { display: flex; align-items: center; gap: 6px; font-size: 10px; color: #666; margin-bottom: 8px; }
        .heatmap-legend .chip { width: 14px; height: 14px; border-radius: 4px; background: #f0f0f5; border: 1px solid #e0e0e0; }
        .heatmap-scroll { overflow-x: auto; padding-bottom: 6px; }
        .heatmap-grid { display: grid; grid-template-columns: 40px repeat(24, 16px); gap: 4px; align-items: center; }
        .heatmap-cell { width: 16px; height: 16px; border-radius: 4px; background: #f0f0f5; border: 1px solid #e6e6ea; }
        .heatmap-label { font-size: 10px; color: #666; text-align: right; padding-right: 4px; white-space: nowrap; }
        .heatmap-hour { font-size: 9px; color: #888; text-align: center; }
        .heatmap-summary { font-size: 11px; color: #666; margin-top: 6px; text-align: right; }
        
        /* –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è */
        .achievement { display: inline-block; text-align: center; padding: 8px; margin: 4px; background: #f9f9f9; border-radius: 10px; border: 1px solid #e0e0e0; font-size: 11px; min-width: 70px; }
        .achievement-icon { font-size: 24px; margin-bottom: 4px; }
        .achievement-title { font-weight: 700; color: var(--blue); }
        .achievement-grid { display: flex; flex-wrap: wrap; gap: 6px; }
        .achievement-progress { font-size: 10px; color: var(--gray); margin-top: 2px; }
        .achievement.done { border-color: #34c759; background: #f2fff6; }
        .achievement.locked { opacity: 0.6; }

        /* –°–ø–∏–¥–æ–º–µ—Ç—Ä */
        .speedometer { position: absolute; left: 12px; bottom: calc(140px + var(--safe-area-inset-bottom)); z-index: 1600; background: rgba(255,255,255,0.95); border-radius: 16px; padding: 10px 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); display: none; align-items: center; gap: 10px; min-width: 120px; }
        .speedometer.visible { display: flex; }
        .speedometer-value { font-size: 22px; font-weight: 800; color: #000; line-height: 1; }
        .speedometer-unit { font-size: 11px; color: var(--gray); margin-left: 4px; font-weight: 700; }
        .speedometer-label { font-size: 10px; color: var(--gray); font-weight: 600; }
        .speedometer-toggle { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; border-radius: 50%; border: none; background: #ff3b30; color: white; font-size: 14px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .speedometer-open-btn { position: absolute; left: 12px; bottom: calc(140px + var(--safe-area-inset-bottom)); z-index: 1600; width: 40px; height: 40px; border-radius: 50%; background: white; border: 2px solid var(--blue); display: none; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); cursor: pointer; }
        .speedometer-open-btn.visible { display: flex; }

        /* –ê–¥–º–∏–Ω—Å–∫–∏–π –º–∞—Ä–∫–µ—Ä –∏ –∏–º—è */
        .admin-marker { background: #fff; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: 2px solid #d4af37; font-size: 18px; position: relative; box-shadow: 0 0 12px rgba(212, 175, 55, 0.55); }
        .admin-marker::before { content: ''; position: absolute; inset: -10px; border-radius: 50%; background: radial-gradient(circle, rgba(212,175,55,0.35) 0%, rgba(212,175,55,0.0) 70%); }
        .admin-marker::after { content: ''; position: absolute; inset: -6px; border-radius: 50%; border: 2px solid rgba(212, 175, 55, 0.5); animation: adminPulse 1.8s ease-out infinite; }
        .admin-marker--map { width: 34px; height: 34px; font-size: 18px; }
        .admin-marker--self { width: 36px; height: 36px; font-size: 19px; }
        .admin-marker-badge { position: absolute; top: -8px; right: -8px; font-size: 12px; }
        .admin-siren { position: absolute; top: -6px; width: 10px; height: 6px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.25); animation: adminSiren 1.2s ease-in-out infinite; }
        .admin-siren-left { left: -2px; background: #ff3b30; }
        .admin-siren-right { right: -2px; background: #007aff; animation-delay: 0.6s; }
        .admin-confirm { margin-top: 8px; padding: 6px 8px; border-radius: 8px; background: linear-gradient(135deg, #f5d76e 0%, #d4af37 100%); color: #111; font-size: 11px; font-weight: 800; text-align: center; }
        .admin-name { background: linear-gradient(90deg, #f5d76e 0%, #d4af37 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; color: transparent; font-weight: 800; }
        .admin-rank { font-size: 11px; color: #d4af37; font-weight: 800; text-transform: uppercase; letter-spacing: 0.4px; }
        .admin-online { display: inline-flex; align-items: center; gap: 6px; font-size: 11px; color: #34c759; font-weight: 700; }
        .admin-online-dot { width: 6px; height: 6px; border-radius: 50%; background: #34c759; box-shadow: 0 0 6px rgba(52, 199, 89, 0.9); }
        @keyframes adminPulse {
            0% { transform: scale(0.85); opacity: 0.8; }
            70% { transform: scale(1.2); opacity: 0; }
            100% { transform: scale(1.2); opacity: 0; }
        }
        @keyframes adminSiren {
            0%, 100% { opacity: 0.35; transform: scaleX(0.9); }
            50% { opacity: 1; transform: scaleX(1.1); }
        }

        /* –ë–∞–Ω–Ω–µ—Ä –∞–¥–º–∏–Ω-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        .broadcast-banner { position: fixed; top: calc(12px + var(--safe-area-inset-top)); left: 50%; transform: translateX(-50%); z-index: 3000; background: linear-gradient(135deg, #111 0%, #333 100%); color: #fff; padding: 12px 16px; border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); display: none; max-width: 90%; text-align: center; font-weight: 700; }
        .broadcast-banner.visible { display: block; }
        .proximity-banner { position: fixed; top: calc(52px + var(--safe-area-inset-top)); left: 50%; transform: translateX(-50%); z-index: 2500; background: #1c1c1e; color: #fff; padding: 10px 14px; border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.28); display: none; min-width: 220px; text-align: center; font-weight: 800; letter-spacing: 0.2px; }
        .proximity-banner.visible { display: block; }
        .proximity-banner--yellow { background: #ffd60a; color: #1a1a1a; }
        .proximity-banner--orange { background: #ff9f0a; color: #1a1a1a; }
        .proximity-banner--red { background: #ff3b30; color: #fff; }
        .proximity-banner--blink { animation: proximityBlink 0.8s ease-in-out infinite; }
        .proximity-banner-title { font-size: 12px; font-weight: 700; opacity: 0.9; }
        .proximity-banner-distance { font-size: 18px; font-weight: 900; margin-left: 6px; }
        @keyframes proximityBlink {
            0%, 100% { box-shadow: 0 10px 30px rgba(255,59,48,0.35); }
            50% { box-shadow: 0 0 0 6px rgba(255,59,48,0.28); }
        }
        
        /* Overlay –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ */
        #tgAuthOverlay {
            display: none !important;
        }
        
        #tgAuthOverlay[style*="display: flex"] {
            display: flex !important;
        }
    </style>
</head>
<body>
    <!-- ============= –≠–ö–†–ê–ù –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø ============= -->
    <div id="splashScreen">
        <img src="img/logo.png" alt="180 –°–∞—Ñ–µ–î—Ä–∞–π–≤" class="splash-logo">
        <div class="splash-greeting" id="greetingText">–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ</div>
        <div class="splash-username" id="usernameText">–í–æ–¥–∏—Ç–µ–ª—å...</div>
        <div class="splash-loader"></div>
    </div>

    <!-- ============= –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –ë–ê–ù–ï ============= -->
    <div id="banNotice" class="ban-notice">
        <div class="ban-notice-content">
            <div class="ban-notice-icon">üö´</div>
            <div class="ban-notice-title">–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</div>
            <div class="ban-notice-message" id="banMessage">–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</div>
            <div class="ban-notice-time" id="banTimeRemaining"></div>
            <button id="unbanRequestBtn" class="unban-request-btn" onclick="requestUnban()">
                üì® –ü–æ–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–∞–∑–±–∞–Ω
            </button>
            <div id="unbanStatus" class="unban-status" style="display: none;"></div>
        </div>
    </div>


    <div class="target" aria-hidden="true"></div>

    <!-- Overlay: –¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram -->
    <div id="tgAuthOverlay" class="auth-overlay" style="display:none; position:fixed; inset:0; z-index:99999; background:rgba(0,0,0,0.6); align-items:center; justify-content:center;">
        <div style="background:#fff; padding:40px 25px; border-radius:16px; max-width:420px; width:95%; text-align:center; box-shadow:0 10px 40px rgba(0,0,0,0.3); animation: slideUp 0.4s ease;">
            <div style="font-size:48px; margin-bottom:20px; animation: pulse 2s ease-in-out infinite;">üîê</div>
            <h2 style="margin:0 0 15px 0; font-size:24px; font-weight:800; color:#333;">–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h2>
            <p style="color:#666; font-size:16px; line-height:1.6; margin:0 0 25px 0;">
                –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑<br><strong>Telegram Mini App</strong>.
            </p>
            <p style="color:#888; font-size:14px; line-height:1.5; margin:0 0 30px 0;">
                –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ –≤ Telegram.
            </p>
            <div style="display:flex; flex-direction:column; gap:12px; justify-content:center;">
                <button onclick="openTelegramBot()" style="padding:14px 20px; border-radius:12px; border:none; background:linear-gradient(135deg, #007aff 0%, #0051d5 100%); color:#fff; font-weight:700; font-size:16px; cursor:pointer; transition:all 0.3s; box-shadow:0 4px 12px rgba(0,122,255,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,122,255,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,122,255,0.3)'">
                    üì± –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
                </button>
                <button onclick="location.reload()" style="padding:12px 20px; border-radius:12px; border:2px solid #ddd; background:#fff; color:#666; font-weight:600; font-size:15px; cursor:pointer; transition:all 0.3s;" onmouseover="this.style.borderColor='#bbb'; this.style.background='#f5f5f5'" onmouseout="this.style.borderColor='#ddd'; this.style.background='#fff'">
                    üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                </button>
            </div>
            <div style="margin-top:25px; padding:15px; background:#f0f7ff; border-radius:10px; border-left:4px solid #007aff;">
                <p style="margin:0; font-size:12px; color:#0051d5; line-height:1.5;">
                    üí° <strong>–°–æ–≤–µ—Ç:</strong> –ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ <strong>@DPSRADARDPR180bot</strong> –≤ Telegram –∏–ª–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –≤—ã—à–µ.
                </p>
            </div>
        </div>
    </div>
    <style>
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>

    <!-- ============= –≠–ö–†–ê–ù –í–í–û–î–ê –ö–û–î–ê –ó–ë–¢ –ü–†–ò–ì–õ–ê–®–ï–ù–ò–Ø ============= -->
    <div id="betaInviteOverlay" class="beta-invite-overlay" style="display:none; position:fixed; inset:0; z-index:99998; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; font-family:system-ui, -apple-system, sans-serif;">
        <div style="background:#fff; padding:40px 25px; border-radius:20px; max-width:450px; width:95%; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.4s ease;">
            <div style="font-size:64px; margin-bottom:20px; animation: pulse 2s ease-in-out infinite;">üéâ</div>
            <h2 style="margin:0 0 10px 0; font-size:28px; font-weight:800; color:#222;">–ó–∞–∫—Ä—ã—Ç–æ–µ –ë–µ—Ç–∞-–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
            <p style="color:#666; font-size:15px; line-height:1.6; margin:0 0 30px 0;">
                –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞<br>–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é EASY RIDE 180
            </p>
            
            <div style="display:flex; flex-direction:column; gap:15px; margin-bottom:25px;">
                <input id="betaInviteCode" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è..." style="padding:14px 16px; border:2px solid #e0e0e0; border-radius:12px; font-size:16px; font-weight:600; letter-spacing:2px; text-transform:uppercase; text-align:center; transition:all 0.3s; outline:none;" onfocus="this.style.borderColor='#007aff'; this.style.boxShadow='0 0 0 3px rgba(0,122,255,0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                
                <button onclick="verifyBetaCode()" style="padding:14px 20px; border-radius:12px; border:none; background:linear-gradient(135deg, #007aff 0%, #0051d5 100%); color:#fff; font-weight:700; font-size:16px; cursor:pointer; transition:all 0.3s; box-shadow:0 4px 12px rgba(0,122,255,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,122,255,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,122,255,0.3)'">
                    ‚úì –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥
                </button>
            </div>
            
            <div id="betaStatus" style="display:none; padding:12px; border-radius:10px; margin-bottom:20px; font-size:14px; font-weight:500;"></div>
            
            <div style="padding:15px; background:#f9f9f9; border-radius:12px; border:1px solid #e0e0e0;">
                <p style="margin:0; font-size:13px; color:#888; line-height:1.6;">
                    üí° –ö–æ–¥ –º–æ–≥ –±—ã—Ç—å –≤—ã—Å–ª–∞–Ω –≤–∞–º<br>–≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
                </p>
            </div>
        </div>
    </div>
    

    <!-- –û–Ω–ª–∞–π–Ω-—Å—á—ë—Ç—á–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div id="onlineCountBadge" style="position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 1600; background: white; padding: 6px 10px; border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); font-weight:700; display: none;">–û–Ω–ª–∞–π–Ω: ‚Äî</div>
    <div id="map"></div>
    <div id="mapDimmingOverlay"></div>

    <!-- –ë–∞–Ω–Ω–µ—Ä –∞–¥–º–∏–Ω-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div id="broadcastBanner" class="broadcast-banner"></div>
    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –±–∞–Ω–Ω–µ—Ä –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è -->
    <div id="proximityBanner" class="proximity-banner"></div>

    <!-- –°–ø–∏–¥–æ–º–µ—Ç—Ä -->
    <div id="speedometer" class="speedometer">
        <div>
            <div class="speedometer-value"><span id="speedValue">0</span><span class="speedometer-unit">–∫–º/—á</span></div>
            <div class="speedometer-label">–°–∫–æ—Ä–æ—Å—Ç—å</div>
        </div>
        <button class="speedometer-toggle" onclick="toggleSpeedometer(false)" title="–°–∫—Ä—ã—Ç—å">‚úï</button>
    </div>
    <button class="speedometer-open-btn" id="speedometerOpenBtn" onclick="toggleSpeedometer(true)" title="–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏–¥–æ–º–µ—Ç—Ä">üß≠</button>
    
    <!-- –ö–Ω–æ–ø–∫–∞ —á–∞—Ç–∞ -->
    <button class="chat-btn fab-chat" onclick="openChatModal()">üí¨</button>
    <!-- –ö–Ω–æ–ø–∫–∞ –†–∞—Ü–∏–∏ (Push-to-Talk) -->
    <button class="chat-btn ptt-btn fab-ptt" onclick="openPttModal()" title="–†–∞—Ü–∏—è: —É–¥–µ—Ä–∂–∏–≤–∞–π, —á—Ç–æ–±—ã –≥–æ–≤–æ—Ä–∏—Ç—å">üéôÔ∏è</button>
    <!-- –ö–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –î–ü–°/–°–ø–µ—Ü–±–∞—Ç -->
    <button class="chat-btn activity-btn fab-activity" onclick="openActivityModal('dpsSpecbatMonth')" title="–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –î–ü–° –∏ –°–ø–µ—Ü–±–∞—Ç –∑–∞ –º–µ—Å—è—Ü">üëÆüõ°Ô∏è</button>
    <!-- –ö–Ω–æ–ø–∫–∞ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã -->
    <button class="chat-btn heatmap-toggle-btn fab-heatmap" id="dtpHeatmapBtn" onclick="toggleDtpHeatmap()" title="–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –î–¢–ü">üóÇÔ∏èüî•</button>
    <!-- –ó–æ—Ä–∫–∏–π –≥–ª–∞–∑: —Ç–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ "–∑–∞—Å–∞–¥" –î–ü–°/–°–ø–µ—Ü–±–∞—Ç -->
    <button class="chat-btn heatmap-toggle-btn fab-heatmap-patrol" id="patrolHeatmapBtn" onclick="togglePatrolHeatmap()" title="–ó–æ—Ä–∫–∏–π –≥–ª–∞–∑: –∑–∞—Å–∞–¥—ã –î–ü–°/–°–ø–µ—Ü–±–∞—Ç">üëÅÔ∏è</button>
    <!-- –ö–Ω–æ–ø–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <button class="chat-btn notif-btn fab-notif" onclick="openNotificationsDrawer()" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
        üîî
        <span id="notifUnreadBadge" class="notif-badge">0</span>
    </button>
    <div id="inAppNotifWrap" class="notif-toast-wrap"></div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ -->
    <div id="chatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">–û–±—â–∏–π —á–∞—Ç</h2>
                <button class="modal-close" onclick="closeChatModal()">‚úï</button>
            </div>

            
            <div class="chat-messages" id="chatMessages">
                <div style="text-align: center; color: var(--gray); padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
            </div>
            
            <div id="chatPhotoPreview" style="padding: 10px; display: none;"></div>
            
            <div class="chat-input-group">
                <input type="text" id="chatInput" class="chat-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="500">
                <div class="chat-photo-upload">
                    <input type="file" id="chatPhotoInput" class="chat-photo-input" accept="image/*">
                    <button class="chat-photo-btn" onclick="document.getElementById('chatPhotoInput').click()">üì∑</button>
                </div>
                <button class="chat-send-btn" onclick="sendChatMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –†–∞—Ü–∏–∏ (PTT) -->
    <div id="pttModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">üéôÔ∏è –†–∞—Ü–∏—è</h2>
                <button class="modal-close" onclick="closePttModal()">‚úï</button>
            </div>
            <button id="pttHoldBtn" class="ptt-hold-btn">–£–¥–µ—Ä–∂–∏–≤–∞–π, —á—Ç–æ–±—ã –≥–æ–≤–æ—Ä–∏—Ç—å</button>
            <div id="pttStatus" class="ptt-status">–ì–æ—Ç–æ–≤–æ.</div>
            <div id="pttSub" class="ptt-sub">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: 7 —Å–µ–∫. –¢–∞–π–º–∞—É—Ç –ø–æ—Å–ª–µ —Ä–µ–ø–ª–∏–∫–∏: 10 —Å–µ–∫.</div>
            <div class="ptt-actions">
                <button id="pttComplainBtn" class="ptt-complain" disabled>üö´ –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é —Ä–µ–ø–ª–∏–∫—É</button>
            </div>
        </div>
    </div>

    <!-- –®—Ç–æ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div id="notificationsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
                <button class="modal-close" onclick="closeNotificationsDrawer()">‚úï</button>
            </div>
            <div style="display:flex; gap:8px; margin-bottom:10px;">
                <button class="main-btn" style="flex:1; background:#34c759;" onclick="markAllNotificationsRead()">–ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ</button>
                <button class="main-btn" style="flex:1; background:#999;" onclick="clearAllNotifications()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            <div id="notificationsList" style="max-height: 460px; overflow-y: auto;">
                <div style="text-align:center; color: var(--gray); padding: 16px;">–ü–æ–∫–∞ –Ω–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
            </div>
        </div>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –∞–¥–º–∏–Ω–∞ -->
    <button class="admin-btn" id="adminBtn" onclick="openAdminModal()">‚öôÔ∏è</button>
    <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
    <button class="profile-btn" id="profileBtn" onclick="openProfileModal()" title="–ü—Ä–æ—Ñ–∏–ª—å">üë§</button>
    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞—Ä–µ–∫–∞–Ω–∏–π -->
    <button class="feedback-btn" id="feedbackBtn" onclick="openBugReportModal()" title="–°–æ–æ–±—â–∏—Ç—å –æ –±–∞–≥–µ">üêõ</button>
    <!-- –ö–Ω–æ–ø–∫–∞ '–ì–¥–µ —è' -->
    <button class="loc-btn" id="locBtn" onclick="centerOnMyLocation()" title="–ì–¥–µ —è">üìç</button>
    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Å–ª–µ–∂–µ–Ω–∏—è GPS -->
    <button class="follow-toggle" id="followToggleBtn" onclick="toggleFollow()" title="–ê–≤—Ç–æ—Å–ª–µ–∂–µ–Ω–∏–µ GPS">üîî</button>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞ –æ –±–∞–≥–µ -->
    <div id="bugReportModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 style="margin: 0;">üêõ –°–æ–æ–±—â–∏—Ç—å –æ –±–∞–≥–µ</h2>
                <button class="modal-close" onclick="closeBugReportModal()">‚úï</button>
            </div>
            
            <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                <p style="color: #666; margin-bottom: 20px;">–ü–æ–º–æ–≥–∏—Ç–µ –Ω–∞–º —É–ª—É—á—à–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –û–ø–∏—à–∏—Ç–µ –Ω–∞–π–¥–µ–Ω–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É:</p>
                
                <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                    <select id="bugCategory" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <option value="ui">üé® –ü—Ä–æ–±–ª–µ–º–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</option>
                        <option value="map">üó∫Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ –∫–∞—Ä—Ç—ã</option>
                        <option value="markers">üìç –ü—Ä–æ–±–ª–µ–º–∞ —Å –º–µ—Ç–∫–∞–º–∏</option>
                        <option value="chat">üí¨ –ü—Ä–æ–±–ª–µ–º–∞ —á–∞—Ç–∞</option>
                        <option value="crash">üí• –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–∏—Å–ª–æ</option>
                        <option value="performance">‚ö° –ü—Ä–æ–±–ª–µ–º–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</option>
                        <option value="other">‚ùì –î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>
                
                <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:</label>
                    <textarea id="bugDescription" 
                        style="width: 100%; min-height: 120px; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"
                        placeholder="–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ? –ö–æ–≥–¥–∞ –ø–æ—è–≤–∏–ª–∞—Å—å –ø—Ä–æ–±–ª–µ–º–∞? –ö–∞–∫–∏–µ —à–∞–≥–∏ –ø—Ä–∏–≤–µ–ª–∏ –∫ –æ—à–∏–±–∫–µ?"></textarea>
                </div>
                
                <!-- –ö–æ–Ω—Ç–∞–∫—Ç -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">–í–∞—à–µ –∏–º—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                    <input type="text" id="bugReporterName" 
                        style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;"
                        placeholder="–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?">
                </div>
                
                <!-- –ß–µ–∫-–ª–∏—Å—Ç -->
                <div style="background: #f0f7ff; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 13px;">
                    <label style="display: flex; align-items: center; margin-bottom: 8px;">
                        <input type="checkbox" id="bugReproducible" style="margin-right: 8px;">
                        <span>–Ø –º–æ–≥—É –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —ç—Ç—É –æ—à–∏–±–∫—É</span>
                    </label>
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" id="bugIncludeLogs" style="margin-right: 8px;">
                        <span>–í–∫–ª—é—á–∏—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</span>
                    </label>
                </div>
                
                <!-- –°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                <div id="bugReportStatus" style="display: none; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-weight: 500;"></div>
                
                <!-- –ö–Ω–æ–ø–∫–∏ -->
                <div style="display: flex; gap: 10px;">
                    <button onclick="submitBugReport()" style="flex: 1; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 15px;">
                        üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç
                    </button>
                    <button onclick="closeBugReportModal()" style="flex: 1; background: #f0f0f5; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 15px;">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
                <button class="modal-close" onclick="closeAdminModal()">‚úï</button>
            </div>
            
            <div class="admin-stats">
                <div class="admin-stat-card">
                    <div class="label">–í—Å–µ–≥–æ –≤–æ–¥–∏—Ç–µ–ª–µ–π</div>
                    <div class="value" id="admin-drivers-count">0</div>
                </div>
                <div class="admin-stat-card">
                    <div class="label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–∫</div>
                    <div class="value" id="admin-markers-count">0</div>
                </div>
            </div>
            
            <h3 style="margin-top: 20px; margin-bottom: 10px; font-size: 14px;">–°–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π</h3>
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <input type="text" id="driverSearchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ ID..." style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-size: 13px;">
                <button onclick="clearDriverSearch()" style="padding: 8px 12px; border: none; border-radius: 8px; background: #f0f0f5; cursor: pointer; font-size: 13px; font-weight: 600;">üîÑ –°–±—Ä–æ—Å</button>
            </div>
            <div style="overflow-x: auto; max-height: 300px; overflow-y: auto;">
                <table class="admin-table" id="admin-drivers-table">
                    <thead>
                        <tr>
                            <th>–ò–º—è</th>
                            <th>–ê–≤—Ç–æ</th>
                            <th>–ù–æ–º–µ—Ä</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody id="admin-drivers-body">
                        <tr><td colspan="5" style="text-align: center; color: var(--gray);">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <h3 style="margin-top: 20px; margin-bottom: 10px; font-size: 14px;">–ê–∫—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–∫–∏</h3>
            <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                <select id="markerTypeFilter" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 13px; cursor: pointer;">
                    <option value="">üìç –í—Å–µ —Å–æ–±—ã—Ç–∏—è</option>
                    <optgroup label="–î–æ—Ä–æ–∂–Ω—ã–π –ø–∞—Ç—Ä—É–ª—å">
                        <option value="dps">üëÆ –î–ü–° (–°—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
                        <option value="patrol">üöî –†–µ–π–¥</option>
                        <option value="specbat">üõ°Ô∏è –°–ø–µ—Ü–±–∞—Ç</option>
                        <option value="motobat">üèçÔ∏è –ú–æ—Ç–æ–±–∞—Ç</option>
                        <option value="cargo_control">üöõ –ì—Ä—É–∑–æ–≤–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å</option>
                    </optgroup>
                    <optgroup label="–í–∑–∞–∏–º–æ–ø–æ–º–æ—â—å">
                        <option value="sos">üÜò SOS / –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å</option>
                        <option value="dtp">üí• –î–¢–ü</option>
                        <option value="danger">‚ö†Ô∏è –û–ø–∞—Å–Ω–æ—Å—Ç—å</option>
                        <option value="traffic_jam">üöó –ü—Ä–æ–±–∫–∞ / –ó–∞—Ç–æ—Ä</option>
                    </optgroup>
                    <optgroup label="Legacy">
                        <option value="camera">üì∏ –ù–∞–±–ª—é–¥–µ–Ω–∏–µ (legacy)</option>
                        <option value="works">üõ£Ô∏è –†–∞–±–æ—Ç—ã (legacy)</option>
                    </optgroup>
                </select>
                <button onclick="clearMarkerFilter()" style="padding: 8px 12px; border: none; border-radius: 8px; background: #f0f0f5; cursor: pointer; font-size: 13px; font-weight: 600;">üîÑ –°–±—Ä–æ—Å</button>
            </div>
            <div style="overflow-x: auto; max-height: 300px; overflow-y: auto;">
                <table class="admin-table" id="admin-markers-table">
                    <thead>
                        <tr>
                            <th>–¢–∏–ø</th>
                            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                            <th>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</th>
                            <th>–°–ø–æ—Ä–Ω—ã–µ</th>
                            <th>Exp</th>
                            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody id="admin-markers-body">
                        <tr><td colspan="6" style="text-align: center; color: var(--gray);">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- ============= –°–ï–ö–¶–ò–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ó–ë–¢ –ö–û–î–ê–ú–ò ============= -->
            <div id="betaInvitesSection" style="margin-top: 30px; padding: 20px; background: #f0f7ff; border-radius: 12px; border: 2px solid #007aff;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; font-size: 18px; font-weight: 700;">üéâ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ó–ë–¢ –∫–æ–¥–∞–º–∏</h3>
                    <button onclick="refreshBetaCodes()" style="background: var(--blue); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>

                <!-- –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞ -->
                <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #e0e0e0;">
                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 700;">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥:</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="number" id="betaCodeCountInput" placeholder="–ö–æ–ª-–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π (1-100)" min="1" max="100" value="1" style="padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 200px; font-size: 14px;">
                        <input type="text" id="betaCodeDescInput" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" style="padding: 10px; border: 1px solid #ddd; border-radius: 8px; flex: 1; min-width: 200px; font-size: 14px;">
                        <button onclick="generateBetaCode()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 700; white-space: nowrap;">
                            ‚ú® –°–æ–∑–¥–∞—Ç—å –∫–æ–¥
                        </button>
                    </div>
                    <div id="betaCodeStatus" style="margin-top: 10px; display: none; padding: 10px; border-radius: 8px; font-size: 14px; font-weight: 500;"></div>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤ -->
                <div style="max-height: 250px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead style="background: #007aff; color: white; font-weight: 700; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">–ö–æ–¥</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">–ú–∞–∫—Å. –∏—Å–ø.</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">–¢–µ–∫—É—â. –∏—Å–ø.</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">–ò—Ç–æ–≥–æ</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">–°—Ç–∞—Ç—É—Å</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">–î–µ–π—Å—Ç–≤–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody id="betaCodesTableBody">
                            <tr style="background: #f9f9f9;">
                                <td colspan="6" style="padding: 20px; text-align: center; color: #888;">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ============= –ú–ê–°–°–û–í–ê–Ø –í–´–î–ê–ß–ê –ê–ß–ò–í–û–ö (–ê–î–ú–ò–ù) ============= -->
            <div style="margin-top: 20px; padding: 16px; background: #fff; border-radius: 12px; border: 1px solid #e8e8e8;">
                <h4 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 700;">üè∑Ô∏è –ú–∞—Å—Å–æ–≤–∞—è –≤—ã–¥–∞—á–∞ –∞—á–∏–≤–∫–∏ `beta_tester`</h4>
                <div style="display:flex; gap:8px; margin-bottom:8px;">
                    <input id="bulkBetaIds" placeholder="–í–≤–µ–¥–∏—Ç–µ user_id —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ –ø—Ä–æ–±–µ–ª" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:8px; font-size:13px;">
                    <button onclick="grantBetaFromInput()" style="padding:8px 12px; background:#ff9500; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:700;">üéñÔ∏è –í—ã–¥–∞—Ç—å</button>
                </div>
                <div id="bulkBetaStatus" style="font-size:13px; color:#666; min-height:18px;"></div>
            </div>

            <!-- ============= –ó–∞–≥—Ä—É–∑–∫–∞ MP3 –æ–∑–≤—É—á–∫–∏ –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π ============= -->
            <div style="margin-top:20px; padding:16px; background:#fff8e6; border-radius:12px; border:1px solid #ffe0a3;">
                <h4 style="margin:0 0 8px 0; font-size:14px; font-weight:700;">üé§ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–µ–π –æ–∑–≤—É—á–∫–∏ (MP3)</h4>
                <div style="font-size:13px; color:#444; margin-bottom:10px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ 4 —Ñ–∞–π–ª–∞ –≤ bucket <strong>/audio/</strong> —Å —Ç–æ—á–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏:</div>
                <div style="font-size:12px; color:#666; margin-bottom:10px; line-height:1.5;">
                    ‚Ä¢ warning_standard_far.mp3<br>
                    ‚Ä¢ warning_standard_close.mp3<br>
                    ‚Ä¢ warning_cheeky_far.mp3<br>
                    ‚Ä¢ warning_cheeky_close.mp3
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:12px;">
                    <div>
                        <div style="font-size:12px; font-weight:700; margin-bottom:6px;">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (–¥–∞–ª–µ–∫–æ)</div>
                        <input type="file" id="audioStandardFar" accept="audio/mpeg,audio/mp3" style="width:100%;">
                    </div>
                    <div>
                        <div style="font-size:12px; font-weight:700; margin-bottom:6px;">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (–±–ª–∏–∑–∫–æ)</div>
                        <input type="file" id="audioStandardClose" accept="audio/mpeg,audio/mp3" style="width:100%;">
                    </div>
                    <div>
                        <div style="font-size:12px; font-weight:700; margin-bottom:6px;">–î–µ—Ä–∑–∫–∏–π (–¥–∞–ª–µ–∫–æ)</div>
                        <input type="file" id="audioCheekyFar" accept="audio/mpeg,audio/mp3" style="width:100%;">
                    </div>
                    <div>
                        <div style="font-size:12px; font-weight:700; margin-bottom:6px;">–î–µ—Ä–∑–∫–∏–π (–±–ª–∏–∑–∫–æ)</div>
                        <input type="file" id="audioCheekyClose" accept="audio/mpeg,audio/mp3" style="width:100%;">
                    </div>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
                    <button onclick="uploadCustomWarningAudios()" style="padding:10px 14px; background:#111; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:700;">‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã</button>
                    <button onclick="listAudioStorageFiles()" style="padding:10px 14px; background:#6f42c1; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:700;">üìÇ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Storage</button>
                </div>
                <div style="margin-top:8px;">
                    <div id="storageFilesList" style="max-height:140px; overflow:auto; border:1px dashed #e0e0e0; padding:8px; border-radius:8px; background:#fff;"></div>
                </div>
                <div id="warningAudioStatus" style="font-size:13px; color:#666; min-height:18px;"></div>
            </div>
            
            <!-- –í–∫–ª–∞–¥–∫–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞–º–∏ –Ω–∞ —Ä–∞–∑–±–∞–Ω -->
<div id="unbanRequestsSection" style="margin-top: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; font-size: 18px; font-weight: 700;">üì® –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ —Ä–∞–∑–±–∞–Ω</h3>
        <button onclick="refreshUnbanRequests()" style="background: var(--blue); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
        </button>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
        <div style="background: #fff3cd; border-radius: 12px; padding: 15px; text-align: center;">
            <div style="font-size: 24px; font-weight: 800; color: #ff9500;" id="pendingRequestsCount">0</div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">–û–∂–∏–¥–∞—é—Ç</div>
        </div>
        <div style="background: #d4edda; border-radius: 12px; padding: 15px; text-align: center;">
            <div style="font-size: 24px; font-weight: 800; color: #28a745;" id="approvedRequestsCount">0</div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">–û–¥–æ–±—Ä–µ–Ω–æ</div>
        </div>
        <div style="background: #f8d7da; border-radius: 12px; padding: 15px; text-align: center;">
            <div style="font-size: 24px; font-weight: 800; color: #dc3545;" id="rejectedRequestsCount">0</div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</div>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <button onclick="filterUnbanRequests('all')" id="filterAll" class="filter-btn active" style="flex: 1; padding: 10px; border: 2px solid var(--blue); background: var(--blue); color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">
            –í—Å–µ
        </button>
        <button onclick="filterUnbanRequests('pending')" id="filterPending" class="filter-btn" style="flex: 1; padding: 10px; border: 2px solid #ff9500; background: white; color: #ff9500; border-radius: 8px; cursor: pointer; font-weight: 600;">
            –û–∂–∏–¥–∞—é—Ç
        </button>
        <button onclick="filterUnbanRequests('approved')" id="filterApproved" class="filter-btn" style="flex: 1; padding: 10px; border: 2px solid #28a745; background: white; color: #28a745; border-radius: 8px; cursor: pointer; font-weight: 600;">
            –û–¥–æ–±—Ä–µ–Ω–æ
        </button>
        <button onclick="filterUnbanRequests('rejected')" id="filterRejected" class="filter-btn" style="flex: 1; padding: 10px; border: 2px solid #dc3545; background: white; color: #dc3545; border-radius: 8px; cursor: pointer; font-weight: 600;">
            –û—Ç–∫–ª–æ–Ω–µ–Ω–æ
        </button>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ -->
    <div style="overflow-x: auto;">
        <table class="admin-table" id="unbanRequestsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th>User ID</th>
                    <th>–î–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="unbanRequestsBody">
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    </div>

            <!-- ============= –°–ï–ö–¶–ò–Ø –ü–†–û–°–ú–û–¢–†–ê –û–¢–ß–ï–¢–û–í –û –ë–ê–ì–ê–• ============= -->
            <div id="bugReportsSection" style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 12px; border: 2px solid #ff9500;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; font-size: 18px; font-weight: 700;">üêõ –û—Ç—á–µ—Ç—ã –æ –±–∞–≥–∞—Ö</h3>
                    <button onclick="refreshBugReports()" style="background: var(--blue); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
                    <div style="background: white; border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 800; color: #ff9500;" id="newBugsCount">0</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">–ù–æ–≤—ã–µ</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 800; color: #007aff;" id="readBugsCount">0</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">–ü—Ä–æ—á–∏—Ç–∞–Ω–æ</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 800; color: #28a745;" id="resolvedBugsCount">0</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">–†–µ—à–µ–Ω—ã</div>
                    </div>
                </div>

                <!-- –¢–∞–±–ª–∏—Ü–∞ –æ—Ç—á–µ—Ç–æ–≤ -->
                <div style="max-height: 300px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead style="background: #ff9500; color: white; font-weight: 700; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">–û—Ç –∫–æ–≥–æ</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">–°—Ç–∞—Ç—É—Å</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">–î–∞—Ç–∞</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">–î–µ–π—Å—Ç–≤–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody id="bugReportsTableBody">
                            <tr style="background: white;">
                                <td colspan="6" style="padding: 20px; text-align: center; color: #888;">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- –†–∞–∑–¥–µ–ª –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ -->
            <div id="maintenanceSection" style="margin-top: 30px; padding: 20px; background: #e8d5ff; border-radius: 12px; border: 2px solid #9c27b0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; font-size: 18px; font-weight: 700;">‚öôÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</h3>
                    <div id="maintenanceStatus" style="background: #28a745; color: white; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 600;">–ö–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–∞</div>
                </div>

                <div style="background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                    <p style="margin: 0 0 15px 0; font-size: 14px; color: #333;">–ó–∞–∫—Ä–æ–π—Ç–µ –∫–∞—Ä—Ç—É –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–≤–∏–¥—è—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:</p>
                    <input type="text" id="maintenanceMessage" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–º–∞–∫—Å 100 —Å–∏–º–≤–æ–ª–æ–≤)" 
                           style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; margin-bottom: 15px; box-sizing: border-box;"
                           maxlength="100" value="‚ö†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ. –ü—Ä–∏–Ω–æ—Å–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è.">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button onclick="enableMaintenance()" style="background: var(--red); color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        üî¥ –ó–∞–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É –Ω–∞ –¢–û
                    </button>
                    <button onclick="disableMaintenance()" style="background: #28a745; color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        üü¢ –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É
                    </button>
                </div>
            </div>

            <!-- –ê–¥–º–∏–Ω: –º–∞—Å—Å–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ —Ä–µ–∂–∏–º –Ω–µ–≤–∏–¥–∏–º–∫–∏ -->
            <div id="adminBroadcastSection" style="margin-top: 30px; padding: 20px; background: #fff; border-radius: 12px; border: 2px solid #d4af37;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; font-size: 18px; font-weight: 700;">üëë –ê–¥–º–∏–Ω-—Ü–µ–Ω—Ç—Ä</h3>
                    <div class="admin-rank">Admin SafeDrive</div>
                </div>
                <div style="font-size: 13px; color: #666; margin-bottom: 10px;">–ú–∞—Å—Å–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</div>
                <textarea id="adminBroadcastText" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–Ω–∏–º–∞–Ω–∏–µ! –û—á–µ—Ä–µ–¥—å –Ω–∞ –ö–ü–ü –≤—ã—Ä–æ—Å–ª–∞ –¥–æ 5 —á–∞—Å–æ–≤!" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 13px; box-sizing: border-box; margin-bottom: 10px;"></textarea>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="sendAdminBroadcast(false)" style="flex: 1; background: #111; color: #fff; border: none; padding: 10px 12px; border-radius: 8px; font-weight: 700; cursor: pointer;">üì£ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
                    <button onclick="sendAdminBroadcast(true)" style="flex: 1; background: #ff9500; color: #fff; border: none; padding: 10px 12px; border-radius: 8px; font-weight: 700; cursor: pointer;">üîä –¢–µ–∫—Å—Ç + —Å–∏–≥–Ω–∞–ª</button>
                </div>
                <div id="adminBroadcastStatus" style="margin-top: 8px; font-size: 12px; color: #666; min-height: 16px;"></div>
                <div style="margin-top: 15px; padding-top: 12px; border-top: 1px dashed #e0e0e0; display: flex; align-items: center; justify-content: space-between; gap: 10px;">
                    <div style="font-size: 13px; font-weight: 700;">üïµÔ∏è –†–µ–∂–∏–º –Ω–µ–≤–∏–¥–∏–º–∫–∏</div>
                    <button id="adminInvisibleToggle" onclick="toggleAdminInvisible()" style="background: #f0f0f5; color: #333; border: none; padding: 8px 12px; border-radius: 8px; font-weight: 700; cursor: pointer;">–í–´–ö–õ</button>
                </div>
            </div>
    
    <button class="main-btn" onclick="closeAdminModal()" style="margin-top: 20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ -->
<div id="reviewUnbanModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üîç –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Ä–∞–∑–±–∞–Ω</h3>
            <button class="modal-close" onclick="closeReviewUnbanModal()">√ó</button>
        </div>

        <div id="reviewUnbanContent">
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–ø—Ä–æ—Å–µ -->
            <div style="background: #f0f0f5; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <div style="margin-bottom: 10px;">
                    <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> <span id="reviewUsername">-</span>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>User ID:</strong> <span id="reviewUserId">-</span>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>–î–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞:</strong> <span id="reviewCreatedAt">-</span>
                </div>
                <div>
                    <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–Ω–µ:</strong> <span id="reviewBanInfo">-</span>
                </div>
            </div>

            <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞:</label>
                <textarea id="reviewComment" 
                    style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"
                    placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —Ä–µ—à–µ–Ω–∏—è..."></textarea>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div style="display: flex; gap: 10px;">
                <button onclick="approveUnbanRequest()" 
                    style="flex: 1; background: #28a745; color: white; border: none; padding: 14px; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer;">
                    ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å –∏ —Å–Ω—è—Ç—å –±–∞–Ω
                </button>
                <button onclick="rejectUnbanRequest()" 
                    style="flex: 1; background: #dc3545; color: white; border: none; padding: 14px; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer;">
                    ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å
                </button>
            </div>
        </div>
    </div>
</div>
    
    <!-- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∞–≤–∏–ª –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ -->
    <div id="rulesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">–ü—Ä–∞–≤–∏–ª–∞</h2>
            </div>
            <div style="line-height: 1.5; color: #333; font-size: 14px;">
                <p style="margin-top: 0;"><strong>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Safe Drive 180!</strong></p>
                <p>–ü–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —á—Ç–æ –≤—ã —Å–æ–≥–ª–∞—Å–Ω—ã —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏:</p>
                <p style="margin: 8px 0;">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±–º–µ–Ω–∞ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–æ—Ä–æ–∂–Ω–æ–π –æ–±—Å—Ç–∞–Ω–æ–≤–∫–µ (–ø–æ–º–æ—â—å, –æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –î–¢–ü, —Ä–∞–±–æ—Ç—ã).</p>
                <p style="margin: 8px 0;">–ó–∞–ø—Ä–µ—â–µ–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –ª—é–±–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é —Ä–µ–≥–∏–æ–Ω–∞ –∏–ª–∏ –≤–æ–µ–Ω–Ω—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏.</p>
                <p style="margin: 8px 0;">–í—ã –Ω–µ—Å–µ—Ç–µ –ª–∏—á–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ü–î–î.</p>
                <p style="margin: 8px 0 16px 0;">–ù–∞–∂–∏–º–∞—è ¬´–ü—Ä–∏–Ω–∏–º–∞—é¬ª, –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ, —á—Ç–æ –±—É–¥–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å —Ç–æ–ª—å–∫–æ –≤ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏—Ö —Ü–µ–ª—è—Ö –¥–ª—è –ø–æ–º–æ—â–∏ –¥—Ä—É–≥–∏–º –≤–æ–¥–∏—Ç–µ–ª—è–º.</p>
                <p style="margin: 8px 0 0 0;"><strong>–¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞:</strong> —Å–Ω–∏–∂–µ–Ω–∏–µ –∞–≤–∞—Ä–∏–π–Ω–æ—Å—Ç–∏ –∏ –≤–∑–∞–∏–º–æ–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≥—Ä–∞–∂–¥–∞–Ω –≤ —Å–ª–æ–∂–Ω—ã—Ö –¥–æ—Ä–æ–∂–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö.</p>
            </div>
            <button id="rulesAcceptBtn" class="main-btn" style="margin-top: 10px;">–ü–†–ò–ù–ò–ú–ê–Æ –ò –°–û–ì–õ–ê–°–ï–ù</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –æ–± –∞–≤—Ç–æ) -->
    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">–ó–∞–≤–µ—Ä—à–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</h2>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <div class="profile-avatar">üë§</div>
                <div class="profile-name" id="reg-user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <form class="registration-form" onsubmit="registerDriver(event)">
                <div class="form-group">
                    <label>–ú–∞—Ä–∫–∞/–ú–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è:</label>
                    <input type="text" id="driver-car" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Toyota Camry">
                </div>
                <div class="form-group">
                    <label>–ù–æ–º–µ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                    <input type="text" id="driver-plate" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: A123BC 77">
                </div>
                <button type="submit" class="main-btn" style="margin-top: 15px;">–ó–ê–í–ï–†–®–ò–¢–¨</button>
            </form>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
                <button class="modal-close" onclick="closeProfileModal()">‚úï</button>
            </div>
            <div class="profile-header">
                <div class="profile-avatar" id="profile-avatar-display" onclick="changeAvatar()" style="cursor: pointer; position: relative;" title="–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å">üë§</div>
                <input type="hidden" id="profile-avatar-value" value="üë§">
                <input type="hidden" id="profile-avatar-url" value="">
                <button class="main-btn" onclick="document.getElementById('profile-photo-input').click()" style="margin-top: 10px; font-size: 12px; padding: 8px; background: #34c759;">üì∏ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –∞–≤–∞—Ç–∞—Ä–∞</button>
                <input type="file" id="profile-photo-input" style="display: none;" accept="image/*">
                <div class="profile-name" id="profile-name-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div id="profile-admin-badges" style="display: none; margin-top: 6px; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <div class="admin-rank" id="profile-admin-rank">Admin SafeDrive</div>
                    <div class="admin-online"><span class="admin-online-dot"></span><span id="profile-admin-online">–ù–∞ —Å–≤—è–∑–∏</span></div>
                </div>
                <div style="margin-top: 15px; border: 1px solid #ddd; border-radius: 10px; padding: 10px; background: #f9f9f9;">
                    <div class="form-group">
                        <label style="font-size: 12px; color: var(--gray);">–ú–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è:</label>
                        <input type="text" id="edit-car-model" placeholder="Toyota Camry" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px;">
                    </div>
                    <div class="form-group">
                        <label style="font-size: 12px; color: var(--gray);">–ù–æ–º–µ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª—è:</label>
                        <input type="text" id="edit-car-plate" placeholder="A123BC 77" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px;">
                    </div>
                    <button class="main-btn" onclick="saveProfileChanges()" style="font-size: 13px; padding: 10px; margin-top: 10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </div>
            </div>
            
            <div class="rating-card">
                <div class="rating-label">–í–∞—à —É—Ä–æ–≤–µ–Ω—å –≤–∑–∞–∏–º–æ–≤—ã—Ä—É—á–∫–∏</div>
                <div class="rating-value" id="profile-rating">0</div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="profile-marks-count">0</div>
                    <div class="stat-label">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ—Ç–æ–∫</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="profile-votes-sum">0</div>
                    <div class="stat-label">–û—á–∫–æ–≤ –∫–∞—Ä–º—ã</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="profile-likes">0</div>
                    <div class="stat-label">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="profile-dislikes">0</div>
                    <div class="stat-label">–°–ø–æ—Ä–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤</div>
                </div>
            </div>
            
            <div style="background: #f9f9f9; border-radius: 12px; padding: 12px; margin-bottom: 15px; text-align: center;">
                <div style="font-size: 12px; color: var(--gray); margin-bottom: 5px;">–°—Ç–∞—Ç—É—Å</div>
                <div id="profile-trust-status" style="font-size: 16px; font-weight: 800; color: var(--blue);">üéØ –û–±—ã—á–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å</div>
            </div>
            
            <button class="main-btn" onclick="openRatingsModal()" style="margin-bottom: 10px; background: #34c759;">–ì–õ–û–ë–ê–õ–¨–ù–´–ô –£–†–û–í–ï–ù–¨ –í–ó–ê–ò–ú–û–í–´–†–£–ß–ö–ò</button>
            
            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∑–≤—É—á–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
            <div style="background: #f0f0f5; border-radius: 12px; padding: 12px; margin-bottom: 15px;">
                <div style="font-size: 13px; font-weight: 700; color: #000; margin-bottom: 10px;">üîä –°—Ç–∏–ª—å –æ–∑–≤—É—á–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="setVoiceStyle('standard')" id="voiceStyleStandard" class="main-btn" style="flex: 1; background: #34c759; padding: 10px; font-size: 12px; border-radius: 8px;">
                        üì¢ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π
                    </button>
                    <button onclick="setVoiceStyle('cheeky')" id="voiceStyleCheeky" class="main-btn" style="flex: 1; background: #9c9c9c; padding: 10px; font-size: 12px; border-radius: 8px;">
                        üòé –î–µ—Ä–∑–∫–∏–π
                    </button>
                </div>
                <div style="font-size: 11px; color: var(--gray); margin-top: 8px; text-align: center;">
                    <span id="voiceStyleDescription">–í—ã–±—Ä–∞–Ω: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å—Ç–∏–ª—å</span>
                </div>
            </div>

            <div style="background: #f0f0f5; border-radius: 12px; padding: 12px; margin-bottom: 15px;">
                <div style="font-size: 13px; font-weight: 700; color: #000; margin-bottom: 10px;">üó£Ô∏è –ì–æ–ª–æ—Å–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                <label style="display:flex; align-items:center; justify-content:space-between; gap:10px; font-size: 12px; font-weight:700; color:#111;">
                    <span>–í–∫–ª—é—á–∏—Ç—å –æ–∑–≤—É—á–∫—É</span>
                    <input id="voice-enable" type="checkbox" style="width:22px; height:22px;">
                </label>
                <div style="font-size: 11px; color: var(--gray); margin-top: 8px; text-align: center;">
                    –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–π —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏. –í —Ñ–æ–Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç Android/WebView.
                </div>
            </div>

            <div style="background: #f0f0f5; border-radius: 12px; padding: 12px; margin-bottom: 15px;">
                <div style="font-size: 13px; font-weight: 700; color: #000; margin-bottom: 10px;">üìç –û–ø–æ–≤–µ—â–µ–Ω–∏—è –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é</div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="setProximityMode(false)" id="proximityModeAlways" class="main-btn" style="flex: 1; background: #34c759; padding: 10px; font-size: 12px; border-radius: 8px;">
                        –í—Å–µ–≥–¥–∞
                    </button>
                    <button onclick="setProximityMode(true)" id="proximityModeFollow" class="main-btn" style="flex: 1; background: #9c9c9c; padding: 10px; font-size: 12px; border-radius: 8px;">
                        –¢–æ–ª—å–∫–æ –ø—Ä–∏ –∞–≤—Ç–æ—Å–ª–µ–∂–µ–Ω–∏–∏
                    </button>
                </div>
                <div style="font-size: 11px; color: var(--gray); margin-top: 8px; text-align: center;">
                    <span id="proximityModeDescription">–í—ã–±—Ä–∞–Ω: –í—Å–µ–≥–¥–∞</span>
                </div>
            </div>

            <div style="background: #f0f0f5; border-radius: 12px; padding: 12px; margin-bottom: 15px;">
                <div style="font-size: 13px; font-weight: 700; color: #000; margin-bottom: 8px;">üß≠ –î–∏—Å—Ç–∞–Ω—Ü–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</div>
                <div style="font-size: 11px; color: var(--gray); margin-bottom: 8px; text-align: center;">
                    <span id="warningDistanceLabel">800 –º</span>
                </div>
                <input id="warningDistanceRange" type="range" min="300" max="2000" step="100" value="800"
                    oninput="setWarningDistance(this.value)"
                    style="width: 100%;">
                <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--gray); margin-top: 6px;">
                    <span>300 –º</span><span>2.0 –∫–º</span>
                </div>
            </div>
            
            <button class="main-btn" onclick="logout()">–í–´–ô–¢–ò</button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞ -->
    <div id="avatarEditorModal" class="modal">
        <div class="modal-content" style="width: 90%; max-width: 400px;">
            <div class="modal-header">
                <h2 style="margin: 0;">–†–µ–¥–∞–∫—Ç–æ—Ä –∞–≤–∞—Ç–∞—Ä–∞</h2>
                <button class="modal-close" onclick="closeAvatarEditor()">‚úï</button>
            </div>
            <div style="text-align: center; padding: 20px;">
                <!-- –ö—Ä—É–≥–ª—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
                <div style="position: relative; width: 200px; height: 200px; margin: 0 auto 20px; border-radius: 50%; overflow: hidden; border: 2px solid var(--blue); background: #f0f0f0;">
                    <img id="avatarEditorImage" style="position: absolute; width: 100%; height: 100%; object-fit: cover; cursor: grab;" alt="Avatar">
                </div>
                
                <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <div style="padding: 0 10px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; text-align: left; font-size: 12px; color: var(--gray); margin-bottom: 5px;">–ú–∞—Å—à—Ç–∞–± (–∑—É–º):</label>
                        <input type="range" id="avatarZoom" min="1" max="3" step="0.1" value="1" style="width: 100%; cursor: pointer;">
                        <div style="font-size: 11px; color: var(--gray); text-align: right;">
                            <span id="avatarZoomValue">100</span>%
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; text-align: left; font-size: 12px; color: var(--gray); margin-bottom: 5px;">–°–º–µ—â–µ–Ω–∏–µ –ø–æ X:</label>
                        <input type="range" id="avatarOffsetX" min="-50" max="50" value="0" style="width: 100%; cursor: pointer;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; text-align: left; font-size: 12px; color: var(--gray); margin-bottom: 5px;">–°–º–µ—â–µ–Ω–∏–µ –ø–æ Y:</label>
                        <input type="range" id="avatarOffsetY" min="-50" max="50" value="0" style="width: 100%; cursor: pointer;">
                    </div>
                    
                    <button class="main-btn" onclick="saveAvatarEdit()" style="width: 100%; margin-bottom: 10px;">‚úÖ –°–û–•–†–ê–ù–ò–¢–¨</button>
                    <button class="main-btn" onclick="closeAvatarEditor()" style="width: 100%; background: #999;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ –≤ –ø–æ–ª–Ω—ã–π —Ä–∞–∑–º–µ—Ä -->
    <input type="hidden" id="photoUrl" value="">
    <div id="photoViewerModal" class="modal" onclick="closePhotoViewer()">
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="event.stopPropagation()">
            <div style="position: relative; max-width: 90vw; max-height: 90vh;">
                <button class="modal-close" onclick="closePhotoViewer()" style="position: absolute; top: -50px; right: 0; font-size: 30px;">‚úï</button>
                <button class="modal-close" onclick="deletePhotoFromChat()" style="position: absolute; top: -50px; right: 40px; font-size: 24px; background: #ff3b30; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 0;" title="–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ">üóëÔ∏è</button>
                <img id="photoViewerImage" src="" style="max-width: 100%; max-height: 90vh; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);" alt="Photo">
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –≤–∑–∞–∏–º–æ–≤—ã—Ä—É—á–∫–∏ -->
    <div id="ratingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">üèÜ –£—Ä–æ–≤–µ–Ω—å –≤–∑–∞–∏–º–æ–≤—ã—Ä—É—á–∫–∏</h2>
                <button class="modal-close" onclick="closeRatingsModal()">‚úï</button>
            </div>
            
            <div style="font-size: 12px; color: var(--gray); margin-bottom: 15px; text-align: center;">
                –£—á–∞—Å—Ç–Ω–∏–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –≤–∫–ª–∞–¥—É –≤ –≤–∑–∞–∏–º–æ–ø–æ–º–æ—â—å. üõü = –≤—ã—Ä—É—á–∞—Ç–æ—Ä (50+ –æ—á–∫–æ–≤)
            </div>
            
            <div style="max-height: 500px; overflow-y: auto;">
                <div id="ratingsList" style="text-align: center; color: var(--gray);">–ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–≤–Ω–µ–π –≤–∑–∞–∏–º–æ–≤—ã—Ä—É—á–∫–∏...</div>
            </div>
            
            <button class="main-btn" onclick="closeRatingsModal()" style="margin-top: 15px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ª–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π -->
    <div id="activityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">üì° –õ–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏–π</h2>
                <button class="modal-close" onclick="closeActivityModal()">‚úï</button>
            </div>
            
            <div style="font-size: 12px; color: var(--gray); margin-bottom: 10px; text-align: center;">
                –†–∞–±–æ—á–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤–æ–¥–∏—Ç–µ–ª–µ–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            </div>

            <div id="activityHeatmap" class="activity-heatmap">
                <div class="heatmap-header">
                    <div class="heatmap-title">üî• –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –≤–∞—à–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
                    <div class="heatmap-toggle" id="heatmapToggle">
                        <button type="button" data-mode="day">–î–µ–Ω—å</button>
                        <button type="button" data-mode="week" class="active">–ù–µ–¥–µ–ª—è</button>
                        <button type="button" data-mode="month">–ú–µ—Å—è—Ü</button>
                    </div>
                </div>
                <div class="heatmap-header" style="margin-top: 6px;">
                    <div class="heatmap-title" style="font-size: 12px; color: #666;">–¢–∏–ø—ã</div>
                    <div class="heatmap-toggle" id="heatmapTypeToggle">
                        <button type="button" data-type="all" class="active">–í—Å–µ</button>
                        <button type="button" data-type="dps_specbat">–î–ü–° + –°–ø–µ—Ü–±–∞—Ç</button>
                    </div>
                </div>
                <div class="heatmap-legend" id="heatmapLegend">
                    <span>–ú–∞–ª–æ</span>
                    <span class="chip"></span>
                    <span class="chip" style="background: rgba(0,122,255,0.35);"></span>
                    <span class="chip" style="background: rgba(0,122,255,0.6);"></span>
                    <span class="chip" style="background: rgba(0,122,255,0.85);"></span>
                    <span>–ú–Ω–æ–≥–æ</span>
                </div>
                <div class="heatmap-scroll">
                    <div id="heatmapGrid" class="heatmap-grid"></div>
                </div>
                <div id="heatmapSummary" class="heatmap-summary">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            
            <div id="activityFeed" style="max-height: 450px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 12px; padding: 10px;">
                <div style="text-align: center; color: var(--gray); padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</div>
            </div>
            
            <button class="main-btn" onclick="closeActivityModal()" style="margin-top: 15px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <div class="bottom-ui">
        <div class="action-card" id="actionCard">
            <button class="action-card-close" onclick="toggleActionCard()">‚úï</button>
            <span class="addr-label" id="addr-text">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞...</span>
            <div class="markers-counter" id="markersCounter">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="weather-widget" id="weatherWidget">üå¶ –ü–æ–≥–æ–¥–∞: –∑–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="type-selector">
                <div class="type-tabs">
                    <button class="type-tab-btn active" data-category="patrol" onclick="switchTypeCategory('patrol', this)">üõ°Ô∏è –ü–ê–¢–†–£–õ–¨</button>
                    <button class="type-tab-btn" data-category="help" onclick="switchTypeCategory('help', this)">ü§ù –í–ó–ê–ò–ú–û–ü–û–ú–û–©–¨</button>
                </div>

                <div class="type-group active" data-category="patrol">
                    <div class="type-group-title patrol">üõ°Ô∏è –î–û–†–û–ñ–ù–´–ô –ü–ê–¢–†–£–õ–¨</div>
                    <button data-type="dps" onclick="setType('dps', this)" class="type-btn active"><div class="icon-circle">üëÆ</div><span>–î–ü–°</span></button>
                    <button data-type="patrol" onclick="setType('patrol', this)" class="type-btn"><div class="icon-circle">üöî</div><span>–†–µ–π–¥</span></button>
                    <button data-type="specbat" onclick="setType('specbat', this)" class="type-btn"><div class="icon-circle">üõ°Ô∏è</div><span>–°–ø–µ—Ü–±–∞—Ç</span></button>
                    <button data-type="motobat" onclick="setType('motobat', this)" class="type-btn"><div class="icon-circle">üèçÔ∏è</div><span>–ú–æ—Ç–æ–±–∞—Ç</span></button>
                    <button data-type="cargo_control" onclick="setType('cargo_control', this)" class="type-btn"><div class="icon-circle">üöõ</div><span>–ì—Ä—É–∑. –∫–æ–Ω—Ç—Ä–æ–ª—å</span></button>
                </div>

                <div class="type-group" data-category="help">
                    <div class="type-group-title help">ü§ù –í–ó–ê–ò–ú–û–ü–û–ú–û–©–¨</div>
                    <button data-type="sos" onclick="setType('sos', this)" class="type-btn"><div class="icon-circle">üÜò</div><span>SOS</span></button>
                    <button data-type="dtp" onclick="setType('dtp', this)" class="type-btn"><div class="icon-circle">üí•</div><span>–î–¢–ü</span></button>
                    <button data-type="danger" onclick="setType('danger', this)" class="type-btn"><div class="icon-circle">‚ö†Ô∏è</div><span>–û–ø–∞—Å–Ω–æ—Å—Ç—å</span></button>
                    <button data-type="works" onclick="setType('works', this)" class="type-btn"><div class="icon-circle">üõ£Ô∏è</div><span>–†–∞–±–æ—Ç—ã</span></button>
                    <button data-type="traffic_jam" onclick="setType('traffic_jam', this)" class="type-btn"><div class="icon-circle">üöó</div><span>–ü—Ä–æ–±–∫–∞</span></button>
                </div>
            </div>
            <input type="text" id="m-comm" style="width:100%; margin-bottom:10px; border-radius:10px; border:1px solid #ddd; padding:8px; box-sizing: border-box;" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
            <button class="main-btn" onclick="addPoint()">–û–¢–ü–†–ê–í–ò–¢–¨</button>
        </div>
    </div>
<script>
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    const SUPABASE_URL = "https://phazbjchjhsruwalddis.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBoYXpiamNoamhzcnV3YWxkZGlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNDcyNjQsImV4cCI6MjA4NTcyMzI2NH0.juQSLL03uRb6ImiCul_UOOE4OwY3mXy-AuItwt2u9ds";
    // Telegram bot username (used to open/start the bot when user is not in Telegram)
    const BOT_USERNAME = 'DPSRADARDPR180bot';
    function createSupabaseClient(token = null) {
        const options = {
            auth: {
                persistSession: false,
                autoRefreshToken: false,
                detectSessionInUrl: false
            }
        };
        if (token) {
            options.global = { headers: { Authorization: `Bearer ${token}` } };
        }
        return window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, options);
    }

    function clearSupabaseAuth() {
        closeRealtimeChannels();
        _sb = createSupabaseClient();
        try { window._sb = _sb; } catch(e) {}
        try {
            localStorage.removeItem('sb_jwt');
            localStorage.removeItem('sb_jwt_exp');
            Object.keys(localStorage).forEach((key) => {
                if (key.includes('-auth-token')) localStorage.removeItem(key);
            });
        } catch (e) {
            // ignore storage errors
        }
    }

    // –ö–ª–∏–µ–Ω—Ç Supabase –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
    let _sb = createSupabaseClient();
    // –£–¥–æ–±–Ω–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏–∑ DevTools: –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö WebView –≥–ª–æ–±–∞–ª—å–Ω—ã–π `let` –Ω–µ –≤–∏–¥–µ–Ω –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è.
    try { window._sb = _sb; } catch(e) {}

    function setSupabaseAuth(token) {
        if (!token || typeof token !== 'string' || token.split('.').length !== 3) {
            clearSupabaseAuth();
            return;
        }
        closeRealtimeChannels();
        _sb = createSupabaseClient(token);
        try { window._sb = _sb; } catch(e) {}
        initRealtimeChannels();
    }

    let lastHelpHomeSyncAt = 0;
    async function syncHelpSubscriberHomeCoords(force = false) {
        try {
            if (!uid) return;
            if (!_sb) return;
            if (!Array.isArray(userLocation) || userLocation.length < 2) return;
            if (!gpsReliable) return;

            const now = Date.now();
            if (!force && lastHelpHomeSyncAt && (now - lastHelpHomeSyncAt) < 5 * 60 * 1000) return;
            lastHelpHomeSyncAt = now;

            const lat = Number(userLocation[0]);
            const lon = Number(userLocation[1]);
            if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
            // –µ—Å–ª–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞ –∏ –±—Ä–∞—É–∑–µ—Ä –≤–µ—Ä–Ω—É–ª 0,0 ‚Äî –Ω–µ –ø–µ—Ä–µ—Ç–∏—Ä–∞–µ–º –æ–ø–æ—Ä–Ω—É—é —Ç–æ—á–∫—É
            if (Math.abs(lat) < 1e-9 && Math.abs(lon) < 1e-9) return;

            // –í –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —á–∞—Ç–∞—Ö chat_id –æ–±—ã—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å user_id (Telegram ID), –ø–æ—ç—Ç–æ–º—É –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ –æ–±–æ–∏–º –≤–∞—Ä–∏–∞–Ω—Ç–∞–º.
            await _sb
                .from('telegram_help_subscribers')
                .update({
                    home_lat: lat,
                    home_lon: lon,
                    updated_at: new Date().toISOString()
                })
                .or(`user_id.eq.${String(uid)},chat_id.eq.${String(uid)}`);
        } catch (e) {
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â—ë –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω –≤ Telegram-–±–æ—Ç–µ (–Ω–µ—Ç —Å—Ç—Ä–æ–∫–∏) ‚Äî –±—É–¥–µ—Ç update 0 rows, —ç—Ç–æ –æ–∫.
            // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç/–ø—Ä–æ—Å—Ä–æ—á–µ–Ω ‚Äî sync –Ω–µ –Ω—É–∂–µ–Ω, auth –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ ensureSupabaseAuth.
        }
    }

    async function ensureSupabaseAuth() {
        const initData = window.Telegram?.WebApp?.initData;
        if (!initData) return null;

        try {
            const res = await fetch(`${SUPABASE_URL}/functions/v1/telegram-auth`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData })
            });
            if (!res.ok) {
                let errText = '';
                try { errText = await res.text(); } catch (e) { errText = ''; }
                clearSupabaseAuth();
                throw new Error(`telegram-auth failed (${res.status}): ${errText || 'empty response'}`);
            }
            const data = await res.json();
            if (data?.token && typeof data.token === 'string' && data.token.split('.').length === 3) {
                setSupabaseAuth(data.token);
                try {
                    localStorage.setItem('sb_jwt', data.token);
                    if (data.exp) localStorage.setItem('sb_jwt_exp', String(data.exp));
                } catch (e) {
                    // ignore storage errors
                }
                // –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –º–æ–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ (–µ—Å–ª–∏ GPS —É–∂–µ –∏–∑–≤–µ—Å—Ç–µ–Ω)
                syncHelpSubscriberHomeCoords(true).catch(()=>{});
                return data.token;
            } else {
                clearSupabaseAuth();
                throw new Error('telegram-auth returned invalid token');
            }
        } catch (e) {
            const msg = String(e?.message || e || '');
            console.warn('Supabase auth failed:', msg);
            if (/invalid hash/i.test(msg)) {
                console.warn('‚ö†Ô∏è Telegram initData –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–æ–∫–µ–Ω–æ–º –±–æ—Ç–∞. –û—Ç–∫—Ä–æ–π—Ç–µ Mini App –ò–ú–ï–ù–ù–û –∏–∑ @DPSRADARDPR180bot (–Ω–µ –∏–∑ BotFather/–ø–µ—Ä–µ—Å–ª–∞–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫), –∑–∞—Ç–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–∞—Ä—Ç—É.');
            }
            return null;
        }
    }

    function getRulesAcceptanceKey(userId) {
        return `rulesAccepted_${String(userId || '')}`;
    }

    const RULES_CONSENT_KEY = 'rules_v1';

    function hasAcceptedRules(userId) {
        if (!userId) return false;
        try {
            return localStorage.getItem(getRulesAcceptanceKey(userId)) === 'true';
        } catch (e) {
            return false;
        }
    }

    async function hasAcceptedRulesOnServer(userId) {
        if (!userId || !_sb) return false;
        try {
            const { data, error } = await _sb
                .from('user_consents')
                .select('accepted_at')
                .eq('user_id', String(userId))
                .eq('consent_key', RULES_CONSENT_KEY)
                .maybeSingle();
            if (error) return false;
            return !!data;
        } catch (e) {
            return false;
        }
    }

    function markRulesAccepted(userId) {
        if (!userId) return;
        try {
            localStorage.setItem(getRulesAcceptanceKey(userId), 'true');
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏–Ω—è—Ç–∏–µ –ø—Ä–∞–≤–∏–ª:', e?.message || e);
        }
    }

    async function markRulesAcceptedOnServer(userId) {
        if (!userId || !_sb) return;
        try {
            await _sb
                .from('user_consents')
                .upsert({
                    user_id: String(userId),
                    consent_key: RULES_CONSENT_KEY,
                    accepted_at: new Date().toISOString()
                }, { onConflict: 'user_id,consent_key' });
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:', e?.message || e);
        }
    }

    function showRulesModal(userId) {
        return new Promise((resolve) => {
            const modal = document.getElementById('rulesModal');
            const acceptBtn = document.getElementById('rulesAcceptBtn');
            if (!modal || !acceptBtn) {
                resolve(true);
                return;
            }

            if (acceptBtn._rulesHandler) {
                acceptBtn.removeEventListener('click', acceptBtn._rulesHandler);
            }

            const onAccept = async () => {
                markRulesAccepted(userId);
                await markRulesAcceptedOnServer(userId);
                modal.classList.remove('active');
                acceptBtn.removeEventListener('click', onAccept);
                acceptBtn._rulesHandler = null;
                resolve(true);
            };

            acceptBtn._rulesHandler = onAccept;
            acceptBtn.addEventListener('click', onAccept);
            modal.classList.add('active');
        });
    }

    async function ensureRulesAccepted(userId) {
        if (!userId) return true;
        if (hasAcceptedRules(userId)) return true;
        if (await hasAcceptedRulesOnServer(userId)) {
            markRulesAccepted(userId);
            return true;
        }
        return showRulesModal(userId);
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase —Å —Ç–∞–π–º–∞—É—Ç–æ–º
    async function queryWithTimeout(promise, timeoutMs = 15000) {
        return Promise.race([
            promise,
            new Promise((_, reject) =>
                setTimeout(() => reject(new Error(`Timeout: –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ ${timeoutMs/1000}—Å - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç—å`)), timeoutMs)
            )
        ]);
    }

    // –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç –≤ Telegram (–ø—ã—Ç–∞–µ–º—Å—è —Å–Ω–∞—á–∞–ª–∞ tg://, –∑–∞—Ç–µ–º https://)
    function openTelegramBot() {
        try {
            const tgUrl = `tg://resolve?domain=${BOT_USERNAME}`;
            const webUrl = `https://t.me/${BOT_USERNAME}`;
            // –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–∫—Ä—ã—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
            window.open(tgUrl, '_blank');
            // –ß–µ—Ä–µ–∑ 300ms –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤–µ–±-–≤–∞—Ä–∏–∞–Ω—Ç –∫–∞–∫ fallback
            setTimeout(() => { window.open(webUrl, '_blank'); }, 300);
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å Telegram:', e);
            window.open(`https://t.me/${BOT_USERNAME}`, '_blank');
        }
    }
    
    // –ò–∫–æ–Ω–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–æ—Ä–æ–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
    const MAP_ICONS = {
        dps: 'üëÆ',
        patrol: 'üöî',
        specbat: 'üõ°Ô∏è',
        motobat: 'üèçÔ∏è',
        cargo_control: 'üöõ',
        sos: 'üÜò',
        dtp: 'üí•',
        danger: '‚ö†Ô∏è',
        traffic_jam: 'üöó',
        camera: 'üì∏',
        works: 'üõ£Ô∏è'
    };
    // ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram (null –µ—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)
    const rawTgId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
    const uid = rawTgId ? String(rawTgId) : null;
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç—ã –∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –º–∞—Ä–∫–µ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –î–ü–°)
    let myMap, selectedType = 'dps';
    // –¢–µ–∫—É—â–µ–µ GPS –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let userLocation = null;
    let lastReliableUserLocation = null;
    let lastGpsAccuracyMeters = null;
    let gpsReliable = false;
    let gpsWarnedUnreliable = false;
    // ID –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è GPS (–¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è)
    let gpsWatchId = null;
    // –ú–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ
    let userLocationMarker = null;
    // –î–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏: –ø—Ä–µ–¥—ã–¥—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è –∏ –≤—Ä–µ–º—è
    let lastUserPositionCoords = null; // [lat, lon]
    let lastUserPositionTime = null; // ms
    let userSpeedKmh = 0; // —Å–∫–æ—Ä–æ—Å—Ç—å –≤ –∫–º/—á
    // –¢–µ–∫—É—â–∏–µ —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –∞—á–∏–≤–∫–∏ (–∫–ª—é—á -> count)
    let currentAchievementCounts = {};
    // –ö–æ–ª–ª–µ–∫—Ü–∏—è –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ (—á—Ç–æ–±—ã –Ω–µ —É–¥–∞–ª—è—Ç—å —Å–ª—É–∂–µ–±–Ω—ã–µ geoObjects –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏)
    let markersCollection = null;
    // –§–ª–∞–≥ –∞–≤—Ç–æ—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è: –µ—Å–ª–∏ true ‚Äî –∫–∞—Ä—Ç–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ GPS
    let autoFollow = true;
    // –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let currentDriver = null;
    // ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π ID Telegram)
    const ADMIN_ID = "5118431735";
    const ADMIN_RANK_LABEL = 'Admin SafeDrive';
    const ADMIN_TITLE_LABEL = '–û—Å–Ω–æ–≤–∞—Ç–µ–ª—å';
    // –ü–æ—Ä–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å"
    const TRUST_LIKES_THRESHOLD = 20; // –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    const TYPE_CATEGORY_STORAGE_KEY = 'selected_type_category';
    // –ü–æ—Ä–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π "—É–µ—Ö–∞–ª–∏" –¥–ª—è –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏
    const MARKER_LEAVE_THRESHOLD = 3; // –µ—Å–ª–∏ 3 —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞–∂–∞–ª–∏ "–£–µ—Ö–∞–ª–∏" - –º–µ—Ç–∫–∞ —É–¥–∞–ª—è–µ—Ç—Å—è
    // –§–ª–∞–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    let isAdmin = false;
    // –§–ª–∞–≥ —Ä–µ–∂–∏–º–∞ –Ω–µ–≤–∏–¥–∏–º–æ—Å—Ç–∏ –∞–¥–º–∏–Ω–∞ (–≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤)
    let adminInvisible = false;
    // Realtime-–∫–∞–Ω–∞–ª –¥–ª—è –∞–¥–º–∏–Ω-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ —Å—Ç–∞—Ç—É—Å–æ–≤
    let adminBroadcastChannel = null;
    // Realtime-–∫–∞–Ω–∞–ª—ã –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã –∏ —á–∞—Ç–∞
    let markersRealtimeChannel = null;
    let messagesRealtimeChannel = null;
    let markersRealtimeTimer = null;
    let messagesRealtimeTimer = null;
    let adminInvisibleIntervalId = null;
    // –§–ª–∞–≥: –æ—Ç–∫—Ä—ã—Ç –ª–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å (–¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ —á—É–∂–æ–º –ø—Ä–æ—Ñ–∏–ª–µ)
    let isViewingOwnProfile = true;
    // –§–ª–∞–≥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—á—Ç–æ–±—ã –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å initApp –ø–æ–≤—Ç–æ—Ä–Ω–æ)
    let initAppInProgress = false;
    // –°–ø–∏–¥–æ–º–µ—Ç—Ä: –≤–∏–¥–∏–º–æ—Å—Ç—å
    let speedometerEnabled = true;
    // –ê–Ω—Ç–∏-—Å–ø–∞–º –¥–ª—è –º–µ—Ç–æ–∫
    const MARKER_RATE_LIMIT_MS = 120000;
    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
    let selectedChatPhoto = null;
    // –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É–∂–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –∑–≤—É–∫)
    let notifiedMarkers = new Set();
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é (marker_id -> —É—Ä–æ–≤–µ–Ω—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: 'far' –∏–ª–∏ 'near')
    let distanceNotifications = new Map(); // { markerId: 'far'|'near' }
    // –¢—Ä–µ–Ω–¥ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–æ –º–∞—Ä–∫–µ—Ä–∞ (marker_id -> { lastDistance, lastTrend, lastUpdate })
    let markerDistanceState = new Map();
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –±–∞–Ω–Ω–µ—Ä–∞ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è
    let proximityBannerState = {
        markerId: null,
        markerType: null,
        markerCoords: null,
        lastDistance: null,
        lastUpdateTs: 0
    };
    let proximityBannerIntervalId = null;
    let currentWarningAudio = null;
    let appNotifications = [];
    let patrolNotifBatch = { count: 0, lastMarker: null, timer: null };
    let notifFeedSyncIntervalId = null;
    const NOTIF_STORAGE_PREFIX = 'app_notifications_';
    const NOTIF_GROUP_WINDOW_MS = 5 * 60 * 1000;
    const NOTIF_MAX_ITEMS = 120;
    const NOTIF_MCHS_RETENTION_MS = 24 * 60 * 60 * 1000;
    const NOTIF_FEED_RADIUS_METERS = 20000;
    const NOTIF_FEED_MARKER_LOOKBACK_MS = 24 * 60 * 60 * 1000;
    const NOTIF_FEED_SYNC_INTERVAL_MS = 5 * 60 * 1000;
    const CRITICAL_DTP_CONFIRMATIONS = 3;
    const PATROL_TYPES = new Set(['dps', 'patrol', 'specbat', 'motobat', 'cargo_control']);
    const TARGET_MIN_TOP_PX = 120;
    const TARGET_CARD_GAP_PX = 90;
    let dtpHeatmapEnabled = false;
    let dtpHeatmapCollection = null;
    let dtpHeatmapCellsCache = [];
    let dtpHeatmapCacheLoadedAt = 0;
    let dtpHeatmapRenderTimer = null;
    const DTP_HEATMAP_CACHE_MS = 2 * 60 * 1000;
    const DTP_HEATMAP_LOOKBACK_DAYS = 30;
    const DTP_HEATMAP_MAX_POINTS = 1200;

    // "–ó–æ—Ä–∫–∏–π –≥–ª–∞–∑": —Ç–æ—á–Ω–∞—è —Ç–µ–ø–ª–æ–∫–∞—Ä—Ç–∞ –∑–∞—Å–∞–¥ –î–ü–°/–°–ø–µ—Ü–±–∞—Ç (—Å–≤–µ–∂–µ—Å—Ç—å 2‚Äì3 —á–∞—Å–∞)
    let patrolHeatmapEnabled = false;
    let patrolHeatmapCollection = null;
    let patrolHeatmapCellsCache = [];
    let patrolHeatmapCacheLoadedAt = 0;
    let patrolHeatmapRenderTimer = null;
    const PATROL_HEATMAP_CACHE_MS = 60 * 1000;
    const PATROL_HEATMAP_LOOKBACK_HOURS = 3;
    const PATROL_HEATMAP_MAX_POINTS = 2500;
    const SAFE_DRIVE_NEWS_ITEMS = [
        {
            id: 'news_notif_feed_v1',
            icon: 'üîµ',
            title: '–í–∞–∂–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ SafeDrive',
            body: '–†–∞–∑–¥–µ–ª ¬´–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è¬ª —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ü–æ–≥–æ–¥—É (Open‚ÄëMeteo), SOS –∏ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –î–¢–ü.',
            createdAt: '2026-02-14T21:00:00.000Z',
            read: false,
            source: 'safedrive_news',
            priority: 'normal'
        }
    ];
    // –°—Ç–∏–ª—å –æ–∑–≤—É—á–∫–∏: 'standard' (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π) –∏–ª–∏ 'cheeky' (–¥–µ—Ä–∑–∫–∏–π)
    let voiceStyle = 'standard';
    // –û–ø–æ–≤–µ—â–µ–Ω–∏—è –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∞–≤—Ç–æ—Å–ª–µ–∂–µ–Ω–∏–∏
    let proximityRequiresFollow = false;
    // –î–∏—Å—Ç–∞–Ω—Ü–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–≤ –º–µ—Ç—Ä–∞—Ö)
    let warningDistanceMeters = 800;
    // –§–ª–∞–≥ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –Ω–∏–∂–Ω–µ–≥–æ –≤–∏–¥–∂–µ—Ç–∞
    let actionCardVisible = true;
    // –§–ª–∞–≥ –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ—Å—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è GPS –ø–æ—Å–ª–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –º–µ—Ç–∫–∏
    let disableAutoFollowOnce = false;
    // –ö—ç—à –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
    let authorsCache = {};
    let authorsCacheTime = 0;
    const CACHE_DURATION = 300000; // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 5 –º–∏–Ω—É—Ç
    // –¢–∞–π–º–µ—Ä –¥–ª—è –¥–µ–±–∞—É–Ω—Å–∞ loadMarkers
    let loadMarkersTimeout = null;

    function isAdminUserId(userId) {
        return String(userId) === String(ADMIN_ID);
    }

    function updateProfileAdminBadges(isAdminProfile) {
        const badges = document.getElementById('profile-admin-badges');
        const rankEl = document.getElementById('profile-admin-rank');
        if (!badges) return;
        if (isAdminProfile) {
            badges.style.display = 'flex';
            if (rankEl) rankEl.textContent = ADMIN_RANK_LABEL;
        } else {
            badges.style.display = 'none';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –Ω–∏–∂–Ω–µ–≥–æ –≤–∏–¥–∂–µ—Ç–∞
    function toggleActionCard() {
        actionCardVisible = !actionCardVisible;
        const card = document.getElementById('actionCard');
        const openBtn = document.getElementById('openActionBtn');
        if (actionCardVisible) {
            card.classList.remove('hidden');
            if (openBtn) openBtn.classList.remove('visible');
        } else {
            card.classList.add('hidden');
            if (openBtn) openBtn.classList.add('visible');
        }
        updateTargetAnchorPosition();
    }

    function updateTargetAnchorPosition() {
        const target = document.querySelector('.target');
        if (!target) return;

        target.style.transform = 'translate(-50%, -50%)';

        const card = document.getElementById('actionCard');
        if (!actionCardVisible || !card || card.classList.contains('hidden')) {
            target.style.top = '50%';
            return;
        }

        const cardRect = card.getBoundingClientRect();
        const desiredTop = Math.max(
            TARGET_MIN_TOP_PX,
            Math.min(window.innerHeight * 0.5, cardRect.top - TARGET_CARD_GAP_PX)
        );
        target.style.top = `${Math.round(desiredTop)}px`;
    }

    function getTargetPlacementCoords() {
        if (!myMap) return [48.01, 37.80];

        const fallback = myMap.getCenter();
        try {
            const target = document.querySelector('.target');
            const projection = myMap.options?.get?.('projection');
            if (!target || !projection || !myMap.converter?.pageToGlobal) return fallback;

            const rect = target.getBoundingClientRect();
            const pixelPoint = [
                rect.left + rect.width / 2,
                rect.top + rect.height / 2
            ];

            const globalPixels = myMap.converter.pageToGlobal(pixelPoint);
            const coords = projection.fromGlobalPixels(globalPixels, myMap.getZoom());

            if (Array.isArray(coords) && coords.length >= 2 && Number.isFinite(Number(coords[0])) && Number.isFinite(Number(coords[1]))) {
                return [Number(coords[0]), Number(coords[1])];
            }
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –º–µ—Ç–∫–µ:', e?.message || e);
        }
        return fallback;
    }

    function setDtpHeatmapUiState(enabled) {
        const btn = document.getElementById('dtpHeatmapBtn');
        if (btn) btn.classList.toggle('active', !!enabled);
        const overlay = document.getElementById('mapDimmingOverlay');
        if (overlay) overlay.classList.toggle('active', !!enabled);
    }

    function setPatrolHeatmapUiState(enabled) {
        const btn = document.getElementById('patrolHeatmapBtn');
        if (btn) btn.classList.toggle('active', !!enabled);
    }

    function getPatrolHeatColor(type, norm) {
        const n = Math.max(0, Math.min(1, Number(norm) || 0));
        // –î–ü–°: –∂—ë–ª—Ç–æ‚Äë–æ—Ä–∞–Ω–∂–µ–≤—ã–π, –°–ø–µ—Ü–±–∞—Ç: —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π/–∫—Ä–∞—Å–Ω—ã–π
        if (String(type) === 'specbat') {
            // purple -> deep red
            const r = Math.round(175 + (255 - 175) * n);
            const g = Math.round(82 + (59 - 82) * n);
            const b = Math.round(222 + (48 - 222) * n);
            return `rgb(${r},${g},${b})`;
        }
        // dps
        const r = Math.round(255);
        const g = Math.round(214 + (120 - 214) * n);
        const b = Math.round(10 + (0 - 10) * n);
        return `rgb(${r},${g},${b})`;
    }

    function buildDotSvg(color, sizePx, alpha = 0.9) {
        const s = Math.max(16, Math.min(28, Math.round(sizePx || 22)));
        const r = Math.round(s / 2);
        const stroke = 'rgba(0,0,0,0.10)';
        const fill = String(color || 'rgb(255,159,10)');
        const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 ${s} ${s}">
  <circle cx="${r}" cy="${r}" r="${Math.max(3, r - 1)}" fill="${fill}" fill-opacity="${Math.max(0.2, Math.min(1, alpha)).toFixed(2)}" stroke="${stroke}" stroke-width="1"/>
</svg>`;
        return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
    }

    function getPatrolHeatmapCellDegrees(zoom) {
        // –û—á–µ–Ω—å —Å—Ç—Ä–æ–≥–∞—è —Å–µ—Ç–∫–∞: —á—Ç–æ–±—ã —Ç–æ—á–∫–∏ –±—ã–ª–∏ "–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –∫–∞—Ä–º–∞–Ω–µ/—Å—ä–µ–∑–¥–µ"
        if (zoom >= 17) return 0.00045;
        if (zoom >= 16) return 0.00065;
        if (zoom >= 15) return 0.00095;
        if (zoom >= 14) return 0.0014;
        return 0.0022;
    }

    function parseTsToMsForQuery(ts) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —Ö–µ–ª–ø–µ—Ä, —á—Ç–æ –∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç
        return parseMarkerTimestampToMs(ts);
    }

    async function loadPatrolHeatmapData(force = false) {
        if (!force && (Date.now() - patrolHeatmapCacheLoadedAt) < PATROL_HEATMAP_CACHE_MS && patrolHeatmapCellsCache.length) {
            return patrolHeatmapCellsCache;
        }

        const now = Date.now();
        const sinceMs = now - PATROL_HEATMAP_LOOKBACK_HOURS * 60 * 60 * 1000;
        const sinceIso = new Date(sinceMs).toISOString();

        let rows = [];
        // –ü—ã—Ç–∞–µ–º—Å—è –∫–∞–∫ BIGINT(ms), –∏–Ω–∞—á–µ fallback –Ω–∞ ISO
        {
            const r1 = await _sb
                .from('markers')
                .select('id,type,ts,coords')
                .in('type', ['dps', 'specbat'])
                .gte('ts', sinceMs)
                .order('ts', { ascending: false })
                .limit(PATROL_HEATMAP_MAX_POINTS);
            if (r1?.error) {
                const r2 = await _sb
                    .from('markers')
                    .select('id,type,ts,coords')
                    .in('type', ['dps', 'specbat'])
                    .gte('ts', sinceIso)
                    .order('ts', { ascending: false })
                    .limit(PATROL_HEATMAP_MAX_POINTS);
                if (!r2?.error && Array.isArray(r2?.data)) rows = r2.data;
            } else {
                if (Array.isArray(r1?.data)) rows = r1.data;
            }
        }

        if (!Array.isArray(rows) || !rows.length) {
            patrolHeatmapCellsCache = [];
            patrolHeatmapCacheLoadedAt = Date.now();
            return patrolHeatmapCellsCache;
        }

        const zoom = myMap ? Number(myMap.getZoom() || 16) : 16;
        const cellDeg = getPatrolHeatmapCellDegrees(zoom);
        const cellMap = new Map();

        rows.forEach(row => {
            const coords = extractMarkerCoordsForNotif(row);
            if (!coords) return;
            const tsMs = parseTsToMsForQuery(row?.ts);
            if (!Number.isFinite(tsMs) || tsMs < sinceMs) return;

            const latKey = Math.round(Number(coords.lat) / cellDeg);
            const lonKey = Math.round(Number(coords.lon) / cellDeg);
            const key = `${latKey}:${lonKey}`;

            const existing = cellMap.get(key) || {
                lat: latKey * cellDeg,
                lon: lonKey * cellDeg,
                dps: 0,
                specbat: 0,
                weight: 0,
                latestMs: 0
            };
            if (row.type === 'dps') existing.dps += 1;
            if (row.type === 'specbat') existing.specbat += 1;

            const ageMin = Math.max(0, (now - tsMs) / 60000);
            // –°–≤–µ–∂–µ—Å—Ç—å: —á–µ–º —Å–≤–µ–∂–µ–µ, —Ç–µ–º –≤—ã—à–µ –≤–µ—Å
            const recency = ageMin <= 30 ? 1.0 : ageMin <= 90 ? 0.75 : ageMin <= 150 ? 0.55 : 0.40;
            existing.weight += recency;
            existing.latestMs = Math.max(existing.latestMs, tsMs);
            cellMap.set(key, existing);
        });

        patrolHeatmapCellsCache = [...cellMap.values()]
            .filter(c => (c.dps + c.specbat) > 0)
            .sort((a, b) => (b.weight || 0) - (a.weight || 0))
            .slice(0, 900);

        patrolHeatmapCacheLoadedAt = Date.now();
        return patrolHeatmapCellsCache;
    }

    async function showPatrolHeatmapAnalytics(cell) {
        if (!cell) return;
        if (!myMap) return;

        const lat = Number(cell.lat);
        const lon = Number(cell.lon);
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;

        let street = '‚Äî';
        try {
            const res = await ymaps.geocode([lat, lon]);
            const obj = res?.geoObjects?.get?.(0);
            const line = obj ? String(obj.getAddressLine() || '').trim() : '';
            if (line) street = line;
        } catch(e) {}

        let probability = null;
        let peak = null;
        try {
            let token = localStorage.getItem('sb_jwt') || '';
            if (!token) {
                const refreshed = await ensureSupabaseAuth();
                token = refreshed || localStorage.getItem('sb_jwt') || '';
            }
            if (token) {
                const resp = await fetch(`${SUPABASE_URL}/functions/v1/smart-hints?action=analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                    body: JSON.stringify({ lat, lon, ts_ms: Date.now(), recent_hours: PATROL_HEATMAP_LOOKBACK_HOURS, analyze_radius_m: 420, fetch_radius_m: 2500, window_days: 30, bucket_hours: 2 })
                });
                if (resp.ok) {
                    const data = await resp.json().catch(()=>null);
                    probability = Number(data?.analyze?.probability);
                    peak = data?.analyze?.peak || null;
                }
            }
        } catch(e) {}

        const probText = Number.isFinite(probability) ? `${Math.round(probability)}%` : '‚Äî';
        const peakText = peak?.start && peak?.end ? `${peak.start} - ${peak.end}` : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';

        const html = [
            '<div style="font-size:12px; line-height:1.25;">',
            '<div style="font-weight:900; margin-bottom:6px;">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ú–æ–Ω–æ–ª–∏—Ç–∞</div>',
            `<div>üìç –ú–µ—Å—Ç–æ: ${escapeHtml(street)}</div>`,
            `<div>‚ö†Ô∏è –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–æ—Å—Ç–∞: <b>${escapeHtml(probText)}</b></div>`,
            `<div>üïí –ü–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: <b>${escapeHtml(peakText)}</b></div>`,
            '</div>'
        ].join('');

        try {
            myMap.balloon.open([lat, lon], html, { closeButton: true, maxWidth: 320 });
        } catch(e) {}
    }

    async function renderPatrolHeatmapOverlay() {
        if (!myMap) return;
        if (!patrolHeatmapCollection) {
            patrolHeatmapCollection = new ymaps.GeoObjectCollection();
            myMap.geoObjects.add(patrolHeatmapCollection);
        }

        patrolHeatmapCollection.removeAll();
        if (!patrolHeatmapEnabled) return;

        const cells = await loadPatrolHeatmapData(false);
        if (!cells.length) return;

        const maxWeight = Math.max(...cells.map(c => Number(c.weight || 0)), 1);

        cells.forEach(cell => {
            const total = (cell.dps || 0) + (cell.specbat || 0);
            const dominant = (cell.specbat || 0) >= (cell.dps || 0) ? 'specbat' : 'dps';
            const norm = Math.max(0.12, Math.min(1, Number(cell.weight || 0) / maxWeight));
            const color = getPatrolHeatColor(dominant, norm);

            // –†–∞–¥–∏—É—Å —Ç–æ—á–∫–∏ —Å—Ç—Ä–æ–≥–æ ~10‚Äì12px
            const size = 22; // diameter
            const href = buildDotSvg(color, size, 0.92);

            const pm = new ymaps.Placemark([cell.lat, cell.lon], {
                hintContent: dominant === 'specbat' ? `–°–ø–µ—Ü–±–∞—Ç ‚Ä¢ ${total}` : `–î–ü–° ‚Ä¢ ${total}`
            }, {
                iconLayout: 'default#image',
                iconImageHref: href,
                iconImageSize: [size, size],
                iconImageOffset: [-Math.round(size/2), -Math.round(size/2)],
                zIndex: 1200
            });

            pm.events.add('click', () => {
                showPatrolHeatmapAnalytics(cell);
            });

            patrolHeatmapCollection.add(pm);
        });
    }

    function schedulePatrolHeatmapRender() {
        if (patrolHeatmapRenderTimer) clearTimeout(patrolHeatmapRenderTimer);
        patrolHeatmapRenderTimer = setTimeout(() => {
            renderPatrolHeatmapOverlay().catch(e => {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É –∑–∞—Å–∞–¥:', e?.message || e);
            });
        }, 120);
    }

    async function togglePatrolHeatmap(forceState = null) {
        patrolHeatmapEnabled = typeof forceState === 'boolean' ? forceState : !patrolHeatmapEnabled;
        setPatrolHeatmapUiState(patrolHeatmapEnabled);

        if (!patrolHeatmapEnabled) {
            if (patrolHeatmapCollection) patrolHeatmapCollection.removeAll();
            return;
        }

        await loadPatrolHeatmapData(false);
        schedulePatrolHeatmapRender();
    }

    function parseMarkerTimestampToMs(value) {
        if (typeof value === 'number') {
            if (value > 1e12) return value;
            if (value > 1e9) return value * 1000;
        }
        if (typeof value === 'string') {
            const asNum = Number(value);
            if (Number.isFinite(asNum)) return parseMarkerTimestampToMs(asNum);
            const parsed = Date.parse(value);
            if (Number.isFinite(parsed)) return parsed;
        }
        return Date.now();
    }

    function getDtpHeatmapCellDegrees(zoom) {
        // –ß–µ–º –±–ª–∏–∂–µ –∑—É–º ‚Äî —Ç–µ–º –º–µ–ª—å—á–µ —Å–µ—Ç–∫–∞, —á—Ç–æ–±—ã "–ø—è—Ç–Ω–∞" —É–∫–∞–∑—ã–≤–∞–ª–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ–µ –º–µ—Å—Ç–æ.
        if (zoom >= 17) return 0.0010;
        if (zoom >= 16) return 0.0016;
        if (zoom >= 15) return 0.0025;
        if (zoom >= 14) return 0.0038;
        if (zoom >= 13) return 0.0055;
        return 0.008;
    }

    function getDtpHeatmapRadiusMeters(zoom) {
        // –†–∞–¥–∏—É—Å—ã —É–º–µ–Ω—å—à–µ–Ω—ã, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–Ω–∏–º–∞–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–æ–∫/—É—á–∞—Å—Ç–æ–∫.
        if (zoom >= 17) return 120;
        if (zoom >= 16) return 180;
        if (zoom >= 15) return 260;
        if (zoom >= 14) return 400;
        if (zoom >= 13) return 550;
        return 750;
    }

    function getDtpHeatColor(norm) {
        const n = Math.max(0, Math.min(1, Number(norm) || 0));
        if (n <= 0.5) {
            const t = n / 0.5;
            const r = Math.round(70 + (255 - 70) * t);
            const g = Math.round(180 + (214 - 180) * t);
            const b = Math.round(255 + (10 - 255) * t);
            return `rgb(${r},${g},${b})`;
        }
        const t = (n - 0.5) / 0.5;
        const r = 255;
        const g = Math.round(214 + (59 - 214) * t);
        const b = Math.round(10 + (48 - 10) * t);
        return `rgb(${r},${g},${b})`;
    }

    async function loadDtpHeatmapData(force = false) {
        if (!force && (Date.now() - dtpHeatmapCacheLoadedAt) < DTP_HEATMAP_CACHE_MS && dtpHeatmapCellsCache.length) {
            return dtpHeatmapCellsCache;
        }

        const { data, error } = await _sb
            .from('markers')
            .select('id,type,ts,coords,leave_confirmations')
            .eq('type', 'dtp')
            .order('ts', { ascending: false })
            .limit(DTP_HEATMAP_MAX_POINTS);

        if (error || !Array.isArray(data)) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ—á–∫–∏ –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã –î–¢–ü:', error?.message || error);
            return dtpHeatmapCellsCache;
        }

        const lookbackMs = DTP_HEATMAP_LOOKBACK_DAYS * 24 * 60 * 60 * 1000;
        const now = Date.now();

        dtpHeatmapCellsCache = data.map(row => {
            const coords = extractMarkerCoordsForNotif(row);
            if (!coords) return null;

            const tsMs = parseMarkerTimestampToMs(row?.ts);
            const ageMs = Math.max(0, now - tsMs);
            const recency = ageMs <= 24 * 60 * 60 * 1000 ? 1 : ageMs <= 3 * 24 * 60 * 60 * 1000 ? 0.75 : ageMs <= 7 * 24 * 60 * 60 * 1000 ? 0.55 : 0.35;
            const confirmations = Number(row?.leave_confirmations || 0);
            const confirmBoost = Math.min(1.4, confirmations * 0.18);

            return {
                lat: Number(coords.lat),
                lon: Number(coords.lon),
                tsMs,
                weight: recency + confirmBoost
            };
        }).filter(point => {
            if (!point) return false;
            if (!Number.isFinite(point.lat) || !Number.isFinite(point.lon)) return false;
            return (now - point.tsMs) <= lookbackMs;
        });

        dtpHeatmapCacheLoadedAt = Date.now();
        return dtpHeatmapCellsCache;
    }

    function aggregateDtpHeatmapCells(points, zoom) {
        const cellDeg = getDtpHeatmapCellDegrees(zoom);
        const cellMap = new Map();

        points.forEach(point => {
            const latKey = Math.round(point.lat / cellDeg);
            const lonKey = Math.round(point.lon / cellDeg);
            const key = `${latKey}:${lonKey}`;
            const existing = cellMap.get(key) || { lat: latKey * cellDeg, lon: lonKey * cellDeg, weight: 0, hits: 0 };
            existing.weight += Number(point.weight || 0);
            existing.hits += 1;
            cellMap.set(key, existing);
        });

        return [...cellMap.values()];
    }

    async function renderDtpHeatmapOverlay() {
        if (!myMap) return;
        if (!dtpHeatmapCollection) {
            dtpHeatmapCollection = new ymaps.GeoObjectCollection();
            myMap.geoObjects.add(dtpHeatmapCollection);
        }

        dtpHeatmapCollection.removeAll();
        if (!dtpHeatmapEnabled) return;

        const points = await loadDtpHeatmapData(false);
        if (!points.length) return;

        const zoom = Number(myMap.getZoom() || 14);
        const radius = getDtpHeatmapRadiusMeters(zoom);
        const bounds = myMap.getBounds();
        const cells = aggregateDtpHeatmapCells(points, zoom).filter(cell => {
            if (!Array.isArray(bounds) || bounds.length < 2) return true;
            const [sw, ne] = bounds;
            return cell.lat >= Number(sw[0]) - 0.03 && cell.lat <= Number(ne[0]) + 0.03 && cell.lon >= Number(sw[1]) - 0.03 && cell.lon <= Number(ne[1]) + 0.03;
        });

        if (!cells.length) return;
        const maxWeight = Math.max(...cells.map(c => Number(c.weight || 0)), 1);

        cells.forEach(cell => {
            const norm = Math.max(0.08, Math.min(1, Number(cell.weight || 0) / maxWeight));
            const color = getDtpHeatColor(norm);

            const glow = new ymaps.Circle([[cell.lat, cell.lon], radius * 1.4], {}, {
                fillColor: color,
                fillOpacity: 0.10 + norm * 0.14,
                strokeOpacity: 0,
                zIndex: 1100
            });
            const core = new ymaps.Circle([[cell.lat, cell.lon], radius], {}, {
                fillColor: color,
                fillOpacity: 0.20 + norm * 0.34,
                strokeColor: color,
                strokeOpacity: 0.08,
                strokeWidth: 1,
                zIndex: 1101
            });

            dtpHeatmapCollection.add(glow);
            dtpHeatmapCollection.add(core);
        });
    }

    function scheduleDtpHeatmapRender() {
        if (dtpHeatmapRenderTimer) clearTimeout(dtpHeatmapRenderTimer);
        dtpHeatmapRenderTimer = setTimeout(() => {
            renderDtpHeatmapOverlay().catch(e => {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É –î–¢–ü:', e?.message || e);
            });
        }, 120);
    }

    async function toggleDtpHeatmap(forceState = null) {
        dtpHeatmapEnabled = typeof forceState === 'boolean' ? forceState : !dtpHeatmapEnabled;
        setDtpHeatmapUiState(dtpHeatmapEnabled);

        if (!dtpHeatmapEnabled) {
            if (dtpHeatmapCollection) dtpHeatmapCollection.removeAll();
            return;
        }

        await loadDtpHeatmapData(false);
        scheduleDtpHeatmapRender();
    }

    // –°–ø–∏–¥–æ–º–µ—Ç—Ä: –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    function loadSpeedometerPreference() {
        try {
            const saved = localStorage.getItem('speedometerEnabled');
            speedometerEnabled = saved !== 'false';
        } catch (e) {
            speedometerEnabled = true;
        }
        applySpeedometerVisibility();
    }

    function applySpeedometerVisibility() {
        const el = document.getElementById('speedometer');
        const openBtn = document.getElementById('speedometerOpenBtn');
        if (!el || !openBtn) return;
        if (speedometerEnabled) {
            el.classList.add('visible');
            openBtn.classList.remove('visible');
        } else {
            el.classList.remove('visible');
            openBtn.classList.add('visible');
        }
    }

    function toggleSpeedometer(forceOn) {
        if (typeof forceOn === 'boolean') {
            speedometerEnabled = forceOn;
        } else {
            speedometerEnabled = !speedometerEnabled;
        }
        try { localStorage.setItem('speedometerEnabled', speedometerEnabled ? 'true' : 'false'); } catch(e) {}
        applySpeedometerVisibility();
    }

    function updateSpeedometerUI(speedKmh) {
        const valueEl = document.getElementById('speedValue');
        if (!valueEl) return;
        valueEl.textContent = Math.max(0, Math.round(speedKmh || 0));
    }

    function registerServiceWorker() {
        if (!('serviceWorker' in navigator)) return;
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('service-worker.js').catch(err => {
                console.warn('Service Worker registration failed:', err);
            });
        });
    }

    // ===================== PWA: Web Push + background location bridge =====================
    // –í–ê–ñ–ù–û:
    // - Web Push —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö –∏ –æ–±—ã—á–Ω–æ —Ç—Ä–µ–±—É–µ—Ç HTTPS + —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—É—é PWA.
    // - –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ Service Worker; –ø–æ—ç—Ç–æ–º—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±–µ—Ä—ë–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏ —à–ª—ë–º –≤ SW.

    // –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à VAPID public key (base64url, –±–µ–∑ '=' –≤ –∫–æ–Ω—Ü–µ –æ–±—ã—á–Ω–æ).
    // –ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞: "BEl6..." (—ç—Ç–æ –ù–ï —Å–µ–∫—Ä–µ—Ç, –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç private key).
    const WEB_PUSH_VAPID_PUBLIC_KEY = 'BCKNXhwDka5GLPLOGJib2ONjp2Hw985myXXwBOWeH2d5m50A6yiBt7ykM0tbxRtbMo5IBH7HP0EpeMwcA4sLvtE';
    const PUSH_SUB_LOCALSTORAGE_KEY = 'safedrive180:pushSubscription';

    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
        return outputArray;
    }

    async function getActiveServiceWorkerForMessaging() {
        if (!('serviceWorker' in navigator)) return null;
        try {
            if (navigator.serviceWorker.controller) return navigator.serviceWorker.controller;
            const reg = await navigator.serviceWorker.ready;
            return reg.active || reg.waiting || reg.installing || null;
        } catch (e) {
            return null;
        }
    }

    function storePushSubscription(subscription) {
        try {
            localStorage.setItem(PUSH_SUB_LOCALSTORAGE_KEY, JSON.stringify(subscription));
        } catch (e) {}
    }

    function clearStoredPushSubscription() {
        try { localStorage.removeItem(PUSH_SUB_LOCALSTORAGE_KEY); } catch (e) {}
    }

    async function saveWebPushSubscriptionOnServer(subscriptionJson) {
        try {
            if (!subscriptionJson || !subscriptionJson.endpoint) return false;
            if (typeof SUPABASE_URL === 'undefined' || !SUPABASE_URL) return false;

            const resp = await fetch(`${SUPABASE_URL}/functions/v1/push-subscribe`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subscription: subscriptionJson,
                    userId: (typeof uid !== 'undefined' && uid) ? String(uid) : null,
                    userAgent: (navigator && navigator.userAgent) ? navigator.userAgent : ''
                })
            });
            if (!resp.ok) {
                const t = await resp.text().catch(() => '');
                console.warn('Web Push: push-subscribe failed:', resp.status, t);
                return false;
            }
            return true;
        } catch (e) {
            console.warn('Web Push: save subscription error:', e?.message || e);
            return false;
        }
    }

    async function enableWebPush() {
        if (!('serviceWorker' in navigator)) throw new Error('Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏');
        if (!('PushManager' in window)) throw new Error('PushManager –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (Web Push –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)');
        if (!('Notification' in window)) throw new Error('Notification API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');

        let permission = Notification.permission;
        if (permission === 'default') {
            permission = await Notification.requestPermission();
        }
        if (permission !== 'granted') {
            throw new Error('–ù–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (Notification.permission != granted)');
        }

        const reg = await navigator.serviceWorker.ready;
        const existing = await reg.pushManager.getSubscription();
        if (existing) {
            storePushSubscription(existing.toJSON());
            saveWebPushSubscriptionOnServer(existing.toJSON()).catch(()=>{});
            return existing;
        }

        const key = String(WEB_PUSH_VAPID_PUBLIC_KEY || '').trim();
        if (!key) {
            throw new Error('–ù–µ –∑–∞–¥–∞–Ω WEB_PUSH_VAPID_PUBLIC_KEY ‚Äî –±–µ–∑ –Ω–µ–≥–æ –ø–æ–¥–ø–∏—Å–∫—É —Å–æ–∑–¥–∞—Ç—å –Ω–µ–ª—å–∑—è');
        }

        const sub = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(key)
        });

        storePushSubscription(sub.toJSON());
        console.log('Web Push subscription created:', sub.toJSON());
        saveWebPushSubscriptionOnServer(sub.toJSON()).catch(()=>{});
        return sub;
    }

    async function disableWebPush() {
        if (!('serviceWorker' in navigator)) return false;
        try {
            const reg = await navigator.serviceWorker.ready;
            const sub = await reg.pushManager.getSubscription();
            if (sub) await sub.unsubscribe();
            clearStoredPushSubscription();
            return true;
        } catch (e) {
            return false;
        }
    }

    async function postLocationToServiceWorker(position) {
        const sw = await getActiveServiceWorkerForMessaging();
        if (!sw || typeof sw.postMessage !== 'function') return;
        const coords = position?.coords;
        if (!coords) return;

        // –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ç—ã–µ –ø–æ–ª—è (–Ω–µ —Ç–∞—â–∏–º –ø—Ä–æ—Ç–æ—Ç–∏–ø—ã GeolocationCoordinates)
        const payload = {
            latitude: Number(coords.latitude),
            longitude: Number(coords.longitude),
            accuracy: Number(coords.accuracy),
            altitude: coords.altitude == null ? null : Number(coords.altitude),
            altitudeAccuracy: coords.altitudeAccuracy == null ? null : Number(coords.altitudeAccuracy),
            heading: coords.heading == null ? null : Number(coords.heading),
            speed: coords.speed == null ? null : Number(coords.speed)
        };

        sw.postMessage({
            type: 'LOCATION_UPDATE',
            coords: payload,
            timestamp: Number.isFinite(position?.timestamp) ? position.timestamp : Date.now()
        });
    }

    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π API, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤–∫–ª—é—á–∞—Ç—å —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–Ω–æ–ø–∫–∏/–∂–µ—Å—Ç—ã.
    window.SafeDrivePwa = {
        enableWebPush,
        disableWebPush,
        postLocationToServiceWorker
    };

    function getNotifStorageKey() {
        return `${NOTIF_STORAGE_PREFIX}${String(uid || 'anon')}`;
    }

    function escapeHtml(input) {
        return String(input || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function loadNotificationsState() {
        try {
            const raw = localStorage.getItem(getNotifStorageKey());
            const parsed = raw ? JSON.parse(raw) : [];
            appNotifications = Array.isArray(parsed) ? parsed : [];
        } catch (e) {
            appNotifications = [];
        }
        pruneOldMchsNotifications();
        renderNotificationsList();
        updateNotificationBadge();
    }

    function pruneOldMchsNotifications() {
        const now = Date.now();
        const before = appNotifications.length;
        appNotifications = appNotifications.filter(n => {
            if (String(n?.source || '') !== 'mchs') return true;
            const ts = new Date(n?.createdAt || 0).getTime();
            if (!Number.isFinite(ts)) return false;
            return (now - ts) <= NOTIF_MCHS_RETENTION_MS;
        });
        if (appNotifications.length !== before) {
            saveNotificationsState();
        }
    }

    function saveNotificationsState() {
        try {
            localStorage.setItem(getNotifStorageKey(), JSON.stringify(appNotifications.slice(0, NOTIF_MAX_ITEMS)));
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', e?.message || e);
        }
    }

    async function updatePwaBadge(unreadCount) {
        try {
            if (typeof navigator.setAppBadge === 'function') {
                if (unreadCount > 0) await navigator.setAppBadge(unreadCount);
                else if (typeof navigator.clearAppBadge === 'function') await navigator.clearAppBadge();
            }
        } catch (e) {
            // ignore unsupported contexts
        }
    }

    function updateNotificationBadge() {
        const unread = appNotifications.filter(n => !n.read).length;
        const badge = document.getElementById('notifUnreadBadge');
        if (badge) {
            if (unread > 0) {
                badge.style.display = 'block';
                badge.textContent = unread > 99 ? '99+' : String(unread);
            } else {
                badge.style.display = 'none';
            }
        }
        updatePwaBadge(unread);
    }

    function formatNotificationTime(ts) {
        try {
            return new Date(ts).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        } catch (e) {
            return '';
        }
    }

    function formatRelativeNotificationTime(ts) {
        const value = new Date(ts).getTime();
        if (!Number.isFinite(value)) return '';
        const diffMs = Date.now() - value;
        if (diffMs < 60 * 1000) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
        const diffMin = Math.floor(diffMs / (60 * 1000));
        if (diffMin < 60) return `${diffMin} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
        const diffH = Math.floor(diffMin / 60);
        if (diffH < 24) return `${diffH} —á. –Ω–∞–∑–∞–¥`;
        const diffD = Math.floor(diffH / 24);
        return `${diffD} –¥–Ω. –Ω–∞–∑–∞–¥`;
    }

    function formatDistanceForNotification(distanceMeters) {
        if (!Number.isFinite(distanceMeters)) return null;
        if (distanceMeters >= 1000) return `${(distanceMeters / 1000).toFixed(1)} –∫–º –æ—Ç –≤–∞—Å`;
        return `${Math.round(distanceMeters)} –º –æ—Ç –≤–∞—Å`;
    }

    function looksLikeMojibake(text) {
        const value = String(text || '');
        return /√ê|√ë|ÔøΩ/.test(value);
    }

    function normalizeFeedText(value, fallback = '') {
        const text = String(value || '').trim();
        if (!text) return fallback;
        if (looksLikeMojibake(text)) return fallback;
        return text;
    }

    function showInAppNotification(notification) {
        const wrap = document.getElementById('inAppNotifWrap');
        if (!wrap) return;
        const toast = document.createElement('div');
        toast.className = 'notif-toast';
        toast.innerHTML = `<div style="font-weight:700; margin-bottom:2px;">${escapeHtml(notification.title)}</div><div>${escapeHtml(notification.body || '')}</div>`;
        wrap.prepend(toast);
        requestAnimationFrame(() => toast.classList.add('visible'));
        setTimeout(() => {
            toast.classList.remove('visible');
            setTimeout(() => toast.remove(), 220);
        }, 4200);
        if (notification.priority === 'high' && navigator.vibrate) {
            try { navigator.vibrate([200, 120, 220]); } catch (e) {}
        }
    }

    async function showSystemNotification(notification) {
        if (!document.hidden) return;
        if (!('Notification' in window)) return;
        let permission = Notification.permission;
        if (permission === 'default') {
            try { permission = await Notification.requestPermission(); } catch (e) { return; }
        }
        if (permission !== 'granted') return;

        // –ï—Å–ª–∏ –∑–∞–¥–∞–Ω VAPID public key ‚Äî —Å–æ–∑–¥–∞—ë–º Web Push –ø–æ–¥–ø–∏—Å–∫—É (–±–µ–∑ –Ω–æ–≤–æ–≥–æ UI).
        try {
            const key = String(typeof WEB_PUSH_VAPID_PUBLIC_KEY !== 'undefined' ? WEB_PUSH_VAPID_PUBLIC_KEY : '').trim();
            if (key && window.SafeDrivePwa && typeof window.SafeDrivePwa.enableWebPush === 'function') {
                window.SafeDrivePwa.enableWebPush().catch(()=>{});
            }
        } catch (e) {}

        const options = {
            body: notification.body || '',
            tag: `marker-${notification.type || 'event'}`,
            renotify: notification.priority === 'high',
            data: {
                url: '/',
                coords: notification.coords || null,
                notifId: notification.id
            },
            vibrate: notification.priority === 'high' ? [200, 120, 220] : [80],
            badge: 'manifest.json'
        };

        try {
            if (navigator.serviceWorker?.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'SHOW_NOTIFICATION',
                    title: notification.title,
                    options
                });
                return;
            }
            if (navigator.serviceWorker?.ready) {
                const reg = await navigator.serviceWorker.ready;
                await reg.showNotification(notification.title, options);
                return;
            }
            new Notification(notification.title, options);
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–∫–∞–∑–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:', e?.message || e);
        }
    }

    function upsertAppNotification(notification, options = {}) {
        if (!notification || !notification.id) return;
        const silent = !!options.silent;
        const idx = appNotifications.findIndex(n => String(n.id) === String(notification.id));
        if (idx >= 0) {
            const prev = appNotifications[idx] || {};
            appNotifications[idx] = { ...prev, ...notification, read: typeof notification.read === 'boolean' ? notification.read : prev.read };
        } else {
            appNotifications.unshift(notification);
        }

        appNotifications.sort((a, b) => new Date(b.createdAt || 0).getTime() - new Date(a.createdAt || 0).getTime());
        if (appNotifications.length > NOTIF_MAX_ITEMS) appNotifications = appNotifications.slice(0, NOTIF_MAX_ITEMS);

        saveNotificationsState();
        renderNotificationsList();
        updateNotificationBadge();

        if (!silent && idx < 0) {
            if (!document.hidden) showInAppNotification(notification);
            showSystemNotification(notification);
        }
    }

    function pushAppNotification(notification) {
        upsertAppNotification(notification, { silent: false });
    }

    function renderNotificationsList() {
        const list = document.getElementById('notificationsList');
        if (!list) return;
        if (!appNotifications.length) {
            list.innerHTML = '<div style="text-align:center; color: var(--gray); padding: 16px;">–ü–æ–∫–∞ –Ω–µ—Ç –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π</div>';
            return;
        }
        list.innerHTML = appNotifications.map(n => `
            <div class="notif-row ${n.read ? '' : 'unread'}" onclick="goToNotification('${escapeHtml(n.id)}')">
                <div class="notif-icon">${escapeHtml(n.icon || 'üìç')}</div>
                <div style="flex:1; min-width:0;">
                    <div class="notif-title">${escapeHtml(n.title)}</div>
                    <div class="notif-body">${escapeHtml(n.body || '')}</div>
                    <div class="notif-time">${formatRelativeNotificationTime(n.createdAt) || formatNotificationTime(n.createdAt)}</div>
                </div>
            </div>
        `).join('');
    }

    function markNotificationReadById(id) {
        const idx = appNotifications.findIndex(n => String(n.id) === String(id));
        if (idx < 0) return;
        if (!appNotifications[idx].read) {
            appNotifications[idx].read = true;
            saveNotificationsState();
            renderNotificationsList();
            updateNotificationBadge();
        }
    }

    function openNotificationsDrawer() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'hidden';
        syncImportantNotificationsFeed({ silent: true }).catch(()=>{});
        renderNotificationsList();
        document.getElementById('notificationsModal').classList.add('active');
    }

    function closeNotificationsDrawer() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        document.getElementById('notificationsModal').classList.remove('active');
    }

    function markAllNotificationsRead() {
        appNotifications = appNotifications.map(n => ({ ...n, read: true }));
        saveNotificationsState();
        renderNotificationsList();
        updateNotificationBadge();
    }

    function clearAllNotifications() {
        appNotifications = [];
        saveNotificationsState();
        renderNotificationsList();
        updateNotificationBadge();
    }

    function goToNotification(notificationId) {
        const n = appNotifications.find(item => String(item.id) === String(notificationId));
        if (!n) return;
        markNotificationReadById(notificationId);
        if (n.coords && myMap) {
            try {
                myMap.setCenter([n.coords.lat, n.coords.lon], 16, { duration: 250 });
            } catch (e) {}
        }
        closeNotificationsDrawer();
    }

    function extractMarkerCoordsForNotif(marker) {
        if (!marker) return null;
        if (Array.isArray(marker.coords) && marker.coords.length >= 2) {
            const a = Number(marker.coords[0]);
            const b = Number(marker.coords[1]);
            if (Math.abs(a) <= 90 && Math.abs(b) <= 180) return { lat: a, lon: b };
            if (Math.abs(a) <= 180 && Math.abs(b) <= 90) return { lat: b, lon: a };
            return { lat: a, lon: b };
        }
        if (typeof marker.latitude === 'number' && typeof marker.longitude === 'number') {
            return { lat: marker.latitude, lon: marker.longitude };
        }
        return null;
    }

    function buildMarkerNotification(marker, distanceMeters, override = null) {
        const type = marker?.type || 'event';
        const icon = getMarkerEmoji(type);
        const label = getMarkerLabel(type);
        const distance = Number.isFinite(distanceMeters) ? `${Math.round(distanceMeters)} –º` : null;
        const baseBody = override || `${label}${distance ? ` ‚Ä¢ ${distance}` : ''}${marker?.comment ? ` ‚Ä¢ ${String(marker.comment).slice(0, 80)}` : ''}`;
        const markerIdPart = marker?.id ? String(marker.id) : `${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
        return {
            id: `realtime_${type}_${markerIdPart}`,
            type,
            icon,
            title: type === 'sos' ? 'üÜò –†—è–¥–æ–º SOS' : `–†—è–¥–æ–º: ${label}`,
            body: baseBody,
            priority: type === 'sos' ? 'high' : 'normal',
            createdAt: new Date().toISOString(),
            read: false,
            source: 'marker',
            coords: extractMarkerCoordsForNotif(marker)
        };
    }

    function buildFeedMarkerNotification(marker, kind, distanceMeters) {
        const markerId = String(marker?.id || `${Date.now()}_${Math.random().toString(36).slice(2, 7)}`);
        const distanceText = formatDistanceForNotification(distanceMeters);
        const comment = String(marker?.comment || '').trim();
        const ts = marker?.ts ? new Date(marker.ts).toISOString() : new Date().toISOString();

        if (kind === 'sos') {
            return {
                id: `feed_sos_${markerId}`,
                type: 'sos',
                icon: 'üî¥',
                title: 'SOS: –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å',
                body: `${comment || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª –ø–æ–º–æ—â—å'}${distanceText ? ` (${distanceText})` : ''}`,
                priority: 'high',
                createdAt: ts,
                read: false,
                source: 'sos',
                coords: extractMarkerCoordsForNotif(marker)
            };
        }

        return {
            id: `feed_dtp_critical_${markerId}`,
            type: 'dtp',
            icon: 'üîµ',
            title: '–î–¢–ü: –ö—Ä–∏—Ç–∏—á–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ',
            body: `${comment || '–í–æ–∑–º–æ–∂–Ω–æ–µ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è'}${distanceText ? ` (${distanceText})` : ''}`,
            priority: 'normal',
            createdAt: ts,
            read: false,
            source: 'critical_dtp',
            coords: extractMarkerCoordsForNotif(marker)
        };
    }

    async function syncMchsFeedToNotifications({ silent = true } = {}) {
        try {
            const resp = await fetch(`${SUPABASE_URL}/functions/v1/mchs-auto?action=feed&limit=8`, { method: 'GET' });
            if (!resp.ok) return;
            const payload = await resp.json();
            const alerts = Array.isArray(payload?.alerts) ? payload.alerts : [];
            alerts.forEach(alert => {
                const alertId = String(alert?.id || '');
                if (!alertId) return;
                const rawTitle = String(alert?.title || '').trim();
                const link = String(alert?.source_link || '').trim();
                const isWeather = /open-meteo\.com/i.test(link) || /\b–ø–æ–≥–æ–¥–∞\b/i.test(rawTitle);
                const isSafeDriveUpdate = /–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ\s+safedrive/i.test(rawTitle) || (!link && !isWeather);
                const hazard = normalizeFeedText(alert?.hazard_text, normalizeFeedText(rawTitle, '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'));
                const recommendation = normalizeFeedText(
                    alert?.recommendation_text,
                    isSafeDriveUpdate ? '–°–ª–µ–¥–∏—Ç–µ –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è¬ª.' : ''
                );
                upsertAppNotification({
                    id: `${isSafeDriveUpdate ? 'feed_update_' : 'feed_mchs_'}${alertId}`,
                    type: isSafeDriveUpdate ? 'update' : (isWeather ? 'weather' : 'mchs'),
                    icon: isSafeDriveUpdate ? 'üîµ' : (isWeather ? 'üå¶' : 'üü†'),
                    title: isSafeDriveUpdate ? 'SafeDrive: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ' : (isWeather ? '–ü–æ–≥–æ–¥–∞: –î–æ–Ω–µ—Ü–∫' : '–ú–ß–°: –®—Ç–æ—Ä–º–æ–≤–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ'),
                    body: `${hazard}${recommendation ? ` ‚Ä¢ ${recommendation}` : ''}`.slice(0, 220),
                    priority: 'normal',
                    createdAt: alert?.pub_date || alert?.created_at || new Date().toISOString(),
                    read: false,
                    source: isSafeDriveUpdate ? 'safedrive_news' : (isWeather ? 'weather' : 'mchs'),
                    link: link || null
                }, { silent });
            });
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≥–æ–¥—É/—Å–≤–æ–¥–∫–∏:', e?.message || e);
        }
    }

    function buildWeatherWidgetLine(alert) {
        const full = String(alert?.full_text || '');
        const hazardText = String(alert?.hazard_text || '');

        const t = full.match(/üå°\s*–¢–ï–ú–ü–ï–†–ê–¢–£–†–ê:\s*([+\-]?\d+)\s*¬∞C/i)?.[1] || null;
        const wind = full.match(/üí®\s*–í–ï–¢–ï–†:\s*(\d+)\s*–∫–º\/—á/i)?.[1] || null;
        const vis = full.match(/üëÅ\s*–í–ò–î–ò–ú–û–°–¢–¨:\s*(\d+)\s*–º/i)?.[1] || null;

        const isIce = /–ì–û–õ–û–õ–ï–î/i.test(hazardText) || /–ì–û–õ–û–õ–ï–î/i.test(full);
        const roadPart = isIce ? '‚ö†Ô∏è –ì–æ–ª–æ–ª—ë–¥' : (/‚úÖ\s*–ù–û–†–ú–ê/i.test(hazardText) ? '‚úÖ –ù–æ—Ä–º–∞' : '');

        const parts = [];
        parts.push(`üå¶ ${t !== null ? `${t}¬∞C` : '‚Äî'}`);
        if (wind !== null) parts.push(`üí® ${wind} –∫–º/—á`);
        if (vis !== null) parts.push(`üëÅ ${vis} –º`);
        if (roadPart) parts.push(`<span class="weather-warn">${roadPart}</span>`);

        return parts.join(' ‚Ä¢ ');
    }

    async function syncWeatherWidget() {
        const el = document.getElementById('weatherWidget');
        if (!el) return;

        try {
            const resp = await fetch(`${SUPABASE_URL}/functions/v1/mchs-auto?action=feed&limit=3`, { method: 'GET' });
            if (!resp.ok) return;
            const payload = await resp.json();
            const alerts = Array.isArray(payload?.alerts) ? payload.alerts : [];

            const weather = alerts.find(a => /open-meteo\.com/i.test(String(a?.source_link || '')) || /\b–ø–æ–≥–æ–¥–∞\b/i.test(String(a?.title || '')));
            if (!weather) {
                el.textContent = 'üå¶ –ü–æ–≥–æ–¥–∞: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                return;
            }

            el.innerHTML = buildWeatherWidgetLine(weather);
        } catch (e) {
            // –ù–µ —à—É–º–∏–º ‚Äî –≤–∏–¥–∂–µ—Ç –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω
        }
    }

    async function syncNearbyImportantMarkersToNotifications({ silent = true } = {}) {
        try {
            const sinceIso = new Date(Date.now() - NOTIF_FEED_MARKER_LOOKBACK_MS).toISOString();
            const { data: markers, error } = await _sb
                .from('markers')
                .select('id,type,ts,comment,coords,leave_confirmations,author_id')
                .in('type', ['sos', 'dtp'])
                .gte('ts', sinceIso)
                .order('ts', { ascending: false })
                .limit(80);

            if (error || !Array.isArray(markers)) return;

            markers.forEach(marker => {
                if (String(marker?.author_id || '') === String(uid || '')) return;

                const coords = extractMarkerCoordsForNotif(marker);
                let distanceMeters = NaN;
                if (coords && Array.isArray(userLocation) && userLocation.length >= 2) {
                    distanceMeters = calculateDistance(userLocation[0], userLocation[1], Number(coords.lat), Number(coords.lon));
                    if (Number.isFinite(distanceMeters) && distanceMeters > NOTIF_FEED_RADIUS_METERS) return;
                }

                if (marker.type === 'sos') {
                    upsertAppNotification(buildFeedMarkerNotification(marker, 'sos', distanceMeters), { silent });
                    return;
                }

                const confirms = Number(marker?.leave_confirmations || 0);
                if (marker.type === 'dtp' && confirms >= CRITICAL_DTP_CONFIRMATIONS) {
                    upsertAppNotification(buildFeedMarkerNotification(marker, 'critical_dtp', distanceMeters), { silent });
                }
            });
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å SOS/–î–¢–ü –≤ –ª–µ–Ω—Ç—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', e?.message || e);
        }
    }

    function seedSafeDriveNewsNotifications() {
        SAFE_DRIVE_NEWS_ITEMS.forEach(item => {
            upsertAppNotification({ ...item }, { silent: true });
        });
    }

    async function syncImportantNotificationsFeed({ silent = true } = {}) {
        await syncMchsFeedToNotifications({ silent });
        await syncWeatherWidget();
        await syncNearbyImportantMarkersToNotifications({ silent });
        pruneOldMchsNotifications();
    }

    async function notifyHelpBotAboutMarker(marker) {
        try {
            if (!marker || !marker.type) return;
            const helpTypes = new Set(['sos', 'dps', 'specbat', 'dtp', 'danger', 'traffic_jam', 'works']);
            if (!helpTypes.has(String(marker.type))) return;

            let token = localStorage.getItem('sb_jwt') || '';
            if (!token) {
                const refreshed = await ensureSupabaseAuth();
                token = refreshed || localStorage.getItem('sb_jwt') || '';
            }
            if (!token) {
                console.warn('–ü—Ä–æ–ø—É—Å–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ help-notify: JWT —Ç–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
                return;
            }

            const addrText = (document.getElementById('addr-text')?.textContent || '').trim();
            const driverName = String(currentDriver?.name || '–í–æ–¥–∏—Ç–µ–ª—å');
            const driverRank = isAdminUserId(uid) ? '–ê–¥–º–∏–Ω' : '–£—á–∞—Å—Ç–Ω–∏–∫';

            const payload = {
                markerId: marker.id,
                type: marker.type,
                comment: marker.comment || '',
                createdAtMs: Number(marker.ts || marker.createdAtMs || Date.now()),
                lat: marker.coords?.[0],
                lon: marker.coords?.[1],
                placeText: addrText,
                driverName,
                driverRank
            };

            const resp = await fetch(`${SUPABASE_URL}/functions/v1/help-notify`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            if (!resp.ok) {
                let bodyText = '';
                try { bodyText = await resp.text(); } catch(e) { bodyText = ''; }
                console.warn('help-notify –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É:', resp.status, bodyText || '(–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç)');
                return;
            }

            try {
                const payload = await resp.json();
                console.log('help-notify result:', payload);
                if (Number(payload?.sent || 0) <= 0) {
                    console.warn('help-notify: –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ 0 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', payload);
                    const errors = Array.isArray(payload?.errors) ? payload.errors : [];
                    const has403 = errors.some(e => Number(e?.status) === 403);
                    const bodyJoin = errors.map(e => String(e?.body || '')).join(' | ');
                    if (has403 && /bot can't initiate conversation|blocked by the user|user is deactivated|Forbidden/i.test(bodyJoin)) {
                        console.warn('‚ö†Ô∏è Telegram –Ω–µ –¥–∞–ª –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π @SafeDrive180_MCHS_bot –∏ –Ω–∞–∂–º–∏—Ç–µ /start, –∑–∞—Ç–µ–º –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –º–µ—Ç–∫—É.');
                    }
                }
            } catch (e) {
                console.log('‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ help-notify');
            }
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram-–±–æ—Ç–∞:', e?.message || e);
        }
    }

    function flushPatrolBatchNotification() {
        if (!patrolNotifBatch.count || !patrolNotifBatch.lastMarker) return;
        const count = patrolNotifBatch.count;
        const notif = buildMarkerNotification(
            patrolNotifBatch.lastMarker,
            patrolNotifBatch.lastDistance,
            `–í –≤–∞—à–µ–º —Ä–∞–π–æ–Ω–µ –≤—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–∞—Ç—Ä—É–ª–µ–π (${count} –Ω–æ–≤—ã—Ö –º–µ—Ç–æ–∫ –∑–∞ 5 –º–∏–Ω—É—Ç)`
        );
        notif.title = 'üõ°Ô∏è –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–∞—Ç—Ä—É–ª–µ–π';
        pushAppNotification(notif);
        patrolNotifBatch.count = 0;
        patrolNotifBatch.lastMarker = null;
        patrolNotifBatch.lastDistance = null;
        if (patrolNotifBatch.timer) {
            clearTimeout(patrolNotifBatch.timer);
            patrolNotifBatch.timer = null;
        }
    }

    function queuePatrolBatchNotification(marker, distanceMeters) {
        patrolNotifBatch.count += 1;
        patrolNotifBatch.lastMarker = marker;
        patrolNotifBatch.lastDistance = distanceMeters;
        if (!patrolNotifBatch.timer) {
            patrolNotifBatch.timer = setTimeout(() => {
                flushPatrolBatchNotification();
            }, NOTIF_GROUP_WINDOW_MS);
        }
    }

    function handleRealtimeMarkerNotification(payload) {
        try {
            if (!payload || payload.eventType !== 'INSERT' || !payload.new) return;
            const marker = payload.new;
            if (String(marker.author_id || '') === String(uid || '')) return;

            const coords = extractMarkerCoordsForNotif(marker);
            if (!coords || !userLocation || !Array.isArray(userLocation) || userLocation.length < 2) return;
            const distance = calculateDistance(userLocation[0], userLocation[1], coords.lat, coords.lon);
            if (!Number.isFinite(distance) || distance > 10000) return;

            if (marker.type === 'sos') {
                pushAppNotification(buildMarkerNotification(marker, distance));
                return;
            }

            if (PATROL_TYPES.has(marker.type)) {
                queuePatrolBatchNotification(marker, distance);
                return;
            }

            pushAppNotification(buildMarkerNotification(marker, distance));
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ realtime-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', e?.message || e);
        }
    }

    // –ì—Ä–∞–Ω–∏—Ü—ã –î–æ–Ω–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ –î–ù–† (–ø—Ä–∏–º–µ—Ä–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)
    const DONETSK_REGION = {
        north: 49.2,    // –°–µ–≤–µ—Ä–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
        south: 47.3,    // –Æ–∂–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
        west: 36.4,     // –ó–∞–ø–∞–¥–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
        east: 40.4      // –í–æ—Å—Ç–æ—á–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
    };

    // –î–µ–±–∞—É–Ω—Å —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —á–∞—Å—Ç—ã—Ö –≤—ã–∑–æ–≤–æ–≤
    function debounce(func, delay) {
        let timeoutId;
        return function(...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(this, args), delay);
        };
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–µ–±–∞—É–Ω—Å –¥–ª—è loadMarkers (750ms –≤–º–µ—Å—Ç–æ 500ms)
    const loadMarkersDebounced = debounce(() => loadMarkers(), 750);
    
    // ============= –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –û –†–ê–°–°–¢–û–Ø–ù–ò–ò –ò –û–ó–í–£–ß–ö–ò =============
    
    /**
     * –í—ã—á–∏—Å–ª—è–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –¥–≤—É–º—è GPS-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ (—Ñ–æ—Ä–º—É–ª–∞ –•–∞–≤–µ—Ä—Å–∏–Ω–∞)
     * @param {number} lat1 - —à–∏—Ä–æ—Ç–∞ –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–∏
     * @param {number} lon1 - –¥–æ–ª–≥–æ—Ç–∞ –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–∏
     * @param {number} lat2 - —à–∏—Ä–æ—Ç–∞ –≤—Ç–æ—Ä–æ–π —Ç–æ—á–∫–∏
     * @param {number} lon2 - –¥–æ–ª–≥–æ—Ç–∞ –≤—Ç–æ—Ä–æ–π —Ç–æ—á–∫–∏
     * @returns {number} —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –º–µ—Ç—Ä–∞—Ö
     */
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000; // –†–∞–¥–∏—É—Å –∑–µ–º–ª–∏ –≤ –º–µ—Ç—Ä–∞—Ö
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function getDynamicWarningMaxMeters() {
        const base = Math.max(300, Number(warningDistanceMeters) || 800);
        const speed = Number(userSpeedKmh) || 0;
        if (speed > 80) return Math.max(base, 1200);
        if (speed < 40) return Math.min(base, 600);
        return base;
    }

    function getWarningMinMeters(maxMeters) {
        return Math.max(200, Math.round(maxMeters * 0.6));
    }

    function getNearThresholdMeters(maxMeters) {
        return Math.max(120, Math.round(maxMeters * 0.25));
    }

    function formatDistanceMeters(distance) {
        if (!isFinite(distance)) return '';
        if (distance >= 1000) return `${Math.round(distance / 10) * 10} –º`;
        if (distance >= 100) return `${Math.round(distance / 10) * 10} –º`;
        return `${Math.round(distance)} –º`;
    }

    function getMarkerLabel(type) {
        const labels = {
            dps: '–î–ü–° (–°—Ç–∞–Ω–¥–∞—Ä—Ç)',
            patrol: '–†–µ–π–¥',
            specbat: '–°–ø–µ—Ü–±–∞—Ç',
            motobat: '–ú–æ—Ç–æ–±–∞—Ç',
            cargo_control: '–ì—Ä—É–∑–æ–≤–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å',
            camera: '–ù–∞–±–ª—é–¥–µ–Ω–∏–µ',
            dtp: '–î–¢–ü',
            works: '–†–∞–±–æ—Ç—ã',
            sos: 'SOS / –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å',
            danger: '–û–ø–∞—Å–Ω–æ—Å—Ç—å',
            traffic_jam: '–ü—Ä–æ–±–∫–∞ / –ó–∞—Ç–æ—Ä'
        };
        return labels[type] || '–î–æ—Ä–æ–∂–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ';
    }

    function getMarkerEmoji(type) {
        const icons = {
            dps: 'üëÆ',
            patrol: 'üöî',
            specbat: 'üõ°Ô∏è',
            motobat: 'üèçÔ∏è',
            cargo_control: 'üöõ',
            camera: 'üì∏',
            dtp: 'üí•',
            works: 'üõ£Ô∏è',
            sos: 'üÜò',
            danger: '‚ö†Ô∏è',
            traffic_jam: 'üöó'
        };
        return icons[type] || '‚ö†Ô∏è';
    }

    async function getUserSosBonus(userId) {
        try {
            if (!userId) return 0;
            const { data, error } = await _sb.rpc('get_user_sos_bonus', { p_user_id: String(userId) });
            if (error) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å SOS-–±–æ–Ω—É—Å:', error?.message || error);
                return 0;
            }
            return Number(data) || 0;
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è SOS-–±–æ–Ω—É—Å–∞:', e?.message || e);
            return 0;
        }
    }

    function updateProximityBanner(distance, type) {
        const banner = document.getElementById('proximityBanner');
        if (!banner) return;
        const label = getMarkerLabel(type);
        const emoji = getMarkerEmoji(type);
        const distanceText = formatDistanceMeters(distance);

        banner.innerHTML = `<span class="proximity-banner-title">${emoji} ${label}:</span> <span class="proximity-banner-distance">${distanceText}</span>`;
        banner.classList.add('visible');

        banner.classList.remove('proximity-banner--yellow', 'proximity-banner--orange', 'proximity-banner--red', 'proximity-banner--blink');
        if (distance <= 200) {
            banner.classList.add('proximity-banner--red', 'proximity-banner--blink');
        } else if (distance <= 500) {
            banner.classList.add('proximity-banner--orange');
        } else if (distance <= 1000) {
            banner.classList.add('proximity-banner--yellow');
        }
    }

    function hideProximityBanner() {
        const banner = document.getElementById('proximityBanner');
        if (!banner) return;
        banner.classList.remove('visible', 'proximity-banner--yellow', 'proximity-banner--orange', 'proximity-banner--red', 'proximity-banner--blink');
    }

    function stopWarningOutput() {
        try {
            if (currentWarningAudio) {
                currentWarningAudio.pause();
                currentWarningAudio.currentTime = 0;
                currentWarningAudio = null;
            }
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞—É–¥–∏–æ:', e?.message || e);
        }
        try {
            if (window.speechSynthesis && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–∑–≤—É—á–∫—É:', e?.message || e);
        }
    }

    // ===================== MONOLITH 180: Voice + WakeLock + Background keep-alive =====================
    const MONOLITH_VOICE_ENABLED_KEY = 'monolith180:voice_enabled';
    let monolithVoiceEnabled = true;

    let monolithWakeLock = null;
    let monolithNavigationActive = false;

    let monolithTtsQueue = [];
    let monolithTtsIsSpeaking = false;
    let monolithSelectedRuVoice = null;

    let monolithKeepAliveAudio = null;
    let monolithKeepAliveTimerId = null;
    let monolithTtsResumeTimerId = null;
    let monolithAudioPrimed = false;

    // very small silent WAV (short) as data URI
    const MONOLITH_SILENT_WAV = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=';

    function isMonolithVoiceEnabled() {
        return !!monolithVoiceEnabled;
    }

    function loadMonolithVoiceEnabled() {
        try {
            const raw = localStorage.getItem(MONOLITH_VOICE_ENABLED_KEY);
            if (raw === 'true' || raw === 'false') monolithVoiceEnabled = (raw === 'true');
        } catch (e) {}
    }

    function saveMonolithVoiceEnabled() {
        try { localStorage.setItem(MONOLITH_VOICE_ENABLED_KEY, monolithVoiceEnabled ? 'true' : 'false'); } catch (e) {}
    }

    function applyMonolithVoiceToggleUI() {
        const el = document.getElementById('voice-enable');
        if (!el) return;
        el.checked = !!monolithVoiceEnabled;
    }

    function initMonolithVoiceToggle() {
        loadMonolithVoiceEnabled();
        applyMonolithVoiceToggleUI();
        const el = document.getElementById('voice-enable');
        if (!el) return;
        el.addEventListener('change', () => {
            monolithVoiceEnabled = !!el.checked;
            saveMonolithVoiceEnabled();
            if (!monolithVoiceEnabled) {
                try { monolithClearTtsQueue(true); } catch (e) {}
                try { monolithStopKeepAliveAudio(); } catch (e) {}
                try { monolithReleaseWakeLock(); } catch (e) {}
            } else {
                try { monolithMaybeUpdateWakeLock(); } catch (e) {}
            }
        });
    }

    function monolithPickRussianVoice() {
        if (!window.speechSynthesis) return null;
        try {
            const voices = window.speechSynthesis.getVoices ? (window.speechSynthesis.getVoices() || []) : [];
            const ru = voices.filter(v => String(v?.lang || '').toLowerCase().startsWith('ru'));
            if (!ru.length) return null;
            const preferred = ru.find(v => /google|yandex|windows|microsoft/i.test(String(v?.name || '')));
            return preferred || ru[0];
        } catch (e) {
            return null;
        }
    }

    function monolithEnsureVoicesReady() {
        if (!window.speechSynthesis) return;
        try { window.speechSynthesis.getVoices(); } catch (e) {}
        try {
            window.speechSynthesis.onvoiceschanged = () => {
                monolithSelectedRuVoice = monolithPickRussianVoice();
            };
        } catch (e) {}
        monolithSelectedRuVoice = monolithPickRussianVoice();
    }

    function monolithSpeakNextFromQueue() {
        if (!isMonolithVoiceEnabled()) return;
        if (!window.speechSynthesis) return;
        if (monolithTtsIsSpeaking) return;
        if (!monolithTtsQueue.length) return;

        const next = monolithTtsQueue.shift();
        if (!next) return;

        monolithTtsIsSpeaking = true;
        const utterance = new SpeechSynthesisUtterance(String(next));
        utterance.lang = 'ru-RU';
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        if (!monolithSelectedRuVoice) monolithSelectedRuVoice = monolithPickRussianVoice();
        if (monolithSelectedRuVoice) utterance.voice = monolithSelectedRuVoice;

        utterance.onend = () => {
            monolithTtsIsSpeaking = false;
            monolithSpeakNextFromQueue();
        };
        utterance.onerror = () => {
            monolithTtsIsSpeaking = false;
            monolithSpeakNextFromQueue();
        };

        try {
            window.speechSynthesis.speak(utterance);
        } catch (e) {
            monolithTtsIsSpeaking = false;
        }
    }

    function monolithClearTtsQueue(cancelNow = false) {
        monolithTtsQueue = [];
        monolithTtsIsSpeaking = false;
        if (cancelNow && window.speechSynthesis) {
            try { window.speechSynthesis.cancel(); } catch (e) {}
        }
    }

    // –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: –µ—Å–ª–∏ —Å–∏–Ω—Ç–µ–∑ —É–∂–µ –≥–æ–≤–æ—Ä–∏—Ç ‚Äî –Ω–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã –≤ –æ—á–µ—Ä–µ–¥—å, –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å.
    function aiSpeak(text) {
        const t = String(text || '').trim();
        if (!t) return;
        if (!isMonolithVoiceEnabled()) return;
        if (!window.speechSynthesis) return;

        monolithEnsureVoicesReady();
        monolithTtsQueue.push(t);

        // –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –æ–∑–≤—É—á–∫–∏ –ø—ã—Ç–∞–µ–º—Å—è —É–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –∂–∏–≤—ã–º (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –±—Ä–∞—É–∑–µ—Ä–∞)
        try { monolithMaybeUpdateWakeLock(); } catch (e) {}
        try { monolithMaybeStartKeepAliveAudio(); } catch (e) {}

        monolithSpeakNextFromQueue();
    }

    async function monolithRequestWakeLock() {
        if (!('wakeLock' in navigator)) return;
        if (!monolithNavigationActive) return;
        if (!isMonolithVoiceEnabled()) return;
        if (document.hidden) return; // screen wake lock –æ–±—ã—á–Ω–æ —Ç—Ä–µ–±—É–µ—Ç –≤–∏–¥–∏–º—É—é –≤–∫–ª–∞–¥–∫—É

        try {
            if (monolithWakeLock) return;
            monolithWakeLock = await navigator.wakeLock.request('screen');
            monolithWakeLock.addEventListener('release', () => {
                monolithWakeLock = null;
            });
        } catch (e) {
            monolithWakeLock = null;
        }
    }

    function monolithReleaseWakeLock() {
        try {
            if (monolithWakeLock) {
                monolithWakeLock.release();
                monolithWakeLock = null;
            }
        } catch (e) {
            monolithWakeLock = null;
        }
    }

    function monolithSetNavigationActive(active) {
        monolithNavigationActive = !!active;
        monolithMaybeUpdateWakeLock();
        if (!monolithNavigationActive) {
            monolithStopKeepAliveAudio();
        }
    }

    function monolithMaybeUpdateWakeLock() {
        if (!monolithNavigationActive || !isMonolithVoiceEnabled()) {
            monolithReleaseWakeLock();
            return;
        }
        monolithRequestWakeLock();
    }

    function monolithPrimeAudioOnce() {
        if (monolithAudioPrimed) return;
        monolithAudioPrimed = true;
        try {
            const a = new Audio(MONOLITH_SILENT_WAV);
            a.volume = 0.001;
            a.play().then(() => {
                try { a.pause(); } catch(e) {}
            }).catch(() => {
                // ignore
            });
        } catch (e) {}
    }

    function monolithMaybeStartKeepAliveAudio() {
        if (!isMonolithVoiceEnabled()) return;
        if (!monolithNavigationActive) return;

        // –º–Ω–æ–≥–∏–µ –±—Ä–∞—É–∑–µ—Ä—ã –∑–∞–ø—Ä–µ—â–∞—é—Ç autoplay –±–µ–∑ user gesture
        if (!monolithAudioPrimed) return;

        if (!monolithKeepAliveAudio) {
            monolithKeepAliveAudio = new Audio(MONOLITH_SILENT_WAV);
            monolithKeepAliveAudio.loop = true;
            monolithKeepAliveAudio.volume = 0.001;
        }

        if (monolithKeepAliveTimerId) return;
        monolithKeepAliveTimerId = setInterval(() => {
            try {
                if (!monolithKeepAliveAudio) return;
                if (!document.hidden) return; // keep-alive –Ω—É–∂–µ–Ω –∏–º–µ–Ω–Ω–æ –ø—Ä–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏
                monolithKeepAliveAudio.play().catch(() => {});
            } catch (e) {}
        }, 25000);

        // –ø–µ—Ä–≤—ã–π —Å—Ç–∞—Ä—Ç
        try {
            if (document.hidden) monolithKeepAliveAudio.play().catch(() => {});
        } catch (e) {}

        // –Ω–µ–±–æ–ª—å—à–æ–π "–ø–∏–Ω–æ–∫" –¥–ª—è TTS –≤ —Ñ–æ–Ω–µ (–º—è–≥–∫–æ)
        if (!monolithTtsResumeTimerId) {
            monolithTtsResumeTimerId = setInterval(() => {
                try {
                    if (!document.hidden) return;
                    if (!window.speechSynthesis) return;
                    if (window.speechSynthesis.speaking) {
                        window.speechSynthesis.resume();
                    }
                } catch (e) {}
            }, 3000);
        }
    }

    function monolithStopKeepAliveAudio() {
        if (monolithKeepAliveTimerId) {
            clearInterval(monolithKeepAliveTimerId);
            monolithKeepAliveTimerId = null;
        }
        if (monolithTtsResumeTimerId) {
            clearInterval(monolithTtsResumeTimerId);
            monolithTtsResumeTimerId = null;
        }
        try {
            if (monolithKeepAliveAudio) {
                monolithKeepAliveAudio.pause();
                monolithKeepAliveAudio.currentTime = 0;
            }
        } catch (e) {}
    }

    // Prime audio on first user interaction (needed for background keep-alive hacks)
    window.addEventListener('touchstart', monolithPrimeAudioOnce, { passive: true, once: true });
    window.addEventListener('click', monolithPrimeAudioOnce, { passive: true, once: true });

    document.addEventListener('visibilitychange', () => {
        // –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: –ø—Ä–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏ –∑–≤—É–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–ª —Ä–∞–±–æ—Ç–∞—Ç—å.
        // –†–µ–∞–ª—å–Ω–æ—Å—Ç—å: –±—Ä–∞—É–∑–µ—Ä/–û–° –º–æ–≥—É—Ç –≤—Å—ë —Ä–∞–≤–Ω–æ –¥—É—à–∏—Ç—å TTS. –ó–¥–µ—Å—å ‚Äî best-effort.
        try {
            if (document.hidden) {
                monolithMaybeStartKeepAliveAudio();
            } else {
                monolithStopKeepAliveAudio();
                monolithMaybeUpdateWakeLock();
                if (window.speechSynthesis) {
                    try { window.speechSynthesis.resume(); } catch(e) {}
                }
            }
        } catch (e) {}
    });

    function speakSmartHintText(text) {
        const t = String(text || '').trim();
        if (!t) return;
        try { aiSpeak(t); } catch(e) {}
    }

    let lastSmartHintCheckAt = 0;
    async function maybeCheckSmartHint(lat, lon) {
        try {
            if (!uid) return;
            if (!gpsReliable) return;
            const speed = Number(userSpeedKmh) || 0;
            if (speed < 10) return;

            const now = Date.now();
            if (now - lastSmartHintCheckAt < 45000) return;
            lastSmartHintCheckAt = now;

            let token = localStorage.getItem('sb_jwt') || '';
            if (!token) {
                const refreshed = await ensureSupabaseAuth();
                token = refreshed || localStorage.getItem('sb_jwt') || '';
            }
            if (!token) return;

            const resp = await fetch(`${SUPABASE_URL}/functions/v1/smart-hints?action=check`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify({ lat: Number(lat), lon: Number(lon), ts_ms: now })
            });

            if (!resp.ok) return;
            const data = await resp.json().catch(()=>null);
            const hint = data?.hint;
            if (!hint || !hint.key) return;

            const hintKey = String(hint.key || '').trim();
            if (!hintKey) return;

            const lastKey = String(localStorage.getItem('last_smart_hint_key') || '').trim();
            const lastTs = Number(localStorage.getItem('last_smart_hint_ts') || 0);
            if (lastKey === hintKey && (now - lastTs) < 60 * 60 * 1000) return; // 1h cooldown per same hint

            localStorage.setItem('last_smart_hint_key', hintKey);
            localStorage.setItem('last_smart_hint_ts', String(now));

            showInAppNotification({
                title: String(hint.title || 'üß† –ü–æ–¥—Å–∫–∞–∑–∫–∞'),
                body: String(hint.body || ''),
                priority: 'high'
            });
            speakSmartHintText(String(hint.voice || ''));
        } catch (e) {
            console.warn('maybeCheckSmartHint error:', e?.message || e);
        }
    }

    function setActiveProximityMarker(markerId, markerType, markerCoords, distance) {
        if (!markerId) return;
        if (!markerCoords || !Array.isArray(markerCoords) || markerCoords.length < 2) return;

        const currentId = proximityBannerState.markerId;
        if (!currentId || currentId === markerId || distance < (proximityBannerState.lastDistance || Infinity)) {
            proximityBannerState.markerId = markerId;
            proximityBannerState.markerType = markerType;
            proximityBannerState.markerCoords = markerCoords;
            proximityBannerState.lastDistance = distance;
            proximityBannerState.lastUpdateTs = Date.now();
            updateProximityBanner(distance, markerType);
        }
    }

    function clearActiveProximityMarker(markerId) {
        if (proximityBannerState.markerId === markerId) {
            proximityBannerState.markerId = null;
            proximityBannerState.markerType = null;
            proximityBannerState.markerCoords = null;
            proximityBannerState.lastDistance = null;
            proximityBannerState.lastUpdateTs = 0;
            hideProximityBanner();
        }
    }

    function refreshProximityBanner() {
        if (!proximityBannerState.markerId || !proximityBannerState.markerCoords || !userLocation) return;
        const coords = proximityBannerState.markerCoords;
        const lat = Number(coords[0]);
        const lon = Number(coords[1]);
        if (!isFinite(lat) || !isFinite(lon)) return;

        const distance = calculateDistance(userLocation[0], userLocation[1], lat, lon);
        const prev = proximityBannerState.lastDistance;
        const warningMax = getDynamicWarningMaxMeters();

        if (isFinite(prev) && distance > prev + 25) {
            distanceNotifications.delete(proximityBannerState.markerId);
            markerDistanceState.set(proximityBannerState.markerId, { lastDistance: distance, lastTrend: 'away', lastUpdate: Date.now() });
            clearActiveProximityMarker(proximityBannerState.markerId);
            stopWarningOutput();
            return;
        }

        if (distance > warningMax) {
            clearActiveProximityMarker(proximityBannerState.markerId);
            return;
        }

        proximityBannerState.lastDistance = distance;
        proximityBannerState.lastUpdateTs = Date.now();
        updateProximityBanner(distance, proximityBannerState.markerType);
    }

    function startProximityBannerLoop() {
        if (proximityBannerIntervalId) return;
        proximityBannerIntervalId = setInterval(() => {
            try { refreshProximityBanner(); } catch (e) { /* ignore */ }
        }, 2500);
    }
    
    /**
    * –û–∑–≤—É—á–∏–≤–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –¥–æ—Ä–æ–∂–Ω–æ–º —Å–æ–±—ã—Ç–∏–∏
     * @param {number} distance - —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –º–µ—Ç—Ä–∞—Ö
    * @param {string} type - —Ç–∏–ø –º–µ—Ç–∫–∏ (dps, patrol, sos –∏ —Ç.–¥.)
     * @param {string} comment - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –º–µ—Ç–∫–µ
     */
    /**
     * –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –≥–æ—Ç–æ–≤–æ–µ –∞—É–¥–∏–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
     * @param {string} audioUrl - URL –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞
     */
    function playAudioWarning(audioUrl) {
        try {
            stopWarningOutput();
            const audio = new Audio(audioUrl);
            currentWarningAudio = audio;
            audio.volume = 1;
            audio.play().catch(err => {
                console.warn('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ:', err);
                // –ï—Å–ª–∏ –∞—É–¥–∏–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏
                useSpeechSynthesis = true;
            });
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ:', e);
        }
    }
    
    async function speakWarning(distance, type, comment) {
        if (!voiceStyle) voiceStyle = 'standard';
        stopWarningOutput();

        // v2: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º ¬´–∂–∏–≤—É—é¬ª –æ–∑–≤—É—á–∫—É –Ω–∞ –ª–µ—Ç—É (–º–æ–∂–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å —É–ª–∏—Ü—ã/–≤—Ä–µ–º—è/–ª—é–±—ã–µ —Ñ—Ä–∞–∑—ã).
        // MP3 –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ Web Speech API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω).
        if (window.speechSynthesis) {
            useWebSpeechAPI(distance, type);
            return;
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
        const distanceCategory = distance < 200 ? 'close' : 'far';
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º MP3 —Ñ–∞–π–ª
        const audioFile = voiceStyle === 'cheeky' 
            ? `warning_cheeky_${distanceCategory}.mp3` 
            : `warning_standard_${distanceCategory}.mp3`;
        
        try {
            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å MP3 –∏–∑ Supabase Storage
            if (typeof _sb !== 'undefined' && _sb.storage) {
                const { data } = await _sb.storage
                    .from('audio')
                    .createSignedUrl(audioFile, 3600);
                
                if (data?.signedUrl) {
                    const audio = new Audio(data.signedUrl);
                    currentWarningAudio = audio;
                    audio.volume = 1.0;
                    audio.play().catch(e => {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ MP3:', e);
                        useWebSpeechAPI(distance, type);
                    });
                    console.log(`üîä –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç—Å—è: ${audioFile}`);
                    return;
                }
            }
        } catch (e) {
            console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${audioFile}:`, e?.message);
        }
        
        // –ï—Å–ª–∏ —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏ MP3 —Ç–æ–∂–µ –Ω–µ —É–¥–∞–ª–æ—Å—å ‚Äî –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∞ –≤—ã—Ö–æ–¥–∏–º.
    }
    
    /**
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Web Speech API –∫–∞–∫ fallback (—Å –Ω–æ–≤—ã–º —Ç–µ–∫—Å—Ç–æ–º –æ–∑–≤—É—á–∫–∏)
     */
    function useWebSpeechAPI(distance, type) {
        if (!window.speechSynthesis) {
            console.warn('Web Speech API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            console.warn('–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä, –≤–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–µ–Ω Chrome, Edge –∏–ª–∏ Safari');
            return;
        }

        // –ü—ã—Ç–∞–µ–º—Å—è –≤—ã–±—Ä–∞—Ç—å —Ä—É—Å—Å–∫–∏–π –≥–æ–ª–æ—Å (–µ—Å–ª–∏ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ)
        try {
            if (!window.__ttsVoicesReady) {
                window.__ttsVoicesReady = true;
                try {
                    // –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å–ø–∏—Å–∫–∞ –≥–æ–ª–æ—Å–æ–≤
                    window.speechSynthesis.getVoices();
                } catch(e) {}
                try {
                    window.speechSynthesis.onvoiceschanged = () => {
                        try { window.__ttsVoices = window.speechSynthesis.getVoices() || []; } catch(e) {}
                    };
                } catch(e) {}
                try { window.__ttsVoices = window.speechSynthesis.getVoices() || []; } catch(e) {}
            }
        } catch (e) {}

        function pickRussianVoice() {
            try {
                const voices = (window.__ttsVoices && Array.isArray(window.__ttsVoices))
                    ? window.__ttsVoices
                    : (window.speechSynthesis.getVoices() || []);
                const ru = voices.filter(v => String(v?.lang || '').toLowerCase().startsWith('ru'));
                if (!ru.length) return null;
                // –°—Ç–∞—Ä–∞–µ–º—Å—è –≤—ã–±—Ä–∞—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ "–ø—Ä–∏—è—Ç–Ω—ã–π" (—á–∞—Å—Ç–æ Google/–Ø–Ω–¥–µ–∫—Å/Windows)
                const preferred = ru.find(v => /google|yandex|windows|microsoft/i.test(String(v?.name || '')));
                return preferred || ru[0];
            } catch (e) {
                return null;
            }
        }
        
        // –û–∫—Ä—É–≥–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
        let distancePretty;
        if (distance > 1000) {
            distancePretty = Math.round(distance / 100) * 100;
        } else if (distance > 100) {
            distancePretty = Math.round(distance / 10) * 10;
        } else {
            distancePretty = Math.round(distance);
        }
        
        let text;
        const messageByType = {
            dps: `–í–ø–µ—Ä–µ–¥–∏ –ø–æ—Å—Ç –î–ü–° —á–µ—Ä–µ–∑ ${distancePretty} –º–µ—Ç—Ä–æ–≤. –°–æ–±–ª—é–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –∏ –±—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã.`,
            patrol: `–í–ø–µ—Ä–µ–¥–∏ –¥–æ—Ä–æ–∂–Ω—ã–π —Ä–µ–π–¥ —á–µ—Ä–µ–∑ ${distancePretty} –º–µ—Ç—Ä–æ–≤. –î–≤–∏–≥–∞–π—Ç–µ—Å—å —Å–ø–æ–∫–æ–π–Ω–æ –∏ –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏–π.`,
            specbat: `–í–ø–µ—Ä–µ–¥–∏ —É—Å–∏–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å (—Å–ø–µ—Ü–±–∞—Ç) —á–µ—Ä–µ–∑ ${distancePretty} –º–µ—Ç—Ä–æ–≤. –°–æ–±–ª—é–¥–∞–π—Ç–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤.`,
            motobat: `–í–ø–µ—Ä–µ–¥–∏ –ø–∞—Ç—Ä—É–ª—å –º–æ—Ç–æ–±–∞—Ç–∞ —á–µ—Ä–µ–∑ ${distancePretty} –º–µ—Ç—Ä–æ–≤. –°–Ω–∏–∑—å—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å –∏ –¥–µ—Ä–∂–∏—Ç–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏—é.`,
            cargo_control: `–í–ø–µ—Ä–µ–¥–∏ –≥—Ä—É–∑–æ–≤–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å —á–µ—Ä–µ–∑ ${distancePretty} –º–µ—Ç—Ä–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≥—Ä—É–∑–∞.`,
            camera: `–í–ø–µ—Ä–µ–¥–∏ —É—á–∞—Å—Ç–æ–∫ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è —á–µ—Ä–µ–∑ ${distancePretty} –º–µ—Ç—Ä–æ–≤. –ë—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã.`,
            dtp: `–í–ø–µ—Ä–µ–¥–∏ –î–¢–ü —á–µ—Ä–µ–∑ ${distancePretty} –º–µ—Ç—Ä–æ–≤. –°–Ω–∏–∑—å—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å –∏ —Å–æ–±–ª—é–¥–∞–π—Ç–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏—é.`,
            works: `–í–ø–µ—Ä–µ–¥–∏ –¥–æ—Ä–æ–∂–Ω—ã–µ —Ä–∞–±–æ—Ç—ã —á–µ—Ä–µ–∑ ${distancePretty} –º–µ—Ç—Ä–æ–≤. –î–≤–∏–≥–∞–π—Ç–µ—Å—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ.`,
            sos: `–í–ø–µ—Ä–µ–¥–∏ SOS-–∑–∞–ø—Ä–æ—Å –ø–æ–º–æ—â–∏ —á–µ—Ä–µ–∑ ${distancePretty} –º–µ—Ç—Ä–æ–≤. –ü—Ä–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–∫–∞–∂–∏—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫—É.`,
            danger: `–í–ø–µ—Ä–µ–¥–∏ –æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ –¥–æ—Ä–æ–≥–µ —á–µ—Ä–µ–∑ ${distancePretty} –º–µ—Ç—Ä–æ–≤. –ë—É–¥—å—Ç–µ –æ—Å–æ–±–µ–Ω–Ω–æ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã.`,
            traffic_jam: `–í–ø–µ—Ä–µ–¥–∏ –ø—Ä–æ–±–∫–∞ —á–µ—Ä–µ–∑ ${distancePretty} –º–µ—Ç—Ä–æ–≤. –ü–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∑–¥.`
        };

        if (voiceStyle === 'cheeky') {
            text = messageByType[type] || `–í–ø–µ—Ä–µ–¥–∏ –¥–æ—Ä–æ–∂–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ —á–µ—Ä–µ–∑ ${distancePretty} –º–µ—Ç—Ä–æ–≤. –ë—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã.`;
        } else {
            text = messageByType[type] || `–í–ø–µ—Ä–µ–¥–∏ –¥–æ—Ä–æ–∂–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ —á–µ—Ä–µ–∑ ${distancePretty} –º–µ—Ç—Ä–æ–≤. –ë—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã.`;
        }
        
        // –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ MONOLITH 180: –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞ ‚Äî —Å—Ç–∞–≤–∏–º –≤ –æ—á–µ—Ä–µ–¥—å
        console.log(`üîä –û–∑–≤—É—á–∫–∞ (${voiceStyle}): ${text.substring(0, 50)}...`);
        aiSpeak(text);
    }
    
    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –º–∞—Ä–∫–µ—Ä–∞ –∏ –≤—ã–¥–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
     * @param {Object} marker - –æ–±—ä–µ–∫—Ç –º–∞—Ä–∫–µ—Ä–∞ –∏–∑ –ë–î
     * @param {Array} userCoords - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [lat, lon]
     */
    function checkMarkerDistance(marker, userCoords) {
            if (!userCoords || userCoords.length < 2) return;
            if (proximityRequiresFollow && !autoFollow) return;

            // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –º–∞—Ä–∫–µ—Ä–∞: coords: [lat,lon] –∏–ª–∏ latitude/longitude
            let mLat = null, mLon = null;
            if (marker.coords && Array.isArray(marker.coords) && marker.coords.length >= 2) {
                // –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã —Ö—Ä–∞–Ω—è—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –≤–∏–¥–µ [lon, lat] –∏–ª–∏ [lat, lon] ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º —É–≥–∞–¥–∞—Ç—å.
                // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –¥–æ–ª–≥–æ—Ç—É –≤ –ø–µ—Ä–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ (|value| > 90), –º–µ–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫.
                const a = Number(marker.coords[0]);
                const b = Number(marker.coords[1]);
                if (Math.abs(a) <= 90 && Math.abs(b) <= 180) {
                    // —Å—á–∏—Ç–∞–µ–º coords = [lat, lon]
                    mLat = a; mLon = b;
                } else if (Math.abs(a) <= 180 && Math.abs(b) <= 90) {
                    // –≤–æ–∑–º–æ–∂–Ω–æ coords = [lon, lat]
                    mLat = b; mLon = a;
                } else {
                    // fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ç–æ—Ä–æ–π –∫–∞–∫ –¥–æ–ª–≥–æ—Ç—É
                    mLat = a; mLon = b;
                }
            } else if (typeof marker.latitude === 'number' && typeof marker.longitude === 'number') {
                mLat = marker.latitude; mLon = marker.longitude;
            } else if (marker.lat && marker.lon) {
                mLat = Number(marker.lat); mLon = Number(marker.lon);
            }
            if (mLat === null || mLon === null) return;

            const distance = calculateDistance(userCoords[0], userCoords[1], mLat, mLon);
        
        const markerId = marker.id;
        const currentNotification = distanceNotifications.get(markerId);
        const warningMax = getDynamicWarningMaxMeters();
        const warningMin = getWarningMinMeters(warningMax);
        const nearThreshold = getNearThresholdMeters(warningMax);

        const prevState = markerDistanceState.get(markerId);
        let trend = prevState?.lastTrend || 'approaching';
        if (prevState && typeof prevState.lastDistance === 'number') {
            if (distance > prevState.lastDistance + 25) trend = 'away';
            else if (distance < prevState.lastDistance - 25) trend = 'approaching';
        }
        markerDistanceState.set(markerId, { lastDistance: distance, lastTrend: trend, lastUpdate: Date.now() });

        if (trend === 'away') {
            if (currentNotification) {
                distanceNotifications.delete(markerId);
                stopWarningOutput();
            }
            if (proximityBannerState.markerId === markerId) {
                clearActiveProximityMarker(markerId);
            }
            return;
        }

        if (distance <= warningMax) {
            setActiveProximityMarker(markerId, marker.type, [mLat, mLon], distance);
        } else if (proximityBannerState.markerId === markerId) {
            clearActiveProximityMarker(markerId);
        }

        // MONOLITH 180: –ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ ‚Äî –æ–∑–≤—É—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ < 1000–º
        if (!isMonolithVoiceEnabled()) return;
        const threshold = 1000;
        const hysteresis = 1100;

        if (distance < threshold && currentNotification !== 'near1k') {
            const label = getMarkerLabel(marker.type);
            aiSpeak(`–í–Ω–∏–º–∞–Ω–∏–µ, –≤–ø–µ—Ä–µ–¥–∏ ${label}`);
            distanceNotifications.set(markerId, 'near1k');
            console.log(`üìç –ì–æ–ª–æ—Å: –º–∞—Ä–∫–µ—Ä ${markerId} (${distance.toFixed(0)}–º)`);
        } else if (distance > hysteresis && currentNotification) {
            distanceNotifications.delete(markerId);
        }
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∏–ª—å –æ–∑–≤—É—á–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏
     * @param {string} style - 'standard' –∏–ª–∏ 'cheeky'
     */
    function setVoiceStyle(style) {
        if (!isViewingOwnProfile) return;
        voiceStyle = style;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
        const standardBtn = document.getElementById('voiceStyleStandard');
        const cheekyBtn = document.getElementById('voiceStyleCheeky');
        const descriptionEl = document.getElementById('voiceStyleDescription');
        
        if (style === 'standard') {
            standardBtn.style.background = '#34c759';
            standardBtn.style.color = 'white';
            cheekyBtn.style.background = '#9c9c9c';
            cheekyBtn.style.color = 'white';
            descriptionEl.textContent = '‚ú® –í—ã–±—Ä–∞–Ω: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å—Ç–∏–ª—å –æ–∑–≤—É—á–∫–∏';
        } else if (style === 'cheeky') {
            standardBtn.style.background = '#9c9c9c';
            standardBtn.style.color = 'white';
            cheekyBtn.style.background = '#34c759';
            cheekyBtn.style.color = 'white';
            descriptionEl.textContent = 'üòé –í—ã–±—Ä–∞–Ω: –î–µ—Ä–∑–∫–∏–π —Å—Ç–∏–ª—å –æ–∑–≤—É—á–∫–∏';
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –≤ localStorage
        try {
            localStorage.setItem('voiceStyle', style);
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∏–ª—å –æ–∑–≤—É—á–∫–∏:', e);
        }
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –º–∞—Ä–∫–µ—Ä–∞ —Å—Ä–∞–∑—É
        try { updateUserLocationMarker(); } catch(e){}
        
        console.log(`üîä –°—Ç–∏–ª—å –æ–∑–≤—É—á–∫–∏ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${style}`);
    }
    
    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å –æ–∑–≤—É—á–∫–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
     */
    function loadVoiceStyle() {
        try {
            const savedStyle = localStorage.getItem('voiceStyle');
            if (savedStyle === 'cheeky' || savedStyle === 'standard') {
                voiceStyle = savedStyle;
            }
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∏–ª—å –æ–∑–≤—É—á–∫–∏:', e);
        }
    }

    function updateWarningDistanceUI() {
        const label = document.getElementById('warningDistanceLabel');
        const range = document.getElementById('warningDistanceRange');
        const meters = Math.max(300, Number(warningDistanceMeters) || 800);
        if (label) {
            label.textContent = meters >= 1000 ? `${(meters / 1000).toFixed(1)} –∫–º` : `${meters} –º`;
        }
        if (range && String(range.value) !== String(meters)) {
            range.value = meters;
        }
    }

    function setWarningDistance(value) {
        if (!isViewingOwnProfile) return;
        warningDistanceMeters = Math.max(300, Math.min(2000, Number(value) || 800));
        updateWarningDistanceUI();
        distanceNotifications.clear();
        try {
            localStorage.setItem('warningDistanceMeters', String(warningDistanceMeters));
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:', e);
        }
    }

    function loadWarningDistance() {
        try {
            const saved = localStorage.getItem('warningDistanceMeters');
            if (saved) warningDistanceMeters = Number(saved) || warningDistanceMeters;
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:', e);
        }
        updateWarningDistanceUI();
    }

    function setProximityMode(requireFollow) {
        if (!isViewingOwnProfile) return;
        proximityRequiresFollow = !!requireFollow;
        const alwaysBtn = document.getElementById('proximityModeAlways');
        const followBtn = document.getElementById('proximityModeFollow');
        const descriptionEl = document.getElementById('proximityModeDescription');

        if (proximityRequiresFollow) {
            if (alwaysBtn) { alwaysBtn.style.background = '#9c9c9c'; alwaysBtn.style.color = 'white'; }
            if (followBtn) { followBtn.style.background = '#34c759'; followBtn.style.color = 'white'; }
            if (descriptionEl) descriptionEl.textContent = '–í—ã–±—Ä–∞–Ω: –¢–æ–ª—å–∫–æ –ø—Ä–∏ –∞–≤—Ç–æ—Å–ª–µ–∂–µ–Ω–∏–∏';
        } else {
            if (alwaysBtn) { alwaysBtn.style.background = '#34c759'; alwaysBtn.style.color = 'white'; }
            if (followBtn) { followBtn.style.background = '#9c9c9c'; followBtn.style.color = 'white'; }
            if (descriptionEl) descriptionEl.textContent = '–í—ã–±—Ä–∞–Ω: –í—Å–µ–≥–¥–∞';
        }

        try {
            localStorage.setItem('proximityRequiresFollow', proximityRequiresFollow ? 'true' : 'false');
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∂–∏–º –æ–ø–æ–≤–µ—â–µ–Ω–∏–π:', e);
        }

        updateFollowButton();
    }

    function loadProximityMode() {
        try {
            const saved = localStorage.getItem('proximityRequiresFollow');
            if (saved === 'true' || saved === 'false') {
                proximityRequiresFollow = (saved === 'true');
            }
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∂–∏–º –æ–ø–æ–≤–µ—â–µ–Ω–∏–π:', e);
        }
        setProximityMode(proximityRequiresFollow);
    }

        function isReliableGeoPosition(lat, lon, accuracyMeters) {
                const a = Number(accuracyMeters);
                if (!Number.isFinite(lat) || !Number.isFinite(lon)) return false;
                if (!Number.isFinite(a)) return false;
                // –ï—Å–ª–∏ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –æ—á–µ–Ω—å –±–æ–ª—å—à–∞—è ‚Äî —ç—Ç–æ –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ IP/–∫—ç—à-–ª–æ–∫–∞—Ü–∏—è (Telegram Desktop/Web)
                if (a > 5000) return false;
                // –ï—Å–ª–∏ —Ç–æ—á–∫–∞ –Ω–µ –≤ –î–ù–† ‚Äî —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                if (!isInDonetskRegion([lat, lon])) return false;
                return true;
        }

    function initGPS() {
        if (!navigator.geolocation) {
            console.warn('Geolocation –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º');
            return;
        }
        
        // –û–ø—Ü–∏–∏ –¥–ª—è geolocation
        const options = {
            enableHighAccuracy: true,
            timeout: 15000,            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: —É–≤–µ–ª–∏—á–∏–ª–∏ —Ç–∞–π–º–∞—É—Ç
            maximumAge: 0              // –ù–µ –±–µ—Ä—ë–º –∫—ç—à ‚Äî –≤ WebView –æ–Ω —á–∞—Å—Ç–æ –¥–∞—ë—Ç –Ω–µ–≤–µ—Ä–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        };
        
        // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è —Å –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ–º —Å–∫–æ—Ä–æ—Å—Ç–∏
        try {
            // –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ Permissions API ‚Äî –ª–æ–≥–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø–æ–ª–µ–∑–Ω–æ –¥–ª—è iOS/Android –≤ WebView)
            if (navigator.permissions && navigator.permissions.query) {
                try {
                    navigator.permissions.query({ name: 'geolocation' }).then(p => {
                        console.log('GPS permission state:', p.state);
                        p.onchange = () => console.log('GPS permission changed:', p.state);
                    }).catch(()=>{});
                } catch(e){}
            }

            gpsWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    // –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                    const { latitude, longitude, accuracy } = position.coords;
                    const now = Date.now();

                    lastGpsAccuracyMeters = Number(accuracy);
                    const latNum = Number(latitude);
                    const lonNum = Number(longitude);
                    const reliableNow = isReliableGeoPosition(latNum, lonNum, Number(accuracy));
                    gpsReliable = reliableNow;

                    if (!reliableNow) {
                        if (!gpsWarnedUnreliable) {
                            gpsWarnedUnreliable = true;
                            console.warn('‚ö†Ô∏è –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ—Ç–æ—á–Ω–∞—è (–±–æ–ª—å—à–∞—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –∏–ª–∏ —Ç–æ—á–∫–∞ –≤–Ω–µ –î–ù–†). –í–∫–ª—é—á–∏—Ç–µ GPS –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é –¥–ª—è Telegram, –∑–∞—Ç–µ–º –ø–æ–¥–æ–∂–¥–∏—Ç–µ 10‚Äì20 —Å–µ–∫—É–Ω–¥.');
                        }
                        if (lastReliableUserLocation) {
                            // –ù–µ –ø–µ—Ä–µ—Ç–∏—Ä–∞–µ–º —Ç–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º—É—Å–æ—Ä–æ–º
                            return;
                        }
                        // –ï—Å–ª–∏ —Ç–æ—á–Ω—ã—Ö –µ—â—ë –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∂–µ–º —Ö–æ—Ç—è –±—ã –º–∞—Ä–∫–µ—Ä, –Ω–æ –±–µ–∑ —Å–∏–Ω–∫–∞ —Ä–∞–¥–∏—É—Å–∞ –∏ –∞–≤—Ç–æ—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
                        userSpeedKmh = 0;
                        userLocation = [latNum, lonNum];
                        updateUserLocationMarker();
                        updateSpeedometerUI(userSpeedKmh);
                        console.log(`üìç GPS (–Ω–µ —Ç–æ—á–Ω–æ): ${latNum.toFixed(4)}, ${lonNum.toFixed(4)} (—Ç–æ—á–Ω–æ—Å—Ç—å: ${Number(accuracy).toFixed(0)}–º)`);
                        return;
                    }

                    // –í—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ (–º/c -> –∫–º/—á)
                    if (lastUserPositionCoords && lastUserPositionTime) {
                        const prev = lastUserPositionCoords;
                        const dt = (now - lastUserPositionTime) / 1000; // —Å–µ–∫
                        if (dt > 0) {
                            const dist = calculateDistance(prev[0], prev[1], latitude, longitude); // –º–µ—Ç—Ä—ã
                            const speedMs = dist / dt; // –º/—Å
                            userSpeedKmh = Math.round(speedMs * 3.6);
                        }
                    }
                    lastUserPositionCoords = [latitude, longitude];
                    lastUserPositionTime = now;

                    userLocation = [latitude, longitude];
                    lastReliableUserLocation = [latitude, longitude];

                    // –ü–∏—à–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É –≤ service worker (–∫–∞–∫ "—Ñ–æ–Ω–æ–≤–æ–π" –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã)
                    // –í–∞–∂–Ω–æ: —Å–∞–º service worker –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é.
                    try {
                        if (window.SafeDrivePwa && typeof window.SafeDrivePwa.postLocationToServiceWorker === 'function') {
                            window.SafeDrivePwa.postLocationToServiceWorker(position);
                        }
                    } catch (e) {}

                    // –æ–±–Ω–æ–≤–ª—è–µ–º –æ–ø–æ—Ä–Ω—É—é —Ç–æ—á–∫—É –¥–ª—è —Ä–∞–¥–∏—É—Å–∞ Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–ø–∏—Å–∞–Ω)
                    syncHelpSubscriberHomeCoords(false).catch(()=>{});

                    // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ (–≤–∫–ª—é—á–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é —Å–∫–æ—Ä–æ—Å—Ç–∏/–∞—á–∏–≤–æ–∫/—Å—Ç–∏–ª—è)
                    updateUserLocationMarker();
                    updateSpeedometerUI(userSpeedKmh);

                    // –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –º–µ—Ç–æ–∫ –î–ü–°/–°–ø–µ—Ü–±–∞—Ç
                    maybeCheckSmartHint(latitude, longitude);

                    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –µ—Å–ª–∏ –∞–≤—Ç–æ—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ
                    if (autoFollow && myMap && userLocation && !disableAutoFollowOnce) {
                        try { myMap.setCenter(userLocation, 17); } catch (e) { console.warn(e); }
                    }
                    if (disableAutoFollowOnce) disableAutoFollowOnce = false;
                    console.log(`üìç GPS: ${latitude.toFixed(4)}, ${longitude.toFixed(4)} (—Ç–æ—á–Ω–æ—Å—Ç—å: ${accuracy.toFixed(0)}–º) speed: ${userSpeedKmh} km/h`);
                },
                (error) => {
                    // –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                    console.warn('–û—à–∏–±–∫–∞ GPS:', error.message);
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            console.warn('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ GPS –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ');
                            // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö WebView –ø–æ–ª–µ–∑–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                                console.warn('iOS: –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é.');
                            }
                            break;
                        case error.POSITION_UNAVAILABLE:
                            console.warn('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Äî –ø—Ä–æ–±—É—é –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é');
                            // –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
                            navigator.geolocation.getCurrentPosition((pos) => {
                                const { latitude, longitude } = pos.coords;
                                userLocation = [latitude, longitude];
                                lastUserPositionCoords = [latitude, longitude];
                                lastUserPositionTime = Date.now();
                                updateUserLocationMarker();
                            }, ()=>{}, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
                            break;
                        case error.TIMEOUT:
                            console.warn('–ò—Å—Ç–µ–∫–ª–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è GPS ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑');
                            break;
                    }
                },
                options
            );
        } catch (e) {
            console.warn('watchPosition failed:', e);
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ
    function updateUserLocationMarker() {
        if (!userLocation || !myMap) return;

        if (isAdmin && adminInvisible) {
            if (userLocationMarker) {
                try { myMap.geoObjects.remove(userLocationMarker); } catch(e) {}
                userLocationMarker = null;
            }
            return;
        }

        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if (userLocationMarker) {
            try { myMap.geoObjects.remove(userLocationMarker); } catch(e){}
        }

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞
        const isCheeky = voiceStyle === 'cheeky';
        const speed = userSpeedKmh || 0; // km/h
        const size = Math.max(32, Math.min(64, 32 + Math.floor(speed / 2))); // —Ä–∞—Å—Ç—ë—Ç —Å —Å–∫–æ—Ä–æ—Å—Ç—å—é

        // –¶–≤–µ—Ç –∏ –±–∞–∑–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –ø–æ —Å—Ç–∏–ª—é –æ–∑–≤—É—á–∫–∏
        const baseColor = isCheeky ? '#ff3b30' : '#007aff';
        const glowColor = isCheeky ? '#ff8a80' : '#9ad1ff';

        // –≠–ª–µ–º–µ–Ω—Ç—ã –∞—á–∏–≤–æ–∫
        const hasBeta = currentAchievementCounts && currentAchievementCounts['beta_tester'];
        const hasSuitolog = currentAchievementCounts && (currentAchievementCounts['suitolog'] || currentAchievementCounts['suetolog'] || false);
        const hasPhantom = currentAchievementCounts && currentAchievementCounts['phantom_racer'];

        // –§–æ—Ä–º–∏—Ä—É–µ–º SVG –¥–ª—è –∏–∫–æ–Ω–∫–∏
        const crownSvg = hasBeta ? `<g transform="translate(${size/2 - 10},-8)"><path d="M2 12 L6 4 L10 12 L14 4 L18 12 L2 12 Z" fill="#ffd700" stroke="#b8860b" stroke-width="0.6"/></g>` : '';

        // –ü–ª–∞–º—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è/—Å—É–µ—Ç–æ–ª–æ–≥–∞
        const flameSvg = (speed >= 40 || hasSuitolog || hasPhantom) ? `<g transform="translate(${size - 6},${size/2 - 6})"><path d=\"M0 8 C2 4,6 2,8 0 C6 4,6 8,2 10 C0 8,0 8,0 8 Z\" fill=\"#ff6a00\" opacity=\"0.9\"/></g>` : '';

        let shapeSvg = '';
        if (isCheeky) {
            // –°–ø–æ—Ä—Ç–∫–∞—Ä/—Å—Ç—Ä–µ–ª–∞
            shapeSvg = `<polygon points=\"${size*0.1},${size*0.5} ${size*0.6},${size*0.1} ${size*0.9},${size*0.5} ${size*0.6},${size*0.9}\" fill=\"${baseColor}\" stroke=\"#fff\" stroke-width=\"1\" opacity=\"0.95\"/>`;
        } else {
            // –ö—Ä—É–≥ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
            shapeSvg = `<circle cx=\"${size/2}\" cy=\"${size/2}\" r=\"${size*0.28}\" fill=\"url(#g)\" stroke=\"#fff\" stroke-width=\"2\"/>`;
        }

        const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
  <defs>
    <radialGradient id="g" cx="50%" cy="40%" r="60%"><stop offset="0%" stop-color="${baseColor}" stop-opacity="1"/><stop offset="100%" stop-color="${glowColor}" stop-opacity="0.6"/></radialGradient>
  </defs>
  <rect width="100%" height="100%" fill="transparent"/>
  ${shapeSvg}
  ${flameSvg}
  ${crownSvg}
  <!-- –Ω–µ–±–æ–ª—å—à–æ–π –∫–æ–Ω—Ç—É—Ä –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ–Ω–∞—Ö -->
  <circle cx="${size/2}" cy="${size/2}" r="${size*0.49}" fill="none" stroke="rgba(0,0,0,0.04)" stroke-width="1"/>
</svg>`;

        if (isAdmin) {
            const adminSize = 36;
            const adminIconHtml = `
                <div class="admin-marker admin-marker--self">
                    <span class="admin-siren admin-siren-left"></span>
                    <span class="admin-siren admin-siren-right"></span>
                    üöó
                    <span class="admin-marker-badge">üëë</span>
                </div>
            `;
            userLocationMarker = new ymaps.Placemark(userLocation,
                {
                    hintContent: '–í—ã –∑–¥–µ—Å—å (–ê–¥–º–∏–Ω)',
                    balloonContent: `üëë –ê–¥–º–∏–Ω –Ω–∞ —Å–≤—è–∑–∏<br>–°–∫–æ—Ä–æ—Å—Ç—å: ${speed} –∫–º/—á`
                },
                {
                    iconLayout: 'default#imageWithContent',
                    iconContent: adminIconHtml,
                    iconImageSize: [adminSize, adminSize],
                    iconImageOffset: [-(adminSize/2), -(adminSize/2)],
                    zIndex: 1100
                }
            );
        } else {
            const svgUrl = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);

            userLocationMarker = new ymaps.Placemark(userLocation,
                {
                    hintContent: '–í—ã –∑–¥–µ—Å—å',
                    balloonContent: `üìç –í–∞—à–µ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ<br>–°–∫–æ—Ä–æ—Å—Ç—å: ${speed} –∫–º/—á`
                },
                {
                    iconLayout: 'default#image',
                    iconImageHref: svgUrl,
                    iconImageSize: [size, size],
                    iconImageOffset: [-(size/2), -(size/2)],
                    zIndex: 1000
                }
            );
        }

        myMap.geoObjects.add(userLocationMarker);

        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ —Ç–µ–∫—É—â–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ (–µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —Ä–∞–∑)
        if (!myMap.lastUserLocationUpdate) {
            try { myMap.setCenter(userLocation, 17); } catch(e){}
            myMap.lastUserLocationUpdate = true;
        }
    }
    
    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç –∫–∞—Ä—Ç—É –Ω–∞ —Ç–µ–∫—É—â–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –∏ –≤–∫–ª—é—á–∞–µ—Ç –∞–≤—Ç–æ—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
    function centerOnMyLocation() {
        if (!userLocation) {
            alert('–ü–æ–∑–∏—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –í–∫–ª—é—á–∏—Ç–µ GPS.');
            return;
        }
        autoFollow = true;
        updateFollowButton();
        try { monolithSetNavigationActive(autoFollow); } catch(e) {}
        try { myMap.setCenter(userLocation, 17); } catch (e) { console.warn(e); }
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Å–ª–µ–∂–µ–Ω–∏—è GPS
    function toggleFollow() {
        autoFollow = !autoFollow;
        updateFollowButton();
        try { monolithSetNavigationActive(autoFollow); } catch(e) {}
        if (autoFollow && userLocation && myMap) {
            try { myMap.setCenter(userLocation, 17); } catch(e) { console.warn(e); }
        }
    }

    function updateFollowButton() {
        const btn = document.getElementById('followToggleBtn');
        if (!btn) return;
        const modeText = proximityRequiresFollow ? '–û–ø–æ–≤–µ—â–µ–Ω–∏—è: —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∞–≤—Ç–æ—Å–ª–µ–∂–µ–Ω–∏–∏' : '–û–ø–æ–≤–µ—â–µ–Ω–∏—è: –≤—Å–µ–≥–¥–∞';
        if (autoFollow) {
            btn.classList.remove('inactive');
            btn.classList.add('active');
            btn.title = `–Ø –Ω–∞ –∫–∞—Ä—Ç–µ (–∞–≤—Ç–æ—Å–ª–µ–∂–µ–Ω–∏–µ –í–ö–õ)\n${modeText}`;
        } else {
            btn.classList.remove('active');
            btn.classList.add('inactive');
            btn.title = `–Ø –Ω–µ –Ω–∞ –∫–∞—Ä—Ç–µ (–∞–≤—Ç–æ—Å–ª–µ–∂–µ–Ω–∏–µ –í–´–ö–õ)\n${modeText}`;
        }
        const icon = autoFollow ? 'üëÅÔ∏è' : 'üö´';
        const badge = proximityRequiresFollow ? '<span class="follow-badge">P</span>' : '';
        btn.innerHTML = `<span class="follow-icon">${icon}</span>${badge}`;
        try { monolithSetNavigationActive(autoFollow); } catch(e) {}
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏ (—Ñ–æ—Ä–º—É–ª–∞ –≥–∞–≤–µ—Ä—Å–∏–Ω—É—Å–æ–≤)
    // coords1 –∏ coords2 - –º–∞—Å—Å–∏–≤—ã [—à–∏—Ä–æ—Ç–∞, –¥–æ–ª–≥–æ—Ç–∞]
    // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –º–µ—Ç—Ä–∞—Ö
    function calculateDistanceFromArrays(coords1, coords2) {
        const R = 6371000; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –º–µ—Ç—Ä–∞—Ö
        const lat1 = coords1[0] * Math.PI / 180;
        const lat2 = coords2[0] * Math.PI / 180;
        const deltaLat = (coords2[0] - coords1[0]) * Math.PI / 180;
        const deltaLon = (coords2[1] - coords1[1]) * Math.PI / 180;
        
        const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
                  Math.cos(lat1) * Math.cos(lat2) * Math.sin(deltaLon / 2) * Math.sin(deltaLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function playAlertSound() {
        try {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Web Audio API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Å—Ç–æ–≥–æ –∑–≤—É–∫–∞ "–±–∏–ø"
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800; // –ß–∞—Å—Ç–æ—Ç–∞ –∑–≤—É–∫–∞ –≤ Hz
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏ –∑–≤—É–∫–∞:', e?.message);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –∑–∞–±–∞–Ω–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    async function isUserBanned(userId) {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ bans —Å —Ç–∞–π–º–∞—É—Ç–æ–º 8 —Å–µ–∫
            const { data: banned, error } = await Promise.race([
                _sb.from('bans').select('*').eq('user_id', userId).maybeSingle(),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Ban check timeout')), 8000)
                )
            ]);
            if (error && error.code !== 'PGRST116') {
                console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –±–∞–Ω—è:', error?.message);
                return { isBanned: false, reason: null };
            }
            return {
                isBanned: banned ? true : false,
                reason: banned?.reason || null
            };
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –±–∞–Ω—è (timeout –∏–ª–∏ error):', e?.message || e);
            return { isBanned: false, reason: null };
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    async function initApp() {
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–≤–æ–π–Ω–æ–π –≤—ã–∑–æ–≤
        if (initAppInProgress) return;
        initAppInProgress = true;

        // –ü–ï–†–í–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ù—É–∂–µ–Ω –ª–∏ –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥–ª—è –ó–ë–¢?
        const hasBetaAccess = localStorage.getItem('beta_access_granted') === 'true';
        if (!hasBetaAccess) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤–≤–æ–¥–∞ –∫–æ–¥–∞
            const betaOverlay = document.getElementById('betaInviteOverlay');
            if (betaOverlay) betaOverlay.style.display = 'flex';
            // –°–∫—Ä—ã–≤–∞–µ–º splash screen
            const splash = document.getElementById('splashScreen');
            if (splash) splash.classList.add('hidden');
            initAppInProgress = false;
            return;
        }

        // –ï—Å–ª–∏ –±–µ—Ç–∞-–¥–æ—Å—Ç—É–ø –µ—Å—Ç—å - —Å–∫—Ä—ã–≤–∞–µ–º overlay
        const betaOverlay = document.getElementById('betaInviteOverlay');
        if (betaOverlay) betaOverlay.style.display = 'none';

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ Telegram
        const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
        if (!tgUser) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º –æ—Ç–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ Telegram
            const overlay = document.getElementById('tgAuthOverlay');
            if (overlay) overlay.style.display = 'flex';
            // –°–∫—Ä—ã–≤–∞–µ–º splash screen
            const splash = document.getElementById('splashScreen');
            if (splash) splash.classList.add('hidden');
            initAppInProgress = false;
            return;
        }

        // –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏ Telegram - —Å–∫—Ä—ã–≤–∞–µ–º overlay –µ—Å–ª–∏ –±—ã–ª –ø–æ–∫–∞–∑–∞–Ω
        const overlay = document.getElementById('tgAuthOverlay');
        if (overlay) overlay.style.display = 'none';

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–¥–º–∏–Ω–∞ —Ä–∞–Ω—å—à–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¢–û
        isAdmin = String(tgUser.id) === String(ADMIN_ID);

        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º Supabase –Ω–∞ authenticated (JWT –∏–∑ Telegram)
        await ensureSupabaseAuth();

        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ –ó–ë–¢ ‚Äî –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∞—á–∏–≤–∫—É "–ü–µ—Ä–≤–æ–ø—Ä–æ—Ö–æ–¥–µ—Ü"
        try {
            if (localStorage.getItem('beta_access_granted') === 'true') {
                await ensureUserAchievement(uid, 'beta_tester');
            }
        } catch(e) {}

        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–∞–Ω–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (—Å —Ç–∞–π–º–∞—É—Ç–æ–º)
            const banInfo = await Promise.race([
                isUserBanned(uid),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Ban check timeout')), 5000)
                )
            ]).catch(() => ({ isBanned: false })); // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É
            
            if (banInfo.isBanned) {
                let banMessage = '‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.';
                if (banInfo.reason) {
                    banMessage += `\n\n–ü—Ä–∏—á–∏–Ω–∞: ${banInfo.reason}`;
                }
                alert(banMessage);
                return;
            }

            // –ü–†–û–í–ï–†–Ø–ï–ú –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–ï
            const isMaintenanceActive = await checkMaintenanceStatus(isAdmin);
            if (isMaintenanceActive) {
                initAppInProgress = false;
                return; // –û–≤–µ—Ä–ª–µ–π –¢–û –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            }

        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:', e?.message || e);
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
        // isAdmin —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤—ã—à–µ
        if (isAdmin) {
            document.getElementById('adminBtn').classList.add('visible');
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–Ω–ª–∞–π–Ω-–±–µ–π–¥–∂ (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
        try { document.getElementById('onlineCountBadge').style.display = 'block'; } catch(e) {}

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏)
        try {
            const { data: driver } = await Promise.race([
                _sb.from('drivers').select('user_id,name,car_model,car_plate').eq('user_id', uid).maybeSingle(),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Driver check timeout')), 8000)
                )
            ]);
            if (!driver) {
                // –ï—Å–ª–∏ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ–± –∞–≤—Ç–æ
                document.getElementById('reg-user-name').textContent = (tgUser.first_name || '') + ' ' + (tgUser.last_name || '');
                openRegistrationModal();
            } else {
                // –ï—Å–ª–∏ –¥–∞, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
                currentDriver = driver;
            }
        } catch (e) {
            // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ drivers –ø–∞–¥–∞–µ—Ç –∏–∑-–∑–∞ –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ö–µ–º—ã, –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∂–µ–º —Ñ–æ—Ä–º—É
            console.warn('drivers table read failed:', e.message || e);
            document.getElementById('reg-user-name').textContent = (tgUser.first_name || '') + ' ' + (tgUser.last_name || '');
            openRegistrationModal();
        }

        // –ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª—è—Ç—å last_seen –∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        try {
            await Promise.race([
                updateLastSeen(),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('LastSeen timeout')), 5000)
                )
            ]).catch(() => console.warn('updateLastSeen timeout'));
            
            // heartbeat –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
            setInterval(() => { updateLastSeen().catch(()=>{}); }, 60*1000);
            // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –æ–Ω–ª–∞–π–Ω –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            await Promise.race([
                loadOnlineCount(),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('OnlineCount timeout')), 5000)
                )
            ]).catch(() => console.warn('loadOnlineCount timeout'));
            
            setInterval(() => { loadOnlineCount().catch(()=>{}); }, 30*1000);
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å heartbeat/online count:', e?.message || e);
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å –æ–∑–≤—É—á–∫–∏
        loadVoiceStyle();
        try { initMonolithVoiceToggle(); } catch(e) {}
        loadProximityMode();
        loadWarningDistance();
        loadSpeedometerPreference();
        restoreTypeCategoryPreference();
        loadNotificationsState();
        seedSafeDriveNewsNotifications();
        syncImportantNotificationsFeed({ silent: true }).catch(()=>{});
        if (!notifFeedSyncIntervalId) {
            notifFeedSyncIntervalId = setInterval(() => {
                syncImportantNotificationsFeed({ silent: true }).catch(()=>{});
            }, NOTIF_FEED_SYNC_INTERVAL_MS);
        }
        updateSpeedometerUI(userSpeedKmh);
        registerServiceWorker();
        // –ê–≤—Ç–æ-–ø–æ–¥–∫–ª—é—á–∞–µ–º Web Push, –µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —É–∂–µ –≤—ã–¥–∞–Ω–æ (–±–µ–∑ –Ω–æ–≤—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤)
        try {
            if ('Notification' in window && Notification.permission === 'granted') {
                if (window.SafeDrivePwa && typeof window.SafeDrivePwa.enableWebPush === 'function') {
                    window.SafeDrivePwa.enableWebPush().catch(()=>{});
                }
            }
        } catch (e) {}
        startProximityBannerLoop();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–¥–º–∏–Ω-–∫–∞–Ω–∞–ª –∏ —Å—Ç–∞—Ç—É—Å –Ω–µ–≤–∏–¥–∏–º–∫–∏
        initAdminBroadcastChannel();
        await refreshAdminInvisibleStatus();
        if (!adminInvisibleIntervalId) {
            adminInvisibleIntervalId = setInterval(() => {
                refreshAdminInvisibleStatus().catch(()=>{});
            }, 30000);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        initAppInProgress = false;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –º–∞—Ä–∫–µ—Ä–∞
    // t - —Ç–∏–ø –º–∞—Ä–∫–µ—Ä–∞, el - —ç–ª–µ–º–µ–Ω—Ç –∫–Ω–æ–ø–∫–∏
    function setType(t, el) {
        selectedType = t;
        // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å active —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å active –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–µ
        el.classList.add('active');

        // –ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∫–ª–∞–¥–∫—É –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–∏–ø—É
        const helpTypes = new Set(['sos', 'dtp', 'danger', 'works', 'traffic_jam']);
        const targetCategory = helpTypes.has(t) ? 'help' : 'patrol';
        switchTypeCategory(targetCategory);

        try {
            const comm = document.getElementById('m-comm');
            if (comm) {
                if (t === 'sos') comm.placeholder = 'SOS: –¢–∏–ø | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ–±–∏–ª –∫–æ–ª–µ—Å–æ | –ù—É–∂–µ–Ω –¥–æ–º–∫—Ä–∞—Ç)';
                else if (t === 'dps') comm.placeholder = '–î–ü–°: –°—Ç–∞—Ç—É—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: –†–∞–±–æ—Ç–∞—é—Ç / –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)';
                else if (t === 'specbat') comm.placeholder = '–°–ø–µ—Ü–±–∞—Ç: –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ | –ò–Ω—Ñ–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –í —Å—Ç–æ—Ä–æ–Ω—É —Ü–µ–Ω—Ç—Ä–∞ | –£—Å–∏–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)';
                else comm.placeholder = '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...';
            }
        } catch (e) {}
    }

    function switchTypeCategory(category, tabEl = null) {
        document.querySelectorAll('.type-tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.category === category);
        });
        document.querySelectorAll('.type-group').forEach(group => {
            group.classList.toggle('active', group.dataset.category === category);
        });

        // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∏–ø –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≤–∫–ª–∞–¥–∫–µ ‚Äî –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Ç–∏–ø –≤ —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–µ
        const currentActive = document.querySelector('.type-btn.active');
        const currentCategory = currentActive?.closest('.type-group')?.dataset?.category;
        if (currentCategory !== category) {
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            const firstBtn = document.querySelector(`.type-group[data-category="${category}"] .type-btn`);
            if (firstBtn) {
                firstBtn.classList.add('active');
                selectedType = firstBtn.dataset.type || selectedType;
            }
        }

        try { localStorage.setItem(TYPE_CATEGORY_STORAGE_KEY, category); } catch(e) {}

        if (tabEl && tabEl.dataset?.category !== category) {
            tabEl.classList.remove('active');
        }
    }

    function restoreTypeCategoryPreference() {
        let saved = 'patrol';
        try {
            const raw = localStorage.getItem(TYPE_CATEGORY_STORAGE_KEY);
            if (raw === 'help' || raw === 'patrol') saved = raw;
        } catch(e) {}
        switchTypeCategory(saved);
    }

    // ============= –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ó–ë–¢ –ü–†–ò–ì–õ–ê–®–ï–ù–ò–ô =============

    async function verifyBetaCode() {
        const codeInput = document.getElementById('betaInviteCode');
        const status = document.getElementById('betaStatus');
        const code = (codeInput.value || '').trim().toUpperCase();

        if (!code) {
            status.textContent = '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥';
            status.style.color = '#dc3545';
            status.style.display = 'block';
            return;
        }

        status.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
        status.style.color = '#007aff';
        status.style.display = 'block';

        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ –≤ –ë–î
            const { data, error } = await _sb.rpc('validate_beta_invite', { 
                p_code: code 
            });

            if (error) {
                throw new Error(error.message || '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞');
            }

            if (data && data.length > 0) {
                const result = data[0];
                
                if (!result.is_valid) {
                    status.textContent = '‚ùå ' + (result.message || '–ö–æ–¥ –Ω–µ –≤–∞–ª–∏–¥–µ–Ω');
                    status.style.color = '#dc3545';
                    status.style.display = 'block';
                    codeInput.style.borderColor = '#dc3545';
                    return;
                }

                // –ö–æ–¥ –≤–∞–ª–∏–¥–µ–Ω! –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                const { error: claimError } = await _sb.rpc('claim_beta_invite', { 
                    p_code: code,
                    p_user_id: String(uid)
                });

                if (claimError) {
                    throw claimError;
                }

                // –£—Å–ø–µ—à–Ω–æ! –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
                localStorage.setItem('beta_access_granted', 'true');
                localStorage.setItem('beta_code_used', code);
                localStorage.setItem('beta_access_date', new Date().toISOString());

                // –ê—á–∏–≤–∫–∞ –∑–∞ –≤—Ö–æ–¥ –≤ –ó–ë–¢
                try { await ensureUserAchievement(uid, 'beta_tester'); } catch(e) {}

                status.textContent = '‚úÖ –î–æ—Å—Ç—É–ø –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω! –ó–∞–≥—Ä—É–∑–∫–∞...';
                status.style.color = '#28a745';
                status.style.display = 'block';

                // –°–∫—Ä—ã–≤–∞–µ–º overlay –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                setTimeout(() => {
                    document.getElementById('betaInviteOverlay').style.display = 'none';
                    initAppInProgress = false;  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
                    initApp();
                }, 800);

            } else {
                status.textContent = '‚ùå –ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω';
                status.style.color = '#dc3545';
                status.style.display = 'block';
            }

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–¥–∞:', err);
            status.textContent = '‚ùå ' + (err?.message || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            status.style.color = '#dc3545';
            status.style.display = 'block';
            codeInput.style.borderColor = '#dc3545';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    function openRegistrationModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'hidden';
        document.getElementById('registrationModal').classList.add('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    function closeRegistrationModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        document.getElementById('registrationModal').classList.remove('active');
    }

    // –§—É–Ω–∫—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è (–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ—Ä—É—Ç—Å—è –∏–∑ Telegram)
    async function registerDriver(event) {
        event.preventDefault();

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ Telegram
        const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
        const name = (tgUser?.first_name || '') + ' ' + (tgUser?.last_name || '');
        const car = document.getElementById('driver-car').value;
        const plate = document.getElementById('driver-plate').value;

        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —ç—Ç–∏–º user_id
            const { data: existingDriver } = await queryWithTimeout(
                _sb.from('drivers').select('user_id').eq('user_id', uid).maybeSingle(),
                10000
            );
            
            if (existingDriver) {
                // –ï—Å–ª–∏ –≤–æ–¥–∏—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
                const { error } = await queryWithTimeout(
                    _sb.from('drivers').update({
                        name: name,
                        car_model: car,
                        car_plate: plate
                    }).eq('user_id', uid),
                    10000
                );

                if (!error) {
                    currentDriver = {
                        user_id: uid,
                        name: name,
                        car_model: car,
                        car_plate: plate,
                        votes_up: 0,
                        votes_down: 0,
                        markers_count: 0
                    };
                    closeRegistrationModal();
                    alert('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω, ' + name + '!');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + (error?.message || '–ø–æ–ø—ã—Ç–∞–π—Ç–µ –µ—â–µ —Ä–∞–∑'));
                }
            } else {
                // –ï—Å–ª–∏ –≤–æ–¥–∏—Ç–µ–ª—è –Ω–µ—Ç, –≤—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ
                const { error } = await queryWithTimeout(
                    _sb.from('drivers').insert([{
                        user_id: uid,
                        name: name,
                        car_model: car,
                        car_plate: plate
                    }]),
                    10000
                );

                if (!error) {
                    currentDriver = {
                        user_id: uid,
                        name: name,
                        car_model: car,
                        car_plate: plate,
                        votes_up: 0,
                        votes_down: 0,
                        markers_count: 0
                    };
                    closeRegistrationModal();
                    alert('‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, ' + name + '!');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + (error?.message || '–ø–æ–ø—ã—Ç–∞–π—Ç–µ –µ—â–µ —Ä–∞–∑'));
                }
            }
        } catch (e) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ AbortError –∏ timeout
            if (e?.name === 'AbortError' || e?.message?.includes('AbortError')) {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ç–∏\n\n–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:\n- –í–∫–ª—é—á–µ–Ω–∞ –º–æ–±–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å –∏–ª–∏ Wi-Fi\n- –ï—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            } else if (e?.message?.includes('Timeout')) {
                alert('‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç\n\n–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.');
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:\n\n' + (e?.message || String(e)));
            }
            console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', e);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    async function openProfileModal(viewUserId = null) {
        // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω ID –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–º–æ—Ç—Ä–∏–º –µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—å
        if (viewUserId && String(viewUserId) !== String(uid)) {
            return openOtherUserProfile(viewUserId);
        }

        isViewingOwnProfile = true;

        const voiceStandardBtn = document.getElementById('voiceStyleStandard');
        const voiceCheekyBtn = document.getElementById('voiceStyleCheeky');
        const warningDistanceRange = document.getElementById('warningDistanceRange');
        const proximityAlwaysBtn = document.getElementById('proximityModeAlways');
        const proximityFollowBtn = document.getElementById('proximityModeFollow');
        if (voiceStandardBtn) { voiceStandardBtn.disabled = false; voiceStandardBtn.style.opacity = '1'; }
        if (voiceCheekyBtn) { voiceCheekyBtn.disabled = false; voiceCheekyBtn.style.opacity = '1'; }
        if (warningDistanceRange) { warningDistanceRange.disabled = false; warningDistanceRange.style.opacity = '1'; }
        if (proximityAlwaysBtn) { proximityAlwaysBtn.disabled = false; proximityAlwaysBtn.style.opacity = '1'; }
        if (proximityFollowBtn) { proximityFollowBtn.disabled = false; proximityFollowBtn.style.opacity = '1'; }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–æ—Ñ–∏–ª—è
        try {
            const { data: driver } = await _sb.from('drivers').select('user_id,name,car_model,car_plate,avatar_url').eq('user_id', uid).maybeSingle();
            if (driver) currentDriver = driver;
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ drivers:', e?.message || e);
        }

        if (!currentDriver) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ—Ç
            openRegistrationModal();
            return;
        }

        // –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Ç–∞–±–ª–∏—Ü—ã markers
        let marks_count = 0, likes = 0, dislikes = 0;
        try {
            const { data: markers } = await _sb.from('markers').select('votes_up,votes_down').eq('author_id', uid);
            if (markers) {
                marks_count = markers.length;
                markers.forEach(m => {
                    likes += m.votes_up || 0;
                    dislikes += m.votes_down || 0;
                });
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á—ë—Ç–µ –º–∞—Ä–∫–µ—Ä–æ–≤:', e?.message || e);
        }

        // –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–π SOS-–±–æ–Ω—É—Å (+50 –∑–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—É—é –ø–æ–º–æ—â—å)
        const sosBonus = await getUserSosBonus(uid);

        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        const displayName = currentDriver.name || ((window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name) || '');
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä (—Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ –µ—Å–ª–∏ –µ—Å—Ç—å)
        const avatarEl = document.getElementById('profile-avatar-display');
        if (currentDriver.avatar_url) {
            avatarEl.style.backgroundImage = `url('${currentDriver.avatar_url}')`;
            avatarEl.style.backgroundSize = 'cover';
            avatarEl.style.backgroundPosition = 'center';
            avatarEl.textContent = '';
            document.getElementById('profile-avatar-url').value = currentDriver.avatar_url;
            document.getElementById('profile-avatar-value').value = '';
        } else {
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º emoji
            avatarEl.style.backgroundImage = 'none';
            avatarEl.textContent = 'üë§';
            document.getElementById('profile-avatar-display').textContent = 'üë§';
            document.getElementById('profile-avatar-value').value = 'üë§';
            document.getElementById('profile-avatar-url').value = '';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        document.getElementById('edit-car-model').value = currentDriver.car_model || '';
        document.getElementById('edit-car-plate').value = currentDriver.car_plate || '';
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º –≤–æ–¥–∏—Ç–µ–ª–µ–º"
        const isTrusted = (likes >= (typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20));
        const isAdminProfile = isAdminUserId(uid);
        const profileNameEl = document.getElementById('profile-name-text');
        if (isAdminProfile) {
            profileNameEl.textContent = displayName;
            profileNameEl.classList.add('admin-name');
            profileNameEl.classList.remove('trusted');
        } else {
            profileNameEl.textContent = (isTrusted ? '‚≠ê ' : '') + displayName;
            if (isTrusted) profileNameEl.classList.add('trusted'); else profileNameEl.classList.remove('trusted');
            profileNameEl.classList.remove('admin-name');
        }
        updateProfileAdminBadges(isAdminProfile);
        const karmaPoints = Math.max(0, (likes - dislikes) + marks_count + sosBonus);
        document.getElementById('profile-rating').textContent = `${karmaPoints}`;
        document.getElementById('profile-marks-count').textContent = marks_count;
        document.getElementById('profile-votes-sum').textContent = karmaPoints;
        document.getElementById('profile-likes').textContent = likes;
        document.getElementById('profile-dislikes').textContent = dislikes;
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –¥–æ–≤–µ—Ä–∏—è
        const trustStatusEl = document.getElementById('profile-trust-status');
        if (isAdminProfile) {
            trustStatusEl.innerHTML = `üëë ${ADMIN_TITLE_LABEL}`;
            trustStatusEl.style.color = '#d4af37';
        } else if (karmaPoints >= 50) {
            trustStatusEl.innerHTML = 'üõü –í—ã—Ä—É—á–∞—Ç–æ—Ä';
            trustStatusEl.style.color = '#1e88e5';
        } else if (isTrusted) {
            trustStatusEl.innerHTML = '‚≠ê –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å';
            trustStatusEl.style.color = '#b8860b';
        } else {
            trustStatusEl.innerHTML = `ü§ù –£—á–∞—Å—Ç–Ω–∏–∫ –≤–∑–∞–∏–º–æ–ø–æ–º–æ—â–∏ (${karmaPoints} –æ—á–∫–æ–≤)`;
            trustStatusEl.style.color = 'var(--blue)';
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        try {
            const ach = await loadAchievements();
            const profileNameEl = document.getElementById('profile-name-text');
            profileNameEl.title = `–°—Ç–∞—Ç—É—Å: ${ach.title}`;

            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –±–ª–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π, –µ—Å–ª–∏ –µ—Å—Ç—å
            const existingAchBlock = document.getElementById('profile-achievements-block');
            if (existingAchBlock) existingAchBlock.remove();

            // –°–æ–∑–¥–∞–µ–º –±–ª–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
            let achievementsHTML = '<div id="profile-achievements-block" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">';
            achievementsHTML += `<div style="font-size: 13px; font-weight: 700; margin-bottom: 6px; color: var(--blue);">üèÖ –°—Ç–∞—Ç—É—Å: ${ach.title}</div>`;
            achievementsHTML += `<div style="font-size: 12px; color: var(--gray); margin-bottom: 10px;">–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${ach.completedCount}/${ach.totalCount}</div>`;
            achievementsHTML += '<div class="achievement-grid">';

            ach.allAchievements.forEach(a => {
                const cls = a.completed ? 'achievement done' : 'achievement locked';
                const progressText = `${Math.min(a.progress, a.required)}/${a.required}${a.metric ? ' ' + a.metric : ''}`;
                achievementsHTML += `<div class="${cls}" title="${a.desc}"><div class="achievement-icon">${a.icon}</div><div class="achievement-title">${a.title}</div><div class="achievement-progress">${progressText}</div></div>`;
            });

            achievementsHTML += '</div></div>';

            // –í—Å—Ç–∞–≤–ª—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –±–ª–æ–∫–æ–º –¥–æ–≤–µ—Ä–∏—è
            const trustBlock = document.getElementById('profile-trust-status').parentElement;
            trustBlock.insertAdjacentHTML('afterend', achievementsHTML);
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π:', e?.message || e);
        }

        // –ü–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤–∑–∞–∏–º–æ–≤—ã—Ä—É—á–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ drivers (–µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∏ –µ—Å—Ç—å)
        try {
            await _sb.from('drivers').upsert([
                { user_id: uid, likes_sum: (likes + sosBonus), is_trusted: isTrusted }
            ], { onConflict: 'user_id' });
        } catch (e) {
            // –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –∏–ª–∏ –∫–æ–ª–æ–Ω–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤–∑–∞–∏–º–æ–≤—ã—Ä—É—á–∫–∏ –≤ drivers (–≤–æ–∑–º–æ–∂–Ω–æ, –∫–æ–ª–æ–Ω–∫–∏ likes_sum/is_trusted –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç):', e?.message || e);
        }

        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'hidden';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —Å—Ç–∏–ª—è –æ–∑–≤—É—á–∫–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ
        document.getElementById('voiceStyleStandard').style.background = voiceStyle === 'standard' ? '#34c759' : '#9c9c9c';
        document.getElementById('voiceStyleCheeky').style.background = voiceStyle === 'cheeky' ? '#34c759' : '#9c9c9c';
        const descEl = document.getElementById('voiceStyleDescription');
        if (voiceStyle === 'cheeky') {
            descEl.textContent = 'üòé –í—ã–±—Ä–∞–Ω: –î–µ—Ä–∑–∫–∏–π —Å—Ç–∏–ª—å –æ–∑–≤—É—á–∫–∏';
        } else {
            descEl.textContent = '‚ú® –í—ã–±—Ä–∞–Ω: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å—Ç–∏–ª—å –æ–∑–≤—É—á–∫–∏';
        }
        
        document.getElementById('profileModal').classList.add('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    function closeProfileModal() {
        isViewingOwnProfile = true;

        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
        const avatarDisplay = document.getElementById('profile-avatar-display');
        avatarDisplay.style.cursor = 'pointer';
        avatarDisplay.title = '–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å';
        avatarDisplay.onclick = () => changeAvatar();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
        const uploadPhotoBtn = document.querySelector('button[onclick="document.getElementById(\'profile-photo-input\').click()"]');
        if (uploadPhotoBtn) uploadPhotoBtn.style.display = '';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ
        const carEditForm = document.querySelector('div[style*="border: 1px solid #ddd"]');
        if (carEditForm) carEditForm.style.display = '';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–í–´–ô–¢–ò"
        const logoutBtn = document.querySelector('button[onclick="logout()"]');
        if (logoutBtn) logoutBtn.style.display = '';
        
        // –£–¥–∞–ª—è–µ–º —Å–µ–∫—Ü–∏—é –º–æ–¥–µ—Ä–∞—Ü–∏–∏
        const adminSection = document.getElementById('profile-admin-section');
        if (adminSection) adminSection.remove();

        const profileNameEl = document.getElementById('profile-name-text');
        if (profileNameEl) profileNameEl.classList.remove('admin-name');
        updateProfileAdminBadges(false);
        
        // –£–¥–∞–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        const carInfoEl = document.getElementById('other-user-car-info');
        if (carInfoEl) carInfoEl.remove();
        
        document.getElementById('profileModal').classList.remove('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function openOtherUserProfile(userId) {
        try {
            isViewingOwnProfile = false;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const { data: driver } = await _sb.from('drivers').select('user_id,name,car_model,car_plate,avatar_url').eq('user_id', userId).maybeSingle();
            
            if (!driver) {
                alert('–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }

            // –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            let marks_count = 0, likes = 0, dislikes = 0;
            try {
                const { data: markers } = await _sb.from('markers').select('votes_up,votes_down').eq('author_id', userId);
                if (markers) {
                    marks_count = markers.length;
                    markers.forEach(m => {
                        likes += m.votes_up || 0;
                        dislikes += m.votes_down || 0;
                    });
                }
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á—ë—Ç–µ –º–∞—Ä–∫–µ—Ä–æ–≤:', e?.message || e);
            }

            // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
            document.getElementById('profile-avatar-display').style.cursor = 'default';
            document.getElementById('profile-avatar-display').title = '';
            document.getElementById('profile-avatar-display').onclick = null;
            document.querySelector('button[onclick="document.getElementById(\'profile-photo-input\').click()"]').style.display = 'none';
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ
            const carEditForm = document.querySelector('div[style*="border: 1px solid #ddd"]');
            if (carEditForm) carEditForm.style.display = 'none';

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —á—É–∂–æ–º –ø—Ä–æ—Ñ–∏–ª–µ
            const voiceStandardBtn = document.getElementById('voiceStyleStandard');
            const voiceCheekyBtn = document.getElementById('voiceStyleCheeky');
            const warningDistanceRange = document.getElementById('warningDistanceRange');
            const proximityAlwaysBtn = document.getElementById('proximityModeAlways');
            const proximityFollowBtn = document.getElementById('proximityModeFollow');
            if (voiceStandardBtn) { voiceStandardBtn.disabled = true; voiceStandardBtn.style.opacity = '0.5'; }
            if (voiceCheekyBtn) { voiceCheekyBtn.disabled = true; voiceCheekyBtn.style.opacity = '0.5'; }
            if (warningDistanceRange) { warningDistanceRange.disabled = true; warningDistanceRange.style.opacity = '0.5'; }
            if (proximityAlwaysBtn) { proximityAlwaysBtn.disabled = true; proximityAlwaysBtn.style.opacity = '0.5'; }
            if (proximityFollowBtn) { proximityFollowBtn.disabled = true; proximityFollowBtn.style.opacity = '0.5'; }

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä
            const avatarEl = document.getElementById('profile-avatar-display');
            if (driver.avatar_url) {
                avatarEl.style.backgroundImage = `url('${driver.avatar_url}')`;
                avatarEl.style.backgroundSize = 'cover';
                avatarEl.style.backgroundPosition = 'center';
                avatarEl.textContent = '';
            } else {
                avatarEl.style.backgroundImage = 'none';
                avatarEl.textContent = 'üë§';
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º –≤–æ–¥–∏—Ç–µ–ª–µ–º"
            const isTrusted = (likes >= (typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20));
            const isAdminProfile = isAdminUserId(userId);
            const profileNameEl = document.getElementById('profile-name-text');
            if (isAdminProfile) {
                profileNameEl.textContent = (driver.name || 'Admin');
                profileNameEl.classList.add('admin-name');
                profileNameEl.classList.remove('trusted');
            } else {
                profileNameEl.textContent = (isTrusted ? '‚≠ê ' : '') + (driver.name || '–ê–Ω–æ–Ω–∏–º');
                if (isTrusted) profileNameEl.classList.add('trusted'); else profileNameEl.classList.remove('trusted');
                profileNameEl.classList.remove('admin-name');
            }
            updateProfileAdminBadges(isAdminProfile);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –≤–∑–∞–∏–º–æ–≤—ã—Ä—É—á–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const sosBonus = await getUserSosBonus(userId);
            const karmaPoints = Math.max(0, (likes - dislikes) + marks_count + sosBonus);
            document.getElementById('profile-rating').textContent = `${karmaPoints}`;
            document.getElementById('profile-marks-count').textContent = marks_count;
            document.getElementById('profile-votes-sum').textContent = karmaPoints;
            document.getElementById('profile-likes').textContent = likes;
            document.getElementById('profile-dislikes').textContent = dislikes;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –¥–æ–≤–µ—Ä–∏—è
            const trustStatusEl = document.getElementById('profile-trust-status');
            if (isAdminProfile) {
                trustStatusEl.innerHTML = `üëë ${ADMIN_TITLE_LABEL}`;
                trustStatusEl.style.color = '#d4af37';
            } else if (karmaPoints >= 50) {
                trustStatusEl.innerHTML = 'üõü –í—ã—Ä—É—á–∞—Ç–æ—Ä';
                trustStatusEl.style.color = '#1e88e5';
            } else if (isTrusted) {
                trustStatusEl.innerHTML = '‚≠ê –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å';
                trustStatusEl.style.color = '#b8860b';
            } else {
                trustStatusEl.innerHTML = `ü§ù –£—á–∞—Å—Ç–Ω–∏–∫ –≤–∑–∞–∏–º–æ–ø–æ–º–æ—â–∏ (${karmaPoints} –æ—á–∫–æ–≤)`;
                trustStatusEl.style.color = '#999';
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–≤—Ç–æ
            const carInfoHtml = `
                <div style="background: #f9f9f9; border-radius: 12px; padding: 12px; margin-bottom: 15px;">
                    <div style="font-size: 12px; color: var(--gray); margin-bottom: 8px; font-weight: 600;">üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å</div>
                    <div style="font-weight: 700; color: #000; font-size: 15px;">${driver.car_model || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                    <div style="font-size: 13px; color: var(--gray); margin-top: 6px;"><strong>–ù–æ–º–µ—Ä:</strong> ${driver.car_plate || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                </div>
            `;
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ –æ–± –∞–≤—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ
            const statsGrid = document.querySelector('.stats-grid');
            let carInfoEl = document.getElementById('other-user-car-info');
            if (!carInfoEl) {
                carInfoEl = document.createElement('div');
                carInfoEl.id = 'other-user-car-info';
                statsGrid.parentElement.insertBefore(carInfoEl, statsGrid);
            }
            carInfoEl.innerHTML = carInfoHtml;

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–±–∞–Ω–∞ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–∞–º–∏ –≤—ã—Ö–æ–¥–∞
            let adminSection = document.getElementById('profile-admin-section');
            if (adminSection) adminSection.remove();
            
            adminSection = document.createElement('div');
            adminSection.id = 'profile-admin-section';
            
            if (isAdmin) {
                adminSection.innerHTML = `
                    <div class="moderation-section" style="padding-top: 0; border-top: none; margin-bottom: 15px;">
                        <div class="moderation-title">‚öôÔ∏è –ú–æ–¥–µ—Ä–∞—Ü–∏—è</div>
                        <div class="moderation-buttons">
                            <button class="mod-btn mod-btn-temp" onclick="moderateUserFromProfile(${userId}, '${(driver.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å').replace(/'/g, "\\'")}', 'temp')">
                                <span style="font-size: 18px;">‚è±Ô∏è</span>
                                –í—Ä–µ–º–µ–Ω–Ω—ã–π –±–∞–Ω
                            </button>
                            
                            <button class="mod-btn mod-btn-perm" onclick="moderateUserFromProfile(${userId}, '${(driver.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å').replace(/'/g, "\\'")}', 'permanent')">
                                <span style="font-size: 18px;">üö´</span>
                                –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –±–∞–Ω
                            </button>
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 8px;">
                            <button class="main-btn" style="background: #666; flex: 1; font-size: 11px; padding: 10px;" onclick="deleteAllUserMarkers(${userId}, '${(driver.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å').replace(/'/g, "\\'")}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫–∏</button>
                            <button class="main-btn" style="background: #666; flex: 1; font-size: 11px; padding: 10px;" onclick="deleteAllUserMessages(${userId}, '${(driver.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å').replace(/'/g, "\\'")}')">üí¨ –£–¥–∞–ª–∏—Ç—å —á–∞—Ç</button>
                        </div>
                    </div>
                `;
            } else {
                adminSection.innerHTML = `
                    <div style="padding-top: 15px; border-top: 1px solid #ddd; margin-bottom: 15px;">
                        <button class="main-btn" style="background: #ff9500; font-size: 12px;" onclick="reportUser(${userId}, '${(driver.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å').replace(/'/g, "\\'")}', '–ø—Ä–æ—Ñ–∏–ª—å', '')">‚ö†Ô∏è –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</button>
                    </div>
                `;
            }

            // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π "–í–´–ô–¢–ò"
            const logoutBtn = document.querySelector('button[onclick="logout()"]');
            logoutBtn.parentElement.insertBefore(adminSection, logoutBtn);

            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–í–´–ô–¢–ò"
            logoutBtn.style.display = 'none';

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è
            const target = document.querySelector('.target');
            if (target) target.style.visibility = 'hidden';
            document.getElementById('profileModal').classList.add('active');

        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e?.message || e);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è: ' + (e?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    }    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∞ —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º —É—Ä–æ–≤–Ω–µ–º –≤–∑–∞–∏–º–æ–≤—ã—Ä—É—á–∫–∏
    async function openRatingsModal() {
        const ratingsList = document.getElementById('ratingsList');
        ratingsList.innerHTML = '<div style="color: var(--gray);">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–≤–Ω–µ–π –≤–∑–∞–∏–º–æ–≤—ã—Ä—É—á–∫–∏...</div>';
        
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π
            const { data: drivers } = await _sb.from('drivers').select('user_id,name,car_model,car_plate,likes_sum,is_trusted');
            
            if (!drivers || drivers.length === 0) {
                ratingsList.innerHTML = '<div style="color: var(--gray); padding: 20px;">–í–æ–¥–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                const target = document.querySelector('.target');
                if (target) target.style.visibility = 'hidden';
                document.getElementById('ratingsModal').classList.add('active');
                return;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º SOS-–±–æ–Ω—É—Å—ã –¥–ª—è –≤—Å–µ—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π
            const { data: sosRewards } = await _sb.from('sos_help_rewards').select('helper_id,bonus_points');
            const sosBonusByUser = {};
            if (sosRewards && sosRewards.length) {
                sosRewards.forEach(r => {
                    const key = String(r.helper_id || '');
                    sosBonusByUser[key] = (sosBonusByUser[key] || 0) + (Number(r.bonus_points) || 0);
                });
            }

            // –°—á–∏—Ç–∞–µ–º –æ—á–∫–∏ –∫–∞—Ä–º—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è (–µ—Å–ª–∏ likes_sum –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
            let driverStats = [];
            for (const d of drivers) {
                let likesSum = d.likes_sum || 0;
                let isTrusted = d.is_trusted || false;
                const sosBonus = Number(sosBonusByUser[String(d.user_id)] || 0);
                
                // –ï—Å–ª–∏ likes_sum –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω, —Å—á–∏—Ç–∞–µ–º –∏–∑ markers
                if (!d.likes_sum) {
                    const { data: markers } = await _sb.from('markers').select('votes_up').eq('author_id', d.user_id);
                    if (markers) {
                        likesSum = markers.reduce((sum, m) => sum + (m.votes_up || 0), 0);
                    }
                    isTrusted = likesSum >= (typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20);
                }
                likesSum += sosBonus;
                
                driverStats.push({
                    user_id: d.user_id,
                    name: d.name || '–ê–Ω–æ–Ω–∏–º',
                    car_model: d.car_model || 'N/A',
                    likes: likesSum,
                    is_trusted: isTrusted
                });
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –æ—á–∫–∞–º –∫–∞—Ä–º—ã (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
            driverStats.sort((a, b) => b.likes - a.likes);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML
            let html = '';
            driverStats.forEach((driver, idx) => {
                const medal = idx === 0 ? 'ü•á' : (idx === 1 ? 'ü•à' : (idx === 2 ? 'ü•â' : ''));
                const trustBadge = driver.is_trusted ? ' ‚≠ê' : '';
                const isAdminProfile = isAdminUserId(driver.user_id);
                const displayNameHtml = isAdminProfile
                    ? `<span class="admin-name">${driver.name}</span> <span class="admin-rank">${ADMIN_RANK_LABEL}</span>`
                    : `${driver.name}${trustBadge}`;
                html += `
                    <div style="padding: 12px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f9f9f9'; this.style.transform='translateX(4px)'" onmouseout="this.style.background=''; this.style.transform='translateX(0)'" onclick="openProfileModal(${driver.user_id}); closeRatingsModal();">
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: #000; font-size: 14px;">${medal} ${displayNameHtml}</div>
                            <div style="font-size: 11px; color: var(--gray);">${driver.car_model}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 800; color: var(--blue); font-size: 16px;">${driver.likes}</div>
                            <div style="font-size: 11px; color: var(--gray);">–∫–∞—Ä–º—ã</div>
                        </div>
                    </div>
                `;
            });
            
            ratingsList.innerHTML = html;
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É—Ä–æ–≤–Ω–µ–π –≤–∑–∞–∏–º–æ–≤—ã—Ä—É—á–∫–∏:', e?.message || e);
            ratingsList.innerHTML = '<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–≤–Ω–µ–π –≤–∑–∞–∏–º–æ–≤—ã—Ä—É—á–∫–∏</div>';
        }
        
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'hidden';
        document.getElementById('ratingsModal').classList.add('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∞ –≤–∑–∞–∏–º–æ–≤—ã—Ä—É—á–∫–∏
    function closeRatingsModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        document.getElementById('ratingsModal').classList.remove('active');
    }

    // ============= –§–£–ù–ö–¶–ò–ò –î–õ–Ø –û–¢–ü–†–ê–í–ö–ò –û–¢–ß–ï–¢–û–í –û –ë–ê–ì–ê–• =============

    function openBugReportModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'hidden';
        
        // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º –∏–º—è –µ—Å–ª–∏ –±—ã–ª–æ —É–∫–∞–∑–∞–Ω–æ —Ä–∞–Ω–µ–µ
        const driverName = currentDriver?.name || window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name || '';
        document.getElementById('bugReporterName').value = driverName;
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
        document.getElementById('bugDescription').value = '';
        document.getElementById('bugCategory').value = 'ui';
        document.getElementById('bugReproducible').checked = false;
        document.getElementById('bugIncludeLogs').checked = false;
        document.getElementById('bugReportStatus').style.display = 'none';
        
        document.getElementById('bugReportModal').classList.add('active');
    }

    function closeBugReportModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        document.getElementById('bugReportModal').classList.remove('active');
    }

    async function submitBugReport() {
        const category = document.getElementById('bugCategory').value;
        const description = document.getElementById('bugDescription').value.trim();
        const reporterName = document.getElementById('bugReporterName').value.trim();
        const reproducible = document.getElementById('bugReproducible').checked;
        const includeLogs = document.getElementById('bugIncludeLogs').checked;
        const status = document.getElementById('bugReportStatus');

        if (!description) {
            status.textContent = '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É';
            status.style.color = '#dc3545';
            status.style.display = 'block';
            return;
        }

        status.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞...';
        status.style.color = '#007aff';
        status.style.display = 'block';

        try {
            // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–∞
            let additionalInfo = '';
            if (includeLogs) {
                additionalInfo = `\n\n---–¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø---\n`;
                additionalInfo += `User ID: ${uid}\n`;
                additionalInfo += `–í—Ä–µ–º—è: ${new Date().toISOString()}\n`;
                additionalInfo += `–û–°: ${window.navigator.userAgent}\n`;
                additionalInfo += `–ú–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∞: ${reproducible ? '–î–∞' : '–ù–µ—Ç'}`;
            }

            const fullMessage = `${description}${additionalInfo}`;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ç–∞–±–ª–∏—Ü—É feedback
            const { error } = await _sb.from('feedback').insert({
                user_id: String(uid),
                user_name: reporterName || '–ê–Ω–æ–Ω–∏–º–Ω–æ',
                message: `[${category.toUpperCase()}] ${fullMessage}`,
                status: 'new'
            });

            if (error) {
                throw error;
            }

            status.textContent = '‚úÖ –°–ø–∞—Å–∏–±–æ! –û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º';
            status.style.color = '#28a745';
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                closeBugReportModal();
            }, 2000);

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç—á–µ—Ç–∞:', err);
            status.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (err?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            status.style.color = '#dc3545';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ
    function openPhotoViewer(photoUrl) {
        document.getElementById('photoViewerImage').src = photoUrl;
        document.getElementById('photoUrl').value = photoUrl;
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'hidden';
        document.getElementById('photoViewerModal').classList.add('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ
    function closePhotoViewer() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        document.getElementById('photoViewerModal').classList.remove('active');
    }
    
    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ –∏–∑ —á–∞—Ç–∞
    async function deletePhotoFromChat() {
        const photoUrl = document.getElementById('photoUrl')?.value;
        if (!photoUrl) {
            alert('–§–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            return;
        }
        
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Ñ–æ—Ç–æ?')) return;
        
        try {
            // –ù–∞–π—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —ç—Ç–∏–º —Ñ–æ—Ç–æ –∏ —É–¥–∞–ª–∏—Ç—å –µ–≥–æ
            const { data: messages } = await _sb.from('messages').select('id, author_id').eq('photo_url', photoUrl);
            
            if (!messages || messages.length === 0) {
                alert('–°–æ–æ–±—â–µ–Ω–∏–µ —Å —ç—Ç–∏–º —Ñ–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                return;
            }
            
            const msg = messages[0];
            const isOwnMessage = msg.author_id === uid;
            const isAdminDeleting = isAdmin && msg.author_id !== uid;
            
            if (!isOwnMessage && !isAdminDeleting) {
                alert('–í—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ñ–æ—Ç–æ');
                return;
            }
            
            // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ñ–æ—Ç–æ
            const { error } = await _sb.from('messages').delete().eq('id', msg.id);
            if (error) {
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                return;
            }
            
            alert('‚úÖ –§–æ—Ç–æ –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω—ã');
            closePhotoViewer();
            await loadChatMessages();
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ:', e);
            alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
    function logout() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
            currentDriver = null;
            closeProfileModal();
            openRegistrationModal();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞ (—Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ, emoji –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±–µ–∑ –∫–æ–ª–æ–Ω–∫–∏ avatar)
    async function changeAvatar() {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ñ–æ—Ç–æ
        document.getElementById('profile-photo-input').click();
    }

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∞
    let avatarEditorState = {
        fileBlob: null,
        zoom: 1,
        offsetX: 0,
        offsetY: 0
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –∞–≤–∞—Ç–∞—Ä–∞
    document.addEventListener('change', async function(e) {
        if (e.target.id === 'profile-photo-input') {
            const file = e.target.files[0];
            if (file) {
                try {
                    // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ Data URL –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –∞–≤–∞—Ç–∞—Ä–∞
                        const img = document.getElementById('avatarEditorImage');
                        img.src = event.target.result;
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º blob —Ñ–∞–π–ª–∞
                        avatarEditorState.fileBlob = file;
                        avatarEditorState.zoom = 1;
                        avatarEditorState.offsetX = 0;
                        avatarEditorState.offsetY = 0;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã
                        document.getElementById('avatarZoom').value = 1;
                        document.getElementById('avatarZoomValue').textContent = '100';
                        document.getElementById('avatarOffsetX').value = 0;
                        document.getElementById('avatarOffsetY').value = 0;
                        
                        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
                        const target = document.querySelector('.target');
                        if (target) target.style.visibility = 'hidden';
                        document.getElementById('avatarEditorModal').classList.add('active');
                    };
                    reader.readAsDataURL(file);
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–∞–π–ª–∞: ' + (err?.message || err));
                }
                e.target.value = ''; // –æ—á–∏—â–∞–µ–º input
            }
        }
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ zoom
    document.getElementById('avatarZoom')?.addEventListener('input', function(e) {
        avatarEditorState.zoom = parseFloat(e.target.value);
        document.getElementById('avatarZoomValue').textContent = Math.round(avatarEditorState.zoom * 100);
        updateAvatarEditorPreview();
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ offsetX
    document.getElementById('avatarOffsetX')?.addEventListener('input', function(e) {
        avatarEditorState.offsetX = parseFloat(e.target.value);
        updateAvatarEditorPreview();
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ offsetY
    document.getElementById('avatarOffsetY')?.addEventListener('input', function(e) {
        avatarEditorState.offsetY = parseFloat(e.target.value);
        updateAvatarEditorPreview();
    });

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–≤—å—é –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
    function updateAvatarEditorPreview() {
        const img = document.getElementById('avatarEditorImage');
        if (img) {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
            const scalePercent = avatarEditorState.zoom;
            const offsetXPercent = avatarEditorState.offsetX;
            const offsetYPercent = avatarEditorState.offsetY;
            
            img.style.transform = `scale(${scalePercent}) translate(${offsetXPercent}px, ${offsetYPercent}px)`;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∞
    function closeAvatarEditor() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        document.getElementById('avatarEditorModal').classList.remove('active');
        avatarEditorState = {
            fileBlob: null,
            zoom: 1,
            offsetX: 0,
            offsetY: 0
        };
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞
    async function saveAvatarEdit() {
        try {
            if (!avatarEditorState.fileBlob) {
                alert('–û—à–∏–±–∫–∞: —Ñ–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –≤—ã—Ä–µ–∑–∞–Ω–∏—è –∫—Ä—É–≥–ª–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 400;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const img = new Image();
            img.onload = async function() {
                // –û—á–∏—â–∞–µ–º canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // –†–∏—Å—É–µ–º –∫—Ä—É–≥–ª—É—é –º–∞—Å–∫—É
                ctx.beginPath();
                ctx.arc(200, 200, 200, 0, Math.PI * 2);
                ctx.clip();

                // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–º–µ—â–µ–Ω–∏–µ
                const scaleFactor = avatarEditorState.zoom;
                const offsetX = (canvas.width / 2) + (avatarEditorState.offsetX * 2);
                const offsetY = (canvas.height / 2) + (avatarEditorState.offsetY * 2);

                // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                ctx.drawImage(
                    img,
                    offsetX - (img.width / 2) * scaleFactor,
                    offsetY - (img.height / 2) * scaleFactor,
                    img.width * scaleFactor,
                    img.height * scaleFactor
                );

                // –ü–æ–ª—É—á–∞–µ–º blob –∏–∑ canvas
                canvas.toBlob((blob) => {
                    try {
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º blob –≤ Base64
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const base64 = event.target.result; // data:image/jpeg;base64,...

                            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ñ–æ—Ç–æ –∫–∞–∫ –∞–≤–∞—Ç–∞—Ä
                            const avatarEl = document.getElementById('profile-avatar-display');
                            avatarEl.style.backgroundImage = `url('${base64}')`;
                            avatarEl.style.backgroundSize = 'cover';
                            avatarEl.style.backgroundPosition = 'center';
                            avatarEl.textContent = '';

                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º Base64 –≤ –ø–æ–ª–µ
                            document.getElementById('profile-avatar-url').value = base64;
                            document.getElementById('profile-avatar-value').value = '';

                            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
                            closeAvatarEditor();
                            alert('‚úÖ –ê–≤–∞—Ç–∞—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                        };
                        reader.readAsDataURL(blob);
                    } catch (err) {
                        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (err?.message || err));
                    }
                }, 'image/jpeg', 0.9);
            };

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            img.src = document.getElementById('avatarEditorImage').src;
        } catch (err) {
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (err?.message || err));
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ—Ñ–∏–ª—è
    async function saveProfileChanges() {
        const carModel = document.getElementById('edit-car-model').value.trim() || (currentDriver?.car_model || '');
        const carPlate = document.getElementById('edit-car-plate').value.trim() || (currentDriver?.car_plate || '');

        try {
            const updateData = {
                car_model: carModel,
                car_plate: carPlate
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –∞–≤–∞—Ç–∞—Ä–∞ —Ñ–æ—Ç–æ –µ—Å–ª–∏ –µ—Å—Ç—å (avatar_url –∫–æ–ª–æ–Ω–∫–∞)
            const avatarUrl = document.getElementById('profile-avatar-url').value;
            if (avatarUrl) {
                updateData.avatar_url = avatarUrl;
            }

            // –í—ã–ø–æ–ª–Ω—è–µ–º update —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ schema cache
            let result = await _sb.from('drivers').update(updateData).eq('user_id', uid);
            let error = result.error;

            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å–æ schema cache, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –±–µ–∑ avatar_url
            if (error && error.message && error.message.includes('avatar')) {
                console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ avatar_url, –ø—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–µ–∑ –Ω–µ–≥–æ:', error.message);
                const updateDataWithoutAvatar = {
                    car_model: carModel,
                    car_plate: carPlate
                };
                result = await _sb.from('drivers').update(updateDataWithoutAvatar).eq('user_id', uid);
                error = result.error;
            }

            if (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                return;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            currentDriver.car_model = carModel;
            currentDriver.car_plate = carPlate;
            if (avatarUrl) {
                currentDriver.avatar_url = avatarUrl;
            }

            alert('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            await openProfileModal();
        } catch (e) {
            alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
        }
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    let adminAllDrivers = [];
    let adminBannedIds = new Set();
    let adminLikesMap = {};
    let adminAllMarkers = [];

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    async function openAdminModal() {
        if (!isAdmin) {
            alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏');
            return;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π
        try {
            const { data: drivers } = await _sb.from('drivers').select('user_id,name,car_model,car_plate');
            adminAllDrivers = drivers || [];
            const tbody = document.getElementById('admin-drivers-body');
            tbody.innerHTML = '';
            if (adminAllDrivers && adminAllDrivers.length > 0) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–±–∞–Ω–Ω–µ–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                adminBannedIds = new Set();
                try {
                    const { data: bans } = await _sb.from('bans').select('user_id');
                    if (bans) {
                        bans.forEach(b => adminBannedIds.add(b.user_id.toString()));
                    }
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –±–∞–Ω–æ–≤ (–≤–æ–∑–º–æ–∂–Ω–æ, —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç):', e?.message);
                }
                
                // –°–æ–±–µ—Ä–µ–º —Å–ø–∏—Å–æ–∫ ID –≤–æ–¥–∏—Ç–µ–ª–µ–π –∏ –ø–æ–¥—Å—á–∏—Ç–∞–µ–º –ª–∞–π–∫–∏ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
                const driverIds = adminAllDrivers.map(d => d.user_id.toString());
                adminLikesMap = {};
                try {
                    const { data: likesRows } = await _sb.from('markers').select('author_id,votes_up').in('author_id', driverIds);
                    if (likesRows) {
                        likesRows.forEach(r => {
                            const id = r.author_id.toString();
                            adminLikesMap[id] = (adminLikesMap[id] || 0) + (r.votes_up || 0);
                        });
                    }
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–∞–π–∫–∏ –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π:', e?.message || e);
                }

                // –†–µ–Ω–¥–µ—Ä–∏–º –≤—Å–µ –≤–æ–¥–∏—Ç–µ–ª–µ–π –≤ —Ç–∞–±–ª–∏—Ü—É
                renderDriversTable(adminAllDrivers);
                document.getElementById('admin-drivers-count').textContent = adminAllDrivers.length;
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--gray);">–í–æ–¥–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–æ–¥–∏—Ç–µ–ª–µ–π:', e?.message || e);
            document.getElementById('admin-drivers-body').innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
        try {
            const { data: markers } = await _sb.from('markers').select('*');
            const now = Date.now();
            adminAllMarkers = (markers || []).filter(m => {
                if (m.exp === null || typeof m.exp === 'undefined') return true;
                if (typeof m.exp === 'number') return m.exp > now;
                const parsed = Date.parse(m.exp);
                return !isNaN(parsed) ? parsed > now : true;
            });
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –≤—Å–µ –º–µ—Ç–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü—É
            renderMarkersTable(adminAllMarkers);
            document.getElementById('admin-markers-count').textContent = adminAllMarkers.length;
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞—Ä–∫–µ—Ä–æ–≤:', e?.message || e);
            document.getElementById('admin-markers-body').innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        const searchInput = document.getElementById('driverSearchInput');
        if (searchInput) {
            searchInput.value = '';
            searchInput.addEventListener('keyup', filterDriversTable);
        }

        const typeFilter = document.getElementById('markerTypeFilter');
        if (typeFilter) {
            typeFilter.value = '';
            typeFilter.addEventListener('change', filterMarkersTable);
        }

        await loadUnbanRequests();
        await refreshBugReports();
        await refreshMaintenanceStatus();

        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'hidden';
        document.getElementById('adminModal').classList.add('active');
    }

    // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ç–∞–±–ª–∏—Ü—ã –≤–æ–¥–∏—Ç–µ–ª–µ–π
    function renderDriversTable(drivers) {
        const tbody = document.getElementById('admin-drivers-body');
        tbody.innerHTML = '';
        
        if (!drivers || drivers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--gray);">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>';
            return;
        }

        drivers.forEach(d => {
            const isBanned = adminBannedIds.has(d.user_id.toString());
            const statusBadge = isBanned ? 'üö´ –ó–ê–ë–ê–ù' : '‚úÖ';
            const statusStyle = isBanned ? 'background: #ff3b30; color: white;' : '';
            const likes = adminLikesMap[d.user_id.toString()] || 0;
            const isTrustedDriver = likes >= (typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20);
            const nameCell = `${isTrustedDriver ? '‚≠ê ' : ''}${d.name || 'N/A'}`;
            const row = `<tr style="${statusStyle}">
                <td>${nameCell}</td>
                <td>${d.car_model || 'N/A'}</td>
                <td>${d.car_plate || 'N/A'}</td>
                <td>${statusBadge}</td>
                <td style="display: flex; gap: 5px;">
                    <button class="delete-btn" onclick="deleteDriver('${d.user_id}')">–£–¥–∞–ª–∏—Ç—å</button>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ä–∫–µ—Ä–æ–≤
    function renderMarkersTable(markers) {
        const tbody = document.getElementById('admin-markers-body');
        tbody.innerHTML = '';
        
        if (!markers || markers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--gray);">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>';
            return;
        }

        markers.forEach(m => {
            // format existing exp to local datetime-local value if possible
            let expVal = '';
            if (m.exp) {
                try {
                    const parsed = (typeof m.exp === 'number') ? new Date(Number(m.exp)) : new Date(m.exp);
                    if (!isNaN(parsed)) {
                        const pad = n => n.toString().padStart(2, '0');
                        const y = parsed.getFullYear();
                        const mo = pad(parsed.getMonth() + 1);
                        const d = pad(parsed.getDate());
                        const hh = pad(parsed.getHours());
                        const mm = pad(parsed.getMinutes());
                        expVal = `${y}-${mo}-${d}T${hh}:${mm}`;
                    }
                } catch (e) { expVal = ''; }
            }

            let readableExp = '';
            if (m.exp) {
                try {
                    const parsedExp = (typeof m.exp === 'number') ? new Date(Number(m.exp)) : new Date(m.exp);
                    if (!isNaN(parsedExp)) {
                        readableExp = parsedExp.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                    }
                } catch (e) { readableExp = ''; }
            }

            const row = `<tr>
                <td>${MAP_ICONS[m.type] || '?'}</td>
                <td>${m.comment || '–±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}</td>
                <td>${m.votes_up || 0}</td>
                <td>${m.votes_down || 0}</td>
                <td style="width:260px;">
                    <input type="datetime-local" id="marker-exp-${m.id}" value="${expVal}" style="width:140px; padding:6px; border-radius:6px; border:1px solid #ddd;">
                    <button class="delete-btn" style="margin-left:6px;" onclick="setMarkerExpiry(${m.id})">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                    <button class="delete-btn" style="margin-left:6px; background:#999;" onclick="clearMarkerExpiry(${m.id})">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    <div style="font-size:12px; color: var(--gray); margin-top:6px;">${readableExp ? readableExp : ''}</div>
                </td>
                <td><button class="delete-btn" onclick="deleteMarkerAdmin(${m.id})">–£–¥–∞–ª–∏—Ç—å</button></td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–π
    function filterDriversTable() {
        const searchInput = document.getElementById('driverSearchInput');
        const query = searchInput.value.toLowerCase().trim();
        
        if (!query) {
            // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ—Ö
            renderDriversTable(adminAllDrivers);
            return;
        }

        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ ID
        const filtered = adminAllDrivers.filter(d => {
            const name = (d.name || '').toLowerCase();
            const id = String(d.user_id).toLowerCase();
            return name.includes(query) || id.includes(query);
        });

        renderDriversTable(filtered);
    }

    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –º–∞—Ä–∫–µ—Ä–æ–≤ –ø–æ —Ç–∏–ø—É
    function filterMarkersTable() {
        const typeFilter = document.getElementById('markerTypeFilter');
        const selectedType = typeFilter.value;
        
        if (!selectedType) {
            // –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä –ø—É—Å—Ç–æ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
            renderMarkersTable(adminAllMarkers);
            return;
        }

        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–∏–ø—É
        const filtered = adminAllMarkers.filter(m => m.type === selectedType);
        renderMarkersTable(filtered);
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –ø–æ–∏—Å–∫–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–π
    function clearDriverSearch() {
        const searchInput = document.getElementById('driverSearchInput');
        searchInput.value = '';
        renderDriversTable(adminAllDrivers);
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –º–∞—Ä–∫–µ—Ä–æ–≤
    function clearMarkerFilter() {
        const typeFilter = document.getElementById('markerTypeFilter');
        typeFilter.value = '';
        renderMarkersTable(adminAllMarkers);
    }

    // ============= –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ó–ë–¢ –ö–û–î–ê–ú–ò =============

    async function invokeAdminFunction(functionName, payload = {}) {
        if (!_sb) {
            throw new Error('Supabase client –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        }
        const { data, error } = await _sb.functions.invoke(functionName, {
            body: payload,
            headers: { 'Content-Type': 'application/json' }
        });
        if (error) {
            const errMsg = String(error?.message || error || `Edge Function ${functionName} error`);
            throw new Error(errMsg);
        }
        if (data && typeof data === 'object' && 'error' in data && data.error) {
            const errMsg = typeof data.error === 'string' ? data.error : JSON.stringify(data.error);
            throw new Error(errMsg || `Edge Function ${functionName} error`);
        }
        return data;
    }

    async function generateBetaCode() {
        const countInput = document.getElementById('betaCodeCountInput');
        const descInput = document.getElementById('betaCodeDescInput');
        const status = document.getElementById('betaCodeStatus');
        
        const count = Math.max(1, Math.min(100, parseInt(countInput.value) || 1));
        const desc = descInput.value.trim() || null;

        status.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ...';
        status.style.color = '#007aff';
        status.style.display = 'block';

        try {
            if (!isAdmin) {
                throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤: —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–æ–¥—ã');
            }

            let code = '';
            let inserted = false;
            let lastError = null;
            let createdResponse = null;
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';

            // –î–µ–ª–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫, —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞—Ç—å –Ω–∞ —Ä–µ–¥–∫–æ–π –∫–æ–ª–ª–∏–∑–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ code
            for (let attempt = 1; attempt <= 7; attempt++) {
                code = Array.from({ length: 6 }, () => alphabet[Math.floor(Math.random() * alphabet.length)]).join('');

                try {
                    createdResponse = await invokeAdminFunction('beta-invite', {
                        code,
                        maxUses: count,
                        description: desc
                    });
                    inserted = true;
                    break;
                } catch (fnError) {
                    lastError = fnError;
                    const msg = String(fnError?.message || '');
                    const isDuplicate = /duplicate key|unique constraint|already exists|409/.test(msg);
                    if (!isDuplicate) {
                        throw fnError;
                    }
                }
            }

            if (!inserted) {
                throw lastError || new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥');
            }

            const createdCode = createdResponse?.code || code;
            status.textContent = `‚úÖ –ö–æ–¥ —Å–æ–∑–¥–∞–Ω: ${createdCode}`;
            status.style.color = '#28a745';
            
            countInput.value = '1';
            descInput.value = '';

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            await refreshBetaCodes();

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–¥–∞:', err);
            const msg = String(err?.message || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            if (/admin|–¥–æ—Å—Ç—É–ø|permission denied|forbidden|Access denied/i.test(msg)) {
                status.textContent = '‚ùå Edge Function beta-invite –æ—Ç–∫–ª–æ–Ω–∏–ª–∞ –∑–∞–ø—Ä–æ—Å (–Ω–µ—Ç –ø—Ä–∞–≤)';
            } else {
                status.textContent = '‚ùå ' + msg;
            }
            status.style.color = '#dc3545';
        }
    }

    async function refreshBetaCodes() {
        try {
            const { data, error } = await _sb
                .from('beta_invites')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                throw error;
            }

            const tbody = document.getElementById('betaCodesTableBody');
            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr style="background: #f9f9f9;">
                        <td colspan="6" style="padding: 20px; text-align: center; color: #888;">
                            –ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.map(invite => {
                const isUsed = invite.current_uses >= invite.max_uses;
                const isActive = invite.is_active && !isUsed;
                
                return `
                    <tr style="background: ${isUsed ? '#fff3cd' : 'white'}; border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: 700; font-family: monospace;">${invite.code}</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${invite.max_uses}</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${invite.current_uses}</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                            ${invite.current_uses}/${invite.max_uses}
                        </td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                            <span style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 700; background: ${isActive ? '#d4edda' : '#f8d7da'}; color: ${isActive ? '#28a745' : '#dc3545'};">
                                ${isActive ? '‚úì –ê–∫—Ç–∏–≤–µ–Ω' : '‚úï –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω'}
                            </span>
                        </td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                            <button onclick="copyBetaCode('${invite.code}')" style="background: #007aff; color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; margin-right: 5px;">
                                üìã –°–∫–æ–ø–∏—Ä.
                            </button>
                            <button onclick="deactivateBetaCode(${invite.id})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                ‚úï –û—Ç–∫–ª—é.
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–¥–æ–≤:', err);
            document.getElementById('betaCodesTableBody').innerHTML = `
                <tr style="background: #fff3cd;">
                    <td colspan="6" style="padding: 20px; text-align: center; color: #dc3545;">
                        ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–¥–æ–≤
                    </td>
                </tr>
            `;
        }
    }

    function copyBetaCode(code) {
        navigator.clipboard.writeText(code).then(() => {
            alert('‚úÖ –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ' + code);
        }).catch(() => {
            alert('‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
        });
    }

    async function deactivateBetaCode(inviteId) {
        if (!confirm('–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –∫–æ–¥?')) return;

        try {
            const { error } = await _sb
                .from('beta_invites')
                .update({ is_active: false })
                .eq('id', inviteId);

            if (error) {
                throw error;
            }

            await refreshBetaCodes();
        } catch (err) {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (err?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    }

    // ============= –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ü–†–û–°–ú–û–¢–†–ê –û–¢–ß–ï–¢–û–í –û –ë–ê–ì–ê–• =============

    async function refreshBugReports() {
        try {
            const { data, error } = await _sb
                .from('feedback')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                throw error;
            }

            const reports = data || [];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const newCount = reports.filter(r => r.status === 'new').length;
            const readCount = reports.filter(r => r.status === 'read').length;
            const resolvedCount = reports.filter(r => r.status === 'resolved').length;
            
            document.getElementById('newBugsCount').textContent = newCount;
            document.getElementById('readBugsCount').textContent = readCount;
            document.getElementById('resolvedBugsCount').textContent = resolvedCount;

            // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É
            const tbody = document.getElementById('bugReportsTableBody');
            if (reports.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px; color: #888;">–ù–µ—Ç –æ—Ç—á–µ—Ç–æ–≤</td></tr>`;
                return;
            }

            tbody.innerHTML = reports.map(report => {
                const date = new Date(report.created_at).toLocaleString('ru-RU', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const message = report.message || '';
                let category = '‚ùì –î—Ä—É–≥–æ–µ';
                if (message.startsWith('[UI]')) category = 'üé® –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å';
                else if (message.startsWith('[MAP]')) category = 'üó∫Ô∏è –ö–∞—Ä—Ç–∞';
                else if (message.startsWith('[MARKERS]')) category = 'üìç –ú–µ—Ç–∫–∏';
                else if (message.startsWith('[CHAT]')) category = 'üí¨ –ß–∞—Ç';
                else if (message.startsWith('[CRASH]')) category = 'üí• –ö—Ä–∞—à';
                else if (message.startsWith('[PERFORMANCE]')) category = '‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å';
                
                const description = message.substring(message.indexOf(']') + 2, 60) + (message.length > 60 ? '...' : '');
                
                const statusBadge = report.status === 'new' ? 'üî¥ –ù–æ–≤–æ–µ' : 
                                   report.status === 'read' ? 'üü° –ü—Ä–æ—á–∏—Ç–∞–Ω–æ' : 
                                   '‚úÖ –†–µ—à–µ–Ω–æ';
                const statusColor = report.status === 'new' ? '#dc3545' : 
                                   report.status === 'read' ? '#ff9500' : 
                                   '#28a745';

                return `<tr style="background: ${report.status === 'new' ? '#fff0f0' : 'white'};">
                    <td>${category}</td>
                    <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;" title="${message}">${description}</td>
                    <td>${report.user_name || '–ê–Ω–æ–Ω–∏–º'}</td>
                    <td style="text-align: center;">
                        <span style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; background: ${statusColor}; color: white;">
                            ${statusBadge}
                        </span>
                    </td>
                    <td style="text-align: center; font-size: 12px;">${date}</td>
                    <td style="text-align: center;">
                        ${report.status !== 'resolved' ? `<button onclick="markBugAsResolved('${report.id}')" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; margin-right: 3px;">‚úì –†–µ—à–µ–Ω–æ</button>` : ''}
                        <button onclick="deleteBugReport('${report.id}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                </tr>`;
            }).join('');

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–æ–≤:', err);
            document.getElementById('bugReportsTableBody').innerHTML = `
                <tr><td colspan="6" style="text-align: center; padding: 20px; color: #dc3545;">
                    ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–æ–≤
                </td></tr>
            `;
        }
    }

    async function markBugAsResolved(reportId) {
        try {
            const { error } = await _sb
                .from('feedback')
                .update({ status: 'resolved' })
                .eq('id', reportId);

            if (error) throw error;
            await refreshBugReports();
        } catch (err) {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (err?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    }

    async function deleteBugReport(reportId) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç—á–µ—Ç?')) return;

        try {
            const { error } = await _sb
                .from('feedback')
                .delete()
                .eq('id', reportId);

            if (error) throw error;
            await refreshBugReports();
        } catch (err) {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (err?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    }

    async function refreshMaintenanceStatus() {
        try {
            const { data } = await _sb
                .from('app_maintenance')
                .select('value')
                .eq('key', 'maintenance_mode')
                .maybeSingle();

            const statusEl = document.getElementById('maintenanceStatus');
            if (!statusEl) return;

            if (data) {
                const settings = JSON.parse(data.value);
                if (settings.active) {
                    statusEl.textContent = 'üî¥ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –ê–ö–¢–ò–í–Ω–æ';
                    statusEl.style.background = '#dc3545';
                    const msgEl = document.getElementById('maintenanceMessage');
                    if (msgEl) msgEl.value = settings.message || '';
                } else {
                    statusEl.textContent = 'üü¢ –ö–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–∞';
                    statusEl.style.background = '#28a745';
                }
            } else {
                statusEl.textContent = 'üü¢ –ö–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–∞';
                statusEl.style.background = '#28a745';
            }
        } catch (err) {
            // –ö–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
            const statusEl = document.getElementById('maintenanceStatus');
            if (statusEl) {
                statusEl.textContent = 'üü¢ –ö–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–∞';
                statusEl.style.background = '#28a745';
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ–º
    async function enableMaintenance() {
        const message = document.getElementById('maintenanceMessage').value || '‚ö†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ. –ü—Ä–∏–Ω–æ—Å–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è.';
        
        try {
            await invokeAdminFunction('maintenance-toggle', {
                active: true,
                message: message,
                timestamp: Date.now()
            });
            alert('‚úÖ –ö–∞—Ä—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∞ –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ!');
            await refreshMaintenanceStatus();
        } catch (err) {
            alert('‚ùå –û—à–∏–±–∫–∞ Edge Function maintenance-toggle: ' + (err?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    }

    async function disableMaintenance() {
        try {
            await invokeAdminFunction('maintenance-toggle', { active: false });
            alert('‚úÖ –ö–∞—Ä—Ç–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –¢–û
            const overlay = document.getElementById('maintenanceOverlay');
            if (overlay) overlay.remove();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º main –∫–æ–Ω—Ç–µ–Ω—Ç
            const main = document.getElementById('main');
            if (main) main.style.display = 'flex';
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é
            await new Promise(r => setTimeout(r, 500));
            location.reload();
            
        } catch (err) {
            alert('‚ùå –û—à–∏–±–∫–∞ Edge Function maintenance-toggle: ' + (err?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    }

    function updateMaintenanceStatus(isActive, message) {
        const status = document.getElementById('maintenanceStatus');
        if (isActive) {
            status.textContent = 'üî¥ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ';
            status.style.background = '#dc3545';
        } else {
            status.textContent = 'üü¢ –ö–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–∞';
            status.style.background = '#28a745';
        }
    }

    async function checkMaintenanceStatus(isUserAdmin = false) {
        try {
            const { data } = await _sb
                .from('app_maintenance')
                .select('value')
                .eq('key', 'maintenance_mode')
                .maybeSingle();

            if (data) {
                const settings = JSON.parse(data.value);
                if (settings.active) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –¢–û
                    showMaintenanceOverlay(settings.message, isUserAdmin);
                    return true;
                }
            }
        } catch (err) {
            // –ö–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω, –¢–û –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ
        }
        return false;
    }

    function showMaintenanceOverlay(message, isUserAdmin = false) {
        // –£–¥–∞–ª–∏–º —Å—Ç–∞—Ä—ã–π –æ–≤–µ—Ä–ª–µ–π –µ—Å–ª–∏ –µ—Å—Ç—å
        const oldOverlay = document.getElementById('maintenanceOverlay');
        if (oldOverlay) oldOverlay.remove();

        const overlay = document.createElement('div');
        overlay.id = 'maintenanceOverlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-family: Arial, sans-serif;
        `;

        const content = document.createElement('div');
        content.style.cssText = `
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 300px;
        `;

        let adminButton = '';
        if (isUserAdmin) {
            adminButton = `
                <button onclick="disableMaintenance()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 15px; width: 100%;">
                    üîë –û—Ç–∫–ª—é—á–∏—Ç—å –¢–û (–ê–¥–º–∏–Ω)
                </button>
            `;
        }

        content.innerHTML = `
            <div style="font-size: 60px; margin-bottom: 15px;">‚öôÔ∏è</div>
            <h2 style="margin: 0 0 15px 0; font-size: 24px; font-weight: 800; color: #333;">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</h2>
            <p style="margin: 0; font-size: 16px; color: #666; line-height: 1.5;">${message}</p>
            <p style="margin: 15px 0 0 0; font-size: 12px; color: #999;">–ü—Ä–∏–Ω–æ—Å–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è –∑–∞ –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞!</p>
            ${adminButton}
        `;

        overlay.appendChild(content);
        document.body.appendChild(overlay);

        // –ü–æ–≤—Ç–æ—Ä—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫ —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
        setTimeout(() => {
            const latest = document.getElementById('maintenanceOverlay');
            if (latest) checkMaintenanceStatus(isUserAdmin);
        }, 10000);
    }

    function initAdminBroadcastChannel() {
        if (!_sb || adminBroadcastChannel) return;
        adminBroadcastChannel = _sb.channel('admin-broadcast', {
            config: { broadcast: { self: true } }
        });

        adminBroadcastChannel.on('broadcast', { event: 'admin-message' }, ({ payload }) => {
            if (!payload || !payload.text) return;
            showBroadcastBanner(payload.text, !!payload.withSignal);
        });

        adminBroadcastChannel.on('broadcast', { event: 'admin-visibility' }, ({ payload }) => {
            if (!payload || typeof payload.active !== 'boolean') return;
            const nextState = !!payload.active;
            if (adminInvisible !== nextState) {
                adminInvisible = nextState;
                updateAdminInvisibleButton();
                loadMarkersDebounced();
                if (isAdmin) updateUserLocationMarker();
            }
        });

        adminBroadcastChannel.subscribe();
    }

    function closeRealtimeChannels() {
        try {
            if (_sb && markersRealtimeChannel) _sb.removeChannel(markersRealtimeChannel);
            if (_sb && messagesRealtimeChannel) _sb.removeChannel(messagesRealtimeChannel);
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è realtime –∫–∞–Ω–∞–ª–æ–≤:', e?.message || e);
        }
        markersRealtimeChannel = null;
        messagesRealtimeChannel = null;
        if (markersRealtimeTimer) {
            clearTimeout(markersRealtimeTimer);
            markersRealtimeTimer = null;
        }
        if (messagesRealtimeTimer) {
            clearTimeout(messagesRealtimeTimer);
            messagesRealtimeTimer = null;
        }
    }

    function scheduleMarkersRealtimeReload() {
        if (markersRealtimeTimer) return;
        markersRealtimeTimer = setTimeout(() => {
            markersRealtimeTimer = null;
            if (typeof loadMarkers === 'function') loadMarkers().catch?.(()=>{});
        }, 300);
    }

    function scheduleMessagesRealtimeReload() {
        if (messagesRealtimeTimer) return;
        messagesRealtimeTimer = setTimeout(() => {
            messagesRealtimeTimer = null;
            const chatModal = document.getElementById('chatModal');
            if (chatModal && chatModal.classList.contains('active') && typeof loadChatMessages === 'function') {
                loadChatMessages().catch?.(()=>{});
            }
        }, 300);
    }

    function initRealtimeChannels() {
        if (!_sb) return;
        if (markersRealtimeChannel || messagesRealtimeChannel) return;

        markersRealtimeChannel = _sb
            .channel('realtime-markers')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'markers' }, (payload) => {
                scheduleMarkersRealtimeReload();
                handleRealtimeMarkerNotification(payload);
            })
            .subscribe();

        messagesRealtimeChannel = _sb
            .channel('realtime-messages')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => {
                scheduleMessagesRealtimeReload();
            })
            .subscribe();
    }

    function showBroadcastBanner(text, withSignal) {
        const banner = document.getElementById('broadcastBanner');
        if (!banner) return;
        banner.textContent = `üëë ${text}`;
        banner.classList.add('visible');
        clearTimeout(banner._hideTimer);
        banner._hideTimer = setTimeout(() => {
            banner.classList.remove('visible');
        }, 8000);
        if (withSignal) playAdminSignal();
    }

    function playAdminSignal() {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.value = 880;
            gain.gain.value = 0.0001;
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.5);
            osc.stop(ctx.currentTime + 0.55);
            osc.onended = () => ctx.close();
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Å–∏–≥–Ω–∞–ª:', e?.message || e);
        }
    }

    async function sendAdminBroadcast(withSignal) {
        if (!isAdmin) {
            alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
            return;
        }
        const input = document.getElementById('adminBroadcastText');
        const statusEl = document.getElementById('adminBroadcastStatus');
        const text = (input?.value || '').trim();
        if (!text) {
            if (statusEl) statusEl.textContent = '‚ùå –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
            return;
        }
        if (statusEl) statusEl.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';
        try {
            initAdminBroadcastChannel();
            const res = await adminBroadcastChannel.send({
                type: 'broadcast',
                event: 'admin-message',
                payload: { text, withSignal: !!withSignal, ts: Date.now(), by: String(uid || '') }
            });
            if (res !== 'ok' && res?.status !== 'ok') throw new Error('Broadcast failed');
            if (statusEl) statusEl.textContent = '‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
            input.value = '';
        } catch (e) {
            if (statusEl) statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏';
        }
    }

    function updateAdminInvisibleButton() {
        const toggle = document.getElementById('adminInvisibleToggle');
        if (!toggle) return;
        if (adminInvisible) {
            toggle.textContent = '–í–ö–õ';
            toggle.style.background = '#111';
            toggle.style.color = '#fff';
        } else {
            toggle.textContent = '–í–´–ö–õ';
            toggle.style.background = '#f0f0f5';
            toggle.style.color = '#333';
        }
    }

    async function refreshAdminInvisibleStatus() {
        let nextState = false;
        try {
            const { data } = await _sb
                .from('app_maintenance')
                .select('value')
                .eq('key', 'admin_invisible')
                .maybeSingle();
            if (data && data.value) {
                const settings = JSON.parse(data.value);
                nextState = !!settings.active;
            }
        } catch (err) {
            nextState = false;
        }
        if (adminInvisible !== nextState) {
            adminInvisible = nextState;
            updateAdminInvisibleButton();
            loadMarkersDebounced();
            if (isAdmin) updateUserLocationMarker();
        }
    }

    async function toggleAdminInvisible() {
        if (!isAdmin) return;
        const nextState = !adminInvisible;
        try {
            initAdminBroadcastChannel();
            if (nextState) {
                await _sb.from('app_maintenance').upsert({
                    key: 'admin_invisible',
                    value: JSON.stringify({ active: true, by: String(uid || ''), timestamp: Date.now() })
                }, { onConflict: 'key' });
            } else {
                await _sb.from('app_maintenance').delete().eq('key', 'admin_invisible');
            }
            adminInvisible = nextState;
            updateAdminInvisibleButton();
            loadMarkersDebounced();
            if (isAdmin) updateUserLocationMarker();
            if (adminBroadcastChannel) {
                await adminBroadcastChannel.send({
                    type: 'broadcast',
                    event: 'admin-visibility',
                    payload: { active: adminInvisible, ts: Date.now() }
                });
            }
        } catch (e) {
            alert('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –Ω–µ–≤–∏–¥–∏–º–∫–∏');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    function closeAdminModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        document.getElementById('adminModal').classList.remove('active');
    }

    // ============================================
    // JAVASCRIPT –ö–û–î –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ó–ê–ü–†–û–°–ê–ú–ò –ù–ê –†–ê–ó–ë–ê–ù
    // ============================================

    let currentFilter = 'all';
    let currentReviewRequestId = null;
    let allUnbanRequests = [];

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Ä–∞–∑–±–∞–Ω
    async function loadUnbanRequests() {
        try {
            const { data, error } = await _sb
                .from('unban_requests')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) throw error;

            allUnbanRequests = data || [];
            updateUnbanRequestsStats();
            displayUnbanRequests();

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:', error);
            document.getElementById('unbanRequestsBody').innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px; color: #dc3545;">
                        ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
                    </td>
                </tr>
            `;
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function updateUnbanRequestsStats() {
        const pending = allUnbanRequests.filter(r => r.status === 'pending').length;
        const approved = allUnbanRequests.filter(r => r.status === 'approved').length;
        const rejected = allUnbanRequests.filter(r => r.status === 'rejected').length;

        document.getElementById('pendingRequestsCount').textContent = pending;
        document.getElementById('approvedRequestsCount').textContent = approved;
        document.getElementById('rejectedRequestsCount').textContent = rejected;
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞
    function displayUnbanRequests() {
        const tbody = document.getElementById('unbanRequestsBody');
        
        let filteredRequests = allUnbanRequests;
        if (currentFilter !== 'all') {
            filteredRequests = allUnbanRequests.filter(r => r.status === currentFilter);
        }

        if (filteredRequests.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">
                        –ó–∞–ø—Ä–æ—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = filteredRequests.map(request => {
            const createdAt = new Date(request.created_at).toLocaleString('ru-RU');
            
            let statusBadge;
            if (request.status === 'pending') {
                statusBadge = '<span style="background: #fff3cd; color: #856404; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700;">‚è≥ –û–∂–∏–¥–∞–µ—Ç</span>';
            } else if (request.status === 'approved') {
                statusBadge = '<span style="background: #d4edda; color: #155724; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700;">‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ</span>';
            } else {
                statusBadge = '<span style="background: #f8d7da; color: #721c24; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700;">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>';
            }

            let actions;
            if (request.status === 'pending') {
                actions = `
                    <button onclick="openReviewUnbanModal(${request.id})" 
                        class="delete-btn" 
                        style="background: var(--blue); padding: 6px 12px;">
                        üîç –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å
                    </button>
                `;
            } else {
                const reviewedAt = request.reviewed_at ? new Date(request.reviewed_at).toLocaleString('ru-RU') : '-';
                actions = `<small style="color: var(--gray);">–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–æ: ${reviewedAt}</small>`;
            }

            return `
                <tr>
                    <td>#${request.id}</td>
                    <td><strong>${request.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</strong></td>
                    <td><code>${request.user_id}</code></td>
                    <td>${createdAt}</td>
                    <td>${statusBadge}</td>
                    <td>${actions}</td>
                </tr>
            `;
        }).join('');
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
    function filterUnbanRequests(filter) {
        currentFilter = filter;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
            btn.style.background = 'white';
            const color = btn.style.borderColor;
            btn.style.color = color || 'var(--blue)';
        });
        
        const filterMap = {
            'all': 'filterAll',
            'pending': 'filterPending',
            'approved': 'filterApproved',
            'rejected': 'filterRejected'
        };
        
        const activeBtn = document.getElementById(filterMap[filter]);
        if (activeBtn) {
            activeBtn.classList.add('active');
            const borderColor = activeBtn.style.borderColor;
            activeBtn.style.background = borderColor;
            activeBtn.style.color = 'white';
        }
        
        displayUnbanRequests();
    }

    // ============= –ó–∞–≥—Ä—É–∑–∫–∞ MP3 –æ–∑–≤—É—á–∫–∏ –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π =============
    async function uploadCustomWarningAudios() {
        const status = document.getElementById('warningAudioStatus');
        if (!status) return;

        if (typeof _sb === 'undefined' || !_sb.storage) {
            status.textContent = '‚ùå Supabase client –Ω–µ –Ω–∞–π–¥–µ–Ω';
            return;
        }

        const files = [
            { id: 'audioStandardFar', name: 'warning_standard_far.mp3' },
            { id: 'audioStandardClose', name: 'warning_standard_close.mp3' },
            { id: 'audioCheekyFar', name: 'warning_cheeky_far.mp3' },
            { id: 'audioCheekyClose', name: 'warning_cheeky_close.mp3' }
        ];

        const selected = files.map(item => {
            const input = document.getElementById(item.id);
            return { file: input?.files?.[0] || null, name: item.name };
        });

        const missing = selected.filter(item => !item.file).map(item => item.name);
        if (missing.length) {
            status.textContent = `‚ùå –ù–µ –≤—ã–±—Ä–∞–Ω—ã —Ñ–∞–π–ª—ã: ${missing.join(', ')}`;
            return;
        }

        status.textContent = '‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º MP3 –≤ Storage...';

        try {
            const bucket = 'audio';
            let success = 0;
            for (const item of selected) {
                const { error } = await _sb.storage
                    .from(bucket)
                    .upload(item.name, item.file, {
                        upsert: true,
                        contentType: item.file.type || 'audio/mpeg'
                    });
                if (error) throw error;
                success++;
            }

            status.textContent = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${success}/4 —Ñ–∞–π–ª–∞. –ì–æ—Ç–æ–≤–æ!`;
        } catch (e) {
            status.textContent = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (e?.message || e);
        }
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç AudioBuffer –≤ WAV Blob
    function bufferToWav(audioBuffer) {
        const numChannels = audioBuffer.numberOfChannels;
        const sampleRate = audioBuffer.sampleRate;
        const channelData = [];
        for (let i = 0; i < numChannels; i++) {
            channelData.push(audioBuffer.getChannelData(i));
        }
        
        // Interleave + –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ Int16
        const samples = new Float32Array(audioBuffer.length * numChannels);
        let offset = 0;
        for (let i = 0; i < audioBuffer.length; i++) {
            for (let c = 0; c < numChannels; c++) {
                samples[offset++] = channelData[c][i];
            }
        }
        
        const int16Samples = new Int16Array(samples.length);
        for (let i = 0; i < samples.length; i++) {
            int16Samples[i] = Math.max(-1, Math.min(1, samples[i])) < 0 
                ? samples[i] * 0x8000 
                : samples[i] * 0x7FFF;
        }
        
        // WAV –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const WAV_HEADER_SIZE = 44;
        const dataLength = int16Samples.length * 2;
        const fileLength = 36 + dataLength;
        const header = new ArrayBuffer(WAV_HEADER_SIZE);
        const view = new DataView(header);
        
        const writeString = (offset, string) => {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        };
        
        writeString(0, 'RIFF');
        view.setUint32(4, fileLength, true);
        writeString(8, 'WAVE');
        writeString(12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * numChannels * 2, true);
        view.setUint16(32, numChannels * 2, true);
        view.setUint16(34, 16, true);
        writeString(36, 'data');
        view.setUint32(40, dataLength, true);
        
        return new Blob([header, int16Samples], { type: 'audio/wav' });
    }

    // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
    async function refreshUnbanRequests() {
        await loadUnbanRequests();
    }

    // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è
    async function openReviewUnbanModal(requestId) {
        currentReviewRequestId = requestId;
        
        const request = allUnbanRequests.find(r => r.id === requestId);
        if (!request) return;

        document.getElementById('reviewUsername').textContent = request.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        document.getElementById('reviewUserId').textContent = request.user_id;
        document.getElementById('reviewCreatedAt').textContent = new Date(request.created_at).toLocaleString('ru-RU');
        document.getElementById('reviewComment').value = '';

        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–Ω–µ
        try {
            const { data: banData } = await _sb
                .from('bans')
                .select('*')
                .eq('user_id', request.user_id)
                .maybeSingle();

            if (banData) {
                const bannedUntil = new Date(banData.banned_until);
                const isPermanent = bannedUntil.getFullYear() > 2050;
                const banInfo = isPermanent 
                    ? 'üö´ –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –±–∞–Ω' 
                    : `‚è∞ –î–æ ${bannedUntil.toLocaleString('ru-RU')}`;
                document.getElementById('reviewBanInfo').innerHTML = `<span style="color: #dc3545; font-weight: 600;">${banInfo}</span>`;
            } else {
                document.getElementById('reviewBanInfo').innerHTML = '<span style="color: #28a745;">‚úÖ –ë–∞–Ω —É–∂–µ —Å–Ω—è—Ç</span>';
            }
        } catch (error) {
            document.getElementById('reviewBanInfo').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏';
        }

        document.getElementById('reviewUnbanModal').classList.add('active');
    }

    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è
    function closeReviewUnbanModal() {
        document.getElementById('reviewUnbanModal').classList.remove('active');
        currentReviewRequestId = null;
    }

    // –û–¥–æ–±—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å
    async function approveUnbanRequest() {
        if (!currentReviewRequestId) return;

        const comment = document.getElementById('reviewComment').value.trim();
        
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–¥–æ–±—Ä–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å? –ë–∞–Ω –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω—è—Ç.')) {
            return;
        }

        try {
            const adminIdString = String(uid);
            const request = allUnbanRequests.find(r => r.id === currentReviewRequestId);
            const targetUserId = request?.user_id ? String(request.user_id) : null;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–ø—Ä–æ—Å–∞ (—Ç—Ä–∏–≥–≥–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–º–µ—Ç –±–∞–Ω)
            const { error } = await _sb
                .from('unban_requests')
                .update({
                    status: 'approved',
                    reviewed_at: new Date().toISOString(),
                    reviewed_by: adminIdString,
                    reviewer_comment: comment || '–ó–∞–ø—Ä–æ—Å –æ–¥–æ–±—Ä–µ–Ω'
                })
                .eq('id', currentReviewRequestId);

            if (error) throw error;

            // –°–Ω–∏–º–∞–µ–º –±–∞–Ω —á–µ—Ä–µ–∑ Edge Function (–≤–Ω—É—Ç—Ä–∏ –≤—ã–∑–æ–≤ SECURITY DEFINER)
            if (targetUserId) {
                try {
                    await invokeAdminFunction('unban-user', { targetUserId });
                } catch (unbanError) {
                    console.warn('unban-user Edge Function error:', unbanError?.message || unbanError);
                }
            }

            alert('‚úÖ –ó–∞–ø—Ä–æ—Å –æ–¥–æ–±—Ä–µ–Ω! –ë–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω—è—Ç.');
            closeReviewUnbanModal();
            await loadUnbanRequests();

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    }

    // –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å
    async function rejectUnbanRequest() {
        if (!currentReviewRequestId) return;

        const comment = document.getElementById('reviewComment').value.trim();
        
        if (!comment) {
            alert('‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏');
            return;
        }

        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å?')) {
            return;
        }

        try {
            const adminIdString = String(uid);

            const { error } = await _sb
                .from('unban_requests')
                .update({
                    status: 'rejected',
                    reviewed_at: new Date().toISOString(),
                    reviewed_by: adminIdString,
                    reviewer_comment: comment
                })
                .eq('id', currentReviewRequestId);

            if (error) throw error;

            alert('‚ùå –ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω');
            closeReviewUnbanModal();
            await loadUnbanRequests();

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.getElementById('reviewUnbanModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeReviewUnbanModal();
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –º–µ—Ç–∫–∏
    async function setMarkerExpiry(markerId) {
        if (!isAdmin) {
            alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
            return;
        }

        const input = document.getElementById(`marker-exp-${markerId}`);
        if (!input) return alert('–ü–æ–ª–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');

        const val = input.value; // format: YYYY-MM-DDTHH:MM
        if (!val) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è');

        try {
            const ts = new Date(val);
            if (isNaN(ts)) return alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏');

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º ISO-—Å—Ç—Ä–æ–∫—É (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç), —á—Ç–æ–±—ã —Ö—Ä–∞–Ω–∏—Ç—å —á–∏—Ç–∞–µ–º—É—é –¥–∞—Ç—É
            const expValue = ts.toISOString();

            const { error } = await _sb.from('markers').update({ exp: expValue }).eq('id', markerId);
            if (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≤—Ä–µ–º–µ–Ω–∏: ' + (error?.message || error));
                return;
            }

            alert('–í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            await openAdminModal();
        } catch (e) {
            alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: –æ—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –º–µ—Ç–∫–∏
    async function clearMarkerExpiry(markerId) {
        if (!isAdmin) {
            alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
            return;
        }
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å—Ä–æ–∫ –∏—Å—Ç–µ—á–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π –º–µ—Ç–∫–∏?')) return;
        try {
            const { error } = await _sb.from('markers').update({ exp: null }).eq('id', markerId);
            if (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ: ' + (error?.message || error));
                return;
            }
            alert('–°—Ä–æ–∫ –∏—Å—Ç–µ—á–µ–Ω–∏—è —É–¥–∞–ª—ë–Ω');
            await openAdminModal();
        } catch (e) {
            alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
        }
    }

    async function expireMarkerById(markerId) {
        return _sb.from('markers').update({ exp: Date.now() }).eq('id', markerId);
    }

    async function expireMarkersByAuthor(authorId) {
        return _sb.from('markers').update({ exp: Date.now() }).eq('author_id', authorId);
    }







    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—è (–∞–¥–º–∏–Ω)
    async function deleteDriver(driverId) {
        if (!isAdmin) {
            alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
            return;
        }

        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —Ç–∞–∫–∂–µ —É–¥–∞–ª–∏—Ç –≤—Å–µ –º–µ—Ç–∫–∏ —ç—Ç–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è')) {
            try {
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ –º–µ—Ç–∫–∏ –≤–æ–¥–∏—Ç–µ–ª—è
                await expireMarkersByAuthor(driverId);
                // –£–¥–∞–ª—è–µ–º –≤–æ–¥–∏—Ç–µ–ª—è
                await _sb.from('drivers').delete().eq('user_id', driverId);
                // –ü—ã—Ç–∞–µ–º—Å—è —Å–Ω—è—Ç—å –±–∞–Ω —á–µ—Ä–µ–∑ Edge Function (–±–µ–∑ –ø—Ä—è–º—ã—Ö –ø—Ä–∞–≤)
                try {
                    await invokeAdminFunction('unban-user', { targetUserId: String(driverId) });
                } catch (e) {
                    console.warn('Edge Function unban-user –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e?.message || e);
                }
                alert('–í–æ–¥–∏—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
                openAdminModal(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + (e?.message || e));
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ (–∞–¥–º–∏–Ω)
    async function deleteMarkerAdmin(markerId) {
        if (!isAdmin) {
            alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
            return;
        }

        if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–µ—Ç–∫—É?')) {
            try {
                await expireMarkerById(markerId);
                alert('–ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
                openAdminModal(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                loadMarkers(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + (e?.message || e));
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞
    async function openChatModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'hidden';
        
        if (!currentDriver) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é');
            openRegistrationModal();
            return;
        }

        document.getElementById('chatModal').classList.add('active');
        await loadChatMessages();
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        chatUpdateInterval = setInterval(loadChatMessages, 5000);
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
    function showChatContextMenu(event, message, userId, userName) {
        event.stopPropagation();
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –º–µ–Ω—é –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        const oldMenu = document.querySelector('.chat-context-menu');
        if (oldMenu) oldMenu.remove();
        
        // –°–æ–∑–¥–∞—ë–º –º–µ–Ω—é
        const menu = document.createElement('div');
        menu.className = 'chat-context-menu';
        menu.style.left = event.pageX + 'px';
        menu.style.top = event.pageY + 'px';
        
        // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏–ª–∏ –∞–¥–º–∏–Ω–∞)
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'chat-context-menu-item delete';
        deleteBtn.innerHTML = '‚ùå –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ';
        deleteBtn.onclick = () => {
            deleteMessage(message.id, userId);
            menu.remove();
        };
        menu.appendChild(deleteBtn);
        
        // –ö–Ω–æ–ø–∫–∞ –∂–∞–ª–æ–±—ã –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const reportBtn = document.createElement('button');
        reportBtn.className = 'chat-context-menu-item report';
        reportBtn.innerHTML = '‚ö†Ô∏è –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è';
        reportBtn.onclick = () => {
            reportUser(userId, userName, '—Å–æ–æ–±—â–µ–Ω–∏–µ', message.text);
            menu.remove();
        };
        menu.appendChild(reportBtn);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –º–µ–Ω—é –≤ –¥–æ–∫—É–º–µ–Ω—Ç
        document.body.appendChild(menu);
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        setTimeout(() => {
            document.addEventListener('click', function closeMenu(e) {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            });
        }, 0);
    }

    function closeChatModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        
        document.getElementById('chatModal').classList.remove('active');
        if (chatUpdateInterval) clearInterval(chatUpdateInterval);
    }

    // ===================== –†–∞—Ü–∏—è (Push-to-Talk) ‚Äî –∫–ª–∏–µ–Ω—Ç =====================
    // –¢—Ä–µ–±—É–µ—Ç: Socket.io client (cdn), MediaRecorder, HTTPS –¥–ª—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.
    const PTT_SERVER_URL = 'https://monolith-180-ptt.onrender.com'; // –µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π origin
    const PTT_SERVER_URL_STORAGE_KEY = 'ptt:serverUrl';
    const PTT_MAX_RECORD_MS = 7000;
    const PTT_COOLDOWN_MS = 10000;

    let pttSocket = null;
    let pttMediaStream = null;
    let pttMediaRecorder = null;
    let pttChunks = [];

    let pttIsPressed = false;
    let pttCooldownUntil = 0;
    let pttRecordAutoStopTimer = null;
    let pttCooldownTimer = null;

    let pttChannelBusy = null; // { userId, name }
    let pttBanned = false;

    let pttLastMessageId = null;
    let pttReporterId = null;

    let pttWakeLock = null;

    function pttBaseUrl() {
        try {
            const stored = localStorage.getItem(PTT_SERVER_URL_STORAGE_KEY);
            const raw = String(stored || PTT_SERVER_URL || '').trim();
            if (raw) return raw.replace(/\/$/, '');
        } catch (e) {}
        return location.origin;
    }

    // –£–¥–æ–±–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏: –≤ –∫–æ–Ω—Å–æ–ª–∏ –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å
    // localStorage.setItem('ptt:serverUrl','https://xxx.onrender.com')
    // –∑–∞—Ç–µ–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.

    function pttEl(id) { return document.getElementById(id); }

    function pttGetName() {
        try {
            const driverName = String(currentDriver?.name || '').trim();
            if (driverName) return driverName.slice(0, 32);
        } catch (e) {}
        try {
            const tgName = String(window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name || '').trim();
            if (tgName) return tgName.slice(0, 32);
        } catch (e) {}
        return '–í–æ–¥–∏—Ç–µ–ª—å';
    }

    function pttGetUserId() {
        try {
            if (typeof uid !== 'undefined' && uid) return String(uid);
        } catch (e) {}
        // fallback
        try {
            const k = 'ptt:userId';
            const stored = localStorage.getItem(k);
            if (stored) return stored;
            const gen = String(Math.random()).slice(2, 10);
            localStorage.setItem(k, gen);
            return gen;
        } catch (e) {
            return 'anon';
        }
    }

    function pttLogStatus(text) {
        const el = pttEl('pttStatus');
        if (el) el.textContent = String(text || '');
    }

    function pttSetHoldButtonState(state) {
        const btn = pttEl('pttHoldBtn');
        if (!btn) return;
        btn.classList.remove('disabled', 'busy');
        btn.disabled = false;

        if (pttBanned) {
            btn.classList.add('disabled');
            btn.disabled = true;
            btn.textContent = 'üö´ –í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –≤ —Ä–∞—Ü–∏–∏ (30 –º–∏–Ω)';
            return;
        }

        const now = Date.now();
        const cooldownLeft = Math.max(0, pttCooldownUntil - now);
        if (cooldownLeft > 0) {
            btn.classList.add('disabled');
            btn.disabled = true;
            const sec = Math.ceil(cooldownLeft / 1000);
            btn.textContent = `‚è≥ –ü–æ–¥–æ–∂–¥–∏ ${sec}—Å`;
            return;
        }

        const myId = pttGetUserId();
        if (pttChannelBusy && String(pttChannelBusy.userId) !== String(myId)) {
            btn.classList.add('busy');
            btn.disabled = true;
            btn.textContent = `–ö–∞–Ω–∞–ª –∑–∞–Ω—è—Ç: ${pttChannelBusy.name}`;
            return;
        }

        if (state === 'pressed') {
            btn.textContent = 'üéôÔ∏è –ì–æ–≤–æ—Ä—é‚Ä¶ –æ—Ç–ø—É—Å—Ç–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏';
            return;
        }

        btn.textContent = 'üéôÔ∏è –£–¥–µ—Ä–∂–∏–≤–∞–π, —á—Ç–æ–±—ã –≥–æ–≤–æ—Ä–∏—Ç—å';
    }

    function pttStartCooldown() {
        pttCooldownUntil = Date.now() + PTT_COOLDOWN_MS;
        if (pttCooldownTimer) clearInterval(pttCooldownTimer);
        pttCooldownTimer = setInterval(() => {
            pttSetHoldButtonState('idle');
            if (Date.now() >= pttCooldownUntil) {
                clearInterval(pttCooldownTimer);
                pttCooldownTimer = null;
                pttSetHoldButtonState('idle');
            }
        }, 250);
        pttSetHoldButtonState('idle');
    }

    async function pttRequestWakeLock() {
        try {
            if (!('wakeLock' in navigator)) return;
            if (document.hidden) return;
            if (pttWakeLock) return;
            pttWakeLock = await navigator.wakeLock.request('screen');
            pttWakeLock.addEventListener('release', () => { pttWakeLock = null; });
        } catch (e) {
            pttWakeLock = null;
        }
    }

    function pttReleaseWakeLock() {
        try { pttWakeLock?.release(); } catch (e) {}
        pttWakeLock = null;
    }

    async function pttEnsureMic() {
        if (pttMediaStream) return pttMediaStream;
        if (!navigator.mediaDevices?.getUserMedia) throw new Error('getUserMedia unsupported');
        pttMediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        return pttMediaStream;
    }

    function pttStartRecording() {
        pttChunks = [];

        const options = {};
        try {
            if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                options.mimeType = 'audio/webm;codecs=opus';
            }
        } catch (e) {}

        pttMediaRecorder = new MediaRecorder(pttMediaStream, options);
        pttMediaRecorder.ondataavailable = (e) => {
            if (e.data && e.data.size > 0) pttChunks.push(e.data);
        };
        pttMediaRecorder.onstop = () => {
            try {
                const blob = new Blob(pttChunks, { type: pttMediaRecorder.mimeType || 'audio/webm' });
                pttUpload(blob).catch(() => {});
            } catch (e) {
                pttLogStatus('–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ –∑–∞–ø–∏—Å–∏');
            }
        };

        pttMediaRecorder.start();
    }

    function pttStopRecording() {
        try {
            if (!pttMediaRecorder) return;
            if (pttMediaRecorder.state !== 'inactive') pttMediaRecorder.stop();
        } catch (e) {}
    }

    async function pttUpload(blob) {
        const fd = new FormData();
        fd.append('userId', pttGetUserId());
        fd.append('name', pttGetName());
        fd.append('audio', blob, `ptt-${Date.now()}.webm`);

        pttLogStatus('–û—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶');

        const resp = await fetch(`${pttBaseUrl()}/ptt/upload`, { method: 'POST', body: fd });
        if (!resp.ok) {
            const t = await resp.text().catch(() => '');
            if (resp.status === 409) {
                pttLogStatus('–ö–∞–Ω–∞–ª –∑–∞–Ω—è—Ç');
            } else if (resp.status === 403) {
                pttLogStatus('–í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –≤ —Ä–∞—Ü–∏–∏');
                pttBanned = true;
            } else {
                pttLogStatus(`–û—à–∏–±–∫–∞ upload: ${resp.status}`);
            }
            console.warn('ptt upload error:', resp.status, t);
            pttSetHoldButtonState('idle');
            return;
        }

        pttLogStatus('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ');
        pttStartCooldown();
    }

    function pttClearAutoStopTimer() {
        if (pttRecordAutoStopTimer) {
            clearTimeout(pttRecordAutoStopTimer);
            pttRecordAutoStopTimer = null;
        }
    }

    function pttCanTalkNow() {
        if (pttBanned) return false;
        if (Date.now() < pttCooldownUntil) return false;
        const myId = pttGetUserId();
        if (pttChannelBusy && String(pttChannelBusy.userId) !== String(myId)) return false;
        return true;
    }

    async function pttPressStart() {
        if (pttIsPressed) return;
        if (!pttCanTalkNow()) {
            pttSetHoldButtonState('idle');
            return;
        }

        try {
            await pttRequestWakeLock();
            await pttEnsureMic();
            pttConnectSocket();
            try { pttSocket?.emit('ptt:start'); } catch (e) {}

            pttIsPressed = true;
            pttSetHoldButtonState('pressed');
            pttLogStatus('–ó–∞–ø–∏—Å—å‚Ä¶');

            pttStartRecording();

            pttClearAutoStopTimer();
            pttRecordAutoStopTimer = setTimeout(() => {
                if (!pttIsPressed) return;
                pttPressEnd(true);
            }, PTT_MAX_RECORD_MS);
        } catch (e) {
            pttIsPressed = false;
            pttLogStatus('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
            pttSetHoldButtonState('idle');
        }
    }

    function pttPressEnd(auto = false) {
        if (!pttIsPressed) return;
        pttIsPressed = false;
        pttClearAutoStopTimer();

        try { pttSocket?.emit('ptt:stop'); } catch (e) {}
        pttStopRecording();

        pttLogStatus(auto ? '7 —Å–µ–∫ ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è—é‚Ä¶' : '–û—Ç–ø—É—â–µ–Ω–æ ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è—é‚Ä¶');
        pttSetHoldButtonState('idle');
    }

    function pttAttachHoldHandlers() {
        const btn = pttEl('pttHoldBtn');
        if (!btn) return;

        btn.addEventListener('mousedown', (e) => { e.preventDefault(); pttPressStart(); });
        window.addEventListener('mouseup', () => pttPressEnd(false));
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); pttPressStart(); }, { passive: false });
        window.addEventListener('touchend', () => pttPressEnd(false));
        btn.addEventListener('mouseleave', () => pttPressEnd(false));
    }

    function pttEnsureReporterId() {
        if (pttReporterId) return pttReporterId;
        try {
            const k = 'ptt:reporterId';
            const stored = localStorage.getItem(k);
            if (stored) { pttReporterId = stored; return stored; }
            const gen = String(Math.random()).slice(2, 12);
            localStorage.setItem(k, gen);
            pttReporterId = gen;
            return gen;
        } catch (e) {
            pttReporterId = 'anon';
            return 'anon';
        }
    }

    async function pttComplainLast() {
        if (!pttLastMessageId) return;
        const btn = pttEl('pttComplainBtn');
        if (btn) btn.disabled = true;
        try {
            const resp = await fetch(`${pttBaseUrl()}/ptt/complaint`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reporterId: pttEnsureReporterId(), messageId: pttLastMessageId })
            });
            const data = await resp.json().catch(() => null);
            if (!resp.ok) {
                pttLogStatus('–ñ–∞–ª–æ–±–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
                return;
            }
            pttLogStatus(`–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ (—Å—á—ë—Ç—á–∏–∫: ${data?.count || 0})`);
        } catch (e) {
            pttLogStatus('–ñ–∞–ª–æ–±–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
        } finally {
            setTimeout(() => { if (btn) btn.disabled = false; }, 1500);
        }
    }

    async function pttPlayIncoming(msg) {
        const speakerName = String(msg?.speakerName || '–ö—Ç–æ-—Ç–æ');
        const url = String(msg?.url || '');
        if (!url) return;

        // –ì–æ–ª–æ—Å–æ–≤–æ–π —à—Ç—É—Ä–º–∞–Ω: —Å–Ω–∞—á–∞–ª–∞ –∏–º—è
        try {
            if (typeof aiSpeak === 'function') aiSpeak(`–ù–∞ —Å–≤—è–∑–∏ ${speakerName}`);
            else if (window.speechSynthesis) {
                const u = new SpeechSynthesisUtterance(`–ù–∞ —Å–≤—è–∑–∏ ${speakerName}`);
                u.lang = 'ru-RU'; u.rate = 1.0;
                window.speechSynthesis.speak(u);
            }
        } catch (e) {}

        // –Ω–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞, —á—Ç–æ–±—ã –Ω–µ —Å–ª–∏–ø–∞–ª–æ—Å—å
        await new Promise(r => setTimeout(r, 450));

        try {
            await pttRequestWakeLock();
            const a = new Audio(`${pttBaseUrl()}${url.startsWith('/') ? '' : '/'}${url}`);
            a.volume = 1.0;
            await a.play();
        } catch (e) {
            console.warn('PTT play blocked:', e);
        }
    }

    function pttConnectSocket() {
        if (pttSocket) return;
        if (typeof io !== 'function') {
            pttLogStatus('Socket.io –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
            return;
        }

        pttSocket = io(pttBaseUrl(), { transports: ['websocket', 'polling'] });

        pttSocket.on('connect', () => {
            try { pttSocket.emit('hello', { userId: pttGetUserId(), name: pttGetName() }); } catch (e) {}
            pttLogStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Ä–∞—Ü–∏–∏');
            pttSetHoldButtonState('idle');
            pttRequestWakeLock();
        });

        pttSocket.on('ptt:state', (state) => {
            pttChannelBusy = state?.busy || null;
            pttBanned = !!state?.banned;
            pttSetHoldButtonState(pttIsPressed ? 'pressed' : 'idle');
        });

        pttSocket.on('ptt:busy', (busy) => {
            pttChannelBusy = busy || null;
            pttSetHoldButtonState(pttIsPressed ? 'pressed' : 'idle');
        });

        pttSocket.on('ptt:free', () => {
            pttChannelBusy = null;
            pttSetHoldButtonState(pttIsPressed ? 'pressed' : 'idle');
        });

        pttSocket.on('ptt:denied', (info) => {
            if (info?.reason === 'banned') {
                pttBanned = true;
                pttLogStatus('–í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –≤ —Ä–∞—Ü–∏–∏');
            } else if (info?.reason === 'busy') {
                pttChannelBusy = info?.busy || pttChannelBusy;
                pttLogStatus('–ö–∞–Ω–∞–ª –∑–∞–Ω—è—Ç');
            }
            pttSetHoldButtonState('idle');
        });

        pttSocket.on('ptt:banned', (info) => {
            if (String(info?.userId) === String(pttGetUserId())) {
                pttBanned = true;
                pttLogStatus('–ê–≤—Ç–æ–±–∞–Ω –≤ —Ä–∞—Ü–∏–∏ –Ω–∞ 30 –º–∏–Ω—É—Ç');
                pttSetHoldButtonState('idle');
            }
        });

        pttSocket.on('ptt:message', (msg) => {
            pttLastMessageId = String(msg?.id || '') || null;
            const btn = pttEl('pttComplainBtn');
            if (btn) btn.disabled = !pttLastMessageId;

            // —Å–≤–æ—ë –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º
            if (String(msg?.speakerId) === String(pttGetUserId())) return;
            pttPlayIncoming(msg).catch(() => {});
        });
    }

    function pttDisconnectSocket() {
        try { pttSocket?.disconnect(); } catch (e) {}
        pttSocket = null;
    }

    function openPttModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'hidden';
        const modal = pttEl('pttModal');
        if (modal) modal.classList.add('active');
        pttAttachHoldHandlers();
        const complainBtn = pttEl('pttComplainBtn');
        if (complainBtn && !complainBtn.__pttBound) {
            complainBtn.__pttBound = true;
            complainBtn.addEventListener('click', pttComplainLast);
        }
        pttConnectSocket();
        pttSetHoldButtonState('idle');
        pttRequestWakeLock();
    }

    function closePttModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        const modal = pttEl('pttModal');
        if (modal) modal.classList.remove('active');
        try { pttPressEnd(false); } catch(e) {}
        pttDisconnectSocket();
        pttReleaseWakeLock();
    }

    document.addEventListener('visibilitychange', () => {
        try {
            if (!document.hidden) pttRequestWakeLock();
            else pttReleaseWakeLock();
        } catch (e) {}
    });

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    async function deleteMessage(messageId, authorId) {
        try {
            const msgId = parseInt(messageId);
            const authId = parseInt(authorId);
            
            const isOwnMessage = authId === uid;
            const isAdminDeleting = isAdmin && authId !== uid;
            
            if (!isOwnMessage && !isAdminDeleting) {
                alert('–í—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }
            
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;
            
            const { error } = await _sb.from('messages').delete().eq('id', msgId);
            if (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                return;
            }
            console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ:', msgId);
            await loadChatMessages();
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', e);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (e?.message || e));
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)
    async function deleteAllUserMessages(userId, userName) {
        if (!isAdmin) {
            alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            return;
        }
        
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) return;
        
        try {
            const { error } = await _sb.from('messages').delete().eq('author_id', userId);
            if (error) {
                alert('–û—à–∏–±–∫–∞: ' + (error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                return;
            }
            alert('‚úÖ –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª–µ–Ω—ã');
            await loadChatMessages();
        } catch (e) {
            alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∂–∞–ª–æ–±—ã –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function reportUser(userId, userName, reportType = '—Å–æ–æ–±—â–µ–Ω–∏–µ', content = '') {
        if (!uid) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ Telegram');
            const overlay = document.getElementById('tgAuthOverlay'); if (overlay) overlay.style.display = 'flex';
            return;
        }
        if (!currentDriver) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ Telegram –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∂–∞–ª–æ–±—ã');
            openRegistrationModal();
            return;
        }

        const reason = prompt(`–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}"?\n\n–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∂–∞–ª–æ–±—ã:\n\n–ü—Ä–∏–º–µ—Ä—ã: "–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è", "–°–ø–∞–º", "–õ–æ–∂–Ω—ã–µ –º–µ—Ç–∫–∏", "–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ"`, '');
        
        if (reason === null) return; // –û—Ç–º–µ–Ω–∞
        if (!reason.trim()) return alert('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∂–∞–ª–æ–±—ã');
        
        try {
            // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø–∏—Å–∞—Ç—å –∂–∞–ª–æ–±—É –≤ —Ç–∞–±–ª–∏—Ü—É reports
            const reportData = {
                reporter_id: uid,
                reported_user_id: userId,
                reported_user_name: userName,
                report_type: reportType,
                reason: reason.trim(),
                content: content,
                status: 'new',
                created_at: new Date().toISOString()
            };
            
            const { error: reportError } = await _sb.from('reports').insert([reportData]);
            
            if (reportError) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É reports:', reportError);
                
                // –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –∏–ª–∏ –ª–æ–≥–∏—Ä—É–µ–º
                if (reportError.message && reportError.message.includes('reports')) {
                    console.warn('–¢–∞–±–ª–∏—Ü–∞ reports –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–æ–ø—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ messages...');
                    
                    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
                    const adminMessage = {
                        author_id: -1,
                        author_name: 'üö® –ê–î–ú–ò–ù –ê–õ–ï–†–¢',
                        text: `üìã –ñ–ê–õ–û–ë–ê: ${reason.trim()}\nüë§ –ù–∞: ${userName} (ID: ${userId})\nüìù –¢–∏–ø: ${reportType}\nüìå –û—Ç: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è`,
                        created_at: new Date().toISOString()
                    };
                    
                    const { error: msgError } = await _sb.from('messages').insert([adminMessage]);
                    
                    if (msgError) {
                        alert('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∂–∞–ª–æ–±—ã: ' + (msgError?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π –∂–∞–ª–æ–±—ã:', msgError);
                        return;
                    }
                }
            }
            
            alert('‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ! –í–∞—à–∞ –∂–∞–ª–æ–±–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.');
            console.log('‚úÖ –ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞:', reportData);
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∂–∞–ª–æ–±—ã:', e);
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∂–∞–ª–æ–±—ã: ' + (e?.message || e));
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –±—ã—Å—Ç—Ä–æ–≥–æ –º–µ–Ω—é –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞ (–æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º –Ω–∞ —é–∑–µ—Ä–∞)
    async function showUserModeratorMenu(userId, userName, event) {
        if (!isAdmin) {
            reportUser(userId, userName, '—Å–æ–æ–±—â–µ–Ω–∏–µ', '');
            return;
        }

        // –ó–∞—â–∏—Ç–∞ –æ—Ç undefined event
        if (!event) {
            event = { pageX: window.innerWidth / 2, pageY: window.innerHeight / 2, stopPropagation: () => {} };
        }

        if (event.stopPropagation) {
            event.stopPropagation();
        }

        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –º–µ–Ω—é –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        const oldMenu = document.querySelector('.moderator-menu');
        if (oldMenu) oldMenu.remove();

        // –°–æ–∑–¥–∞—ë–º –º–µ–Ω—é
        const menu = document.createElement('div');
        menu.className = 'moderator-menu';
        menu.style.cssText = `
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 3000;
            border: 2px solid #ff9500;
            overflow: hidden;
        `;
        menu.style.left = (event.pageX || window.innerWidth / 2) + 'px';
        menu.style.top = (event.pageY || window.innerHeight / 2) + 'px';

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
        const createMenuBtn = (text, color, callback) => {
            const btn = document.createElement('button');
            btn.style.cssText = `
                display: block;
                width: 100%;
                border: none;
                padding: 10px 15px;
                text-align: left;
                cursor: pointer;
                background: white;
                color: ${color};
                font-weight: 600;
                border-bottom: 1px solid #eee;
                font-size: 13px;
            `;
            btn.innerHTML = text;
            btn.onmouseover = () => btn.style.background = '#f9f9f9';
            btn.onmouseout = () => btn.style.background = 'white';
            btn.onclick = callback;
            return btn;
        };

        // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        menu.appendChild(createMenuBtn('üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è', '#ff3b30', () => {
            deleteAllUserMessages(userId, userName);
            menu.remove();
        }));

        // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –º–µ—Ç–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        menu.appendChild(createMenuBtn('üìç –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–µ—Ç–∫–∏', '#ff9500', () => {
            deleteAllUserMarkers(userId, userName);
            menu.remove();
        }));

        // –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∂–∞–ª–æ–±—ã
        menu.appendChild(createMenuBtn('‚ö†Ô∏è –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è', '#007aff', () => {
            reportUser(userId, userName, '—Å–æ–æ–±—â–µ–Ω–∏–µ', '');
            menu.remove();
        }));

        // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è
        menu.appendChild(createMenuBtn('üë§ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å', '#34c759', () => {
            // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è
            alert('–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ–∫–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞');
            menu.remove();
        }));

        // –î–æ–±–∞–≤–ª—è–µ–º –º–µ–Ω—é –≤ –¥–æ–∫—É–º–µ–Ω—Ç
        document.body.appendChild(menu);

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        setTimeout(() => {
            document.addEventListener('click', function closeMenu(e) {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            });
        }, 0);
    }

    // –§—É–Ω–∫—Ü–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
    async function moderateUserFromProfile(userId, userName, banType) {
        if (!isAdmin) {
            alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –º–æ–¥–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            return;
        }

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        closeProfileModal();

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏
        currentModeratingUserId = userId;
        document.getElementById('modUserName').textContent = userName || '–ê–Ω–æ–Ω–∏–º';
        document.getElementById('modUserId').textContent = userId;

        if (banType === 'temp') {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            openBanDurationModal();
        } else {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –±–∞–Ω–∞
            document.getElementById('moderatorModal').classList.add('active');
            
            // –°—Ä–∞–∑—É –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –±–∞–Ω–∞
            setTimeout(() => {
                banUser('permanent');
            }, 100);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –º–µ—Ç–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function deleteAllUserMarkers(userId, userName) {
        if (!isAdmin) {
            alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –º–µ—Ç–∫–∏ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            return;
        }

        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–µ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) return;

        try {
            const { error } = await expireMarkersByAuthor(userId);
            if (error) {
                alert('–û—à–∏–±–∫–∞: ' + (error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                return;
            }
            alert('‚úÖ –í—Å–µ –º–µ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª–µ–Ω—ã. –û–±–Ω–æ–≤–∏—Ç–µ –∫–∞—Ä—Ç—É.');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (typeof loadMarkers === 'function') {
                loadMarkers();
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
        }
    }

    // –í–µ—Ä—Å–∏—è –º–µ–Ω—é –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ balloonContent)
    window.showUserModeratorMenuFromMarker = (userId, userName) => {
        if (!window.isAdmin) {
            window.reportUser(userId, userName, '–º–∞—Ä–∫–µ—Ä', '');
            return;
        }

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –±–∞–ª—É–Ω
        if (window.myMap && window.myMap.balloon) {
            window.myMap.balloon.close();
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
        setTimeout(() => {
            window.showUserModeratorMenu(userId, userName, new MouseEvent('click', {
                bubbles: true,
                cancelable: true,
                view: window,
                pageX: window.innerWidth / 2,
                pageY: window.innerHeight / 2
            }));
        }, 100);
    };

    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞
    let chatUpdateInterval = null;

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞
    async function loadChatMessages() {
        try {
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ 30 –¥–ª—è –±—ã—Å—Ç—Ä–æ—Å—Ç–∏
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª-–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ 30 –¥–ª—è –±—ã—Å—Ç—Ä–æ—Ç—ã —Ä–µ–Ω–¥–µ—Ä–∞
            const { data: messages } = await _sb.from('messages').select('*').order('created_at', { ascending: true }).limit(30);
            const container = document.getElementById('chatMessages');

            if (!messages || messages.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--gray); padding: 20px;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
                return;
            }

            // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∞–≤—Ç–æ—Ä—ã –∏ –ø–æ–ª—É—á–∞–µ–º –∏—Ö –¥–∞–Ω–Ω—ã–µ (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
            const authorIds = Array.from(new Set(messages.map(m => String(m.author_id))));
            let authorsMap = {};
            const now = Date.now();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—Å—Ç–∞—Ä–µ–ª –ª–∏ –∫—ç—à
            if (now - authorsCacheTime > CACHE_DURATION) {
                authorsCache = {};
                authorsCacheTime = now;
            }
            
            // –ë–µ—Ä—ë–º –∏–∑ –∫—ç—à–∞ —Ç–æ —á—Ç–æ –µ—Å—Ç—å
            const cachedIds = authorIds.filter(id => authorsCache[id]);
            const uncachedIds = authorIds.filter(id => !authorsCache[id]);
            
            // –ö–æ–ø–∏—Ä—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            cachedIds.forEach(id => { authorsMap[id] = authorsCache[id]; });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
            if (uncachedIds.length > 0) {
                try {
                    const { data: authors } = await _sb.from('drivers').select('user_id,likes_sum,is_trusted,avatar_url').in('user_id', uncachedIds);
                    if (authors) {
                        authors.forEach(a => {
                            const id = String(a.user_id);
                            authorsMap[id] = a;
                            authorsCache[id] = a; // –ö—ç—à–∏—Ä—É–µ–º
                        });
                    }
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–µ–π –∞–≤—Ç–æ—Ä–æ–≤:', e?.message || e);
                }
            }

            // –£—Ç–∏–ª–∏—Ç–∞: –ø–µ—Ä–µ–≤–æ–¥–∏–º likes_sum –≤ 0..5 –∑–≤—ë–∑–¥
            function likesToStars(likes) {
                const n = Number(likes) || 0;
                if (n <= 0) return 0;
                if (n >= 100) return 5;
                if (n >= 60) return 4;
                if (n >= 30) return 3;
                if (n >= 10) return 2;
                return 1;
            }

            // –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å –±–µ–π–¥–∂–∞–º–∏-–∑–≤—ë–∑–¥–∞–º–∏ —Ä—è–¥–æ–º —Å –∏–º–µ–Ω–µ–º
            container.innerHTML = '';
            messages.forEach(msg => {
                const isOwn = String(msg.author_id) === String(uid);
                const canDelete = isOwn || isAdmin;
                const messageEl = document.createElement('div');
                messageEl.className = `chat-message ${isOwn ? 'own' : 'other'}`;
                messageEl.style.position = 'relative';

                let photoHTML = '';
                if (msg.photo_url && msg.photo_url.trim()) {
                    photoHTML = `<img src="${msg.photo_url}" class="chat-message-photo" onclick="openPhotoViewer('${msg.photo_url}')" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è" style="display: block; margin-top: 8px; max-width: 100%;">`;
                }

                const timestamp = new Date(msg.created_at).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

                let deleteButtonHTML = '';
                if (canDelete) {
                    deleteButtonHTML = `<button class="chat-delete-btn" data-msg-id="${msg.id}" data-author-id="${msg.author_id}" style="position: absolute; top: 5px; right: 5px; background: #ff3b30; color: white; border: none; border-radius: 4px; padding: 2px 6px; font-size: 10px; cursor: pointer; transition: all 0.2s;" title="–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">‚ùå</button>`;
                }

                // –ë–µ–π–¥–∂ –∑–≤—ë–∑–¥
                const authorInfo = authorsMap[String(msg.author_id)] || {};
                const likesSum = authorInfo.likes_sum || 0;
                const isTrusted = !!authorInfo.is_trusted;
                const starsCount = likesToStars(likesSum);
                let starsHTML = '';
                for (let i = 0; i < 5; i++) starsHTML += (i < starsCount) ? '‚òÖ' : '‚òÜ';
                const starsBadge = `<span style="margin-left:8px; color: ${isTrusted ? '#b8860b' : '#f5c542'}; font-weight:700;">${starsHTML}</span>`;

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä (—Ñ–æ—Ç–æ –∏–ª–∏ emoji)
                let avatarHTML = '';
                if (authorInfo.avatar_url) {
                    avatarHTML = `<img src="${authorInfo.avatar_url}" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 6px; object-fit: cover;">`;
                } else {
                    const avatar = authorInfo.avatar || 'üë§';
                    avatarHTML = `<span style="margin-right: 6px; font-size: 16px;">${avatar}</span>`;
                }

                messageEl.innerHTML = `
                    ${deleteButtonHTML}
                    ${!isOwn ? `<div class="chat-message-author" style="display: flex; align-items: center; cursor: ${isAdmin ? 'pointer' : 'default'}; ${isAdmin ? 'padding: 4px 8px; border-radius: 6px; transition: all 0.2s; user-select: none;' : ''}" data-user-id="${msg.author_id}" data-user-name="${(msg.author_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å').replace(/"/g, '&quot;')}">${avatarHTML}<span>${msg.author_name || '–ê–Ω–æ–Ω–∏–º'}</span> ${starsBadge}</div>` : ''}
                    <div>${msg.text || ''}</div>
                    ${photoHTML}
                    <div class="chat-message-time">${timestamp}</div>
                `;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∏–º—è –¥–ª—è –∞–¥–º–∏–Ω–∞
                if (isAdmin && !isOwn) {
                    const authorDiv = messageEl.querySelector('.chat-message-author');
                    if (authorDiv) {
                        authorDiv.onclick = (e) => {
                            showUserModeratorMenu(msg.author_id, msg.author_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', e);
                        };
                        authorDiv.onmouseover = () => {
                            authorDiv.style.background = '#f0f0f5';
                            authorDiv.style.transform = 'scale(1.02)';
                        };
                        authorDiv.onmouseout = () => {
                            authorDiv.style.background = '';
                            authorDiv.style.transform = 'scale(1)';
                        };
                    }
                }
                container.appendChild(messageEl);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
                const deleteBtn = messageEl.querySelector('.chat-delete-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', async function(e) {
                        e.stopPropagation();
                        const msgId = this.dataset.msgId;
                        const authorId = this.dataset.authorId;
                        await deleteMessage(msgId, authorId);
                    });
                    deleteBtn.addEventListener('mouseover', function() {
                        this.style.background = '#d32f2b';
                        this.style.transform = 'scale(1.1)';
                    });
                    deleteBtn.addEventListener('mouseout', function() {
                        this.style.background = '#ff3b30';
                        this.style.transform = 'scale(1)';
                    });
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ (–µ—Å–ª–∏ –∞–¥–º–∏–Ω)
                if (isAdmin && !isOwn) {
                    messageEl.style.cursor = 'pointer';
                    messageEl.addEventListener('click', function(e) {
                        const author = this.querySelector('[data-user-id]');
                        if (author && !e.target.closest('.chat-delete-btn')) {
                            showChatContextMenu(e, msg, author.dataset.userId, author.dataset.userName);
                        }
                    });
                }
            });

            // –°–∫—Ä–æ–ª–∏–º –≤–Ω–∏–∑ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            container.scrollTop = container.scrollHeight;
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π:', e?.message || e);
            document.getElementById('chatMessages').innerHTML = '<div style="text-align: center; color: red; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–∂–∞—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ)
    async function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.7) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –±–æ–ª—å—à–µ –ª–∏–º–∏—Ç–∞
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = width * ratio;
                        height = height * ratio;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // –°–∂–∏–º–∞–µ–º –≤ JPEG —Å –Ω—É–∂–Ω—ã–º –∫–∞—á–µ—Å—Ç–≤–æ–º
                    canvas.toBlob((blob) => {
                        resolve(blob);
                    }, 'image/jpeg', quality);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
    async function sendChatMessage() {
        if (!currentDriver) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ Telegram');
            openRegistrationModal();
            return;
        }
        const messageText = document.getElementById('chatInput').value.trim();
        
        if (!messageText && !selectedChatPhoto) {
            alert('–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ');
            return;
        }

        let photoURL = null;

        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ Base64
        if (selectedChatPhoto) {
            try {
                // –°–∂–∏–º–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                const compressedBlob = await compressImage(selectedChatPhoto, 800, 800, 0.7);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ—Å–ª–µ —Å–∂–∞—Ç–∏—è (–º–∞–∫—Å–∏–º—É–º 2MB)
                if (compressedBlob.size > 2 * 1024 * 1024) {
                    alert('‚ùå –§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ –¥–∞–∂–µ –ø–æ—Å–ª–µ —Å–∂–∞—Ç–∏—è. –ú–∞–∫—Å–∏–º—É–º 2MB.');
                    selectedChatPhoto = null;
                    return;
                }

                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º blob –≤ Base64
                const reader = new FileReader();
                await new Promise((resolve, reject) => {
                    reader.onload = function(event) {
                        photoURL = event.target.result; // data:image/jpeg;base64,...
                        console.log('‚úÖ –§–æ—Ç–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–æ –≤ Base64, —Ä–∞–∑–º–µ—Ä:', photoURL.length);
                        resolve();
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(compressedBlob);
                });
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ:', e?.message || e);
                alert('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ: ' + (e?.message || e));
                selectedChatPhoto = null;
                return;
            }
        }

        // –í—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ë–î
        try {
            const messageData = {
                author_id: String(uid || ''),
                author_name: currentDriver?.name || '–ê–Ω–æ–Ω–∏–º',
                text: messageText || '',
                created_at: new Date().toISOString()
            };

            if (!messageData.author_id) {
                alert('‚ùå –û—à–∏–±–∫–∞: –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–Ω–∏‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
                return;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
            if (photoURL) {
                messageData.photo_url = photoURL;
            }
            
            const { error } = await _sb.from('messages').insert([messageData]);

            if (!error) {
                console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
                document.getElementById('chatInput').value = '';
                selectedChatPhoto = null;
                document.getElementById('chatPhotoPreview').innerHTML = '';
                await loadChatMessages();
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                console.error('–û—à–∏–±–∫–∞ –ë–î:', error);
            }
        } catch (e) {
            alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (e?.message || e));
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', e);
        }
    }

    // –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª–µ last_seen –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
    let presenceSupported = true;
    async function updateLastSeen() {
        if (!uid) return;
        if (!presenceSupported) return;
        try {
            const payload = { user_id: uid, last_seen: new Date().toISOString() };
            const { error } = await _sb.from('drivers').upsert([payload], { onConflict: 'user_id' });
            if (error) {
                // –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞, –≤–æ–∑–º–æ–∂–Ω–æ –∫–æ–ª–æ–Ω–∫–∏ –Ω–µ—Ç ‚Äî –æ—Ç–∫–ª—é—á–∞–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
                console.warn('updateLastSeen error:', error.message || error);
                presenceSupported = false;
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ updateLastSeen:', e?.message || e);
            presenceSupported = false;
        }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å last_seen –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 2 –º–∏–Ω—É—Ç
    async function loadOnlineCount() {
        const badge = document.getElementById('onlineCountBadge');
        if (!badge) return;
        if (!presenceSupported) {
            badge.textContent = '–û–Ω–ª–∞–π–Ω: N/A';
            return;
        }
        try {
            const threshold = new Date(Date.now() - 2*60*1000).toISOString();
            const res = await _sb.from('drivers').select('user_id', { count: 'exact' }).gte('last_seen', threshold);
            const count = res.count || (res.data ? res.data.length : 0);
            badge.textContent = `–û–Ω–ª–∞–π–Ω: ${count}`;
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ loadOnlineCount:', e?.message || e);
            badge.textContent = '–û–Ω–ª–∞–π–Ω: ?';
            presenceSupported = false;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è —á–∞—Ç–∞
    document.addEventListener('change', function(e) {
        if (e.target.id === 'chatPhotoInput') {
            const file = e.target.files[0];
            if (file) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
                if (!file.type.startsWith('image/')) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                    e.target.value = '';
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ä–∞–∑–º–µ—Ä (–º–∞–∫—Å–∏–º—É–º 20MB –¥–æ —Å–∂–∞—Ç–∏—è)
                if (file.size > 20 * 1024 * 1024) {
                    alert('–ò—Å—Ö–æ–¥–Ω–æ–µ —Ñ–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å–∏–º—É–º 20MB)');
                    e.target.value = '';
                    return;
                }
                
                selectedChatPhoto = file;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ
                const reader = new FileReader();
                reader.onload = (event) => {
                    const preview = document.getElementById('chatPhotoPreview');
                    preview.innerHTML = `
                        <div style="position: relative; display: inline-block;">
                            <img src="${event.target.result}" style="max-width: 100px; max-height: 100px; border-radius: 8px;">
                            <button onclick="selectedChatPhoto = null; document.getElementById('chatPhotoPreview').innerHTML = ''; document.getElementById('chatInput').focus();" 
                                style="position: absolute; top: -5px; right: -5px; background: red; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px;">‚úï</button>
                        </div>
                    `;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –∑–∞ –º–∞—Ä–∫–µ—Ä (–ª–∞–π–∫/–¥–∏–∑–ª–∞–π–∫)
    window.vote = async (id, isUp) => {
        try {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –º–∞—Ä–∫–µ—Ä –∏–∑ –ë–î
            const { data: current } = await _sb.from('markers').select('*').eq('id', id).single();
            if (!current) return;
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ª–∞–π–∫–æ–≤ –∏–ª–∏ –¥–∏–∑–ª–∞–π–∫–æ–≤
            const upd = isUp ? { votes_up: (current.votes_up || 0) + 1 } : { votes_down: (current.votes_down || 0) + 1 };
            await _sb.from('markers').update(upd).eq('id', id);

            // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ–º —Å—É–º–º–∞—Ä–Ω—ã–µ –ª–∞–π–∫–∏ –∞–≤—Ç–æ—Ä–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–∏–º –≤ drivers
            try {
                const authorId = current.author_id;
                const { data: authorMarkers } = await _sb.from('markers').select('votes_up').eq('author_id', authorId);
                let likesSum = 0;
                if (authorMarkers && authorMarkers.length) likesSum = authorMarkers.reduce((s, r) => s + (r.votes_up || 0), 0);
                const isTrusted = likesSum >= (typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20);
                // –ü—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å/–≤—Å—Ç–∞–≤–∏—Ç—å –≤ drivers (–≥—Ä–µ–π—Å—Ñ—É–ª ‚Äî –µ—Å–ª–∏ –∫–æ–ª–æ–Ω–æ–∫ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º)
                try {
                    await _sb.from('drivers').upsert([{ user_id: authorId, likes_sum: likesSum, is_trusted: isTrusted }], { onConflict: 'user_id' });
                } catch (err) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å drivers.likes_sum/is_trusted:', err?.message || err);
                }
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á—ë—Ç–µ –ª–∞–π–∫–æ–≤ –∞–≤—Ç–æ—Ä–∞:', e?.message || e);
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–∞—Ä–∫–µ—Ä–∞:', e?.message || e);
        }

        // –ü–µ—Ä–µ—Å—á—ë—Ç —Ä–µ–π—Ç–∏–Ω–≥–∞ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è (–∏–∑ —Ç–∞–±–ª–∏—Ü—ã markers)
        loadMarkers();
    };

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –º–µ—Ç–∫–∏ (–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ "–°—Ç–æ—è—Ç" –∏–ª–∏ "–£–µ—Ö–∞–ª–∏")
    window.confirmMarker = async (markerId, status) => {
        // status: 'stay' –∏–ª–∏ 'leave'
        if (!uid) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ Telegram');
            const overlay = document.getElementById('tgAuthOverlay'); if (overlay) overlay.style.display = 'flex';
            return;
        }

        try {
            const { data: markerInfo } = await _sb.from('markers').select('author_id,type').eq('id', markerId).maybeSingle();
            const isAdminMarker = markerInfo && isAdminUserId(markerInfo.author_id);
            if (isAdminMarker && status === 'leave') {
                alert('–≠—Ç–∞ –º–µ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –∏ –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è –≥–æ–ª–æ—Å–∞–º–∏.');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª –ª–∏ —É–∂–µ —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞ —ç—Ç—É –º–µ—Ç–∫—É
            const { data: existing } = await _sb.from('marker_confirmations')
                .select('id').eq('marker_id', markerId).eq('user_id', uid).maybeSingle();
            
            if (existing) {
                alert(`–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ —ç—Ç—É –º–µ—Ç–∫—É. –û–¥–∏–Ω –≥–æ–ª–æ—Å –Ω–∞ –º–µ—Ç–∫—É.`);
                return;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ–ª–æ—Å –≤ —Ç–∞–±–ª–∏—Ü—É marker_confirmations
            const { error: insertError } = await _sb.from('marker_confirmations').insert([{
                marker_id: markerId,
                user_id: uid,
                status: status,
                created_at: new Date().toISOString()
            }]);

            if (insertError && insertError.code === 'PGRST116') {
                // –¢–∞–±–ª–∏—Ü–∞ marker_confirmations –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—á—ë—Ç—á–∏–∫ –≤ markers
                console.warn('–¢–∞–±–ª–∏—Ü–∞ marker_confirmations –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π —Å—á—ë—Ç—á–∏–∫');
                const { data: marker } = await _sb.from('markers').select('leave_confirmations').eq('id', markerId).single();
                if (marker) {
                    const newCount = (status === 'leave') ? ((marker.leave_confirmations || 0) + 1) : (marker.leave_confirmations || 0);
                    await _sb.from('markers').update({ leave_confirmations: newCount }).eq('id', markerId);
                    
                    // –ï—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π - —É–¥–∞–ª—è–µ–º –º–µ—Ç–∫—É
                    if (newCount >= (typeof MARKER_LEAVE_THRESHOLD !== 'undefined' ? MARKER_LEAVE_THRESHOLD : 3)) {
                        await expireMarkerById(markerId);
                        alert(`‚úÖ –ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞ - ${newCount} —á–µ–ª–æ–≤–µ–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ —á—Ç–æ –æ–±—ä–µ–∫—Ç —É–µ—Ö–∞–ª.`);
                        myMap.balloon.close();
                        loadMarkers();
                        return;
                    }
                }
            } else if (!insertError) {
                let sosBonusText = '';
                if (status === 'stay' && markerInfo?.type === 'sos') {
                    try {
                        const { data: claimData, error: claimError } = await _sb.rpc('claim_sos_help_bonus', { p_marker_id: markerId });
                        if (!claimError && Array.isArray(claimData) && claimData.length > 0 && claimData[0]?.granted) {
                            sosBonusText = ' +50 –æ—á–∫–æ–≤ –∫–∞—Ä–º—ã –∑–∞ SOS-–ø–æ–º–æ—â—å';
                        }
                    } catch (e) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∏—Å–ª–∏—Ç—å SOS-–±–æ–Ω—É—Å:', e?.message || e);
                    }
                }

                // –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–∏–ª–∏ –∑–∞–ø–∏—Å—å, —Å—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ "leave" –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
                const { data: confirmations } = await _sb.from('marker_confirmations')
                    .select('id').eq('marker_id', markerId).eq('status', 'leave');
                
                const leaveCount = (confirmations ? confirmations.length : 0);
                
                // –ï—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π - —É–¥–∞–ª—è–µ–º –º–µ—Ç–∫—É
                if (leaveCount >= (typeof MARKER_LEAVE_THRESHOLD !== 'undefined' ? MARKER_LEAVE_THRESHOLD : 3)) {
                    await expireMarkerById(markerId);
                    alert(`‚úÖ –ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞ - ${leaveCount} —á–µ–ª–æ–≤–µ–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ —á—Ç–æ –æ–±—ä–µ–∫—Ç —É–µ—Ö–∞–ª.`);
                    myMap.balloon.close();
                    loadMarkers();
                    return;
                }
                
                // –ò–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å—á—ë—Ç—á–∏–∫
                if (status === 'stay') {
                    alert(`‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ.${sosBonusText}`);
                } else {
                    alert(`‚úÖ –í–∞—à –≥–æ–ª–æ—Å —É—á—Ç—ë–Ω (${leaveCount}/${typeof MARKER_LEAVE_THRESHOLD !== 'undefined' ? MARKER_LEAVE_THRESHOLD : 3} –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è)`);
                }
                loadMarkers(); // –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É —Å –Ω–æ–≤—ã–º —Å—á—ë—Ç—á–∏–∫–æ–º
            } else if (insertError) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏: ' + (insertError.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –º–µ—Ç–∫–∏:', e?.message || e);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏: ' + (e?.message || e));
        }
    };

    // SOS: –æ—Ç–º–µ—Ç–∏—Ç—å "–Ø –≤ –ø—É—Ç–∏" (–∫—Ç–æ –µ–¥–µ—Ç –ø–æ–º–æ–≥–∞—Ç—å)
    window.sosEnroute = async (markerId) => {
        if (!uid) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ Telegram');
            const overlay = document.getElementById('tgAuthOverlay'); if (overlay) overlay.style.display = 'flex';
            return;
        }

        try {
            let token = localStorage.getItem('sb_jwt') || '';
            if (!token) {
                const refreshed = await ensureSupabaseAuth();
                token = refreshed || localStorage.getItem('sb_jwt') || '';
            }

            if (!token) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                return;
            }

            const resp = await fetch(`${SUPABASE_URL}/functions/v1/sos-enroute?action=add`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify({ markerId: Number(markerId) })
            });

            if (!resp.ok) {
                let txt = '';
                try { txt = await resp.text(); } catch(e) { txt = ''; }
                alert('–û—à–∏–±–∫–∞: ' + (txt || String(resp.status)));
                return;
            }

            alert('üöë –û—Ç–º–µ—á–µ–Ω–æ! –í—ã –≤ –ø—É—Ç–∏.');
            try { if (myMap && myMap.balloon) myMap.balloon.close(); } catch(e) {}
            loadMarkers();
        } catch (e) {
            console.warn('sosEnroute error:', e?.message || e);
            alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
        }
    };

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∞)
    window.delMarker = async (id) => {
        if (confirm("–£–¥–∞–ª–∏—Ç—å –≤–∞—à—É –º–µ—Ç–∫—É?")) {
            await expireMarkerById(id);
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–∏–π –±–∞–ª—É–Ω
            myMap.balloon.close();
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–∞—Ä–∫–µ—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ
            loadMarkers();
        }
    };

    // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –º–æ–¥–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ window –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ balloonContent
    window.deleteAllUserMessages = deleteAllUserMessages;
    window.deleteAllUserMarkers = deleteAllUserMarkers;
    window.reportUser = reportUser;
    window.deleteMessage = deleteMessage;

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ª–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π
    async function openActivityModal(mode) {
        const feed = document.getElementById('activityFeed');
        feed.innerHTML = '<div style="text-align: center; color: var(--gray);">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</div>';
        const isDpsSpecbatMonthMode = mode === 'dpsSpecbatMonth';

        initActivityHeatmapUI();
        if (isDpsSpecbatMonthMode) {
            activityHeatmapMode = 'month';
            activityHeatmapType = 'dps_specbat';
            const toggle = document.getElementById('heatmapToggle');
            if (toggle) {
                [...toggle.querySelectorAll('button')].forEach(b => b.classList.toggle('active', b.dataset.mode === 'month'));
            }
            const typeToggle = document.getElementById('heatmapTypeToggle');
            if (typeToggle) {
                [...typeToggle.querySelectorAll('button')].forEach(b => b.classList.toggle('active', b.dataset.type === 'dps_specbat'));
            }
        } else if (mode === 'heatmap') {
            activityHeatmapMode = 'week';
            activityHeatmapType = 'all';
            const toggle = document.getElementById('heatmapToggle');
            if (toggle) {
                [...toggle.querySelectorAll('button')].forEach(b => b.classList.toggle('active', b.dataset.mode === 'week'));
            }
            const typeToggle = document.getElementById('heatmapTypeToggle');
            if (typeToggle) {
                [...typeToggle.querySelectorAll('button')].forEach(b => b.classList.toggle('active', b.dataset.type === 'all'));
            }
        }
        loadActivityHeatmap();
        
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –º–∞—Ä–∫–µ—Ä—ã (—Å–æ–±—ã—Ç–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è)
            let recentMarkersQuery = _sb.from('markers').select('id,type,ts,author_id');
            if (isDpsSpecbatMonthMode) {
                recentMarkersQuery = recentMarkersQuery.in('type', ['dps', 'specbat']);
            }
            const { data: recentMarkers } = await recentMarkersQuery.order('ts', { ascending: false }).limit(20);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–æ–¥–∏—Ç–µ–ª—è—Ö (–∏–º—è, —Ä–µ–π—Ç–∏–Ω–≥) –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–≤—ë–∑–¥ –≤ –ª–µ–Ω—Ç–µ
            const { data: drivers } = await _sb.from('drivers').select('user_id,name,likes_sum,is_trusted');
            const driverMap = {};
            const driverInfoMap = {};
            if (drivers) {
                drivers.forEach(d => {
                    driverMap[d.user_id] = d.name || '–ê–Ω–æ–Ω–∏–º';
                    driverInfoMap[d.user_id] = {
                        name: d.name || '–ê–Ω–æ–Ω–∏–º',
                        likes_sum: (typeof d.likes_sum !== 'undefined' && d.likes_sum !== null) ? Number(d.likes_sum) : 0,
                        is_trusted: !!d.is_trusted
                    };
                });
            }

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ø–µ—Ä–µ–≤–æ–¥–∏–º likes_sum –≤ 0..5 –∑–≤—ë–∑–¥
            function likesToStars(n) {
                const v = Number(n) || 0;
                if (v <= 0) return 0;
                if (v >= 100) return 5;
                if (v >= 60) return 4;
                if (v >= 30) return 3;
                if (v >= 10) return 2;
                return 1;
            }
            
            let html = '';
            const typeNames = {
                dps: '–î–ü–° (–°—Ç–∞–Ω–¥–∞—Ä—Ç)',
                patrol: '–†–µ–π–¥',
                specbat: '–°–ø–µ—Ü–±–∞—Ç',
                motobat: '–ú–æ—Ç–æ–±–∞—Ç',
                cargo_control: '–ì—Ä—É–∑–æ–≤–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å',
                sos: 'SOS / –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å',
                dtp: '–î–¢–ü',
                danger: '–û–ø–∞—Å–Ω–æ—Å—Ç—å',
                traffic_jam: '–ü—Ä–æ–±–∫–∞ / –ó–∞—Ç–æ—Ä',
                camera: '–ù–∞–±–ª—é–¥–µ–Ω–∏–µ',
                works: '–†–∞–±–æ—Ç—ã'
            };
            const typeEmoji = {
                dps: 'üëÆ',
                patrol: 'üöî',
                specbat: 'üõ°Ô∏è',
                motobat: 'üèçÔ∏è',
                cargo_control: 'üöõ',
                sos: 'üÜò',
                dtp: 'üí•',
                danger: '‚ö†Ô∏è',
                traffic_jam: 'üöó',
                camera: 'üì∏',
                works: 'üöß'
            };
            
            if (recentMarkers && recentMarkers.length > 0) {
                recentMarkers.forEach(marker => {
                    const driverName = driverMap[marker.author_id] || '–í–æ–¥–∏—Ç–µ–ª—å';
                    const authorInfo = driverInfoMap[marker.author_id] || { name: driverName, likes_sum: 0, is_trusted: false };
                    const typeName = typeNames[marker.type] || marker.type;
                    const icon = typeEmoji[marker.type] || 'üìç';
                    const time = new Date(marker.ts).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

                    // –†–µ–Ω–¥–µ—Ä–∏–º –∑–≤—ë–∑–¥—ã —Ä—è–¥–æ–º —Å –∏–º–µ–Ω–µ–º
                    const starsCount = likesToStars(authorInfo.likes_sum);
                    let starsHTML = '';
                    for (let i = 0; i < 5; i++) starsHTML += (i < starsCount) ? '‚òÖ' : '‚òÜ';
                    const starsBadge = `<span style="margin-left:8px; color: ${authorInfo.is_trusted ? '#b8860b' : '#f5c542'}; font-weight:700;">${starsHTML}</span>`;
                    const trustedMark = authorInfo.is_trusted ? '<span style="color:#b8860b; font-weight:800; margin-left:6px;">‚≠ê</span>' : '';

                    html += `
                        <div class="activity-item">
                            <div><span class="activity-icon">${icon}</span><strong>${driverName}</strong> ${trustedMark} ${starsBadge} –¥–æ–±–∞–≤–∏–ª ${typeName}</div>
                            <div class="activity-time">üïê ${time}</div>
                        </div>
                    `;
                });
            } else {
                html = '<div style="text-align: center; color: var(--gray); padding: 20px;">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π</div>';
            }
            
            feed.innerHTML = html;
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ª–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π:', e?.message || e);
            feed.innerHTML = '<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
        }
        
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'hidden';
        document.getElementById('activityModal').classList.add('active');
    }

    let activityHeatmapMode = 'week';
    let activityHeatmapType = 'all';
    let activityHeatmapCache = null;
    let activityHeatmapCachedAt = 0;

    function initActivityHeatmapUI() {
        const toggle = document.getElementById('heatmapToggle');
        if (toggle && !toggle.dataset.bound) {
            toggle.dataset.bound = '1';
            toggle.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-mode]');
                if (!btn) return;
                activityHeatmapMode = btn.dataset.mode;
                [...toggle.querySelectorAll('button')].forEach(b => b.classList.toggle('active', b === btn));
                renderActivityHeatmap();
            });
        }

        const typeToggle = document.getElementById('heatmapTypeToggle');
        if (typeToggle && !typeToggle.dataset.bound) {
            typeToggle.dataset.bound = '1';
            typeToggle.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-type]');
                if (!btn) return;
                activityHeatmapType = btn.dataset.type;
                [...typeToggle.querySelectorAll('button')].forEach(b => b.classList.toggle('active', b === btn));
                renderActivityHeatmap();
            });
        }
    }

    async function loadActivityHeatmap(force = false) {
        const summaryEl = document.getElementById('heatmapSummary');
        if (summaryEl) summaryEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

        if (!uid) {
            if (summaryEl) summaryEl.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö (–Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)';
            activityHeatmapCache = { markers: [], updatedAt: new Date() };
            activityHeatmapCachedAt = Date.now();
            renderActivityHeatmap();
            return;
        }

        const now = Date.now();
        if (!force && activityHeatmapCache && (now - activityHeatmapCachedAt) < 120000) {
            renderActivityHeatmap();
            return;
        }

        try {
            const nowDate = new Date();
            const monthStart = new Date(nowDate);
            monthStart.setDate(nowDate.getDate() - 29);
            monthStart.setHours(0, 0, 0, 0);

            // markers.ts –≤ –ø—Ä–æ–µ–∫—Ç–µ –º–æ–∂–µ—Ç –±—ã—Ç—å BIGINT (Date.now()) –∏–ª–∏ TIMESTAMPTZ.
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∫–∞–∫ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã, –∑–∞—Ç–µ–º fallback –Ω–∞ ISO.
            const monthStartMs = monthStart.getTime();

            let markers = [];
            {
                const res = await _sb
                    .from('markers')
                    .select('ts,type')
                    .eq('author_id', uid)
                    .gte('ts', monthStartMs)
                    .order('ts', { ascending: false })
                    .limit(10000);
                if (res?.error) {
                    const res2 = await _sb
                        .from('markers')
                        .select('ts,type')
                        .eq('author_id', uid)
                        .gte('ts', monthStart.toISOString())
                        .order('ts', { ascending: false })
                        .limit(10000);
                    if (res2?.error) {
                        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã (markers.ts filter):', res2.error?.message || res2.error);
                        markers = [];
                    } else {
                        markers = Array.isArray(res2?.data) ? res2.data : [];
                    }
                } else {
                    markers = Array.isArray(res?.data) ? res.data : [];
                }
            }

            activityHeatmapCache = {
                markers: Array.isArray(markers) ? markers : [],
                updatedAt: nowDate
            };
            activityHeatmapCachedAt = now;
            renderActivityHeatmap();
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:', e?.message || e);
            if (summaryEl) summaryEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        }
    }

    function renderActivityHeatmap() {
        const gridEl = document.getElementById('heatmapGrid');
        const summaryEl = document.getElementById('heatmapSummary');
        if (!gridEl || !summaryEl || !activityHeatmapCache) return;

        const markers = Array.isArray(activityHeatmapCache.markers) ? activityHeatmapCache.markers : [];
        const hours = Array.from({ length: 24 }, (_, i) => i);
        const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
        const nowDate = activityHeatmapCache.updatedAt || new Date();
        const nowMs = nowDate.getTime();
        const dayStart = new Date(nowDate);
        dayStart.setHours(0, 0, 0, 0);
        const weekStart = new Date(nowDate);
        weekStart.setDate(nowDate.getDate() - 6);
        weekStart.setHours(0, 0, 0, 0);
        const monthStart = new Date(nowDate);
        monthStart.setDate(nowDate.getDate() - 29);
        monthStart.setHours(0, 0, 0, 0);
        const dayLabels = Array.from({ length: 7 }, (_, i) => {
            const d = new Date(weekStart);
            d.setDate(weekStart.getDate() + i);
            const name = dayNames[(d.getDay() + 6) % 7];
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            return `${name} ${dd}.${mm}`;
        });

        const modeStart = activityHeatmapMode === 'day'
            ? dayStart
            : activityHeatmapMode === 'month'
                ? monthStart
                : weekStart;
        const modeStartMs = modeStart.getTime();
        const allowedTypes = activityHeatmapType === 'dps_specbat' ? new Set(['dps', 'specbat']) : null;

        const scopedMarkers = markers.filter(m => {
            if (!m?.ts) return false;
            const tsMs = parseMarkerTimestampToMs(m.ts);
            if (!Number.isFinite(tsMs)) return false;
            if (tsMs < modeStartMs || tsMs > nowMs) return false;
            if (allowedTypes && !allowedTypes.has(m.type)) return false;
            return true;
        });

        const weekCounts = Array.from({ length: 7 }, () => Array(24).fill(0));
        const rowCounts = Array(24).fill(0);
        const msDay = 24 * 60 * 60 * 1000;

        scopedMarkers.forEach(m => {
            const d = new Date(parseMarkerTimestampToMs(m.ts));
            if (isNaN(d.getTime())) return;
            const hour = d.getHours();
            rowCounts[hour] += 1;
            if (activityHeatmapMode === 'week') {
                const dayOffset = Math.floor((d - weekStart) / msDay);
                if (dayOffset >= 0 && dayOffset < 7) {
                    weekCounts[dayOffset][hour] += 1;
                }
            }
        });

        let max = 0;
        if (activityHeatmapMode === 'week') {
            weekCounts.forEach(row => row.forEach(v => { if (v > max) max = v; }));
        } else {
            rowCounts.forEach(v => { if (v > max) max = v; });
        }

        const colorFor = (value) => {
            if (!value || max <= 0) return '#f0f0f5';
            const alpha = Math.min(0.92, 0.12 + (value / max) * 0.8);
            return `rgba(0,122,255,${alpha.toFixed(3)})`;
        };

        let html = '';
        html += '<div></div>';
        hours.forEach(h => {
            html += `<div class="heatmap-hour">${h}</div>`;
        });

        if (activityHeatmapMode === 'week') {
            weekCounts.forEach((row, rowIndex) => {
                html += `<div class="heatmap-label">${dayLabels[rowIndex]}</div>`;
                row.forEach((v, h) => {
                    const title = `${dayLabels[rowIndex]} ${String(h).padStart(2, '0')}:00 ‚Äî ${v}`;
                    html += `<div class="heatmap-cell" title="${title}" style="background:${colorFor(v)}"></div>`;
                });
            });
        } else {
            const rowLabel = activityHeatmapMode === 'month' ? '30 –¥–Ω–µ–π' : '–°–µ–≥–æ–¥–Ω—è';
            html += `<div class="heatmap-label">${rowLabel}</div>`;
            rowCounts.forEach((v, h) => {
                const title = `${rowLabel} ${String(h).padStart(2, '0')}:00 ‚Äî ${v}`;
                html += `<div class="heatmap-cell" title="${title}" style="background:${colorFor(v)}"></div>`;
            });
        }

        gridEl.innerHTML = html;

        const total = scopedMarkers.length;
        const peakCount = rowCounts.reduce((acc, v) => Math.max(acc, v), 0);
        const peakHours = peakCount > 0
            ? rowCounts
                .map((v, h) => ({ v, h }))
                .filter(x => x.v === peakCount)
                .map(x => `${String(x.h).padStart(2, '0')}:00`)
            : [];
        const peakText = peakHours.length ? peakHours.join(', ') : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
        const typeLabel = activityHeatmapType === 'dps_specbat' ? '–î–ü–° + –°–ø–µ—Ü–±–∞—Ç' : '–í—Å–µ —Ç–∏–ø—ã';

        if (activityHeatmapMode === 'month') {
            summaryEl.textContent = `${typeLabel} ‚Ä¢ –í—Å–µ–≥–æ –∑–∞ 30 –¥–Ω–µ–π: ${total} ‚Ä¢ –ü–∏–∫–æ–≤–æ–µ –≤—Ä–µ–º—è: ${peakText}`;
        } else if (activityHeatmapMode === 'week') {
            summaryEl.textContent = `${typeLabel} ‚Ä¢ –í—Å–µ–≥–æ –∑–∞ 7 –¥–Ω–µ–π: ${total} ‚Ä¢ –ü–∏–∫–æ–≤–æ–µ –≤—Ä–µ–º—è: ${peakText}`;
        } else {
            summaryEl.textContent = `${typeLabel} ‚Ä¢ –í—Å–µ–≥–æ —Å–µ–≥–æ–¥–Ω—è: ${total} ‚Ä¢ –ü–∏–∫–æ–≤–æ–µ –≤—Ä–µ–º—è: ${peakText}`;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –ª–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π
    function closeActivityModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        document.getElementById('activityModal').classList.remove('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –≤ –ø—Ä–æ—Ñ–∏–ª—å
    async function loadAchievements() {
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Ç–æ–∫ –∏ –æ—á–∫–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const { data: markers } = await _sb.from('markers').select('votes_up, votes_down, ts, type, exp').eq('author_id', uid);
        
        let markersCount = 0;
        let totalLikes = 0;
        let totalVotes = 0;
        
        if (markers) {
            markersCount = markers.length;
            markers.forEach(m => {
                totalLikes += m.votes_up || 0;
                totalVotes += (m.votes_up || 0) + (m.votes_down || 0);
            });
        }

        const sosBonus = await getUserSosBonus(uid);
        totalLikes += sosBonus;
        
        // –ù–æ–≤—ã–µ –∞—á–∏–≤–∫–∏ —Å —ç–º–æ–¥–∑–∏-–ø–∞–∫–æ–º SafeDrive 180 (–ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
        const achievements = [];
        
        // –ü–µ—Ä–≤—ã–µ –º–µ—Ç–∫–∏ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        if (markersCount >= 1) achievements.push({ icon: 'üé®', title: '–ü–µ—Ä–≤–∞—è –º–µ—Ç–∫–∞', desc: '–í—ã –Ω–∞—á–∞–ª–∏ –ø–æ–º–æ–≥–∞—Ç—å —Å–æ–æ–±—â–µ—Å—Ç–≤—É' });
        if (markersCount >= 10) achievements.push({ icon: 'üîü', title: '–î–µ—Å—è—Ç–æ–∫', desc: '10 –º–µ—Ç–æ–∫' });
        if (markersCount >= 50) achievements.push({ icon: 'üèÖ', title: '–ü–æ–ª–æ–≤–∏–Ω–∞ —Å–æ—Ç–Ω–∏', desc: '50 –º–µ—Ç–æ–∫' });
        if (markersCount >= 100) achievements.push({ icon: 'üíØ', title: '–°—Ç–æ–ª–µ—Ç–∏–µ', desc: '100 –º–µ—Ç–æ–∫' });

        // –ö–∞—Ä–º–∞ –∏ –¥–æ–≤–µ—Ä–∏–µ
        if (totalLikes >= 10) achievements.push({ icon: 'üëç', title: '–ü–æ–ª–µ–∑–Ω–æ', desc: '10 –æ—á–∫–æ–≤ –∫–∞—Ä–º—ã –æ—Ç —Å–æ–æ–±—â–µ—Å—Ç–≤–∞' });
        if (totalLikes >= 50) achievements.push({ icon: 'üëë', title: '–õ–∏–¥–µ—Ä –≤–∑–∞–∏–º–æ–ø–æ–º–æ—â–∏', desc: '–í—ã—Å–æ–∫–∏–π –≤–∫–ª–∞–¥ –≤ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è' });
        if (totalLikes >= 100) achievements.push({ icon: 'üçÄ', title: '–õ–µ–≥–µ–Ω–¥–∞', desc: '100 –æ—á–∫–æ–≤ –∫–∞—Ä–º—ã' });

        // –¢–æ—á–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å
        if (totalVotes >= 50) achievements.push({ icon: 'üëÅÔ∏è', title: '–ì–ª–∞–∑ –æ—Ä–ª–∞', desc: '–°–≤–µ—Ä—Ö—Ç–æ—á–Ω—ã–µ –º–µ—Ç–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏—Å—è—Ç —á–∞—Å–∞–º–∏' });
        if (totalVotes >= 200) achievements.push({ icon: 'üïäÔ∏è', title: '–ú–∏—Ä–æ—Ç–≤–æ—Ä–µ—Ü', desc: '–ë–æ–ª—å—à–æ–π –≤–∫–ª–∞–¥ –≤ —Å–ø–æ–∫–æ–π–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞' });

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –∞—á–∏–≤–∫–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã user_achievements
        const serverCounts = {};
        try {
            const { data: serverAchs } = await _sb.from('user_achievements').select('key,created_at').eq('user_id', uid);
            // –°—á–∏—Ç–∞–µ–º –ø–æ–≤—Ç–æ—Ä—ã –ø–æ –∫–ª—é—á—É
            if (serverAchs && serverAchs.length > 0) {
                serverAchs.forEach(r => { serverCounts[r.key] = (serverCounts[r.key] || 0) + 1; });

                // –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –∞—á–∏–≤–∫–∏ —Å –Ω–æ–≤—ã–º–∏ —ç–º–æ–¥–∑–∏ (SafeDrive 180)
                if (serverCounts['beta_tester']) achievements.push({ icon: 'üõ°Ô∏è', title: '–ü–µ—Ä–≤–æ–ø—Ä–æ—Ö–æ–¥–µ—Ü (Beta-Tester)', desc: '–°—Ç–∞—Ç—É—Å ¬´–æ–ª–¥–∞¬ª ‚Äî –±—ã–ª —Å –Ω–∞–º–∏ –Ω–∞ –ó–ë–¢' });
                if (serverCounts['bug_report']) {
                    achievements.push({ icon: 'üîç', title: '–û—Ö—Ç–Ω–∏–∫ –∑–∞ –±–∞–≥–∞–º–∏', desc: `–ü–æ–º–æ–≥ —á–∏—Å—Ç–∏—Ç—å –∫–æ–¥ –∏ –∑–≤—É–∫–∏: ${serverCounts['bug_report']}` });
                    if (serverCounts['bug_report'] >= 5) {
                        achievements.push({ icon: 'üì¢', title: '–°—ã–Ω –ñ–∏—Ä–∏–Ω–æ–≤—Å–∫–æ–≥–æ', desc: '–û–±–ª–∞–¥–∞—Ç–µ–ª—å —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ–π –æ–∑–≤—É—á–∫–∏' });
                        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–µ—Ä–∑–∫–∏–π —Å—Ç–∏–ª—å –ª–æ–∫–∞–ª—å–Ω–æ
                        try { localStorage.setItem('cheekyUnlocked', 'true'); } catch(e){}
                    }
                }
                if (serverCounts['ghost_catcher']) achievements.push({ icon: 'üåô', title: '–ù–æ—á–Ω–æ–π –ø–∞—Ç—Ä—É–ª—å', desc: `–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ —Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫` });
                if (serverCounts['night_patrol']) achievements.push({ icon: '‚ö°', title: '–°—É–µ—Ç–æ–ª–æ–≥', desc: '–ê–Ω–æ–º–∞–ª—å–Ω–æ –≤—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å' });
                if (serverCounts['phantom_racer']) achievements.push({ icon: 'üî•', title: '–ü—Ä–∏–∑—Ä–∞—á–Ω—ã–π –≥–æ–Ω—â–∏–∫', desc: '–í–æ–≤—Ä–µ–º—è –∑–∞—Ç–æ—Ä–º–æ–∑–∏–ª –ø–æ—Å–ª–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è' });
            }
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –º–µ—Ç–∫–∏
            try { currentAchievementCounts = serverCounts; } catch(e){}
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –∞—á–∏–≤–∫–∏:', e?.message || e);
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º "–∑–≤–∞–Ω–∏–µ" (—Å—Ç–∞—Ç—É—Å)
        let title = 'üöó –ù–æ–≤–∏—á–æ–∫';
        if (markersCount >= 10) title = 'üöô –ê–∫—Ç–∏–≤–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å';
        if (markersCount >= 50) title = 'üèéÔ∏è –û–ø—ã—Ç–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å';
        if (markersCount >= 100) title = 'üèÜ –ù–∞–≤–∏–≥–∞—Ç–æ—Ä-–ø—Ä–æ—Ñ–∏';
        if (totalLikes >= 50) title = 'üëë –õ–∏–¥–µ—Ä –≤–∑–∞–∏–º–æ–ø–æ–º–æ—â–∏';

        // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É
        const uniq = [];
        const seen = new Set();
        achievements.forEach(a => { if (!seen.has(a.title)) { uniq.push(a); seen.add(a.title); } });

        // –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
        const allAchievements = [
            { key: 'markers_1', icon: 'üé®', title: '–ü–µ—Ä–≤–∞—è –º–µ—Ç–∫–∞', desc: '–í—ã –Ω–∞—á–∞–ª–∏ –ø–æ–º–æ–≥–∞—Ç—å —Å–æ–æ–±—â–µ—Å—Ç–≤—É', required: 1, progress: markersCount, metric: '–º–µ—Ç–æ–∫' },
            { key: 'markers_10', icon: 'üîü', title: '–î–µ—Å—è—Ç–æ–∫', desc: '10 –º–µ—Ç–æ–∫', required: 10, progress: markersCount, metric: '–º–µ—Ç–æ–∫' },
            { key: 'markers_50', icon: 'üèÖ', title: '–ü–æ–ª–æ–≤–∏–Ω–∞ —Å–æ—Ç–Ω–∏', desc: '50 –º–µ—Ç–æ–∫', required: 50, progress: markersCount, metric: '–º–µ—Ç–æ–∫' },
            { key: 'markers_100', icon: 'üíØ', title: '–°—Ç–æ–ª–µ—Ç–∏–µ', desc: '100 –º–µ—Ç–æ–∫', required: 100, progress: markersCount, metric: '–º–µ—Ç–æ–∫' },
            { key: 'likes_10', icon: 'üëç', title: '–ü–æ–ª–µ–∑–Ω–æ', desc: '10 –æ—á–∫–æ–≤ –∫–∞—Ä–º—ã –æ—Ç —Å–æ–æ–±—â–µ—Å—Ç–≤–∞', required: 10, progress: totalLikes, metric: '–∫–∞—Ä–º—ã' },
            { key: 'likes_50', icon: 'üëë', title: '–õ–∏–¥–µ—Ä –≤–∑–∞–∏–º–æ–ø–æ–º–æ—â–∏', desc: '–í—ã—Å–æ–∫–∏–π –≤–∫–ª–∞–¥ –≤ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è', required: 50, progress: totalLikes, metric: '–∫–∞—Ä–º—ã' },
            { key: 'likes_100', icon: 'üçÄ', title: '–õ–µ–≥–µ–Ω–¥–∞', desc: '100 –æ—á–∫–æ–≤ –∫–∞—Ä–º—ã', required: 100, progress: totalLikes, metric: '–∫–∞—Ä–º—ã' },
            { key: 'votes_50', icon: 'üëÅÔ∏è', title: '–ì–ª–∞–∑ –æ—Ä–ª–∞', desc: '–°–≤–µ—Ä—Ö—Ç–æ—á–Ω—ã–µ –º–µ—Ç–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏—Å—è—Ç —á–∞—Å–∞–º–∏', required: 50, progress: totalVotes, metric: '–≥–æ–ª–æ—Å–æ–≤' },
            { key: 'votes_200', icon: 'üïäÔ∏è', title: '–ú–∏—Ä–æ—Ç–≤–æ—Ä–µ—Ü', desc: '–ë–æ–ª—å—à–æ–π –≤–∫–ª–∞–¥ –≤ —Å–ø–æ–∫–æ–π–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞', required: 200, progress: totalVotes, metric: '–≥–æ–ª–æ—Å–æ–≤' },
            { key: 'beta_tester', icon: 'üõ°Ô∏è', title: '–ü–µ—Ä–≤–æ–ø—Ä–æ—Ö–æ–¥–µ—Ü (Beta-Tester)', desc: '–°—Ç–∞—Ç—É—Å ¬´–æ–ª–¥–∞¬ª ‚Äî –±—ã–ª —Å –Ω–∞–º–∏ –Ω–∞ –ó–ë–¢', required: 1, progress: serverCounts['beta_tester'] || 0, metric: '—Ä–∞–∑' },
            { key: 'bug_report_1', icon: 'üîç', title: '–û—Ö—Ç–Ω–∏–∫ –∑–∞ –±–∞–≥–∞–º–∏', desc: '–ü–æ–º–æ–≥ —á–∏—Å—Ç–∏—Ç—å –∫–æ–¥ –∏ –∑–≤—É–∫–∏', required: 1, progress: serverCounts['bug_report'] || 0, metric: '–æ—Ç—á–µ—Ç–æ–≤' },
            { key: 'bug_report_5', icon: 'üì¢', title: '–°—ã–Ω –ñ–∏—Ä–∏–Ω–æ–≤—Å–∫–æ–≥–æ', desc: '–û–±–ª–∞–¥–∞—Ç–µ–ª—å —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ–π –æ–∑–≤—É—á–∫–∏', required: 5, progress: serverCounts['bug_report'] || 0, metric: '–æ—Ç—á–µ—Ç–æ–≤' },
            { key: 'ghost_catcher', icon: 'üåô', title: '–ù–æ—á–Ω–æ–π –ø–∞—Ç—Ä—É–ª—å', desc: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ —Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫', required: 1, progress: serverCounts['ghost_catcher'] || 0, metric: '—Ä–∞–∑' },
            { key: 'night_patrol', icon: '‚ö°', title: '–°—É–µ—Ç–æ–ª–æ–≥', desc: '–ê–Ω–æ–º–∞–ª—å–Ω–æ –≤—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', required: 1, progress: serverCounts['night_patrol'] || 0, metric: '—Ä–∞–∑' },
            { key: 'phantom_racer', icon: 'üî•', title: '–ü—Ä–∏–∑—Ä–∞—á–Ω—ã–π –≥–æ–Ω—â–∏–∫', desc: '–í–æ–≤—Ä–µ–º—è –∑–∞—Ç–æ—Ä–º–æ–∑–∏–ª –ø–æ—Å–ª–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', required: 1, progress: serverCounts['phantom_racer'] || 0, metric: '—Ä–∞–∑' }
        ];

        allAchievements.forEach(a => { a.completed = a.progress >= a.required; });
        const completedCount = allAchievements.filter(a => a.completed).length;
        const totalCount = allAchievements.length;

        return { achievements: uniq, title, markersCount, totalLikes, totalVotes, allAchievements, completedCount, totalCount };
    }

    // –£—Ç–∏–ª–∏—Ç–∞: –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø—Ä–∏—Å–≤–æ–∏—Ç—å –æ–¥–Ω—É –∞—á–∏–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç)
    async function ensureUserAchievement(userId, key) {
        if (!userId || !key) return;
        try {
            const { data: exists } = await _sb.from('user_achievements').select('id').eq('user_id', String(userId)).eq('key', key).maybeSingle();
            if (!exists) {
                await _sb.from('user_achievements').insert([{ user_id: String(userId), key }]);
                console.log(`üèÖ –ü—Ä–∏—Å–≤–æ–µ–Ω–∞ –∞—á–∏–≤–∫–∞ ${key} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${userId}`);
            }
        } catch (e) {
            console.warn('ensureUserAchievement error:', e?.message || e);
        }
    }

    // –ê–¥–º–∏–Ω-—Ñ—É–Ω–∫—Ü–∏—è: –ø—Ä–∏—Å–≤–æ–∏—Ç—å –∞—á–∏–≤–∫—É –º–Ω–æ–∂–µ—Å—Ç–≤—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (batch)
    async function grantAchievementToUsers(key, userIds = []) {
        if (!window.isAdmin) { console.warn('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ (isAdmin=false)'); return; }
        if (!key || !Array.isArray(userIds) || userIds.length === 0) return;
        try {
            const rows = userIds.map(id => ({ user_id: String(id), key }));
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º upsert —Å –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ–º –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
            const { error } = await _sb.from('user_achievements').upsert(rows, { onConflict: 'user_id,key', ignoreDuplicates: true });
            if (error) throw error;
            console.log(`üèÖ –ê—á–∏–≤–∫–∞ ${key} –ø—Ä–∏—Å–≤–æ–µ–Ω–∞ ${userIds.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º`);
        } catch (e) {
            console.warn('grantAchievementToUsers error:', e?.message || e);
            throw e; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ UI
        }
    }

    // –£–¥–æ–±–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ –¥–ª—è –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è beta_tester —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å –∏–ª–∏ –∞–¥–º–∏–Ω–∫—É
    window.grantBetaToIds = function(ids) { return grantAchievementToUsers('beta_tester', ids); };

    // UI: –º–∞—Å—Å–æ–≤–∞—è –≤—ã–¥–∞—á–∞ –∏–∑ –ø–æ–ª—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    async function grantBetaFromInput() {
        const el = document.getElementById('bulkBetaIds');
        const status = document.getElementById('bulkBetaStatus');
        if (!el) return;
        let raw = (el.value || '').trim();
        if (!raw) { status.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω user_id.'; return; }
        // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏: –∑–∞–ø—è—Ç–∞—è –∏–ª–∏ –ø—Ä–æ–±–µ–ª –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å
        const ids = raw.split(/[,\s]+/).map(s => s.trim()).filter(Boolean);
        if (ids.length === 0) { status.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID.'; return; }
        status.textContent = `‚è≥ –í—ã–¥–∞—ë–º –∞—á–∏–≤–∫—É ${ids.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º...`;
        try {
            await grantAchievementToUsers('beta_tester', ids);
            status.textContent = `‚úÖ –ê—á–∏–≤–∫–∞ –≤—ã–¥–∞–Ω–∞ ${ids.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.`;
        } catch (e) {
            console.warn(e);
            status.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–¥–∞—á–µ (—Å–º. –∫–æ–Ω—Å–æ–ª—å).';
        }
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Å—Ç–æ–≥–æ WAV (–º–æ–Ω–æ) —Å —Å–∏–Ω—É—Å–æ–∏–¥–æ–π
    function createSineWav(freq = 440, durationSec = 1, volume = 0.5) {
        const sampleRate = 44100;
        const length = sampleRate * durationSec;
        const buffer = new ArrayBuffer(44 + length * 2);
        const view = new DataView(buffer);

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // RIFF header
        writeString(view, 0, 'RIFF');
        view.setUint32(4, 36 + length * 2, true);
        writeString(view, 8, 'WAVE');
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, 1, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * 2, true);
        view.setUint16(32, 2, true);
        view.setUint16(34, 16, true);
        writeString(view, 36, 'data');
        view.setUint32(40, length * 2, true);

        // samples
        let offset = 44;
        for (let i = 0; i < length; i++) {
            const t = i / sampleRate;
            const sample = Math.max(-1, Math.min(1, volume * Math.sin(2 * Math.PI * freq * t)));
            view.setInt16(offset, sample * 0x7fff, true);
            offset += 2;
        }

        return new Blob([view], { type: 'audio/wav' });
    }

    // –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–∏–º–µ–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –æ–∂–∏–¥–∞–µ–º—ã–º –≤ /audio/)
    const PLACEHOLDER_AUDIO_FILES = [
        { name: 'warning_standard_dps_500.mp3', freq: 600, dur: 1.2 },
        { name: 'warning_standard_dps_200.mp3', freq: 800, dur: 0.9 },
        { name: 'warning_standard_cam_500.mp3', freq: 620, dur: 1.2 },
        { name: 'warning_standard_cam_200.mp3', freq: 820, dur: 0.9 },
        { name: 'warning_cheeky_500.mp3', freq: 540, dur: 1.3 },
        { name: 'warning_cheeky_200.mp3', freq: 760, dur: 1.0 }
    ];

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ —Å–∫–∞—á–∏–≤–∞–µ—Ç –≤—Å–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
    function generatePlaceholderAudios() {
        const status = document.getElementById('audioGenStatus');
        status.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤...';
        setTimeout(() => {
            try {
                PLACEHOLDER_AUDIO_FILES.forEach(f => {
                    const wav = createSineWav(f.freq, f.dur, 0.5);
                    const url = URL.createObjectURL(wav);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = f.name.replace('.mp3', '.wav');
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                });
                status.textContent = '‚úÖ –§–∞–π–ª—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–∞—á–∞–ª—Å—è –∑–∞–≥—Ä—É–∑–∫–∞. –ü–µ—Ä–µ–∏–º–µ–Ω—É–π—Ç–µ –≤ .mp3 –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤ /audio/';
            } catch (e) {
                console.warn(e);
                status.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞—É–¥–∏–æ.';
            }
        }, 50);
    }

    // –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª—ã –ø–æ –æ–¥–Ω–æ–º—É —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –∏–º–µ–Ω–µ–º
    function downloadSinglePlaceholders() {
        const status = document.getElementById('audioGenStatus');
        status.textContent = '';
        PLACEHOLDER_AUDIO_FILES.forEach(f => {
            const wav = createSineWav(f.freq, f.dur, 0.5);
            const url = URL.createObjectURL(wav);
            const a = document.createElement('a');
            a.href = url;
            a.download = f.name.replace('.mp3', '.wav');
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });
        document.getElementById('audioGenStatus').textContent = '‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª–æ.';
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤ –≤ Supabase Storage (bucket: 'audio')
    async function uploadPlaceholdersToStorage() {
        const status = document.getElementById('audioGenStatus');
        status.textContent = '‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –≤ Supabase Storage...';
        if (typeof _sb === 'undefined' || !_sb.storage) {
            status.textContent = '‚ùå Supabase client –Ω–µ –Ω–∞–π–¥–µ–Ω (–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è _sb).';
            return;
        }
        const bucket = 'audio';
        let success = 0;
        for (const f of PLACEHOLDER_AUDIO_FILES) {
            try {
                const wav = createSineWav(f.freq, f.dur, 0.5);
                const fileName = f.name.replace('.mp3', '.wav');
                // –ó–∞–≥—Ä—É–∂–∞–µ–º
                const { data, error } = await _sb.storage.from(bucket).upload(fileName, wav, { upsert: true, contentType: 'audio/wav' });
                if (error) {
                    console.warn('Upload error', fileName, error.message || error);
                    status.textContent = `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${fileName}: ${error.message || error}`;
                    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
                    continue;
                }
                success++;
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞:', e);
                status.textContent = `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: ${e.message || e}`;
            }
        }
        if (success > 0) {
            status.textContent = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${success}/${PLACEHOLDER_AUDIO_FILES.length} —Ñ–∞–π–ª—ã –≤ bucket "${bucket}".`;
        }
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∏–∑ Supabase Storage (bucket: 'audio')
    async function listAudioStorageFiles() {
        const listEl = document.getElementById('storageFilesList');
        const status = document.getElementById('warningAudioStatus');
        listEl.innerHTML = '‚è≥ –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫...';
        if (typeof _sb === 'undefined' || !_sb.storage) {
            listEl.innerHTML = '‚ùå Supabase client –Ω–µ –Ω–∞–π–¥–µ–Ω (–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è _sb).';
            return;
        }
        const bucket = 'audio';
        try {
            const { data, error } = await _sb.storage.from(bucket).list('', { limit: 200, offset: 0, sortBy: { column: 'name', order: 'asc' } });
            if (error) throw error;
            if (!data || data.length === 0) {
                listEl.innerHTML = '<div style="color: #666;">–ü—É—Å—Ç–æ</div>';
                return;
            }
            let html = '<ul style="list-style:none;padding:0;margin:0;">';
            data.forEach(item => {
                html += `<li style="display:flex;justify-content:space-between;align-items:center;padding:6px 4px;border-bottom:1px dashed #f0f0f0;">` +
                        `<span style="font-size:13px;">${item.name}</span>` +
                        `<span style="display:flex;gap:8px;">` +
                        `<button onclick="downloadAudioFromStorage('${item.name.replace(/'/g, "\\'")}')" style="padding:6px 8px;background:#007aff;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;">‚¨áÔ∏è</button>` +
                        `</span></li>`;
            });
            html += '</ul>';
            listEl.innerHTML = html;
            if (status) status.textContent = `‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${data.length} —Ñ–∞–π–ª–æ–≤ –∏–∑ bucket "${bucket}".`;
        } catch (e) {
            console.warn('listAudioStorageFiles error:', e);
            listEl.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç –ø—Ä–∞–≤ —É anon –∫–ª—é—á–∞).';
        }
    }

    // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∏–∑ Supabase Storage
    async function downloadAudioFromStorage(name) {
        const status = document.getElementById('warningAudioStatus');
        if (status) status.textContent = `‚è≥ –°–∫–∞—á–∏–≤–∞–µ–º ${name}...`;
        if (typeof _sb === 'undefined' || !_sb.storage) {
            if (status) status.textContent = '‚ùå Supabase client –Ω–µ –Ω–∞–π–¥–µ–Ω (–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è _sb).';
            return;
        }
        const bucket = 'audio';
        try {
            const { data, error } = await _sb.storage.from(bucket).download(name);
            if (error) throw error;
            const url = URL.createObjectURL(data);
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            if (status) status.textContent = `‚úÖ –°–∫–∞—á–∞–Ω ${name}`;
        } catch (e) {
            console.warn('downloadAudioFromStorage error:', e);
            if (status) status.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç –ø—Ä–∞–≤).';
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    async function checkBanStatus() {
        try {
            const { data: banned, error } = await _sb.from('bans').select('*').eq('user_id', uid).maybeSingle();
            
            if (error) {
                console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –±–∞–Ω–∞:', error?.message);
                return false;
            }
            
            if (banned) {
                console.warn('‚õî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω:', uid);
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å—é –∫–∞—Ä—Ç—É –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
                document.getElementById('map').style.display = 'none';
                document.querySelectorAll('button').forEach(btn => btn.style.display = 'none');
                document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –±–∞–Ω–µ
                const banMessage = document.createElement('div');
                banMessage.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.95);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    flex-direction: column;
                    gap: 20px;
                `;
                banMessage.innerHTML = `
                    <div style="font-size: 60px; text-align: center;">üö´</div>
                    <div style="color: white; font-size: 24px; font-weight: bold; text-align: center;">–í–´ –ó–ê–ë–ê–ù–ï–ù–´</div>
                    <div style="color: #ccc; font-size: 14px; text-align: center; max-width: 300px;">
                        –ü—Ä–∏—á–∏–Ω–∞: ${banned.reason || '–±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è'}<br>
                        –ö–æ–Ω—Ç–∞–∫—Ç: @admin_easy_ride
                    </div>
                `;
                document.body.appendChild(banMessage);
                return true;
            }
            
            return false;
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–Ω—è:', e?.message || e);
            return false;
        }
    }

    // ============= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´ –í –Ø–ù–î–ï–ö–°.–ì–û–¢–û–í–ê–Ø =============
    ymaps.ready(async () => {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        showSplashScreen();

        try {
            const tgUserForRules = window.Telegram?.WebApp?.initDataUnsafe?.user;
            if (tgUserForRules?.id) {
                await ensureSupabaseAuth();
                await ensureRulesAccepted(String(tgUserForRules.id));
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –±–∞–Ω–∞ —Å —Ç–∞–π–º–∞—É—Ç–æ–º
            userBanStatus = await Promise.race([
                checkBanStatus(),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Ban status check timeout')), 8000)
                )
            ]);

            if (userBanStatus) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                showBanNotice(userBanStatus);
                return; // –ù–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
            }

            // –ï—Å–ª–∏ –Ω–µ –∑–∞–±–∞–Ω–µ–Ω - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å —Ü–µ–Ω—Ç—Ä–æ–º –∏ —É—Ä–æ–≤–Ω–µ–º –∑—É–º–∞
            myMap = new ymaps.Map("map", { center: [48.01, 37.80], zoom: 16, controls: [] });
            
            // –ì—Ä–∞–Ω–∏—Ü—ã –î–æ–Ω–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ (—Å–∫—Ä—ã—Ç—ã)
            // const donetskBoundary = new ymaps.Rectangle([
            //     [DONETSK_REGION.south, DONETSK_REGION.west],
            //     [DONETSK_REGION.north, DONETSK_REGION.east]
            // ], {}, {
            //     fillColor: '#0066ff33',
            //     strokeColor: '#007aff',
            //     strokeWidth: 2,
            //     strokeOpacity: 0.7
            // });
            // myMap.geoObjects.add(donetskBoundary);
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é –º–∞—Ä–∫–µ—Ä–æ–≤ ‚Äî –µ—ë –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ—á–∏—â–∞—Ç—å –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ—á–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤
            markersCollection = new ymaps.GeoObjectCollection();
            myMap.geoObjects.add(markersCollection);
            
            // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã –æ–±–Ω–æ–≤–ª—è–µ–º –∞–¥—Ä–µ—Å
            myMap.events.add('actionend', () => {
                const targetCoords = getTargetPlacementCoords();
                ymaps.geocode(targetCoords).then(res => {
                    const obj = res.geoObjects.get(0);
                    document.getElementById('addr-text').innerText = obj ? obj.getAddressLine() : "–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ";
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤ –∫–∞–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ –Ω–∞—Ö–æ–¥–∏–º—Å—è
                    const coords = targetCoords;
                    if (isInDonetskRegion(coords)) {
                        document.getElementById('addr-text').style.color = '#34c759';
                    } else {
                        document.getElementById('addr-text').style.color = '#ff3b30';
                    }
                });
                if (dtpHeatmapEnabled) scheduleDtpHeatmapRender();
                if (patrolHeatmapEnabled) schedulePatrolHeatmapRender();
            });
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–¥–≤–∏–≥–∞—Ç—å –∫–∞—Ä—Ç—É ‚Äî –æ—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
            myMap.events.add('actionstart', () => {
                autoFollow = false;
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é)
            appInitialized = true;
            initApp();
            updateTargetAnchorPosition();
            window.addEventListener('resize', updateTargetAnchorPosition);
            setDtpHeatmapUiState(false);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º GPS –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
            initGPS();
            // –û–±–Ω–æ–≤–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Å–ª–µ–∂–µ–Ω–∏—è
            try { updateFollowButton(); } catch(e) { /* ignore */ }
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
            loadMarkers();
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥ (–≤–º–µ—Å—Ç–æ 10) –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –±–∞—Ç–∞—Ä–µ–∏
            setInterval(loadMarkersDebounced, 20000);

            // –ï—Å–ª–∏ actionCard —Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–∫—Ä—ã—Ç–∏—è
            const openBtn = document.getElementById('openActionBtn');
            if (openBtn && !actionCardVisible) openBtn.classList.add('visible');
            
            // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
            hideSplashScreenImmediately();

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã (timeout –∏–ª–∏ –æ—à–∏–±–∫–∞):', error?.message);
            // –°–∫—Ä—ã–≤–∞–µ–º splash screen –ø—Ä–∏ –æ—à–∏–±–∫–µ –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É
            hideSplashScreenImmediately();
            appInitialized = true;
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É, –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–Ω–∞
            try {
                myMap = new ymaps.Map("map", { center: [48.01, 37.80], zoom: 16, controls: [] });
                markersCollection = new ymaps.GeoObjectCollection();
                myMap.geoObjects.add(markersCollection);
                
                initApp();
                initGPS();
                try { updateFollowButton(); } catch(e) { /* ignore */ }
                loadMarkers();
                setInterval(loadMarkersDebounced, 20000);
                
                const openBtn = document.getElementById('openActionBtn');
                if (openBtn && !actionCardVisible) openBtn.classList.add('visible');
            } catch(e) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', e);
            }
        }
    });



    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –≤ –î–æ–Ω–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏
    function isInDonetskRegion(coords) {
        if (!coords || coords.length < 2) return false;
        const lat = coords[0];
        const lon = coords[1];
        
        return lat >= DONETSK_REGION.south && 
               lat <= DONETSK_REGION.north && 
               lon >= DONETSK_REGION.west && 
               lon <= DONETSK_REGION.east;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π —Ç–æ—á–∫–∏ (–º–∞—Ä–∫–µ—Ä–∞) –Ω–∞ –∫–∞—Ä—Ç—É
    async function addPoint() {
        if (!currentDriver) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é');
            openRegistrationModal();
            return;
        }

        // –ê–Ω—Ç–∏-—Å–ø–∞–º: 1 –º–µ—Ç–∫–∞ –≤ 2 –º–∏–Ω—É—Ç—ã
        const nowTs = Date.now();
        const rateKey = `last_marker_ts_${uid || 'anon'}`;
        let lastTs = 0;
        try { lastTs = Number(localStorage.getItem(rateKey) || 0); } catch(e) { lastTs = 0; }
        if (lastTs && (nowTs - lastTs) < MARKER_RATE_LIMIT_MS) {
            const waitSec = Math.ceil((MARKER_RATE_LIMIT_MS - (nowTs - lastTs)) / 1000);
            alert(`‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${waitSec} —Å–µ–∫. –ú–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–∫—É –Ω–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ 2 –º–∏–Ω—É—Ç—ã.`);
            return;
        }

        // –ë–µ—Ä—ë–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ –ø–æ–∑–∏—Ü–∏–∏ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –º–µ—Ç–∫–∏ (–ø—Ä–∏—Ü–µ–ª–∞),
        // —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—ã–ª–∞ —Ç–æ—á–Ω–æ–π –¥–∞–∂–µ –ø—Ä–∏ –ø–æ–¥–Ω—è—Ç–∏–∏ –ø—Ä–∏—Ü–µ–ª–∞ –Ω–∞–¥ –Ω–∏–∂–Ω–∏–º –≤–∏–¥–∂–µ—Ç–æ–º.
        const coords = getTargetPlacementCoords();

        const commentEl = document.getElementById('m-comm');
        const rawComment = (commentEl && typeof commentEl.value === 'string') ? commentEl.value.trim() : '';
        if (['sos', 'dps', 'specbat'].includes(String(selectedType))) {
            if (!rawComment) {
                if (selectedType === 'sos') alert('üÜò –î–ª—è SOS –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ: –¢–∏–ø | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π');
                else if (selectedType === 'dps') alert('üöî –î–ª—è –î–ü–° –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ –°—Ç–∞—Ç—É—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: –†–∞–±–æ—Ç–∞—é—Ç / –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)');
                else alert('üõ° –î–ª—è –°–ø–µ—Ü–±–∞—Ç–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ: –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ | –ò–Ω—Ñ–æ');
                return;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ –î–æ–Ω–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ –î–ù–†
        if (!isInDonetskRegion(coords)) {
            alert('‚õî –ú–µ—Ç–∫–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –≤ –î–ù–†.\n\n–¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ' + coords[0].toFixed(2) + '¬∞N, ' + coords[1].toFixed(2) + '¬∞E');
            return;
        }

        // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä –≤ –ë–î
        try {
            const markerToCreate = {
                coords: coords, // –¶–µ–Ω—Ç—Ä —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç—ã
                ts: Date.now(), // –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
                exp: Date.now() + 7200000, // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –º–∞—Ä–∫–µ—Ä–∞ (2 —á–∞—Å–∞)
                type: selectedType, // –¢–∏–ø –º–∞—Ä–∫–µ—Ä–∞ (–î–ü–°, –†–µ–π–¥ –∏ —Ç.–¥.)
                comment: rawComment, // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                author_id: uid // ID –∞–≤—Ç–æ—Ä–∞ –º–∞—Ä–∫–µ—Ä–∞
            };
            const { data: insertedMarkers, error } = await _sb.from('markers').insert([markerToCreate]).select('id,type,comment,coords');

            if (!error) {
                try { localStorage.setItem(rateKey, String(Date.now())); } catch(e) {}
                // –ü–æ–ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ drivers, –Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                try {
                    await _sb.from('drivers').update({ markers_count: (currentDriver.markers_count || 0) + 1 }).eq('user_id', uid);
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å markers_count –≤ drivers (–≤–æ–∑–º–æ–∂–Ω–æ, –∫–æ–ª–æ–Ω–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç):', e?.message || e);
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                currentDriver.markers_count = (currentDriver.markers_count || 0) + 1;

                // –ï—Å–ª–∏ –Ω–µ—Ç –æ—à–∏–±–∫–∏, –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã
                document.getElementById('m-comm').value = '';
                // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Å–¥–≤–∏–≥ GPS –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—á—Ç–æ–±—ã –∫–∞—Ä—Ç–∞ –Ω–µ –≤–µ—Ä–Ω—É–ª–∞—Å—å –∫ GPS –ø–æ—Å–ª–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –º–µ—Ç–∫–∏)
                disableAutoFollowOnce = true;
                alert('‚úÖ –ú–µ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                if (insertedMarkers && insertedMarkers[0]) {
                    notifyHelpBotAboutMarker(insertedMarkers[0]);
                }
                loadMarkers();
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–µ—Ç–∫–∏:', e?.message || e);
            const msg = (e?.message || String(e));
            if (msg.toLowerCase().includes('rate') || msg.toLowerCase().includes('limit')) {
                alert('‚è≥ –°–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ. –ú–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–∫—É –Ω–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ 2 –º–∏–Ω—É—Ç—ã.');
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–µ—Ç–∫–∏: ' + msg);
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ —Å –∫–∞—Ä—Ç—ã
    async function loadMarkers() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –∏—Å—Ç–µ–∫–ª–∏ (exp > —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è)
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –º–µ—Ç–∫–∏ –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∏—Ö –ø–æ exp –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ,
        // —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –ø–æ–ª—è exp (BIGINT –∏–ª–∏ TIMESTAMPTZ)
        try {
            const { data: markers } = await Promise.race([
                _sb.from('markers').select('*'),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Markers load timeout')), 10000)
                )
            ]);
            if (!markers || !myMap) {
                console.warn('–ú–∞—Ä–∫–µ—Ä—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–ª–∏ –∫–∞—Ä—Ç–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                return;
            }
        const now = Date.now();
        const activeMarkers = (markers || []).filter(m => {
            if (m.exp === null || typeof m.exp === 'undefined') return true;
            if (typeof m.exp === 'number') return m.exp > now;
            const parsed = Date.parse(m.exp);
            return !isNaN(parsed) ? parsed > now : true;
        });
        
        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –º–µ—Ç–∫–∏ –ø–æ —Ç–∏–ø–∞–º
        const typeCounts = {};
        activeMarkers.forEach(m => {
            typeCounts[m.type] = (typeCounts[m.type] || 0) + 1;
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ –≤ UI
        const counterEl = document.getElementById('markersCounter');
        if (counterEl) {
            const typeNames = {
                dps: '–î–ü–°',
                patrol: '–†–µ–π–¥',
                specbat: '–°–ø–µ—Ü–±–∞—Ç',
                motobat: '–ú–æ—Ç–æ–±–∞—Ç',
                cargo_control: '–ì—Ä—É–∑. –∫–æ–Ω—Ç—Ä–æ–ª—å',
                sos: 'SOS',
                dtp: '–î–¢–ü',
                danger: '–û–ø–∞—Å–Ω–æ—Å—Ç—å',
                traffic_jam: '–ü—Ä–æ–±–∫–∞',
                camera: '–ù–∞–±–ª—é–¥–µ–Ω–∏–µ',
                works: '–†–∞–±–æ—Ç—ã'
            };
            let counterHTML = '–ê–∫—Ç–∏–≤–Ω—ã–µ: ';
            let hasCounters = false;
            for (const [type, count] of Object.entries(typeCounts)) {
                if (count > 0) {
                    counterHTML += `<span class="counter-item"><span>${count}</span> ${typeNames[type] || type}</span>`;
                    hasCounters = true;
                }
            }
            if (!hasCounters) {
                counterHTML = '‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –Ω–µ—Ç';
            }
            counterEl.innerHTML = counterHTML;
        }
        
        // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Ä–∫–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Ä–µ–Ω–¥–µ—Ä–∏–º (–Ω–µ —Ç—Ä–æ–≥–∞–µ–º userLocationMarker –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã)
        if (markersCollection) markersCollection.removeAll();
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º GPS –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏–Ω–∞—á–µ —Ü–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã
        const userCoords = (userLocation && userLocation.length >= 2) ? userLocation : myMap.getCenter();

        // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ –æ–± –∞–≤—Ç–æ—Ä–∞—Ö (–∏–º—è, likes_sum, is_trusted)
        const authorIds = Array.from(new Set(markers.map(m => String(m.author_id))));
        const authorsInfoMap = {}; // user_id -> { name, likes_sum, is_trusted }
        try {
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–º—è –∏ —Ä–µ–π—Ç–∏–Ω–≥ –∏–∑ drivers (–µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞/–∫–æ–ª–æ–Ω–∫–∏ –µ—Å—Ç—å)
            const { data: driversInfo } = await _sb.from('drivers').select('user_id,name,likes_sum,is_trusted').in('user_id', authorIds);
            if (driversInfo) {
                driversInfo.forEach(d => {
                    const id = String(d.user_id);
                    authorsInfoMap[id] = {
                        name: d.name || '–ê–Ω–æ–Ω–∏–º',
                        likes_sum: (typeof d.likes_sum !== 'undefined' && d.likes_sum !== null) ? Number(d.likes_sum) : 0,
                        is_trusted: !!d.is_trusted
                    };
                });
            }
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ drivers –¥–ª—è –∞–≤—Ç–æ—Ä–æ–≤ (–≤–æ–∑–º–æ–∂–Ω–æ, —Ç–∞–±–ª–∏—Ü–∞/–∫–æ–ª–æ–Ω–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç):', e?.message || e);
        }

        // –î–ª—è –∞–≤—Ç–æ—Ä–æ–≤ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥—Å—á–∏—Ç–∞–µ–º —Å—É–º–º–∞—Ä–Ω—ã–µ –ª–∞–π–∫–∏ –ø–æ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –º–µ—Ç–∫–∞–º
        const missingAuthors = authorIds.filter(id => !authorsInfoMap[id]);
        if (missingAuthors.length > 0) {
            try {
                const { data: allMarkers } = await _sb.from('markers').select('author_id,votes_up').in('author_id', missingAuthors);
                const sumMap = {};
                if (allMarkers) {
                    allMarkers.forEach(r => {
                        const id = String(r.author_id);
                        sumMap[id] = (sumMap[id] || 0) + (r.votes_up || 0);
                    });
                }
                missingAuthors.forEach(id => {
                    const likes = sumMap[id] || 0;
                    authorsInfoMap[id] = { name: '–ê–Ω–æ–Ω–∏–º', likes_sum: likes, is_trusted: likes >= (typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20) };
                });
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Å—á–∏—Ç–∞—Ç—å —Å—É–º–º–∞—Ä–Ω—ã–µ –ª–∞–π–∫–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–æ–≤:', e?.message || e);
            }
        }

        // SOS: –∫—Ç–æ "–≤ –ø—É—Ç–∏" (Edge Function, —á—Ç–æ–±—ã –Ω–µ —É–ø–∏—Ä–∞—Ç—å—Å—è –≤ RLS —Ç–∞–±–ª–∏—Ü—ã)
        const sosEnrouteByMarker = {}; // marker_id -> user_id[]
        const sosResponderNames = {}; // user_id -> name
        try {
            const sosIds = activeMarkers
                .filter(x => String(x?.type) === 'sos')
                .map(x => Number(x?.id))
                .filter(n => Number.isFinite(n) && n > 0);

            if (sosIds.length > 0) {
                let token = localStorage.getItem('sb_jwt') || '';
                if (!token) {
                    const refreshed = await ensureSupabaseAuth();
                    token = refreshed || localStorage.getItem('sb_jwt') || '';
                }

                if (token) {
                    const resp = await fetch(`${SUPABASE_URL}/functions/v1/sos-enroute?action=list`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify({ markerIds: sosIds })
                    });

                    if (resp.ok) {
                        const payload = await resp.json();
                        const byMarker = payload?.byMarker || {};

                        Object.keys(byMarker).forEach(midStr => {
                            const mid = Number(midStr);
                            const list = Array.isArray(byMarker[midStr]) ? byMarker[midStr] : [];
                            if (!Number.isFinite(mid) || mid <= 0) return;

                            sosEnrouteByMarker[mid] = [];
                            list.forEach(item => {
                                const rid = String(item?.userId || '').trim();
                                const name = String(item?.name || '').trim();
                                if (!rid) return;
                                if (!sosEnrouteByMarker[mid].includes(rid)) sosEnrouteByMarker[mid].push(rid);
                                if (name) sosResponderNames[rid] = name;
                            });
                        });
                    }
                }
            }
        } catch (e) {}

        // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞ —Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –Ω–∞ –∫–∞—Ä—Ç–µ
        activeMarkers.forEach(m => {
            // –ü–æ–ª—É—á–∞–µ–º ID –∞–≤—Ç–æ—Ä–∞ –≤ –Ω–∞—á–∞–ª–µ —Ü–∏–∫–ª–∞
            const authorId = String(m.author_id);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–æ–º –º–∞—Ä–∫–µ—Ä–∞
            const isOwner = String(m.author_id) === String(uid);
            
            // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π "—É–µ—Ö–∞–ª–∏" (–≥—Ä–µ–π—Å—Ñ—É–ª - –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –±–µ—Ä—ë–º –∏–∑ —Å—á—ë—Ç—á–∏–∫–∞ –≤ markers)
            let leaveCount = m.leave_confirmations || 0;
            const confirmThreshold = typeof MARKER_LEAVE_THRESHOLD !== 'undefined' ? MARKER_LEAVE_THRESHOLD : 3;
            const confirmationBar = leaveCount > 0 ? `<div style="margin-top: 8px; font-size: 11px; color: #666;">üöó –£–µ—Ö–∞–ª–∏: ${leaveCount}/${confirmThreshold}</div>` : '';
            
            // HTML –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –æ–∫–Ω–∞ –º–∞—Ä–∫–µ—Ä–∞
            const authorInfo = authorsInfoMap[authorId] || { name: '–ê–Ω–æ–Ω–∏–º', likes_sum: 0, is_trusted: false };
            const isAdminMarker = isAdminUserId(authorId);
            const showAdminStyle = isAdminMarker && !adminInvisible;
            // –ü–µ—Ä–µ–≤–æ–¥–∏–º likes_sum –≤ 0..5 –∑–≤—ë–∑–¥
            function likesToStarsLocal(likes) {
                const n = Number(likes) || 0;
                if (n <= 0) return 0;
                if (n >= 100) return 5;
                if (n >= 60) return 4;
                if (n >= 30) return 3;
                if (n >= 10) return 2;
                return 1;
            }
            const starsCountLocal = likesToStarsLocal(authorInfo.likes_sum);
            let starsHTMLLocal = '';
            for (let i = 0; i < 5; i++) starsHTMLLocal += (i < starsCountLocal) ? '‚òÖ' : '‚òÜ';
            const starsBadgeLocal = `<span style="margin-left:8px; color: ${authorInfo.is_trusted ? '#b8860b' : '#f5c542'}; font-weight:700;">${starsHTMLLocal}</span>`;

            const authorNameHtml = showAdminStyle
                ? `<span class="admin-name">${authorInfo.name || 'Admin'}</span>`
                : `<strong>${authorInfo.name || '–ê–Ω–æ–Ω–∏–º'}</strong>`;
            const authorBadgesHtml = showAdminStyle
                ? `<span class="admin-rank">${ADMIN_RANK_LABEL}</span>`
                : `${authorInfo.is_trusted ? '<span style="color:#b8860b; font-weight:800; margin-left:6px;">‚≠ê</span>' : ''} ${starsBadgeLocal}`;
            const adminOnlineHtml = showAdminStyle
                ? `<div class="admin-online" style="margin-bottom:6px;"><span class="admin-online-dot"></span>–ù–∞ —Å–≤—è–∑–∏</div>`
                : '';
            const adminConfirmHtml = showAdminStyle
                ? `<div class="admin-confirm">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π</div>`
                : '';
            const reportButtonHtml = showAdminStyle
                ? adminConfirmHtml
                : `<button class="b-del" style="background: #ff9500; color:white;" onclick="window.reportUser(${m.author_id}, '${(authorInfo.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å').replace(/'/g, "\\'")}')" title="–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –∞–≤—Ç–æ—Ä–∞ –º–µ—Ç–∫–∏">‚ö†Ô∏è –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</button>`;

            const sosEnrouteIds = (String(m.type) === 'sos') ? (sosEnrouteByMarker[Number(m.id)] || []) : [];
            const sosEnrouteCount = Array.isArray(sosEnrouteIds) ? sosEnrouteIds.length : 0;
            const sosEnrouteNames = (sosEnrouteIds || [])
                .map(id => sosResponderNames[id] || id)
                .filter(Boolean)
                .slice(0, 6);
            const sosEnrouteNamesText = sosEnrouteNames.length ? ` ‚Äî ${sosEnrouteNames.join(', ')}` : '';
            const sosEnrouteInfoHtml = (String(m.type) === 'sos')
                ? `<div style="margin-top: 8px; font-size: 11px; color: #666;">üöë –í –ø—É—Ç–∏: ${sosEnrouteCount}${sosEnrouteNamesText}</div>`
                : '';
            const canEnroute = String(m.type) === 'sos' && uid && String(uid) !== String(m.author_id);
            const sosEnrouteBtnHtml = canEnroute
                ? `<button class="b-poll-btn" onclick="window.sosEnroute(${m.id})" style="flex: 1; background: var(--blue); color: white; font-weight: 900;">üöë –Ø –≤ –ø—É—Ç–∏</button>`
                : '';

            const bHtml = `<div class="b-cont">
                <div style="font-size:13px; margin-bottom:6px; color:#222; cursor: ${window.isAdmin ? 'pointer' : 'default'}; padding: 4px; border-radius: 4px; transition: all 0.2s;" onmouseover="${window.isAdmin ? `this.style.background='#f0f0f5'; this.style.transform='scale(1.02)'` : ''}" onmouseout="${window.isAdmin ? `this.style.background=''; this.style.transform='scale(1)'` : ''}" onclick="${window.isAdmin ? `window.showUserModeratorMenuFromMarker(${m.author_id}, '${(authorInfo.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å').replace(/'/g, "\\'")}')` : ''}">${authorNameHtml} ${authorBadgesHtml}</div>
                ${adminOnlineHtml}
                <strong>${m.comment || '–ú–µ—Ç–∫–∞'}</strong>
                ${m.photo_url ? `<div style="margin-top: 8px; margin-bottom: 8px;"><img src="${m.photo_url}" style="max-width: 100%; border-radius: 8px; cursor: pointer; max-height: 250px;" onclick="openPhotoViewer('${m.photo_url}')" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è"></div>` : ''}
                <div class="b-poll">
                    <button class="b-poll-btn" onclick="window.vote(${m.id}, true)">üëç ${m.votes_up || 0}</button>
                    <button class="b-poll-btn" onclick="window.vote(${m.id}, false)">üëé ${m.votes_down || 0}</button>
                </div>
                <div style="margin-top: 8px; display: flex; gap: 5px;">
                    <button class="b-poll-btn" onclick="window.confirmMarker(${m.id}, 'stay')" style="flex: 1; background: #34c759; color: white; font-weight: bold;">‚úÖ –°—Ç–æ—è—Ç</button>
                    <button class="b-poll-btn" onclick="window.confirmMarker(${m.id}, 'leave')" style="flex: 1; background: #ff3b30; color: white; font-weight: bold;">üöó –£–µ—Ö–∞–ª–∏</button>
                </div>
                ${sosEnrouteBtnHtml ? `<div style="margin-top: 8px; display: flex; gap: 5px;">${sosEnrouteBtnHtml}</div>` : ''}
                ${confirmationBar}
                ${sosEnrouteInfoHtml}
                ${isOwner ? `<button class="b-del" onclick="window.delMarker(${m.id})">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                ${reportButtonHtml}
            </div>`;
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ–≤–µ—Ä–∏–µ –∞–≤—Ç–æ—Ä–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∑–≤–µ–∑–¥–æ—á–∫—É –∫ –∏–∫–æ–Ω–∫–µ, –µ—Å–ª–∏ –æ–Ω –ø—Ä–æ–≤–µ—Ä–µ–Ω
            const isTrustedAuthor = authorInfo.is_trusted;
            const iconInner = showAdminStyle
                ? `<div class="admin-marker admin-marker--map"><span class="admin-siren admin-siren-left"></span><span class="admin-siren admin-siren-right"></span>${MAP_ICONS[m.type]}<span class="admin-marker-badge">üëë</span></div>`
                : `<div style="background:white; border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center; border:2px solid ${isTrustedAuthor ? '#b8860b' : 'var(--blue)'}; font-size:18px; position: relative;">${MAP_ICONS[m.type]}${isTrustedAuthor ? '<span style=\"position:absolute; top:-6px; right:-6px; font-size:12px;\">‚≠ê</span>' : ''}</div>`;
            // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä —Å –∏–∫–æ–Ω–∫–æ–π –∏ –±–∞–ª—É–Ω–æ–º
            const iconSize = showAdminStyle ? 34 : 30;
            const p = new ymaps.Placemark(m.coords, { balloonContent: bHtml, iconContent: iconInner }, 
            { iconLayout: 'default#imageWithContent', iconImageHref: '', iconImageSize: [iconSize, iconSize], iconImageOffset: [-(iconSize/2), -(iconSize/2)] });
            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é
            if (markersCollection) markersCollection.add(p);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –º–∞—Ä–∫–µ—Ä–∞ –∏ –≤—ã–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            checkMarkerDistance(m, userCoords);
            
            // –û—á–∏—â–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –¥–∞–ª–µ–∫–æ (–±–æ–ª–µ–µ 800–º)
            if (distanceNotifications.has(m.id)) {
                const mc = extractMarkerCoordsForNotif(m);
                if (mc) {
                    const distance = calculateDistance(userCoords[0], userCoords[1], mc.lat, mc.lon);
                    if (distance > 800) {
                        distanceNotifications.delete(m.id);
                    }
                }
            }
        });
        if (dtpHeatmapEnabled) {
            dtpHeatmapCacheLoadedAt = 0;
            scheduleDtpHeatmapRender();
        }
        if (patrolHeatmapEnabled) {
            patrolHeatmapCacheLoadedAt = 0;
            schedulePatrolHeatmapRender();
        }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞—Ä–∫–µ—Ä–æ–≤ (timeout –∏–ª–∏ –æ—à–∏–±–∫–∞ –ë–î):', error?.message);
        }
    }
</script>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div id="moderatorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0;">–ú–æ–¥–µ—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                <button class="modal-close" onclick="closeModerationModal()">√ó</button>
            </div>
            <div id="moderatorModalContent">
                <div style="background: #f0f0f5; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: var(--gray); margin-bottom: 8px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</div>
                    <div id="modUserName" style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">‚Äî</div>
                    <div style="font-size: 12px; color: var(--gray);">
                        Telegram ID: <span id="modUserId" style="font-weight: 600; color: #000;">‚Äî</span>
                    </div>
                </div>
                
                <div class="moderation-section">
                    <div class="moderation-title">‚öôÔ∏è –î–µ–π—Å—Ç–≤–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏</div>
                    <div class="moderation-buttons">
                        <button class="mod-btn mod-btn-temp" onclick="openBanDurationModal()">
                            <span style="font-size: 18px;">‚è±Ô∏è</span>
                            –í—Ä–µ–º–µ–Ω–Ω—ã–π –±–∞–Ω
                        </button>
                        
                        <button class="mod-btn mod-btn-perm" onclick="banUser('permanent')">
                            <span style="font-size: 18px;">üö´</span>
                            –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –±–∞–Ω
                        </button>
                    </div>
                    
                    <div style="margin-top: 10px; padding: 12px; background: #fff3cd; border-radius: 8px; font-size: 12px; color: #856404;">
                        ‚ö†Ô∏è –ó–∞–±–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ —Å–º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–µ—Ç–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–∞–Ω–∞ -->
    <div id="banDurationModal" class="ban-duration-modal">
        <div class="ban-duration-content">
            <div class="ban-duration-title">‚è±Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–∞–Ω–∞</div>
            
            <div class="ban-options">
                <div class="ban-option" data-hours="1">
                    <span class="duration">1 —á–∞—Å</span>
                    <span class="label">–ë—ã—Å—Ç—Ä–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</span>
                </div>
                <div class="ban-option" data-hours="6">
                    <span class="duration">6 —á–∞—Å–æ–≤</span>
                    <span class="label">–°–µ—Ä—å—ë–∑–Ω–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ</span>
                </div>
                <div class="ban-option" data-hours="24">
                    <span class="duration">24 —á–∞—Å–∞</span>
                    <span class="label">–°—É—Ç–∫–∏</span>
                </div>
                <div class="ban-option" data-hours="72">
                    <span class="duration">3 –¥–Ω—è</span>
                    <span class="label">–î–ª–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ</span>
                </div>
                <div class="ban-option" data-hours="168">
                    <span class="duration">7 –¥–Ω–µ–π</span>
                    <span class="label">–ù–µ–¥–µ–ª—è</span>
                </div>
                <div class="ban-option" data-hours="720">
                    <span class="duration">30 –¥–Ω–µ–π</span>
                    <span class="label">–ú–µ—Å—è—Ü</span>
                </div>
            </div>
            
            <div class="ban-actions">
                <button class="ban-cancel-btn" onclick="closeBanDurationModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="ban-confirm-btn" onclick="confirmTempBan()">–ó–∞–±–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID —Ç–µ–∫—É—â–µ–≥–æ –º–æ–¥–µ—Ä–∏—Ä—É–µ–º–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let currentModeratingUserId = null;

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∏–º—è –∞–≤—Ç–æ—Ä–∞ –≤ –º–∞—Ä–∫–µ—Ä–µ)
        window.showUserModeratorMenuFromMarker = function(userId, userName) {
            if (!window.isAdmin) {
                console.warn('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω: —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤');
                return;
            }
            
            currentModeratingUserId = userId;
            document.getElementById('modUserName').textContent = userName || '–ê–Ω–æ–Ω–∏–º';
            document.getElementById('modUserId').textContent = userId;
            document.getElementById('moderatorModal').classList.add('active');
        };

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
        function closeModerationModal() {
            document.getElementById('moderatorModal').classList.remove('active');
            currentModeratingUserId = null;
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–∞–Ω–∞ (–≤ —á–∞—Å–∞—Ö)
        let selectedBanHours = 24; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 24 —á–∞—Å–∞

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–∞–Ω–∞
        function openBanDurationModal() {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
            document.getElementById('moderatorModal').classList.remove('active');
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            document.getElementById('banDurationModal').classList.add('active');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä
            document.querySelectorAll('.ban-option').forEach(opt => opt.classList.remove('selected'));
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –æ–ø—Ü–∏–∏
            document.querySelectorAll('.ban-option').forEach(option => {
                option.onclick = function() {
                    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –æ–ø—Ü–∏–π
                    document.querySelectorAll('.ban-option').forEach(opt => opt.classList.remove('selected'));
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –æ–ø—Ü–∏—é
                    this.classList.add('selected');
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤
                    selectedBanHours = parseInt(this.getAttribute('data-hours'));
                };
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–∞–Ω–∞
        function closeBanDurationModal() {
            document.getElementById('banDurationModal').classList.remove('active');
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –º–æ–¥–∞–ª—å–Ω–æ–º—É –æ–∫–Ω—É –º–æ–¥–µ—Ä–∞—Ü–∏–∏
            document.getElementById('moderatorModal').classList.add('active');
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –±–∞–Ω–∞
        async function confirmTempBan() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω–∞ –ª–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            const selectedOption = document.querySelector('.ban-option.selected');
            if (!selectedOption) {
                alert('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–∞–Ω–∞');
                return;
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            document.getElementById('banDurationModal').classList.remove('active');
            
            // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –±–∞–Ω–∞ —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
            await banUserWithDuration(selectedBanHours);
        }

        // –§—É–Ω–∫—Ü–∏—è –±–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é (–≤ —á–∞—Å–∞—Ö)
        async function banUserWithDuration(hours) {
            if (!currentModeratingUserId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏');
                return;
            }

            const userName = document.getElementById('modUserName').textContent;
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
            let durationText = '';
            if (hours < 24) {
                durationText = `${hours} ${hours === 1 ? '—á–∞—Å' : hours < 5 ? '—á–∞—Å–∞' : '—á–∞—Å–æ–≤'}`;
            } else if (hours < 168) {
                const days = Math.floor(hours / 24);
                durationText = `${days} ${days === 1 ? '–¥–µ–Ω—å' : days < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'}`;
            } else {
                const days = Math.floor(hours / 24);
                durationText = `${days} ${days === 1 ? '–¥–µ–Ω—å' : days < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'}`;
            }
            
            const confirmMessage = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –Ω–∞ ${durationText}?`;

            if (!confirm(confirmMessage)) {
                // –ï—Å–ª–∏ –æ—Ç–º–µ–Ω–∏–ª–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –º–æ–¥–∞–ª—å–Ω–æ–º—É –æ–∫–Ω—É –º–æ–¥–µ—Ä–∞—Ü–∏–∏
                document.getElementById('moderatorModal').classList.add('active');
                return;
            }

            try {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –±–∞–Ω–∞
                const bannedUntil = new Date(Date.now() + hours * 60 * 60 * 1000).toISOString();
                const targetUserId = String(currentModeratingUserId);

                await invokeAdminFunction('ban-user', {
                    targetUserId,
                    bannedUntil,
                    banType: 'temp',
                    reason: `–í—Ä–µ–º–µ–Ω–Ω—ã–π –±–∞–Ω –Ω–∞ ${durationText}`
                });

                alert(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${userName}" –∑–∞–±–∞–Ω–µ–Ω –Ω–∞ ${durationText}`);
                currentModeratingUserId = null;

                // –£–¥–∞–ª—è–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã –∑–∞–±–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–∞—Ä—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–µ—Ç–∫–∏ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–∞—Ä—Ç—ã?')) {
                    const { error: deleteError } = await _sb
                        .from('markers')
                        .delete()
                        .eq('author_id', targetUserId);

                    if (deleteError) {
                        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫:', deleteError);
                    } else {
                        alert('‚úÖ –ú–µ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª–µ–Ω—ã');
                        await loadMarkers(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
                    }
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–∞–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                const msg = String(error?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                alert('‚ùå Edge Function ban-user –æ—Ç–∫–ª–æ–Ω–∏–ª–∞ –∑–∞–ø—Ä–æ—Å: ' + msg);
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –º–æ–¥–∞–ª—å–Ω–æ–º—É –æ–∫–Ω—É –º–æ–¥–µ—Ä–∞—Ü–∏–∏
                document.getElementById('moderatorModal').classList.add('active');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –±–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function banUser(banType) {
            if (!currentModeratingUserId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏');
                return;
            }

            const userName = document.getElementById('modUserName').textContent;
            const confirmMessage = banType === 'temp' 
                ? `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –Ω–∞ 24 —á–∞—Å–∞?`
                : `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ù–ê–í–°–ï–ì–î–ê –∑–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}"?`;

            if (!confirm(confirmMessage)) return;

            try {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –±–∞–Ω–∞
                const bannedUntil = banType === 'temp' 
                    ? new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString() // +24 —á–∞—Å–∞
                    : new Date('2099-12-31').toISOString(); // "–ù–∞–≤—Å–µ–≥–¥–∞"

                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º user_id –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å TEXT —Ç–∏–ø–æ–º –≤ –ë–î
                const userIdString = String(currentModeratingUserId);

                await invokeAdminFunction('ban-user', {
                    targetUserId: userIdString,
                    bannedUntil,
                    banType,
                    reason: banType === 'temp' ? '–í—Ä–µ–º–µ–Ω–Ω—ã–π –±–∞–Ω (24—á)' : '–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –±–∞–Ω'
                });

                const successMessage = banType === 'temp'
                    ? `‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${userName}" –∑–∞–±–∞–Ω–µ–Ω –Ω–∞ 24 —á–∞—Å–∞`
                    : `‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${userName}" –∑–∞–±–∞–Ω–µ–Ω –Ω–∞–≤—Å–µ–≥–¥–∞`;

                alert(successMessage);
                closeModerationModal();

                // –£–¥–∞–ª—è–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã –∑–∞–±–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–∞—Ä—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–µ—Ç–∫–∏ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–∞—Ä—Ç—ã?')) {
                    const { error: deleteError } = await _sb
                        .from('markers')
                        .delete()
                        .eq('author_id', userIdString);

                    if (deleteError) {
                        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫:', deleteError);
                    } else {
                        alert('‚úÖ –ú–µ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª–µ–Ω—ã');
                        await loadMarkers(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
                    }
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–∞–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                const msg = String(error?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                alert('‚ùå Edge Function ban-user –æ—Ç–∫–ª–æ–Ω–∏–ª–∞ –∑–∞–ø—Ä–æ—Å: ' + msg);
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ –æ–±–ª–∞—Å—Ç–∏
        document.getElementById('moderatorModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModerationModal();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–∞–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ –æ–±–ª–∞—Å—Ç–∏
        document.getElementById('banDurationModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeBanDurationModal();
            }
        });
    
        // ============= –≠–ö–†–ê–ù –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø =============
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 12) return 'üåÖ –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ';
            if (hour >= 12 && hour < 17) return '‚òÄÔ∏è –î–æ–±—Ä—ã–π –¥–µ–Ω—å';
            if (hour >= 17 && hour < 22) return 'üåÜ –î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä';
            return 'üåô –î–æ–±—Ä–æ–π –Ω–æ—á–∏';
        }

        function showSplashScreen() {
            const splashScreen = document.getElementById('splashScreen');
            const greetingText = document.getElementById('greetingText');
            const usernameText = document.getElementById('usernameText');

            greetingText.textContent = getGreeting();
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –≤–æ–¥–∏—Ç–µ–ª—è –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
            const driverName = currentDriver?.name || 
                               window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name || 
                               '–≤–æ–¥–∏—Ç–µ–ª—å';
            usernameText.textContent = `–í–æ–¥–∏—Ç–µ–ª—å ${driverName}`;

            splashScreen.classList.remove('hidden');

            // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã (–≤–º–µ—Å—Ç–æ 1)
            setTimeout(() => {
                splashScreen.classList.add('hidden');
            }, 2000);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —ç–∫—Ä–∞–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
        function hideSplashScreenImmediately() {
            document.getElementById('splashScreen').classList.add('hidden');
        }

        // ============= –ü–†–û–í–ï–†–ö–ê –ë–ê–ù–ê =============
        let userBanStatus = null;
        let appInitialized = false;

        async function checkBanStatus() {
            try {
                const userIdString = String(uid);
                const { data, error } = await _sb
                    .from('bans')
                    .select('*')
                    .eq('user_id', userIdString)
                    .maybeSingle();

                if (error && error.code !== 'PGRST116') {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–Ω–∞:', error);
                    return null;
                }

                if (!data) return null;

                const bannedUntil = new Date(data.banned_until);
                const now = new Date();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å—Ç–µ–∫ –ª–∏ –±–∞–Ω
                if (now >= bannedUntil) {
                    // –ë–∞–Ω –∏—Å—Ç–µ–∫ - —É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å
                    await _sb.from('bans').delete().eq('user_id', userIdString);
                    return null;
                }

                return data;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–Ω–∞:', error);
                return null;
            }
        }

        function showBanNotice(banData) {
            const banNotice = document.getElementById('banNotice');
            const banMessage = document.getElementById('banMessage');
            const banTimeRemaining = document.getElementById('banTimeRemaining');

            const bannedUntil = new Date(banData.banned_until);
            const isPermanent = bannedUntil.getFullYear() > 2050;

            if (isPermanent) {
                banMessage.textContent = '–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞–≤—Å–µ–≥–¥–∞ –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª.';
                banTimeRemaining.textContent = '';
            } else {
                banMessage.textContent = '–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª.';
                updateBanTimer(bannedUntil);
            }

            banNotice.classList.add('active');
            
            // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –µ—Å–ª–∏ –æ–Ω –ø–æ–∫–∞–∑–∞–Ω
            document.getElementById('splashScreen').classList.add('hidden');
        }

        function updateBanTimer(bannedUntil) {
            const banTimeRemaining = document.getElementById('banTimeRemaining');

            function update() {
                const now = new Date();
                const diff = bannedUntil - now;

                if (diff <= 0) {
                    banTimeRemaining.textContent = '–ë–∞–Ω –∏—Å—Ç–µ–∫. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                    setTimeout(() => location.reload(), 2000);
                    return;
                }

                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                banTimeRemaining.textContent = `–û—Å—Ç–∞–ª–æ—Å—å: ${hours}—á ${minutes}–º ${seconds}—Å`;
            }

            update();
            setInterval(update, 1000);
        }

        async function requestUnban() {
            const btn = document.getElementById('unbanRequestBtn');
            const status = document.getElementById('unbanStatus');

            btn.disabled = true;
            btn.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';

            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                const userIdNum = uid;
                if (!userIdNum) {
                    throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                }

                const userIdString = String(userIdNum);
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –≤–∞–∂–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è
                const driverName = currentDriver && currentDriver.name ? currentDriver.name : null;
                const telegramName = window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user && window.Telegram.WebApp.initDataUnsafe.user.first_name ? window.Telegram.WebApp.initDataUnsafe.user.first_name : null;
                const fullName = driverName || telegramName || '–≤–æ–¥–∏—Ç–µ–ª—å';
                
                console.log('–ù–∞—á–∞–ª–æ: userIdString=' + userIdString + ', fullName=' + fullName);

                // –ù–µ —Å–æ–∑–¥–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π pending-–∑–∞–ø—Ä–æ—Å
                const { data: pendingRequest, error: pendingError } = await _sb
                    .from('unban_requests')
                    .select('id,status,created_at')
                    .eq('user_id', userIdString)
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false })
                    .maybeSingle();

                if (pendingError && pendingError.code !== 'PGRST116') {
                    throw pendingError;
                }

                if (pendingRequest) {
                    status.textContent = '‚ÑπÔ∏è –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–∞–∑–±–∞–Ω';
                    status.style.color = '#ff9500';
                    status.style.display = 'block';
                    btn.textContent = '‚è≥ –ó–∞–ø—Ä–æ—Å —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω';
                    btn.disabled = true;
                    return;
                }
                
                // –í—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
                const insertResult = await _sb.from('unban_requests').insert({
                    user_id: userIdString,
                    username: fullName,
                    status: 'pending',
                    created_at: new Date().toISOString()
                });

                if (insertResult.error) {
                    throw insertResult.error;
                }

                status.textContent = '‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º';
                status.style.color = '#28a745';
                status.style.display = 'block';
                btn.textContent = '‚úì –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω';
                btn.disabled = true;

            } catch (err) {
                console.error('requestUnban –æ—à–∏–±–∫–∞:', err);
                
                let msg = '‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞';
                if (err && err.message) {
                    msg = '‚ùå ' + err.message.substring(0, 80);
                }
                
                status.textContent = msg;
                status.style.color = '#dc3545';
                status.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'üì® –ü–æ–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–∞–∑–±–∞–Ω';
            }
        }

        // ============= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –° –ü–†–û–í–ï–†–ö–û–ô –ë–ê–ù–ê =============
        // –≠—Ç–∞ –ª–æ–≥–∏–∫–∞ —Ç–µ–ø–µ—Ä—å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ ymaps.ready() –≤—ã—à–µ


</script>

    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–∏–∂–Ω–µ–≥–æ –≤–∏–¥–∂–µ—Ç–∞ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–æ–≥–¥–∞ –æ–Ω –∑–∞–∫—Ä—ã—Ç) -->
    <button id="openActionBtn" class="open-action-btn" onclick="toggleActionCard()">‚ñ≤</button>

    <script>
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
        console.log('%cüé§ EASY RIDE 180 - –û–∑–≤—É—á–∫–∞', 'font-size:16px;font-weight:bold;color:#007aff');
        console.log('%c–î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ MP3 –æ–∑–≤—É—á–∫–∏, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏:\nuploadCustomWarningAudios()', 'font-size:13px;color:#666');
        window.quickUploadAudio = async function() {
            console.log('‚è≥ –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É MP3 –æ–∑–≤—É—á–∫–∏...');
            if (typeof uploadCustomWarningAudios === 'function') {
                await uploadCustomWarningAudios();
            } else {
                console.error('‚ùå –§—É–Ω–∫—Ü–∏—è uploadCustomWarningAudios –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            }
        };
        console.log('%c–ò–õ–ò –Ω–∞–∂–º–∏—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É:\n', 'font-size:13px;color:#999');
        console.log('%c[–ó–ê–ì–†–£–ó–ò–¢–¨ –û–ó–í–£–ß–ö–£]', 'font-size:14px;cursor:pointer;color:#007aff;text-decoration:underline;background:#f0f0f0;padding:8px 16px;border-radius:6px');
    </script>
</body>
</html>

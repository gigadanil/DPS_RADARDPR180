<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#007aff">
    <title>EASY RIDE ‚Äî RELIABLE</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=7f7db9e2-0eff-47d4-98d3-59b326552ed7&lang=ru_RU"></script>
    <style>
        :root { --blue: #007aff; --bg: #f2f2f7; --gray: #8e8e93;
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --safe-area-inset-left: env(safe-area-inset-left);
            --safe-area-inset-right: env(safe-area-inset-right); }
        body, html { width: 100%; height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); overflow: hidden; }
        
        /* –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏–µ —Ç–∞–ø-—Ä–µ–∞–∫—Ü–∏–π */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        body, html {
            position: fixed;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* ============= –≠–ö–†–ê–ù –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø ============= */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        #splashScreen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        .splash-logo {
            width: 180px;
            height: 180px;
            margin-bottom: 30px;
            animation: logoFadeIn 0.8s ease-out, logoPulse 2s ease-in-out infinite 1s;
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.3));
        }
        
        .splash-greeting {
            color: white;
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
            animation: textFadeIn 1s ease-out 0.3s both;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .splash-username {
            color: rgba(255,255,255,0.9);
            font-size: 18px;
            font-weight: 500;
            text-align: center;
            animation: textFadeIn 1s ease-out 0.5s both;
            text-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .splash-loader {
            margin-top: 40px;
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes logoFadeIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        @keyframes logoPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        @keyframes textFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ============= –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –ë–ê–ù–ï ============= */
        .ban-notice { 
            display: none;
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.9); 
            z-index: 9999; 
            align-items: center; 
            justify-content: center;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        .ban-notice.active { display: flex; }
        
        .ban-notice-content { 
            background: white; 
            border-radius: 24px; 
            padding: 30px; 
            max-width: 400px; 
            width: 90%; 
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        
        .ban-notice-icon { 
            font-size: 64px; 
            margin-bottom: 20px; 
        }
        
        .ban-notice-title { 
            font-size: 24px; 
            font-weight: 800; 
            color: #ff3b30; 
            margin-bottom: 15px; 
        }
        
        .ban-notice-message { 
            font-size: 16px; 
            color: #333; 
            line-height: 1.5; 
            margin-bottom: 20px; 
        }
        
        .ban-notice-time { 
            font-size: 14px; 
            color: var(--gray); 
            margin-bottom: 25px; 
        }
        
        .unban-request-btn {
            width: 100%;
            background: var(--blue);
            color: white;
            border: none;
            border-radius: 14px;
            padding: 16px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .unban-request-btn:active { transform: scale(0.98); }
        
        .unban-request-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .unban-status {
            font-size: 13px;
            color: #34c759;
            margin-top: 10px;
            font-weight: 600;
        }
        #map { width: 100%; height: 100%; position: absolute; }
        .target {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%);
            z-index: 9999;
            pointer-events: none;
            font-size: 40px;
            transition: visibility 0.2s, opacity 0.2s;
            visibility: visible;
            opacity: 1;
        }
        .bottom-ui { position: absolute; bottom: calc(10px + var(--safe-area-inset-bottom)); left: 0; right: 0; z-index: 1000; padding: 0 8px; }
        .action-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(15px); border-radius: 24px; padding: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); position: relative; }
        .action-card.hidden { display: none; }
        .action-card-close { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray); padding: 4px 8px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s; }
        .action-card-close:active { background: #f0f0f5; color: #000; }
        .open-action-btn { position: fixed; bottom: calc(18px + var(--safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); width: 48px; height: 48px; border-radius: 50%; background: white; border: 2px solid var(--blue); z-index: 1600; display: none; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); cursor: pointer; }
        .open-action-btn.visible { display: flex; }
        .addr-label { font-size: 12px; color: #000; font-weight: 600; margin-bottom: 10px; display: block; text-align: center; }
        .type-selector { display: flex; justify-content: space-between; margin-bottom: 12px; gap: 6px; flex-wrap: wrap; }
        .type-btn { 
            border: none; background: none; cursor: pointer; display: flex; flex-direction: column; 
            align-items: center; gap: 6px; width: 31%; padding: 8px; border-radius: 14px; 
            transition: all 0.25s ease; position: relative;
        }
        .type-btn:active { transform: scale(0.95); }
        .icon-circle { 
            width: 54px; height: 54px; background: #f0f0f5; border-radius: 16px; display: flex; 
            align-items: center; justify-content: center; border: 3px solid transparent; 
            transition: all 0.25s ease; font-size: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .type-btn span { font-size: 11px; font-weight: 700; color: var(--gray); text-transform: uppercase; letter-spacing: 0.3px; }
        .type-btn:hover .icon-circle { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
        .type-btn.active { color: var(--blue); background: rgba(0, 122, 255, 0.08); }
        .type-btn.active .icon-circle { background: #fff; border-color: var(--blue); box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3); }
        
        /* –°—á—ë—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–∫ */
        .markers-counter { font-size: 11px; color: var(--gray); margin-bottom: 10px; text-align: center; padding: 8px; background: #f9f9f9; border-radius: 10px; }
        .counter-item { display: inline-block; margin: 0 6px; }
        .counter-item span:first-child { font-weight: 700; color: var(--blue); }
        .main-btn { width: 100%; background: var(--blue); color: white; border: none; border-radius: 16px; padding: 14px; font-size: 15px; font-weight: 800; cursor: pointer; }
        .b-cont { font-size: 14px; line-height: 1.4; min-width: 170px; }
        .b-poll { display: flex; gap: 8px; margin-top: 10px; }
        .b-poll-btn { flex: 1; border: none; border-radius: 8px; padding: 8px; cursor: pointer; background: #f0f0f5; font-weight: bold; }
        .b-del { color: #ff3b30; border: none; background: none; font-size: 11px; margin-top: 12px; width: 100%; cursor: pointer; font-weight: bold; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è –∏ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ */
        .profile-btn { position: absolute; top: calc(15px + var(--safe-area-inset-top)); right: calc(15px + var(--safe-area-inset-right)); z-index: 1500; width: 45px; height: 45px; border-radius: 50%; background: white; border: 2px solid var(--blue); cursor: pointer; font-size: 22px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .profile-btn:active { transform: scale(1.05); }
        /* –ö–Ω–æ–ø–∫–∞ "–ì–¥–µ —è" */
        .loc-btn { position: absolute; top: calc(15px + var(--safe-area-inset-top)); right: calc(70px + var(--safe-area-inset-right)); z-index: 1500; width: 45px; height: 45px; border-radius: 50%; background: white; border: 2px solid var(--blue); cursor: pointer; font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        .loc-btn:active { transform: scale(1.05); }
        .follow-toggle { position: absolute; top: calc(15px + var(--safe-area-inset-top)); right: calc(120px + var(--safe-area-inset-right)); z-index: 1500; width: 40px; height: 40px; border-radius: 50%; background: white; border: 2px solid #34c759; cursor: pointer; font-size: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        .follow-toggle.inactive { background: #fff; border-color: #ccc; color: #888; }
        .follow-toggle.active { background: #34c759; color: white; border-color: #34c759; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2500; overflow-y: auto; }
        .modal.active { display: block; }
        .modal-content { background: white; border-radius: 20px; margin: 20px; padding: 20px; max-width: 500px; margin-left: auto; margin-right: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: var(--gray); }
        
        /* –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å */
        .admin-btn { position: absolute; top: calc(15px + var(--safe-area-inset-top)); left: calc(15px + var(--safe-area-inset-left)); z-index: 1500; width: 45px; height: 45px; border-radius: 50%; background: #ff9500; border: 2px solid white; cursor: pointer; font-size: 22px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
        .admin-btn.visible { display: block; }
        .admin-btn:active { transform: scale(1.05); }
        
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .admin-table th, .admin-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; font-size: 12px; }
        .admin-table th { background: #f0f0f5; font-weight: 600; }
        .admin-table tr:hover { background: #f9f9f9; }
        
        .delete-btn { background: #ff3b30; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .delete-btn:active { background: #e63027; }
        
        .admin-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .admin-stat-card { background: #f0f0f5; border-radius: 12px; padding: 15px; text-align: center; }
        .admin-stat-card .value { font-size: 28px; font-weight: 800; color: var(--blue); }
        .admin-stat-card .label { font-size: 12px; color: var(--gray); margin-top: 5px; }
        
        /* –ö–Ω–æ–ø–∫–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ */
        .moderation-section { margin-top: 20px; padding-top: 20px; border-top: 2px solid #f0f0f5; }
        .moderation-title { font-size: 14px; font-weight: 700; color: #333; margin-bottom: 12px; text-align: center; }
        .moderation-buttons { display: flex; gap: 10px; }
        .mod-btn { flex: 1; border: none; padding: 12px; border-radius: 12px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .mod-btn:active { transform: scale(0.95); }
        .mod-btn-temp { background: #ff9500; color: white; }
        .mod-btn-temp:hover { background: #e68600; }
        .mod-btn-perm { background: #ff3b30; color: white; }
        .mod-btn-perm:hover { background: #e63027; }
        .mod-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –±–∞–Ω–∞ */
        .ban-duration-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 3000; align-items: center; justify-content: center; }
        .ban-duration-modal.active { display: flex; }
        .ban-duration-content { background: white; border-radius: 20px; padding: 25px; max-width: 350px; width: 90%; }
        .ban-duration-title { font-size: 18px; font-weight: 700; margin-bottom: 15px; text-align: center; }
        .ban-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .ban-option { background: #f0f0f5; border: 2px solid transparent; padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; font-size: 13px; font-weight: 600; transition: all 0.2s; }
        .ban-option:hover { background: #e5e5ea; }
        .ban-option.selected { background: #fff; border-color: #ff9500; color: #ff9500; }
        .ban-option .duration { display: block; font-size: 16px; font-weight: 700; margin-bottom: 4px; }
        .ban-option .label { display: block; font-size: 11px; color: var(--gray); }
        .ban-actions { display: flex; gap: 10px; }
        .ban-confirm-btn, .ban-cancel-btn { flex: 1; border: none; padding: 12px; border-radius: 12px; font-size: 14px; font-weight: 700; cursor: pointer; }
        .ban-confirm-btn { background: #ff9500; color: white; }
        .ban-cancel-btn { background: #f0f0f5; color: #333; }
        

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Ä–∞–∑–±–∞–Ω */
        .filter-btn {
            transition: all 0.2s;
        }
        .filter-btn:active {
            transform: scale(0.95);
        }
        .filter-btn.active {
            opacity: 1;
        }
        .filter-btn:not(.active) {
            opacity: 0.6;
        }
        

        /* –ß–∞—Ç */
        .chat-btn { position: absolute; bottom: calc(100px + var(--safe-area-inset-bottom)); right: calc(15px + var(--safe-area-inset-right)); z-index: 1500; width: 50px; height: 50px; border-radius: 50%; background: var(--blue); border: 2px solid white; cursor: pointer; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        .chat-btn:hover { transform: scale(1.05); }
        .chat-btn:active { transform: scale(0.95); }
        
        .chat-messages { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; max-height: 400px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 12px; }
        .chat-message { padding: 10px 12px; border-radius: 10px; font-size: 13px; max-width: 80%; word-wrap: break-word; }
        .chat-message.own { background: var(--blue); color: white; margin-left: auto; }
        .chat-message.other { background: white; border: 1px solid #ddd; }
        .chat-message-author { font-size: 11px; font-weight: 600; margin-bottom: 3px; opacity: 0.8; }
        .chat-message-photo { max-width: 200px; border-radius: 8px; margin-top: 5px; cursor: pointer; }
        .chat-message-time { font-size: 10px; opacity: 0.7; margin-top: 3px; }
        
        .chat-input-group { display: flex; gap: 8px; }
        .chat-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; box-sizing: border-box; }
        .chat-send-btn { background: var(--blue); color: white; border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; }
        .chat-send-btn:hover { background: #0051d5; }
        
        .chat-photo-upload { position: relative; }
        .chat-photo-input { display: none; }
        .chat-photo-btn { background: #f0f0f5; color: var(--blue); border: none; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 16px; }
        .chat-photo-btn:hover { background: #e0e0e5; }
        
        /* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
        .chat-context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            min-width: 180px;
            padding: 8px 0;
        }
        .chat-context-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chat-context-menu-item:hover { background: #f0f0f5; }
        .chat-context-menu-item.delete { color: #ff3b30; }
        .chat-context-menu-item.report { color: #ff9500; }
        
        /* –ú–µ–Ω—é –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞ */
        .moderator-menu {
            animation: slideIn 0.15s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
        .registration-form input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; box-sizing: border-box; }
        .registration-form label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; color: #000; }
        .registration-form .form-group { margin-bottom: 15px; }
        
        /* –°—Ç–∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è */
        .profile-header { text-align: center; margin-bottom: 20px; }
        .profile-avatar { width: 80px; height: 80px; background: var(--blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 40px; margin: 0 auto 15px; }
        .profile-name { font-size: 20px; font-weight: 800; color: #000; margin-bottom: 5px; }
        .profile-name.trusted { color: #b8860b; text-shadow: 0 1px 0 rgba(0,0,0,0.15); }
        .profile-id { font-size: 12px; color: var(--gray); }
        
        /* –†–µ–π—Ç–∏–Ω–≥ */
        .rating-card { background: linear-gradient(135deg, var(--blue), #5ac8fa); border-radius: 15px; padding: 15px; color: white; margin-bottom: 15px; }
        .rating-value { font-size: 36px; font-weight: 800; }
        .rating-label { font-size: 12px; opacity: 0.9; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-item { background: #f0f0f5; border-radius: 12px; padding: 12px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: 800; color: var(--blue); }
        .stat-label { font-size: 11px; color: var(--gray); margin-top: 5px; }
        
        /* –°—Ç–∏–ª–∏ –ª–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π */
        .activity-item { padding: 10px; border-bottom: 1px solid #e0e0e0; font-size: 12px; line-height: 1.4; }
        .activity-item:last-child { border-bottom: none; }
        .activity-time { font-size: 10px; color: var(--gray); margin-top: 4px; }
        .activity-icon { margin-right: 6px; }
        
        /* –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è */
        .achievement { display: inline-block; text-align: center; padding: 8px; margin: 4px; background: #f9f9f9; border-radius: 10px; border: 1px solid #e0e0e0; font-size: 11px; min-width: 70px; }
        .achievement-icon { font-size: 24px; margin-bottom: 4px; }
        .achievement-title { font-weight: 700; color: var(--blue); }
    </style>
</head>
<body>
    <!-- ============= –≠–ö–†–ê–ù –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø ============= -->
    <div id="splashScreen">
        <img src="img/logo.png" alt="180 –°–∞—Ñ–µ–î—Ä–∞–π–≤" class="splash-logo">
        <div class="splash-greeting" id="greetingText">–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ</div>
        <div class="splash-username" id="usernameText">–í–æ–¥–∏—Ç–µ–ª—å...</div>
        <div class="splash-loader"></div>
    </div>

    <!-- ============= –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –ë–ê–ù–ï ============= -->
    <div id="banNotice" class="ban-notice">
        <div class="ban-notice-content">
            <div class="ban-notice-icon">üö´</div>
            <div class="ban-notice-title">–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</div>
            <div class="ban-notice-message" id="banMessage">–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</div>
            <div class="ban-notice-time" id="banTimeRemaining"></div>
            <button id="unbanRequestBtn" class="unban-request-btn" onclick="requestUnban()">
                üì® –ü–æ–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–∞–∑–±–∞–Ω
            </button>
            <div id="unbanStatus" class="unban-status" style="display: none;"></div>
        </div>
    </div>


    <div class="target">üìç</div>

    <!-- Overlay: –¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram -->
    <div id="tgAuthOverlay" class="auth-overlay" style="display:none; position:fixed; inset:0; z-index:99999; background:rgba(0,0,0,0.6); align-items:center; justify-content:center;">
        <div style="background:#fff; padding:20px; border-radius:12px; max-width:420px; width:90%; text-align:center; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
            <h3 style="margin-top:0;">–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram</h3>
            <p style="color:#444;">–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç–∫—Ä—ã—Ç—å –µ–≥–æ —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞ –∏ –ø—Ä–æ–π—Ç–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.</p>
            <div style="display:flex; gap:8px; justify-content:center; margin-top:12px;">
                <button onclick="openTelegramBot()" style="padding:10px 14px; border-radius:10px; border:none; background:#00a2ff; color:#fff; font-weight:700;">–û—Ç–∫—Ä—ã—Ç—å –≤ Telegram</button>
                <button onclick="location.reload()" style="padding:10px 14px; border-radius:10px; border:1px solid #ccc; background:#fff;">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –û–Ω–ª–∞–π–Ω-—Å—á—ë—Ç—á–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div id="onlineCountBadge" style="position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 1600; background: white; padding: 6px 10px; border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); font-weight:700; display: none;">–û–Ω–ª–∞–π–Ω: ‚Äî</div>
    <div id="map"></div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ —á–∞—Ç–∞ -->
    <button class="chat-btn" onclick="openChatModal()">üí¨</button>
    <!-- –ö–Ω–æ–ø–∫–∞ –ª–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π -->
    <button class="chat-btn" onclick="openActivityModal()" style="bottom: 160px;">üì°</button>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ -->
    <div id="chatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">–û–±—â–∏–π —á–∞—Ç</h2>
                <button class="modal-close" onclick="closeChatModal()">‚úï</button>
            </div>

            
            <div class="chat-messages" id="chatMessages">
                <div style="text-align: center; color: var(--gray); padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
            </div>
            
            <div id="chatPhotoPreview" style="padding: 10px; display: none;"></div>
            
            <div class="chat-input-group">
                <input type="text" id="chatInput" class="chat-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="500">
                <div class="chat-photo-upload">
                    <input type="file" id="chatPhotoInput" class="chat-photo-input" accept="image/*">
                    <button class="chat-photo-btn" onclick="document.getElementById('chatPhotoInput').click()">üì∑</button>
                </div>
                <button class="chat-send-btn" onclick="sendChatMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –∞–¥–º–∏–Ω–∞ -->
    <button class="admin-btn" id="adminBtn" onclick="openAdminModal()">‚öôÔ∏è</button>
    <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
    <button class="profile-btn" id="profileBtn" onclick="openProfileModal()" title="–ü—Ä–æ—Ñ–∏–ª—å">üë§</button>
    <!-- –ö–Ω–æ–ø–∫–∞ '–ì–¥–µ —è' -->
    <button class="loc-btn" id="locBtn" onclick="centerOnMyLocation()" title="–ì–¥–µ —è">üìç</button>
    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Å–ª–µ–∂–µ–Ω–∏—è GPS -->
    <button class="follow-toggle" id="followToggleBtn" onclick="toggleFollow()" title="–ê–≤—Ç–æ—Å–ª–µ–∂–µ–Ω–∏–µ GPS">üîî</button>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
                <button class="modal-close" onclick="closeAdminModal()">‚úï</button>
            </div>
            
            <div class="admin-stats">
                <div class="admin-stat-card">
                    <div class="label">–í—Å–µ–≥–æ –≤–æ–¥–∏—Ç–µ–ª–µ–π</div>
                    <div class="value" id="admin-drivers-count">0</div>
                </div>
                <div class="admin-stat-card">
                    <div class="label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–∫</div>
                    <div class="value" id="admin-markers-count">0</div>
                </div>
            </div>
            
            <h3 style="margin-top: 20px; margin-bottom: 10px; font-size: 14px;">–°–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π</h3>
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <input type="text" id="driverSearchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ ID..." style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-size: 13px;">
                <button onclick="clearDriverSearch()" style="padding: 8px 12px; border: none; border-radius: 8px; background: #f0f0f5; cursor: pointer; font-size: 13px; font-weight: 600;">üîÑ –°–±—Ä–æ—Å</button>
            </div>
            <div style="overflow-x: auto; max-height: 300px; overflow-y: auto;">
                <table class="admin-table" id="admin-drivers-table">
                    <thead>
                        <tr>
                            <th>–ò–º—è</th>
                            <th>–ê–≤—Ç–æ</th>
                            <th>–ù–æ–º–µ—Ä</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody id="admin-drivers-body">
                        <tr><td colspan="5" style="text-align: center; color: var(--gray);">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <h3 style="margin-top: 20px; margin-bottom: 10px; font-size: 14px;">–ê–∫—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–∫–∏</h3>
            <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                <select id="markerTypeFilter" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 13px; cursor: pointer;">
                    <option value="">üìç –í—Å–µ —Ç–∏–ø—ã</option>
                    <option value="dps">ÔøΩ –î–ü–°</option>
                    <option value="camera">üì∏ –ö–∞–º–µ—Ä–∞</option>
                    <option value="patrol">üöî –†–µ–π–¥</option>
                    <option value="dtp">üí• –î–¢–ü</option>
                    <option value="works">üöß –†–∞–±–æ—Ç—ã</option>
                    <option value="sos">üÜò SOS</option>
                </select>
                <button onclick="clearMarkerFilter()" style="padding: 8px 12px; border: none; border-radius: 8px; background: #f0f0f5; cursor: pointer; font-size: 13px; font-weight: 600;">üîÑ –°–±—Ä–æ—Å</button>
            </div>
            <div style="overflow-x: auto; max-height: 300px; overflow-y: auto;">
                <table class="admin-table" id="admin-markers-table">
                    <thead>
                        <tr>
                            <th>–¢–∏–ø</th>
                            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                            <th>–õ–∞–π–∫–∏</th>
                            <th>–î–∏–∑–ª–∞–π–∫–∏</th>
                            <th>Exp</th>
                            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody id="admin-markers-body">
                        <tr><td colspan="6" style="text-align: center; color: var(--gray);">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
            

            <!-- ============ –†–ê–ó–î–ï–õ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ó–ê–ü–†–û–°–ê–ú–ò –ù–ê –†–ê–ó–ë–ê–ù ============ -->
            <div id="unbanRequestsSection" style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; font-size: 18px; font-weight: 700;">üì® –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ —Ä–∞–∑–±–∞–Ω</h3>
                    <button onclick="refreshUnbanRequests()" style="background: var(--blue); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
                    <div style="background: #fff3cd; border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 800; color: #ff9500;" id="pendingRequestsCount">0</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">–û–∂–∏–¥–∞—é—Ç</div>
                    </div>
                    <div style="background: #d4edda; border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 800; color: #28a745;" id="approvedRequestsCount">0</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">–û–¥–æ–±—Ä–µ–Ω–æ</div>
                    </div>
                    <div style="background: #f8d7da; border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 800; color: #dc3545;" id="rejectedRequestsCount">0</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</div>
                    </div>
                </div>

                <!-- –§–∏–ª—å—Ç—Ä—ã -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button onclick="filterUnbanRequests('all')" id="filterAll" class="filter-btn active" style="flex: 1; padding: 10px; border: 2px solid var(--blue); background: var(--blue); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; min-width: 70px;">
                        –í—Å–µ
                    </button>
                    <button onclick="filterUnbanRequests('pending')" id="filterPending" class="filter-btn" style="flex: 1; padding: 10px; border: 2px solid #ff9500; background: white; color: #ff9500; border-radius: 8px; cursor: pointer; font-weight: 600; min-width: 70px;">
                        –û–∂–∏–¥–∞—é—Ç
                    </button>
                    <button onclick="filterUnbanRequests('approved')" id="filterApproved" class="filter-btn" style="flex: 1; padding: 10px; border: 2px solid #28a745; background: white; color: #28a745; border-radius: 8px; cursor: pointer; font-weight: 600; min-width: 70px;">
                        –û–¥–æ–±—Ä–µ–Ω–æ
                    </button>
                    <button onclick="filterUnbanRequests('rejected')" id="filterRejected" class="filter-btn" style="flex: 1; padding: 10px; border: 2px solid #dc3545; background: white; color: #dc3545; border-radius: 8px; cursor: pointer; font-weight: 600; min-width: 70px;">
                        –û—Ç–∫–ª–æ–Ω–µ–Ω–æ
                    </button>
                </div>

                <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ -->
                <div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
                    <table class="admin-table" id="unbanRequestsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>User ID</th>
                                <th>–î–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="unbanRequestsBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">
                                    –ó–∞–≥—Ä—É–∑–∫–∞...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <button class="main-btn" onclick="closeAdminModal()" style="margin-top: 20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Ä–∞–∑–±–∞–Ω -->
    <div id="reviewUnbanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîç –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Ä–∞–∑–±–∞–Ω</h3>
                <button class="modal-close" onclick="closeReviewUnbanModal()">√ó</button>
            </div>

            <div id="reviewUnbanContent">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–ø—Ä–æ—Å–µ -->
                <div style="background: #f0f0f5; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <div style="margin-bottom: 10px;">
                        <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> <span id="reviewUsername">-</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>User ID:</strong> <span id="reviewUserId">-</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>–î–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞:</strong> <span id="reviewCreatedAt">-</span>
                    </div>
                    <div>
                        <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–Ω–µ:</strong> <span id="reviewBanInfo">-</span>
                    </div>
                </div>

                <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞:</label>
                    <textarea id="reviewComment" 
                        style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"
                        placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —Ä–µ—à–µ–Ω–∏—è..."></textarea>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                <div style="display: flex; gap: 10px;">
                    <button onclick="approveUnbanRequest()" 
                        style="flex: 1; background: #28a745; color: white; border: none; padding: 14px; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer;">
                        ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å –∏ —Å–Ω—è—Ç—å –±–∞–Ω
                    </button>
                    <button onclick="rejectUnbanRequest()" 
                        style="flex: 1; background: #dc3545; color: white; border: none; padding: 14px; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer;">
                        ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å
                    </button>
                </div>
            </div>
        </div>
    </div>
    

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –æ–± –∞–≤—Ç–æ) -->
    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">–ó–∞–≤–µ—Ä—à–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</h2>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <div class="profile-avatar">üë§</div>
                <div class="profile-name" id="reg-user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <form class="registration-form" onsubmit="registerDriver(event)">
                <div class="form-group">
                    <label>–ú–∞—Ä–∫–∞/–ú–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è:</label>
                    <input type="text" id="driver-car" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Toyota Camry">
                </div>
                <div class="form-group">
                    <label>–ù–æ–º–µ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                    <input type="text" id="driver-plate" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: A123BC 77">
                </div>
                <button type="submit" class="main-btn" style="margin-top: 15px;">–ó–ê–í–ï–†–®–ò–¢–¨</button>
            </form>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
                <button class="modal-close" onclick="closeProfileModal()">‚úï</button>
            </div>
            <div class="profile-header">
                <div class="profile-avatar" id="profile-avatar-display" onclick="changeAvatar()" style="cursor: pointer; position: relative;" title="–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å">üë§</div>
                <input type="hidden" id="profile-avatar-value" value="üë§">
                <input type="hidden" id="profile-avatar-url" value="">
                <button class="main-btn" onclick="document.getElementById('profile-photo-input').click()" style="margin-top: 10px; font-size: 12px; padding: 8px; background: #34c759;">üì∏ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –∞–≤–∞—Ç–∞—Ä–∞</button>
                <input type="file" id="profile-photo-input" style="display: none;" accept="image/*">
                <div class="profile-name" id="profile-name-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div style="margin-top: 15px; border: 1px solid #ddd; border-radius: 10px; padding: 10px; background: #f9f9f9;">
                    <div class="form-group">
                        <label style="font-size: 12px; color: var(--gray);">–ú–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è:</label>
                        <input type="text" id="edit-car-model" placeholder="Toyota Camry" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px;">
                    </div>
                    <div class="form-group">
                        <label style="font-size: 12px; color: var(--gray);">–ù–æ–º–µ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª—è:</label>
                        <input type="text" id="edit-car-plate" placeholder="A123BC 77" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px;">
                    </div>
                    <button class="main-btn" onclick="saveProfileChanges()" style="font-size: 13px; padding: 10px; margin-top: 10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </div>
            </div>
            
            <div class="rating-card">
                <div class="rating-label">–í–∞—à —Ä–µ–π—Ç–∏–Ω–≥</div>
                <div class="rating-value" id="profile-rating">0.0</div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="profile-marks-count">0</div>
                    <div class="stat-label">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ—Ç–æ–∫</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="profile-votes-sum">0</div>
                    <div class="stat-label">–ü–æ–ª–µ–∑–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="profile-likes">0</div>
                    <div class="stat-label">–õ–∞–π–∫–æ–≤</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="profile-dislikes">0</div>
                    <div class="stat-label">–î–∏–∑–ª–∞–π–∫–æ–≤</div>
                </div>
            </div>
            
            <div style="background: #f9f9f9; border-radius: 12px; padding: 12px; margin-bottom: 15px; text-align: center;">
                <div style="font-size: 12px; color: var(--gray); margin-bottom: 5px;">–°—Ç–∞—Ç—É—Å</div>
                <div id="profile-trust-status" style="font-size: 16px; font-weight: 800; color: var(--blue);">üéØ –û–±—ã—á–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å</div>
            </div>
            
            <button class="main-btn" onclick="openRatingsModal()" style="margin-bottom: 10px; background: #34c759;">–ì–õ–û–ë–ê–õ–¨–ù–´–ô –†–ï–ô–¢–ò–ù–ì</button>
            <button class="main-btn" onclick="logout()">–í–´–ô–¢–ò</button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞ -->
    <div id="avatarEditorModal" class="modal">
        <div class="modal-content" style="width: 90%; max-width: 400px;">
            <div class="modal-header">
                <h2 style="margin: 0;">–†–µ–¥–∞–∫—Ç–æ—Ä –∞–≤–∞—Ç–∞—Ä–∞</h2>
                <button class="modal-close" onclick="closeAvatarEditor()">‚úï</button>
            </div>
            <div style="text-align: center; padding: 20px;">
                <!-- –ö—Ä—É–≥–ª—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
                <div style="position: relative; width: 200px; height: 200px; margin: 0 auto 20px; border-radius: 50%; overflow: hidden; border: 2px solid var(--blue); background: #f0f0f0;">
                    <img id="avatarEditorImage" style="position: absolute; width: 100%; height: 100%; object-fit: cover; cursor: grab;" alt="Avatar">
                </div>
                
                <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <div style="padding: 0 10px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; text-align: left; font-size: 12px; color: var(--gray); margin-bottom: 5px;">–ú–∞—Å—à—Ç–∞–± (–∑—É–º):</label>
                        <input type="range" id="avatarZoom" min="1" max="3" step="0.1" value="1" style="width: 100%; cursor: pointer;">
                        <div style="font-size: 11px; color: var(--gray); text-align: right;">
                            <span id="avatarZoomValue">100</span>%
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; text-align: left; font-size: 12px; color: var(--gray); margin-bottom: 5px;">–°–º–µ—â–µ–Ω–∏–µ –ø–æ X:</label>
                        <input type="range" id="avatarOffsetX" min="-50" max="50" value="0" style="width: 100%; cursor: pointer;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; text-align: left; font-size: 12px; color: var(--gray); margin-bottom: 5px;">–°–º–µ—â–µ–Ω–∏–µ –ø–æ Y:</label>
                        <input type="range" id="avatarOffsetY" min="-50" max="50" value="0" style="width: 100%; cursor: pointer;">
                    </div>
                    
                    <button class="main-btn" onclick="saveAvatarEdit()" style="width: 100%; margin-bottom: 10px;">‚úÖ –°–û–•–†–ê–ù–ò–¢–¨</button>
                    <button class="main-btn" onclick="closeAvatarEditor()" style="width: 100%; background: #999;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ –≤ –ø–æ–ª–Ω—ã–π —Ä–∞–∑–º–µ—Ä -->
    <input type="hidden" id="photoUrl" value="">
    <div id="photoViewerModal" class="modal" onclick="closePhotoViewer()">
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="event.stopPropagation()">
            <div style="position: relative; max-width: 90vw; max-height: 90vh;">
                <button class="modal-close" onclick="closePhotoViewer()" style="position: absolute; top: -50px; right: 0; font-size: 30px;">‚úï</button>
                <button class="modal-close" onclick="deletePhotoFromChat()" style="position: absolute; top: -50px; right: 40px; font-size: 24px; background: #ff3b30; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 0;" title="–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ">üóëÔ∏è</button>
                <img id="photoViewerImage" src="" style="max-width: 100%; max-height: 90vh; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);" alt="Photo">
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞ -->
    <div id="ratingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">üèÜ –†–µ–π—Ç–∏–Ω–≥ –≤–æ–¥–∏—Ç–µ–ª–µ–π</h2>
                <button class="modal-close" onclick="closeRatingsModal()">‚úï</button>
            </div>
            
            <div style="font-size: 12px; color: var(--gray); margin-bottom: 15px; text-align: center;">
                –í–æ–¥–∏—Ç–µ–ª–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ —Å—É–º–º–µ –ª–∞–π–∫–æ–≤. ‚≠ê = –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å (20+ –ª–∞–π–∫–æ–≤)
            </div>
            
            <div style="max-height: 500px; overflow-y: auto;">
                <div id="ratingsList" style="text-align: center; color: var(--gray);">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</div>
            </div>
            
            <button class="main-btn" onclick="closeRatingsModal()" style="margin-top: 15px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ª–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π -->
    <div id="activityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">üì° –õ–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏–π</h2>
                <button class="modal-close" onclick="closeActivityModal()">‚úï</button>
            </div>
            
            <div style="font-size: 12px; color: var(--gray); margin-bottom: 10px; text-align: center;">
                –†–∞–±–æ—á–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤–æ–¥–∏—Ç–µ–ª–µ–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            </div>
            
            <div id="activityFeed" style="max-height: 450px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 12px; padding: 10px;">
                <div style="text-align: center; color: var(--gray); padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</div>
            </div>
            
            <button class="main-btn" onclick="closeActivityModal()" style="margin-top: 15px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <div class="bottom-ui">
        <div class="action-card" id="actionCard">
            <button class="action-card-close" onclick="toggleActionCard()">‚úï</button>
            <span class="addr-label" id="addr-text">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞...</span>
            <div class="markers-counter" id="markersCounter">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="type-selector">
                <button onclick="setType('dps', this)" class="type-btn active"><div class="icon-circle">üëÆ</div><span>–î–ü–°</span></button>
                <button onclick="setType('patrol', this)" class="type-btn"><div class="icon-circle">üöî</div><span>–†–µ–π–¥</span></button>
                <button onclick="setType('camera', this)" class="type-btn"><div class="icon-circle">üì∏</div><span>–ö–∞–º–µ—Ä–∞</span></button>
                <button onclick="setType('dtp', this)" class="type-btn"><div class="icon-circle">üí•</div><span>–î–¢–ü</span></button>
                <button onclick="setType('works', this)" class="type-btn"><div class="icon-circle">üöß</div><span>–†–∞–±–æ—Ç—ã</span></button>
                <button onclick="setType('sos', this)" class="type-btn"><div class="icon-circle">üÜò</div><span>SOS</span></button>
            </div>
            <input type="text" id="m-comm" style="width:100%; margin-bottom:10px; border-radius:10px; border:1px solid #ddd; padding:8px; box-sizing: border-box;" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
            <button class="main-btn" onclick="addPoint()">–û–¢–ü–†–ê–í–ò–¢–¨</button>
        </div>
    </div>
<script>
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    const SUPABASE_URL = "https://phazbjchjhsruwalddis.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBoYXpiamNoamhzcnV3YWxkZGlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNDcyNjQsImV4cCI6MjA4NTcyMzI2NH0.juQSLL03uRb6ImiCul_UOOE4OwY3mXy-AuItwt2u9ds";
    // Telegram bot username (used to open/start the bot when user is not in Telegram)
    const BOT_USERNAME = 'DPSRADARDPR180bot';
    // –ö–ª–∏–µ–Ω—Ç Supabase –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
    const _sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase —Å —Ç–∞–π–º–∞—É—Ç–æ–º
    async function queryWithTimeout(promise, timeoutMs = 15000) {
        return Promise.race([
            promise,
            new Promise((_, reject) =>
                setTimeout(() => reject(new Error(`Timeout: –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ ${timeoutMs/1000}—Å - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç—å`)), timeoutMs)
            )
        ]);
    }

    // –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç –≤ Telegram (–ø—ã—Ç–∞–µ–º—Å—è —Å–Ω–∞—á–∞–ª–∞ tg://, –∑–∞—Ç–µ–º https://)
    function openTelegramBot() {
        try {
            const tgUrl = `tg://resolve?domain=${BOT_USERNAME}`;
            const webUrl = `https://t.me/${BOT_USERNAME}`;
            // –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–∫—Ä—ã—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
            window.open(tgUrl, '_blank');
            // –ß–µ—Ä–µ–∑ 300ms –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤–µ–±-–≤–∞—Ä–∏–∞–Ω—Ç –∫–∞–∫ fallback
            setTimeout(() => { window.open(webUrl, '_blank'); }, 300);
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å Telegram:', e);
            window.open(`https://t.me/${BOT_USERNAME}`, '_blank');
        }
    }
    
    // –ò–∫–æ–Ω–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –º–∞—Ä–∫–µ—Ä–æ–≤ (–î–ü–°, –†–µ–π–¥, –ö–∞–º–µ—Ä–∞, –î–¢–ü, –†–∞–±–æ—Ç—ã, SOS)
    const MAP_ICONS = { dps: 'üëÆ', patrol: 'üöî', camera: 'üì∏', dtp: 'üí•', works: 'üöß', sos: 'üÜò' };
    // ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram (null –µ—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)
    const rawTgId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
    const uid = rawTgId ? Number(rawTgId) : null;
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç—ã –∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –º–∞—Ä–∫–µ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –î–ü–°)
    let myMap, selectedType = 'dps';
    // –¢–µ–∫—É—â–µ–µ GPS –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let userLocation = null;
    // ID –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è GPS (–¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è)
    let gpsWatchId = null;
    // –ú–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ
    let userLocationMarker = null;
    // –ö–æ–ª–ª–µ–∫—Ü–∏—è –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ (—á—Ç–æ–±—ã –Ω–µ —É–¥–∞–ª—è—Ç—å —Å–ª—É–∂–µ–±–Ω—ã–µ geoObjects –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏)
    let markersCollection = null;
    // –§–ª–∞–≥ –∞–≤—Ç–æ—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è: –µ—Å–ª–∏ true ‚Äî –∫–∞—Ä—Ç–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ GPS
    let autoFollow = true;
    // –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let currentDriver = null;
    // ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π ID Telegram)
    const ADMIN_ID = "5118431735";
    // –ü–æ—Ä–æ–≥ –ª–∞–π–∫–æ–≤ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å"
    const TRUST_LIKES_THRESHOLD = 20; // –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    // –ü–æ—Ä–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π "—É–µ—Ö–∞–ª–∏" –¥–ª—è –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏
    const MARKER_LEAVE_THRESHOLD = 3; // –µ—Å–ª–∏ 3 —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞–∂–∞–ª–∏ "–£–µ—Ö–∞–ª–∏" - –º–µ—Ç–∫–∞ —É–¥–∞–ª—è–µ—Ç—Å—è
    // –§–ª–∞–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    let isAdmin = false;
    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
    let selectedChatPhoto = null;
    // –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É–∂–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –∑–≤—É–∫)
    let notifiedMarkers = new Set();
    // –§–ª–∞–≥ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –Ω–∏–∂–Ω–µ–≥–æ –≤–∏–¥–∂–µ—Ç–∞
    let actionCardVisible = true;
    // –§–ª–∞–≥ –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ—Å—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è GPS –ø–æ—Å–ª–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –º–µ—Ç–∫–∏
    let disableAutoFollowOnce = false;
    // –ö—ç—à –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
    let authorsCache = {};
    let authorsCacheTime = 0;
    const CACHE_DURATION = 300000; // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 5 –º–∏–Ω—É—Ç
    // –¢–∞–π–º–µ—Ä –¥–ª—è –¥–µ–±–∞—É–Ω—Å–∞ loadMarkers
    let loadMarkersTimeout = null;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –Ω–∏–∂–Ω–µ–≥–æ –≤–∏–¥–∂–µ—Ç–∞
    function toggleActionCard() {
        actionCardVisible = !actionCardVisible;
        const card = document.getElementById('actionCard');
        const openBtn = document.getElementById('openActionBtn');
        if (actionCardVisible) {
            card.classList.remove('hidden');
            if (openBtn) openBtn.classList.remove('visible');
        } else {
            card.classList.add('hidden');
            if (openBtn) openBtn.classList.add('visible');
        }
    }

    // –ì—Ä–∞–Ω–∏—Ü—ã –î–æ–Ω–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ –î–ù–† (–ø—Ä–∏–º–µ—Ä–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)
    const DONETSK_REGION = {
        north: 49.2,    // –°–µ–≤–µ—Ä–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
        south: 47.3,    // –Æ–∂–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
        west: 36.4,     // –ó–∞–ø–∞–¥–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
        east: 40.4      // –í–æ—Å—Ç–æ—á–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
    };

    // –î–µ–±–∞—É–Ω—Å —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —á–∞—Å—Ç—ã—Ö –≤—ã–∑–æ–≤–æ–≤
    function debounce(func, delay) {
        let timeoutId;
        return function(...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(this, args), delay);
        };
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–µ–±–∞—É–Ω—Å –¥–ª—è loadMarkers (750ms –≤–º–µ—Å—Ç–æ 500ms)
    const loadMarkersDebounced = debounce(() => loadMarkers(), 750);
    function initGPS() {
        if (!navigator.geolocation) {
            console.warn('Geolocation –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º');
            return;
        }
        
        // –û–ø—Ü–∏–∏ –¥–ª—è geolocation
        const options = {
            enableHighAccuracy: true,
            timeout: 15000,            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: —É–≤–µ–ª–∏—á–∏–ª–∏ —Ç–∞–π–º–∞—É—Ç
            maximumAge: 5000           // –ö—ç—à–∏—Ä—É–µ–º GPS –¥–∞–Ω–Ω—ã–µ –Ω–∞ 5 —Å–µ–∫
        };
        
        // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
        gpsWatchId = navigator.geolocation.watchPosition(
            (position) => {
                // –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                const { latitude, longitude, accuracy } = position.coords;
                userLocation = [latitude, longitude];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ
                updateUserLocationMarker();
                // –ï—Å–ª–∏ –∞–≤—Ç–æ—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ ‚Äî —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (–µ—Å–ª–∏ –Ω–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ –≤—Ä—É—á–Ω—É—é)
                if (autoFollow && myMap && userLocation && !disableAutoFollowOnce) {
                    try { myMap.setCenter(userLocation, 17); } catch (e) { console.warn(e); }
                }
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –æ–¥–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                if (disableAutoFollowOnce) disableAutoFollowOnce = false;
                console.log(`üìç GPS: ${latitude.toFixed(4)}, ${longitude.toFixed(4)} (—Ç–æ—á–Ω–æ—Å—Ç—å: ${accuracy.toFixed(0)}–º)`);
            },
            (error) => {
                // –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                console.warn('–û—à–∏–±–∫–∞ GPS:', error.message);
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        console.warn('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ GPS –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ');
                        break;
                    case error.POSITION_UNAVAILABLE:
                        console.warn('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
                        break;
                    case error.TIMEOUT:
                        console.warn('–ò—Å—Ç–µ–∫–ª–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è GPS');
                        break;
                }
            },
            options
        );
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ
    function updateUserLocationMarker() {
        if (!userLocation || !myMap) return;
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if (userLocationMarker) {
            myMap.geoObjects.remove(userLocationMarker);
        }
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä (—Å–∏–Ω–∏–π –∫—Ä—É–≥ —Å –ø—É–ª—å—Å–∞—Ü–∏–µ–π)
        userLocationMarker = new ymaps.Placemark(userLocation, 
            { 
                hintContent: '–í—ã –∑–¥–µ—Å—å',
                balloonContent: 'üìç –í–∞—à–µ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ'
            },
            {
                iconLayout: 'default#image',
                iconImageHref: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSI4IiBmaWxsPSIjMDA3YWZmIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=',
                iconImageSize: [32, 32],
                iconImageOffset: [-16, -16],
                zIndex: 1000
            }
        );
        
        myMap.geoObjects.add(userLocationMarker);
        
        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ —Ç–µ–∫—É—â–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ (–µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —Ä–∞–∑)
        if (!myMap.lastUserLocationUpdate) {
            myMap.setCenter(userLocation, 17);
            myMap.lastUserLocationUpdate = true;
        }
    }
    
    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç –∫–∞—Ä—Ç—É –Ω–∞ —Ç–µ–∫—É—â–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –∏ –≤–∫–ª—é—á–∞–µ—Ç –∞–≤—Ç–æ—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
    function centerOnMyLocation() {
        if (!userLocation) {
            alert('–ü–æ–∑–∏—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –í–∫–ª—é—á–∏—Ç–µ GPS.');
            return;
        }
        autoFollow = true;
        updateFollowButton();
        try { myMap.setCenter(userLocation, 17); } catch (e) { console.warn(e); }
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Å–ª–µ–∂–µ–Ω–∏—è GPS
    function toggleFollow() {
        autoFollow = !autoFollow;
        updateFollowButton();
        if (autoFollow && userLocation && myMap) {
            try { myMap.setCenter(userLocation, 17); } catch(e) { console.warn(e); }
        }
    }

    function updateFollowButton() {
        const btn = document.getElementById('followToggleBtn');
        if (!btn) return;
        if (autoFollow) {
            btn.classList.remove('inactive');
            btn.classList.add('active');
            btn.title = '–Ø –Ω–∞ –∫–∞—Ä—Ç–µ (–∞–≤—Ç–æ—Å–ª–µ–∂–µ–Ω–∏–µ –í–ö–õ)';
            btn.textContent = 'üëÅÔ∏è';
        } else {
            btn.classList.remove('active');
            btn.classList.add('inactive');
            btn.title = '–Ø –Ω–µ –Ω–∞ –∫–∞—Ä—Ç–µ (–∞–≤—Ç–æ—Å–ª–µ–∂–µ–Ω–∏–µ –í–´–ö–õ)';
            btn.textContent = 'üö´';
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏ (—Ñ–æ—Ä–º—É–ª–∞ –≥–∞–≤–µ—Ä—Å–∏–Ω—É—Å–æ–≤)
    // coords1 –∏ coords2 - –º–∞—Å—Å–∏–≤—ã [—à–∏—Ä–æ—Ç–∞, –¥–æ–ª–≥–æ—Ç–∞]
    // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –º–µ—Ç—Ä–∞—Ö
    function calculateDistance(coords1, coords2) {
        const R = 6371000; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –º–µ—Ç—Ä–∞—Ö
        const lat1 = coords1[0] * Math.PI / 180;
        const lat2 = coords2[0] * Math.PI / 180;
        const deltaLat = (coords2[0] - coords1[0]) * Math.PI / 180;
        const deltaLon = (coords2[1] - coords1[1]) * Math.PI / 180;
        
        const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
                  Math.cos(lat1) * Math.cos(lat2) * Math.sin(deltaLon / 2) * Math.sin(deltaLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function playAlertSound() {
        try {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Web Audio API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Å—Ç–æ–≥–æ –∑–≤—É–∫–∞ "–±–∏–ø"
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800; // –ß–∞—Å—Ç–æ—Ç–∞ –∑–≤—É–∫–∞ –≤ Hz
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏ –∑–≤—É–∫–∞:', e?.message);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –∑–∞–±–∞–Ω–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    async function isUserBanned(userId) {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ bans
            const { data: banned, error } = await _sb.from('bans').select('*').eq('user_id', userId).maybeSingle();
            if (error && error.code !== 'PGRST116') { // PGRST116 - —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –±–∞–Ω—è:', error?.message);
                return { isBanned: false, reason: null };
            }
            return {
                isBanned: banned ? true : false,
                reason: banned?.reason || null
            };
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –±–∞–Ω—è:', e?.message || e);
            return { isBanned: false, reason: null };
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    async function initApp() {
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ Telegram
        const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
        if (!tgUser) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º –æ—Ç–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ Telegram
            const overlay = document.getElementById('tgAuthOverlay');
            if (overlay) overlay.style.display = 'flex';
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–∞–Ω–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        const banInfo = await isUserBanned(uid);
        if (banInfo.isBanned) {
            let banMessage = '‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.';
            if (banInfo.reason) {
                banMessage += `\n\n–ü—Ä–∏—á–∏–Ω–∞: ${banInfo.reason}`;
            }
            alert(banMessage);
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
        isAdmin = String(tgUser.id) === String(ADMIN_ID);
        if (isAdmin) {
            document.getElementById('adminBtn').classList.add('visible');
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–Ω–ª–∞–π–Ω-–±–µ–π–¥–∂ (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
        try { document.getElementById('onlineCountBadge').style.display = 'block'; } catch(e) {}

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏)
        try {
            const { data: driver } = await _sb.from('drivers').select('user_id,name,car_model,car_plate').eq('user_id', uid).maybeSingle();
            if (!driver) {
                // –ï—Å–ª–∏ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ–± –∞–≤—Ç–æ
                document.getElementById('reg-user-name').textContent = (tgUser.first_name || '') + ' ' + (tgUser.last_name || '');
                openRegistrationModal();
            } else {
                // –ï—Å–ª–∏ –¥–∞, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
                currentDriver = driver;
            }
        } catch (e) {
            // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ drivers –ø–∞–¥–∞–µ—Ç –∏–∑-–∑–∞ –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ö–µ–º—ã, –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∂–µ–º —Ñ–æ—Ä–º—É
            console.warn('drivers table read failed:', e.message || e);
            document.getElementById('reg-user-name').textContent = (tgUser.first_name || '') + ' ' + (tgUser.last_name || '');
            openRegistrationModal();
        }

        // –ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª—è—Ç—å last_seen –∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        try {
            await updateLastSeen();
            // heartbeat –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
            setInterval(() => { updateLastSeen().catch(()=>{}); }, 60*1000);
            // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –æ–Ω–ª–∞–π–Ω –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            await loadOnlineCount();
            setInterval(() => { loadOnlineCount().catch(()=>{}); }, 30*1000);
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å heartbeat/online count:', e?.message || e);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –º–∞—Ä–∫–µ—Ä–∞
    // t - —Ç–∏–ø –º–∞—Ä–∫–µ—Ä–∞, el - —ç–ª–µ–º–µ–Ω—Ç –∫–Ω–æ–ø–∫–∏
    function setType(t, el) {
        selectedType = t;
        // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å active —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å active –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–µ
        el.classList.add('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    function openRegistrationModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'hidden';
        document.getElementById('registrationModal').classList.add('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    function closeRegistrationModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        document.getElementById('registrationModal').classList.remove('active');
    }

    // –§—É–Ω–∫—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è (–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ—Ä—É—Ç—Å—è –∏–∑ Telegram)
    async function registerDriver(event) {
        event.preventDefault();

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ Telegram
        const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
        const name = (tgUser?.first_name || '') + ' ' + (tgUser?.last_name || '');
        const car = document.getElementById('driver-car').value;
        const plate = document.getElementById('driver-plate').value;

        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —ç—Ç–∏–º user_id
            const { data: existingDriver } = await queryWithTimeout(
                _sb.from('drivers').select('user_id').eq('user_id', uid).maybeSingle(),
                10000
            );
            
            if (existingDriver) {
                // –ï—Å–ª–∏ –≤–æ–¥–∏—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
                const { error } = await queryWithTimeout(
                    _sb.from('drivers').update({
                        name: name,
                        car_model: car,
                        car_plate: plate
                    }).eq('user_id', uid),
                    10000
                );

                if (!error) {
                    currentDriver = {
                        user_id: uid,
                        name: name,
                        car_model: car,
                        car_plate: plate,
                        votes_up: 0,
                        votes_down: 0,
                        markers_count: 0
                    };
                    closeRegistrationModal();
                    alert('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω, ' + name + '!');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + (error?.message || '–ø–æ–ø—ã—Ç–∞–π—Ç–µ –µ—â–µ —Ä–∞–∑'));
                }
            } else {
                // –ï—Å–ª–∏ –≤–æ–¥–∏—Ç–µ–ª—è –Ω–µ—Ç, –≤—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ
                const { error } = await queryWithTimeout(
                    _sb.from('drivers').insert([{
                        user_id: uid,
                        name: name,
                        car_model: car,
                        car_plate: plate
                    }]),
                    10000
                );

                if (!error) {
                    currentDriver = {
                        user_id: uid,
                        name: name,
                        car_model: car,
                        car_plate: plate,
                        votes_up: 0,
                        votes_down: 0,
                        markers_count: 0
                    };
                    closeRegistrationModal();
                    alert('‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, ' + name + '!');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + (error?.message || '–ø–æ–ø—ã—Ç–∞–π—Ç–µ –µ—â–µ —Ä–∞–∑'));
                }
            }
        } catch (e) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ AbortError –∏ timeout
            if (e?.name === 'AbortError' || e?.message?.includes('AbortError')) {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ç–∏\n\n–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:\n- –í–∫–ª—é—á–µ–Ω–∞ –º–æ–±–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å –∏–ª–∏ Wi-Fi\n- –ï—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            } else if (e?.message?.includes('Timeout')) {
                alert('‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç\n\n–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.');
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:\n\n' + (e?.message || String(e)));
            }
            console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', e);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    async function openProfileModal(viewUserId = null) {
        // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω ID –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–º–æ—Ç—Ä–∏–º –µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—å
        if (viewUserId && String(viewUserId) !== String(uid)) {
            return openOtherUserProfile(viewUserId);
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–æ—Ñ–∏–ª—è
        try {
            const { data: driver } = await _sb.from('drivers').select('user_id,name,car_model,car_plate,avatar_url').eq('user_id', uid).maybeSingle();
            if (driver) currentDriver = driver;
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ drivers:', e?.message || e);
        }

        if (!currentDriver) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ—Ç
            openRegistrationModal();
            return;
        }

        // –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Ç–∞–±–ª–∏—Ü—ã markers
        let marks_count = 0, likes = 0, dislikes = 0;
        try {
            const { data: markers } = await _sb.from('markers').select('votes_up,votes_down').eq('author_id', uid);
            if (markers) {
                marks_count = markers.length;
                markers.forEach(m => {
                    likes += m.votes_up || 0;
                    dislikes += m.votes_down || 0;
                });
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á—ë—Ç–µ –º–∞—Ä–∫–µ—Ä–æ–≤:', e?.message || e);
        }

        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        const displayName = currentDriver.name || ((window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name) || '');
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä (—Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ –µ—Å–ª–∏ –µ—Å—Ç—å)
        const avatarEl = document.getElementById('profile-avatar-display');
        if (currentDriver.avatar_url) {
            avatarEl.style.backgroundImage = `url('${currentDriver.avatar_url}')`;
            avatarEl.style.backgroundSize = 'cover';
            avatarEl.style.backgroundPosition = 'center';
            avatarEl.textContent = '';
            document.getElementById('profile-avatar-url').value = currentDriver.avatar_url;
            document.getElementById('profile-avatar-value').value = '';
        } else {
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º emoji
            avatarEl.style.backgroundImage = 'none';
            avatarEl.textContent = 'üë§';
            document.getElementById('profile-avatar-display').textContent = 'üë§';
            document.getElementById('profile-avatar-value').value = 'üë§';
            document.getElementById('profile-avatar-url').value = '';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        document.getElementById('edit-car-model').value = currentDriver.car_model || '';
        document.getElementById('edit-car-plate').value = currentDriver.car_plate || '';
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º –≤–æ–¥–∏—Ç–µ–ª–µ–º"
        const isTrusted = (likes >= (typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20));
        const profileNameEl = document.getElementById('profile-name-text');
        profileNameEl.textContent = (isTrusted ? '‚≠ê ' : '') + displayName;
        if (isTrusted) profileNameEl.classList.add('trusted'); else profileNameEl.classList.remove('trusted');
        const rating = marks_count ? ((likes - dislikes) / marks_count) : 0;
        document.getElementById('profile-rating').textContent = rating.toFixed(1);
        document.getElementById('profile-marks-count').textContent = marks_count;
        document.getElementById('profile-votes-sum').textContent = (likes + dislikes);
        document.getElementById('profile-likes').textContent = likes;
        document.getElementById('profile-dislikes').textContent = dislikes;
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –¥–æ–≤–µ—Ä–∏—è
        const trustStatusEl = document.getElementById('profile-trust-status');
        if (isTrusted) {
            trustStatusEl.innerHTML = '‚≠ê –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å';
            trustStatusEl.style.color = '#b8860b';
        } else {
            trustStatusEl.innerHTML = `üéØ –û–±—ã—á–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å (${likes}/${typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20} –ª–∞–π–∫–æ–≤)`;
            trustStatusEl.style.color = 'var(--blue)';
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        try {
            const ach = await loadAchievements();
            const profileNameEl = document.getElementById('profile-name-text');
            profileNameEl.title = `–°—Ç–∞—Ç—É—Å: ${ach.title}`;
            
            // –°–æ–∑–¥–∞–µ–º –±–ª–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
            let achievementsHTML = '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">';
            achievementsHTML += `<div style="font-size: 13px; font-weight: 700; margin-bottom: 10px; color: var(--blue);">üèÖ –°—Ç–∞—Ç—É—Å: ${ach.title}</div>`;
            achievementsHTML += '<div style="display: flex; flex-wrap: wrap; gap: 4px;">';
            
            if (ach.achievements.length > 0) {
                ach.achievements.forEach(a => {
                    achievementsHTML += `<div class="achievement" title="${a.desc}"><div class="achievement-icon">${a.icon}</div><div class="achievement-title">${a.title}</div></div>`;
                });
            } else {
                achievementsHTML += '<div style="color: var(--gray); font-size: 11px;">–ù–∞—á–Ω–∏—Ç–µ —Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–∫–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>';
            }
            
            achievementsHTML += '</div></div>';
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –±–ª–æ–∫–æ–º –¥–æ–≤–µ—Ä–∏—è
            const trustBlock = document.getElementById('profile-trust-status').parentElement;
            trustBlock.insertAdjacentHTML('afterend', achievementsHTML);
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π:', e?.message || e);
        }

        // –ü–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ drivers (–µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∏ –µ—Å—Ç—å)
        try {
            await _sb.from('drivers').upsert([
                { user_id: uid, likes_sum: likes, is_trusted: isTrusted }
            ], { onConflict: 'user_id' });
        } catch (e) {
            // –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –∏–ª–∏ –∫–æ–ª–æ–Ω–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ –≤ drivers (–≤–æ–∑–º–æ–∂–Ω–æ, –∫–æ–ª–æ–Ω–∫–∏ likes_sum/is_trusted –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç):', e?.message || e);
        }

        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'hidden';
        document.getElementById('profileModal').classList.add('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    function closeProfileModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
        const avatarDisplay = document.getElementById('profile-avatar-display');
        avatarDisplay.style.cursor = 'pointer';
        avatarDisplay.title = '–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å';
        avatarDisplay.onclick = () => changeAvatar();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
        const uploadPhotoBtn = document.querySelector('button[onclick="document.getElementById(\'profile-photo-input\').click()"]');
        if (uploadPhotoBtn) uploadPhotoBtn.style.display = '';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ
        const carEditForm = document.querySelector('div[style*="border: 1px solid #ddd"]');
        if (carEditForm) carEditForm.style.display = '';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–í–´–ô–¢–ò"
        const logoutBtn = document.querySelector('button[onclick="logout()"]');
        if (logoutBtn) logoutBtn.style.display = '';
        
        // –£–¥–∞–ª—è–µ–º —Å–µ–∫—Ü–∏—é –º–æ–¥–µ—Ä–∞—Ü–∏–∏
        const adminSection = document.getElementById('profile-admin-section');
        if (adminSection) adminSection.remove();
        
        // –£–¥–∞–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        const carInfoEl = document.getElementById('other-user-car-info');
        if (carInfoEl) carInfoEl.remove();
        
        document.getElementById('profileModal').classList.remove('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function openOtherUserProfile(userId) {
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const { data: driver } = await _sb.from('drivers').select('user_id,name,car_model,car_plate,avatar_url').eq('user_id', userId).maybeSingle();
            
            if (!driver) {
                alert('–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }

            // –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            let marks_count = 0, likes = 0, dislikes = 0;
            try {
                const { data: markers } = await _sb.from('markers').select('votes_up,votes_down').eq('author_id', userId);
                if (markers) {
                    marks_count = markers.length;
                    markers.forEach(m => {
                        likes += m.votes_up || 0;
                        dislikes += m.votes_down || 0;
                    });
                }
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á—ë—Ç–µ –º–∞—Ä–∫–µ—Ä–æ–≤:', e?.message || e);
            }

            // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
            document.getElementById('profile-avatar-display').style.cursor = 'default';
            document.getElementById('profile-avatar-display').title = '';
            document.getElementById('profile-avatar-display').onclick = null;
            document.querySelector('button[onclick="document.getElementById(\'profile-photo-input\').click()"]').style.display = 'none';
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ
            const carEditForm = document.querySelector('div[style*="border: 1px solid #ddd"]');
            if (carEditForm) carEditForm.style.display = 'none';

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä
            const avatarEl = document.getElementById('profile-avatar-display');
            if (driver.avatar_url) {
                avatarEl.style.backgroundImage = `url('${driver.avatar_url}')`;
                avatarEl.style.backgroundSize = 'cover';
                avatarEl.style.backgroundPosition = 'center';
                avatarEl.textContent = '';
            } else {
                avatarEl.style.backgroundImage = 'none';
                avatarEl.textContent = 'üë§';
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º –≤–æ–¥–∏—Ç–µ–ª–µ–º"
            const isTrusted = (likes >= (typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20));
            const profileNameEl = document.getElementById('profile-name-text');
            profileNameEl.textContent = (isTrusted ? '‚≠ê ' : '') + (driver.name || '–ê–Ω–æ–Ω–∏–º');
            if (isTrusted) profileNameEl.classList.add('trusted'); else profileNameEl.classList.remove('trusted');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const rating = marks_count ? ((likes - dislikes) / marks_count) : 0;
            document.getElementById('profile-rating').textContent = rating.toFixed(1);
            document.getElementById('profile-marks-count').textContent = marks_count;
            document.getElementById('profile-votes-sum').textContent = (likes + dislikes);
            document.getElementById('profile-likes').textContent = likes;
            document.getElementById('profile-dislikes').textContent = dislikes;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –¥–æ–≤–µ—Ä–∏—è
            const trustStatusEl = document.getElementById('profile-trust-status');
            if (isTrusted) {
                trustStatusEl.innerHTML = '‚≠ê –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å';
                trustStatusEl.style.color = '#b8860b';
            } else {
                const threshold = typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20;
                const remaining = Math.max(0, threshold - likes);
                trustStatusEl.innerHTML = `‚è≥ ${remaining} –ª–∞–π–∫–æ–≤ –¥–æ —Å—Ç–∞—Ç—É—Å–∞`;
                trustStatusEl.style.color = '#999';
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–≤—Ç–æ
            const carInfoHtml = `
                <div style="background: #f9f9f9; border-radius: 12px; padding: 12px; margin-bottom: 15px;">
                    <div style="font-size: 12px; color: var(--gray); margin-bottom: 8px; font-weight: 600;">üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å</div>
                    <div style="font-weight: 700; color: #000; font-size: 15px;">${driver.car_model || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                    <div style="font-size: 13px; color: var(--gray); margin-top: 6px;"><strong>–ù–æ–º–µ—Ä:</strong> ${driver.car_plate || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                </div>
            `;
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ –æ–± –∞–≤—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ
            const statsGrid = document.querySelector('.stats-grid');
            let carInfoEl = document.getElementById('other-user-car-info');
            if (!carInfoEl) {
                carInfoEl = document.createElement('div');
                carInfoEl.id = 'other-user-car-info';
                statsGrid.parentElement.insertBefore(carInfoEl, statsGrid);
            }
            carInfoEl.innerHTML = carInfoHtml;

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–±–∞–Ω–∞ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–∞–º–∏ –≤—ã—Ö–æ–¥–∞
            let adminSection = document.getElementById('profile-admin-section');
            if (adminSection) adminSection.remove();
            
            adminSection = document.createElement('div');
            adminSection.id = 'profile-admin-section';
            
            if (isAdmin) {
                adminSection.innerHTML = `
                    <div class="moderation-section" style="padding-top: 0; border-top: none; margin-bottom: 15px;">
                        <div class="moderation-title">‚öôÔ∏è –ú–æ–¥–µ—Ä–∞—Ü–∏—è</div>
                        <div class="moderation-buttons">
                            <button class="mod-btn mod-btn-temp" onclick="moderateUserFromProfile(${userId}, '${(driver.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å').replace(/'/g, "\\'")}', 'temp')">
                                <span style="font-size: 18px;">‚è±Ô∏è</span>
                                –í—Ä–µ–º–µ–Ω–Ω—ã–π –±–∞–Ω
                            </button>
                            
                            <button class="mod-btn mod-btn-perm" onclick="moderateUserFromProfile(${userId}, '${(driver.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å').replace(/'/g, "\\'")}', 'permanent')">
                                <span style="font-size: 18px;">üö´</span>
                                –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –±–∞–Ω
                            </button>
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 8px;">
                            <button class="main-btn" style="background: #666; flex: 1; font-size: 11px; padding: 10px;" onclick="deleteAllUserMarkers(${userId}, '${(driver.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å').replace(/'/g, "\\'")}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫–∏</button>
                            <button class="main-btn" style="background: #666; flex: 1; font-size: 11px; padding: 10px;" onclick="deleteAllUserMessages(${userId}, '${(driver.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å').replace(/'/g, "\\'")}')">üí¨ –£–¥–∞–ª–∏—Ç—å —á–∞—Ç</button>
                        </div>
                    </div>
                `;
            } else {
                adminSection.innerHTML = `
                    <div style="padding-top: 15px; border-top: 1px solid #ddd; margin-bottom: 15px;">
                        <button class="main-btn" style="background: #ff9500; font-size: 12px;" onclick="reportUser(${userId}, '${(driver.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å').replace(/'/g, "\\'")}', '–ø—Ä–æ—Ñ–∏–ª—å', '')">‚ö†Ô∏è –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</button>
                    </div>
                `;
            }

            // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π "–í–´–ô–¢–ò"
            const logoutBtn = document.querySelector('button[onclick="logout()"]');
            logoutBtn.parentElement.insertBefore(adminSection, logoutBtn);

            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–í–´–ô–¢–ò"
            logoutBtn.style.display = 'none';

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è
            const target = document.querySelector('.target');
            if (target) target.style.visibility = 'hidden';
            document.getElementById('profileModal').classList.add('active');

        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e?.message || e);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è: ' + (e?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    }    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∞ —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º –≤–æ–¥–∏—Ç–µ–ª–µ–π
    async function openRatingsModal() {
        const ratingsList = document.getElementById('ratingsList');
        ratingsList.innerHTML = '<div style="color: var(--gray);">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</div>';
        
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π
            const { data: drivers } = await _sb.from('drivers').select('user_id,name,car_model,car_plate,likes_sum,is_trusted');
            
            if (!drivers || drivers.length === 0) {
                ratingsList.innerHTML = '<div style="color: var(--gray); padding: 20px;">–í–æ–¥–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                const target = document.querySelector('.target');
                if (target) target.style.visibility = 'hidden';
                document.getElementById('ratingsModal').classList.add('active');
                return;
            }
            
            // –°—á–∏—Ç–∞–µ–º –ª–∞–π–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è (–µ—Å–ª–∏ likes_sum –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
            let driverStats = [];
            for (const d of drivers) {
                let likesSum = d.likes_sum || 0;
                let isTrusted = d.is_trusted || false;
                
                // –ï—Å–ª–∏ likes_sum –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω, —Å—á–∏—Ç–∞–µ–º –∏–∑ markers
                if (!d.likes_sum) {
                    const { data: markers } = await _sb.from('markers').select('votes_up').eq('author_id', d.user_id);
                    if (markers) {
                        likesSum = markers.reduce((sum, m) => sum + (m.votes_up || 0), 0);
                    }
                    isTrusted = likesSum >= (typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20);
                }
                
                driverStats.push({
                    user_id: d.user_id,
                    name: d.name || '–ê–Ω–æ–Ω–∏–º',
                    car_model: d.car_model || 'N/A',
                    likes: likesSum,
                    is_trusted: isTrusted
                });
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ª–∞–π–∫–∞–º (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
            driverStats.sort((a, b) => b.likes - a.likes);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML
            let html = '';
            driverStats.forEach((driver, idx) => {
                const medal = idx === 0 ? 'ü•á' : (idx === 1 ? 'ü•à' : (idx === 2 ? 'ü•â' : ''));
                const trustBadge = driver.is_trusted ? ' ‚≠ê' : '';
                html += `
                    <div style="padding: 12px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f9f9f9'; this.style.transform='translateX(4px)'" onmouseout="this.style.background=''; this.style.transform='translateX(0)'" onclick="openProfileModal(${driver.user_id}); closeRatingsModal();">
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: #000; font-size: 14px;">${medal} ${driver.name}${trustBadge}</div>
                            <div style="font-size: 11px; color: var(--gray);">${driver.car_model}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 800; color: var(--blue); font-size: 16px;">${driver.likes}</div>
                            <div style="font-size: 11px; color: var(--gray);">–ª–∞–π–∫–æ–≤</div>
                        </div>
                    </div>
                `;
            });
            
            ratingsList.innerHTML = html;
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ–π—Ç–∏–Ω–≥–∞:', e?.message || e);
            ratingsList.innerHTML = '<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞</div>';
        }
        
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'hidden';
        document.getElementById('ratingsModal').classList.add('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞
    function closeRatingsModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        document.getElementById('ratingsModal').classList.remove('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ
    function openPhotoViewer(photoUrl) {
        document.getElementById('photoViewerImage').src = photoUrl;
        document.getElementById('photoUrl').value = photoUrl;
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'hidden';
        document.getElementById('photoViewerModal').classList.add('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ
    function closePhotoViewer() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        document.getElementById('photoViewerModal').classList.remove('active');
    }
    
    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ –∏–∑ —á–∞—Ç–∞
    async function deletePhotoFromChat() {
        const photoUrl = document.getElementById('photoUrl')?.value;
        if (!photoUrl) {
            alert('–§–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            return;
        }
        
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Ñ–æ—Ç–æ?')) return;
        
        try {
            // –ù–∞–π—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —ç—Ç–∏–º —Ñ–æ—Ç–æ –∏ —É–¥–∞–ª–∏—Ç—å –µ–≥–æ
            const { data: messages } = await _sb.from('messages').select('id, author_id').eq('photo_url', photoUrl);
            
            if (!messages || messages.length === 0) {
                alert('–°–æ–æ–±—â–µ–Ω–∏–µ —Å —ç—Ç–∏–º —Ñ–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                return;
            }
            
            const msg = messages[0];
            const isOwnMessage = msg.author_id === uid;
            const isAdminDeleting = isAdmin && msg.author_id !== uid;
            
            if (!isOwnMessage && !isAdminDeleting) {
                alert('–í—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ñ–æ—Ç–æ');
                return;
            }
            
            // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ñ–æ—Ç–æ
            const { error } = await _sb.from('messages').delete().eq('id', msg.id);
            if (error) {
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                return;
            }
            
            alert('‚úÖ –§–æ—Ç–æ –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω—ã');
            closePhotoViewer();
            await loadChatMessages();
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ:', e);
            alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
    function logout() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
            currentDriver = null;
            closeProfileModal();
            openRegistrationModal();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞ (—Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ, emoji –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±–µ–∑ –∫–æ–ª–æ–Ω–∫–∏ avatar)
    async function changeAvatar() {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ñ–æ—Ç–æ
        document.getElementById('profile-photo-input').click();
    }

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∞
    let avatarEditorState = {
        fileBlob: null,
        zoom: 1,
        offsetX: 0,
        offsetY: 0
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –∞–≤–∞—Ç–∞—Ä–∞
    document.addEventListener('change', async function(e) {
        if (e.target.id === 'profile-photo-input') {
            const file = e.target.files[0];
            if (file) {
                try {
                    // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ Data URL –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –∞–≤–∞—Ç–∞—Ä–∞
                        const img = document.getElementById('avatarEditorImage');
                        img.src = event.target.result;
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º blob —Ñ–∞–π–ª–∞
                        avatarEditorState.fileBlob = file;
                        avatarEditorState.zoom = 1;
                        avatarEditorState.offsetX = 0;
                        avatarEditorState.offsetY = 0;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã
                        document.getElementById('avatarZoom').value = 1;
                        document.getElementById('avatarZoomValue').textContent = '100';
                        document.getElementById('avatarOffsetX').value = 0;
                        document.getElementById('avatarOffsetY').value = 0;
                        
                        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
                        const target = document.querySelector('.target');
                        if (target) target.style.visibility = 'hidden';
                        document.getElementById('avatarEditorModal').classList.add('active');
                    };
                    reader.readAsDataURL(file);
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–∞–π–ª–∞: ' + (err?.message || err));
                }
                e.target.value = ''; // –æ—á–∏—â–∞–µ–º input
            }
        }
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ zoom
    document.getElementById('avatarZoom')?.addEventListener('input', function(e) {
        avatarEditorState.zoom = parseFloat(e.target.value);
        document.getElementById('avatarZoomValue').textContent = Math.round(avatarEditorState.zoom * 100);
        updateAvatarEditorPreview();
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ offsetX
    document.getElementById('avatarOffsetX')?.addEventListener('input', function(e) {
        avatarEditorState.offsetX = parseFloat(e.target.value);
        updateAvatarEditorPreview();
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ offsetY
    document.getElementById('avatarOffsetY')?.addEventListener('input', function(e) {
        avatarEditorState.offsetY = parseFloat(e.target.value);
        updateAvatarEditorPreview();
    });

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–≤—å—é –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
    function updateAvatarEditorPreview() {
        const img = document.getElementById('avatarEditorImage');
        if (img) {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
            const scalePercent = avatarEditorState.zoom;
            const offsetXPercent = avatarEditorState.offsetX;
            const offsetYPercent = avatarEditorState.offsetY;
            
            img.style.transform = `scale(${scalePercent}) translate(${offsetXPercent}px, ${offsetYPercent}px)`;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∞
    function closeAvatarEditor() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        document.getElementById('avatarEditorModal').classList.remove('active');
        avatarEditorState = {
            fileBlob: null,
            zoom: 1,
            offsetX: 0,
            offsetY: 0
        };
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞
    async function saveAvatarEdit() {
        try {
            if (!avatarEditorState.fileBlob) {
                alert('–û—à–∏–±–∫–∞: —Ñ–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –≤—ã—Ä–µ–∑–∞–Ω–∏—è –∫—Ä—É–≥–ª–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 400;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const img = new Image();
            img.onload = async function() {
                // –û—á–∏—â–∞–µ–º canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // –†–∏—Å—É–µ–º –∫—Ä—É–≥–ª—É—é –º–∞—Å–∫—É
                ctx.beginPath();
                ctx.arc(200, 200, 200, 0, Math.PI * 2);
                ctx.clip();

                // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–º–µ—â–µ–Ω–∏–µ
                const scaleFactor = avatarEditorState.zoom;
                const offsetX = (canvas.width / 2) + (avatarEditorState.offsetX * 2);
                const offsetY = (canvas.height / 2) + (avatarEditorState.offsetY * 2);

                // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                ctx.drawImage(
                    img,
                    offsetX - (img.width / 2) * scaleFactor,
                    offsetY - (img.height / 2) * scaleFactor,
                    img.width * scaleFactor,
                    img.height * scaleFactor
                );

                // –ü–æ–ª—É—á–∞–µ–º blob –∏–∑ canvas
                canvas.toBlob((blob) => {
                    try {
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º blob –≤ Base64
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const base64 = event.target.result; // data:image/jpeg;base64,...

                            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ñ–æ—Ç–æ –∫–∞–∫ –∞–≤–∞—Ç–∞—Ä
                            const avatarEl = document.getElementById('profile-avatar-display');
                            avatarEl.style.backgroundImage = `url('${base64}')`;
                            avatarEl.style.backgroundSize = 'cover';
                            avatarEl.style.backgroundPosition = 'center';
                            avatarEl.textContent = '';

                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º Base64 –≤ –ø–æ–ª–µ
                            document.getElementById('profile-avatar-url').value = base64;
                            document.getElementById('profile-avatar-value').value = '';

                            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
                            closeAvatarEditor();
                            alert('‚úÖ –ê–≤–∞—Ç–∞—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                        };
                        reader.readAsDataURL(blob);
                    } catch (err) {
                        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (err?.message || err));
                    }
                }, 'image/jpeg', 0.9);
            };

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            img.src = document.getElementById('avatarEditorImage').src;
        } catch (err) {
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (err?.message || err));
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ—Ñ–∏–ª—è
    async function saveProfileChanges() {
        const carModel = document.getElementById('edit-car-model').value.trim() || (currentDriver?.car_model || '');
        const carPlate = document.getElementById('edit-car-plate').value.trim() || (currentDriver?.car_plate || '');

        try {
            const updateData = {
                car_model: carModel,
                car_plate: carPlate
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –∞–≤–∞—Ç–∞—Ä–∞ —Ñ–æ—Ç–æ –µ—Å–ª–∏ –µ—Å—Ç—å (avatar_url –∫–æ–ª–æ–Ω–∫–∞)
            const avatarUrl = document.getElementById('profile-avatar-url').value;
            if (avatarUrl) {
                updateData.avatar_url = avatarUrl;
            }

            // –í—ã–ø–æ–ª–Ω—è–µ–º update —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ schema cache
            let result = await _sb.from('drivers').update(updateData).eq('user_id', uid);
            let error = result.error;

            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å–æ schema cache, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –±–µ–∑ avatar_url
            if (error && error.message && error.message.includes('avatar')) {
                console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ avatar_url, –ø—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–µ–∑ –Ω–µ–≥–æ:', error.message);
                const updateDataWithoutAvatar = {
                    car_model: carModel,
                    car_plate: carPlate
                };
                result = await _sb.from('drivers').update(updateDataWithoutAvatar).eq('user_id', uid);
                error = result.error;
            }

            if (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                return;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            currentDriver.car_model = carModel;
            currentDriver.car_plate = carPlate;
            if (avatarUrl) {
                currentDriver.avatar_url = avatarUrl;
            }

            alert('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            await openProfileModal();
        } catch (e) {
            alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
        }
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    let adminAllDrivers = [];
    let adminBannedIds = new Set();
    let adminLikesMap = {};
    let adminAllMarkers = [];

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    async function openAdminModal() {
        if (!isAdmin) {
            alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏');
            return;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π
        try {
            const { data: drivers } = await _sb.from('drivers').select('user_id,name,car_model,car_plate');
            adminAllDrivers = drivers || [];
            const tbody = document.getElementById('admin-drivers-body');
            tbody.innerHTML = '';
            if (adminAllDrivers && adminAllDrivers.length > 0) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–±–∞–Ω–Ω–µ–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                adminBannedIds = new Set();
                try {
                    const { data: bans } = await _sb.from('bans').select('user_id');
                    if (bans) {
                        bans.forEach(b => adminBannedIds.add(b.user_id.toString()));
                    }
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –±–∞–Ω–æ–≤ (–≤–æ–∑–º–æ–∂–Ω–æ, —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç):', e?.message);
                }
                
                // –°–æ–±–µ—Ä–µ–º —Å–ø–∏—Å–æ–∫ ID –≤–æ–¥–∏—Ç–µ–ª–µ–π –∏ –ø–æ–¥—Å—á–∏—Ç–∞–µ–º –ª–∞–π–∫–∏ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
                const driverIds = adminAllDrivers.map(d => d.user_id.toString());
                adminLikesMap = {};
                try {
                    const { data: likesRows } = await _sb.from('markers').select('author_id,votes_up').in('author_id', driverIds);
                    if (likesRows) {
                        likesRows.forEach(r => {
                            const id = r.author_id.toString();
                            adminLikesMap[id] = (adminLikesMap[id] || 0) + (r.votes_up || 0);
                        });
                    }
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–∞–π–∫–∏ –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π:', e?.message || e);
                }

                // –†–µ–Ω–¥–µ—Ä–∏–º –≤—Å–µ –≤–æ–¥–∏—Ç–µ–ª–µ–π –≤ —Ç–∞–±–ª–∏—Ü—É
                renderDriversTable(adminAllDrivers);
                document.getElementById('admin-drivers-count').textContent = adminAllDrivers.length;
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--gray);">–í–æ–¥–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–æ–¥–∏—Ç–µ–ª–µ–π:', e?.message || e);
            document.getElementById('admin-drivers-body').innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
        try {
            const { data: markers } = await _sb.from('markers').select('*');
            const now = Date.now();
            adminAllMarkers = (markers || []).filter(m => {
                if (m.exp === null || typeof m.exp === 'undefined') return true;
                if (typeof m.exp === 'number') return m.exp > now;
                const parsed = Date.parse(m.exp);
                return !isNaN(parsed) ? parsed > now : true;
            });
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –≤—Å–µ –º–µ—Ç–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü—É
            renderMarkersTable(adminAllMarkers);
            document.getElementById('admin-markers-count').textContent = adminAllMarkers.length;
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞—Ä–∫–µ—Ä–æ–≤:', e?.message || e);
            document.getElementById('admin-markers-body').innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        const searchInput = document.getElementById('driverSearchInput');
        if (searchInput) {
            searchInput.value = '';
            searchInput.addEventListener('keyup', filterDriversTable);
        }

        const typeFilter = document.getElementById('markerTypeFilter');
        if (typeFilter) {
            typeFilter.value = '';
            typeFilter.addEventListener('change', filterMarkersTable);
        }

        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'hidden';
        document.getElementById('adminModal').classList.add('active');
        await loadUnbanRequests();
    }

    // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ç–∞–±–ª–∏—Ü—ã –≤–æ–¥–∏—Ç–µ–ª–µ–π
    function renderDriversTable(drivers) {
        const tbody = document.getElementById('admin-drivers-body');
        tbody.innerHTML = '';
        
        if (!drivers || drivers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--gray);">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>';
            return;
        }

        drivers.forEach(d => {
            const isBanned = adminBannedIds.has(d.user_id.toString());
            const statusBadge = isBanned ? 'üö´ –ó–ê–ë–ê–ù' : '‚úÖ';
            const statusStyle = isBanned ? 'background: #ff3b30; color: white;' : '';
            const likes = adminLikesMap[d.user_id.toString()] || 0;
            const isTrustedDriver = likes >= (typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20);
            const nameCell = `${isTrustedDriver ? '‚≠ê ' : ''}${d.name || 'N/A'}`;
            const row = `<tr style="${statusStyle}">
                <td>${nameCell}</td>
                <td>${d.car_model || 'N/A'}</td>
                <td>${d.car_plate || 'N/A'}</td>
                <td>${statusBadge}</td>
                <td style="display: flex; gap: 5px;">
                    <button class="delete-btn" onclick="deleteDriver('${d.user_id}')">–£–¥–∞–ª–∏—Ç—å</button>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ä–∫–µ—Ä–æ–≤
    function renderMarkersTable(markers) {
        const tbody = document.getElementById('admin-markers-body');
        tbody.innerHTML = '';
        
        if (!markers || markers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--gray);">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>';
            return;
        }

        markers.forEach(m => {
            // format existing exp to local datetime-local value if possible
            let expVal = '';
            if (m.exp) {
                try {
                    const parsed = (typeof m.exp === 'number') ? new Date(Number(m.exp)) : new Date(m.exp);
                    if (!isNaN(parsed)) {
                        const pad = n => n.toString().padStart(2, '0');
                        const y = parsed.getFullYear();
                        const mo = pad(parsed.getMonth() + 1);
                        const d = pad(parsed.getDate());
                        const hh = pad(parsed.getHours());
                        const mm = pad(parsed.getMinutes());
                        expVal = `${y}-${mo}-${d}T${hh}:${mm}`;
                    }
                } catch (e) { expVal = ''; }
            }

            let readableExp = '';
            if (m.exp) {
                try {
                    const parsedExp = (typeof m.exp === 'number') ? new Date(Number(m.exp)) : new Date(m.exp);
                    if (!isNaN(parsedExp)) {
                        readableExp = parsedExp.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                    }
                } catch (e) { readableExp = ''; }
            }

            const row = `<tr>
                <td>${MAP_ICONS[m.type] || '?'}</td>
                <td>${m.comment || '–±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}</td>
                <td>${m.votes_up || 0}</td>
                <td>${m.votes_down || 0}</td>
                <td style="width:260px;">
                    <input type="datetime-local" id="marker-exp-${m.id}" value="${expVal}" style="width:140px; padding:6px; border-radius:6px; border:1px solid #ddd;">
                    <button class="delete-btn" style="margin-left:6px;" onclick="setMarkerExpiry(${m.id})">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                    <button class="delete-btn" style="margin-left:6px; background:#999;" onclick="clearMarkerExpiry(${m.id})">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    <div style="font-size:12px; color: var(--gray); margin-top:6px;">${readableExp ? readableExp : ''}</div>
                </td>
                <td><button class="delete-btn" onclick="deleteMarkerAdmin(${m.id})">–£–¥–∞–ª–∏—Ç—å</button></td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–π
    function filterDriversTable() {
        const searchInput = document.getElementById('driverSearchInput');
        const query = searchInput.value.toLowerCase().trim();
        
        if (!query) {
            // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ—Ö
            renderDriversTable(adminAllDrivers);
            return;
        }

        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ ID
        const filtered = adminAllDrivers.filter(d => {
            const name = (d.name || '').toLowerCase();
            const id = String(d.user_id).toLowerCase();
            return name.includes(query) || id.includes(query);
        });

        renderDriversTable(filtered);
    }

    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –º–∞—Ä–∫–µ—Ä–æ–≤ –ø–æ —Ç–∏–ø—É
    function filterMarkersTable() {
        const typeFilter = document.getElementById('markerTypeFilter');
        const selectedType = typeFilter.value;
        
        if (!selectedType) {
            // –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä –ø—É—Å—Ç–æ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
            renderMarkersTable(adminAllMarkers);
            return;
        }

        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–∏–ø—É
        const filtered = adminAllMarkers.filter(m => m.type === selectedType);
        renderMarkersTable(filtered);
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –ø–æ–∏—Å–∫–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–π
    function clearDriverSearch() {
        const searchInput = document.getElementById('driverSearchInput');
        searchInput.value = '';
        renderDriversTable(adminAllDrivers);
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –º–∞—Ä–∫–µ—Ä–æ–≤
    function clearMarkerFilter() {
        const typeFilter = document.getElementById('markerTypeFilter');
        typeFilter.value = '';
        renderMarkersTable(adminAllMarkers);
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    function closeAdminModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        document.getElementById('adminModal').classList.remove('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –º–µ—Ç–∫–∏
    async function setMarkerExpiry(markerId) {
        if (!isAdmin) {
            alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
            return;
        }

        const input = document.getElementById(`marker-exp-${markerId}`);
        if (!input) return alert('–ü–æ–ª–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');

        const val = input.value; // format: YYYY-MM-DDTHH:MM
        if (!val) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è');

        try {
            const ts = new Date(val);
            if (isNaN(ts)) return alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏');

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º ISO-—Å—Ç—Ä–æ–∫—É (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç), —á—Ç–æ–±—ã —Ö—Ä–∞–Ω–∏—Ç—å —á–∏—Ç–∞–µ–º—É—é –¥–∞—Ç—É
            const expValue = ts.toISOString();

            const { error } = await _sb.from('markers').update({ exp: expValue }).eq('id', markerId);
            if (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≤—Ä–µ–º–µ–Ω–∏: ' + (error?.message || error));
                return;
            }

            alert('–í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            await openAdminModal();
        } catch (e) {
            alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: –æ—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –º–µ—Ç–∫–∏
    async function clearMarkerExpiry(markerId) {
        if (!isAdmin) {
            alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
            return;
        }
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å—Ä–æ–∫ –∏—Å—Ç–µ—á–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π –º–µ—Ç–∫–∏?')) return;
        try {
            const { error } = await _sb.from('markers').update({ exp: null }).eq('id', markerId);
            if (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ: ' + (error?.message || error));
                return;
            }
            alert('–°—Ä–æ–∫ –∏—Å—Ç–µ—á–µ–Ω–∏—è —É–¥–∞–ª—ë–Ω');
            await openAdminModal();
        } catch (e) {
            alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
        }
    }







    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—è (–∞–¥–º–∏–Ω)
    async function deleteDriver(driverId) {
        if (!isAdmin) {
            alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
            return;
        }

        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —Ç–∞–∫–∂–µ —É–¥–∞–ª–∏—Ç –≤—Å–µ –º–µ—Ç–∫–∏ —ç—Ç–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è')) {
            try {
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ –º–µ—Ç–∫–∏ –≤–æ–¥–∏—Ç–µ–ª—è
                await _sb.from('markers').delete().eq('author_id', driverId);
                // –£–¥–∞–ª—è–µ–º –≤–æ–¥–∏—Ç–µ–ª—è
                await _sb.from('drivers').delete().eq('user_id', driverId);
                // –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å –∏–∑ –±–∞–Ω–∞ (–µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
                try {
                    await _sb.from('bans').delete().eq('user_id', driverId);
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ bans (–≤–æ–∑–º–æ–∂–Ω–æ, —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç):', e?.message);
                }
                alert('–í–æ–¥–∏—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
                openAdminModal(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + (e?.message || e));
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ (–∞–¥–º–∏–Ω)
    async function deleteMarkerAdmin(markerId) {
        if (!isAdmin) {
            alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
            return;
        }

        if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–µ—Ç–∫—É?')) {
            try {
                await _sb.from('markers').delete().eq('id', markerId);
                alert('–ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
                openAdminModal(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                loadMarkers(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + (e?.message || e));
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞
    async function openChatModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'hidden';
        
        if (!currentDriver) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é');
            openRegistrationModal();
            return;
        }

        document.getElementById('chatModal').classList.add('active');
        await loadChatMessages();
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        chatUpdateInterval = setInterval(loadChatMessages, 5000);
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
    function showChatContextMenu(event, message, userId, userName) {
        event.stopPropagation();
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –º–µ–Ω—é –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        const oldMenu = document.querySelector('.chat-context-menu');
        if (oldMenu) oldMenu.remove();
        
        // –°–æ–∑–¥–∞—ë–º –º–µ–Ω—é
        const menu = document.createElement('div');
        menu.className = 'chat-context-menu';
        menu.style.left = event.pageX + 'px';
        menu.style.top = event.pageY + 'px';
        
        // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏–ª–∏ –∞–¥–º–∏–Ω–∞)
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'chat-context-menu-item delete';
        deleteBtn.innerHTML = '‚ùå –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ';
        deleteBtn.onclick = () => {
            deleteMessage(message.id, userId);
            menu.remove();
        };
        menu.appendChild(deleteBtn);
        
        // –ö–Ω–æ–ø–∫–∞ –∂–∞–ª–æ–±—ã –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const reportBtn = document.createElement('button');
        reportBtn.className = 'chat-context-menu-item report';
        reportBtn.innerHTML = '‚ö†Ô∏è –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è';
        reportBtn.onclick = () => {
            reportUser(userId, userName, '—Å–æ–æ–±—â–µ–Ω–∏–µ', message.text);
            menu.remove();
        };
        menu.appendChild(reportBtn);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –º–µ–Ω—é –≤ –¥–æ–∫—É–º–µ–Ω—Ç
        document.body.appendChild(menu);
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        setTimeout(() => {
            document.addEventListener('click', function closeMenu(e) {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            });
        }, 0);
    }

    function closeChatModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        
        document.getElementById('chatModal').classList.remove('active');
        if (chatUpdateInterval) clearInterval(chatUpdateInterval);
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    async function deleteMessage(messageId, authorId) {
        try {
            const msgId = parseInt(messageId);
            const authId = parseInt(authorId);
            
            const isOwnMessage = authId === uid;
            const isAdminDeleting = isAdmin && authId !== uid;
            
            if (!isOwnMessage && !isAdminDeleting) {
                alert('–í—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }
            
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;
            
            const { error } = await _sb.from('messages').delete().eq('id', msgId);
            if (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                return;
            }
            console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ:', msgId);
            await loadChatMessages();
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', e);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (e?.message || e));
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)
    async function deleteAllUserMessages(userId, userName) {
        if (!isAdmin) {
            alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            return;
        }
        
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) return;
        
        try {
            const { error } = await _sb.from('messages').delete().eq('author_id', userId);
            if (error) {
                alert('–û—à–∏–±–∫–∞: ' + (error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                return;
            }
            alert('‚úÖ –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª–µ–Ω—ã');
            await loadChatMessages();
        } catch (e) {
            alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∂–∞–ª–æ–±—ã –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function reportUser(userId, userName, reportType = '—Å–æ–æ–±—â–µ–Ω–∏–µ', content = '') {
        if (!uid) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ Telegram');
            const overlay = document.getElementById('tgAuthOverlay'); if (overlay) overlay.style.display = 'flex';
            return;
        }
        if (!currentDriver) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ Telegram –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∂–∞–ª–æ–±—ã');
            openRegistrationModal();
            return;
        }

        const reason = prompt(`–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}"?\n\n–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∂–∞–ª–æ–±—ã:\n\n–ü—Ä–∏–º–µ—Ä—ã: "–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è", "–°–ø–∞–º", "–õ–æ–∂–Ω—ã–µ –º–µ—Ç–∫–∏", "–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ"`, '');
        
        if (reason === null) return; // –û—Ç–º–µ–Ω–∞
        if (!reason.trim()) return alert('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∂–∞–ª–æ–±—ã');
        
        try {
            // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø–∏—Å–∞—Ç—å –∂–∞–ª–æ–±—É –≤ —Ç–∞–±–ª–∏—Ü—É reports
            const reportData = {
                reporter_id: uid,
                reported_user_id: userId,
                reported_user_name: userName,
                report_type: reportType,
                reason: reason.trim(),
                content: content,
                status: 'new',
                created_at: new Date().toISOString()
            };
            
            const { error: reportError } = await _sb.from('reports').insert([reportData]);
            
            if (reportError) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É reports:', reportError);
                
                // –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –∏–ª–∏ –ª–æ–≥–∏—Ä—É–µ–º
                if (reportError.message && reportError.message.includes('reports')) {
                    console.warn('–¢–∞–±–ª–∏—Ü–∞ reports –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–æ–ø—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ messages...');
                    
                    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
                    const adminMessage = {
                        author_id: -1,
                        author_name: 'üö® –ê–î–ú–ò–ù –ê–õ–ï–†–¢',
                        text: `üìã –ñ–ê–õ–û–ë–ê: ${reason.trim()}\nüë§ –ù–∞: ${userName} (ID: ${userId})\nüìù –¢–∏–ø: ${reportType}\nüìå –û—Ç: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è`,
                        created_at: new Date().toISOString()
                    };
                    
                    const { error: msgError } = await _sb.from('messages').insert([adminMessage]);
                    
                    if (msgError) {
                        alert('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∂–∞–ª–æ–±—ã: ' + (msgError?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π –∂–∞–ª–æ–±—ã:', msgError);
                        return;
                    }
                }
            }
            
            alert('‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ! –í–∞—à–∞ –∂–∞–ª–æ–±–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.');
            console.log('‚úÖ –ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞:', reportData);
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∂–∞–ª–æ–±—ã:', e);
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∂–∞–ª–æ–±—ã: ' + (e?.message || e));
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –±—ã—Å—Ç—Ä–æ–≥–æ –º–µ–Ω—é –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞ (–æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º –Ω–∞ —é–∑–µ—Ä–∞)
    async function showUserModeratorMenu(userId, userName, event) {
        if (!isAdmin) {
            reportUser(userId, userName, '—Å–æ–æ–±—â–µ–Ω–∏–µ', '');
            return;
        }

        // –ó–∞—â–∏—Ç–∞ –æ—Ç undefined event
        if (!event) {
            event = { pageX: window.innerWidth / 2, pageY: window.innerHeight / 2, stopPropagation: () => {} };
        }

        if (event.stopPropagation) {
            event.stopPropagation();
        }

        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –º–µ–Ω—é –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        const oldMenu = document.querySelector('.moderator-menu');
        if (oldMenu) oldMenu.remove();

        // –°–æ–∑–¥–∞—ë–º –º–µ–Ω—é
        const menu = document.createElement('div');
        menu.className = 'moderator-menu';
        menu.style.cssText = `
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 3000;
            border: 2px solid #ff9500;
            overflow: hidden;
        `;
        menu.style.left = (event.pageX || window.innerWidth / 2) + 'px';
        menu.style.top = (event.pageY || window.innerHeight / 2) + 'px';

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
        const createMenuBtn = (text, color, callback) => {
            const btn = document.createElement('button');
            btn.style.cssText = `
                display: block;
                width: 100%;
                border: none;
                padding: 10px 15px;
                text-align: left;
                cursor: pointer;
                background: white;
                color: ${color};
                font-weight: 600;
                border-bottom: 1px solid #eee;
                font-size: 13px;
            `;
            btn.innerHTML = text;
            btn.onmouseover = () => btn.style.background = '#f9f9f9';
            btn.onmouseout = () => btn.style.background = 'white';
            btn.onclick = callback;
            return btn;
        };

        // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        menu.appendChild(createMenuBtn('üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è', '#ff3b30', () => {
            deleteAllUserMessages(userId, userName);
            menu.remove();
        }));

        // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –º–µ—Ç–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        menu.appendChild(createMenuBtn('üìç –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–µ—Ç–∫–∏', '#ff9500', () => {
            deleteAllUserMarkers(userId, userName);
            menu.remove();
        }));

        // –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∂–∞–ª–æ–±—ã
        menu.appendChild(createMenuBtn('‚ö†Ô∏è –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è', '#007aff', () => {
            reportUser(userId, userName, '—Å–æ–æ–±—â–µ–Ω–∏–µ', '');
            menu.remove();
        }));

        // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è
        menu.appendChild(createMenuBtn('üë§ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å', '#34c759', () => {
            // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è
            alert('–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ–∫–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞');
            menu.remove();
        }));

        // –î–æ–±–∞–≤–ª—è–µ–º –º–µ–Ω—é –≤ –¥–æ–∫—É–º–µ–Ω—Ç
        document.body.appendChild(menu);

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        setTimeout(() => {
            document.addEventListener('click', function closeMenu(e) {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            });
        }, 0);
    }

    // –§—É–Ω–∫—Ü–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
    async function moderateUserFromProfile(userId, userName, banType) {
        if (!isAdmin) {
            alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –º–æ–¥–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            return;
        }

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        closeProfileModal();

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏
        currentModeratingUserId = userId;
        document.getElementById('modUserName').textContent = userName || '–ê–Ω–æ–Ω–∏–º';
        document.getElementById('modUserId').textContent = userId;

        if (banType === 'temp') {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            openBanDurationModal();
        } else {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –±–∞–Ω–∞
            document.getElementById('moderatorModal').classList.add('active');
            
            // –°—Ä–∞–∑—É –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –±–∞–Ω–∞
            setTimeout(() => {
                banUser('permanent');
            }, 100);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –º–µ—Ç–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function deleteAllUserMarkers(userId, userName) {
        if (!isAdmin) {
            alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –º–µ—Ç–∫–∏ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            return;
        }

        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–µ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) return;

        try {
            const { error } = await _sb.from('markers').delete().eq('author_id', userId);
            if (error) {
                alert('–û—à–∏–±–∫–∞: ' + (error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                return;
            }
            alert('‚úÖ –í—Å–µ –º–µ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª–µ–Ω—ã. –û–±–Ω–æ–≤–∏—Ç–µ –∫–∞—Ä—Ç—É.');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (typeof loadMarkers === 'function') {
                loadMarkers();
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
        }
    }

    // –í–µ—Ä—Å–∏—è –º–µ–Ω—é –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ balloonContent)
    window.showUserModeratorMenuFromMarker = (userId, userName) => {
        if (!window.isAdmin) {
            window.reportUser(userId, userName, '–º–∞—Ä–∫–µ—Ä', '');
            return;
        }

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –±–∞–ª—É–Ω
        if (window.myMap && window.myMap.balloon) {
            window.myMap.balloon.close();
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
        setTimeout(() => {
            window.showUserModeratorMenu(userId, userName, new MouseEvent('click', {
                bubbles: true,
                cancelable: true,
                view: window,
                pageX: window.innerWidth / 2,
                pageY: window.innerHeight / 2
            }));
        }, 100);
    };

    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞
    let chatUpdateInterval = null;

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞
    async function loadChatMessages() {
        try {
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ 30 –¥–ª—è –±—ã—Å—Ç—Ä–æ—Å—Ç–∏
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª-–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ 30 –¥–ª—è –±—ã—Å—Ç—Ä–æ—Ç—ã —Ä–µ–Ω–¥–µ—Ä–∞
            const { data: messages } = await _sb.from('messages').select('*').order('created_at', { ascending: true }).limit(30);
            const container = document.getElementById('chatMessages');

            if (!messages || messages.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--gray); padding: 20px;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
                return;
            }

            // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∞–≤—Ç–æ—Ä—ã –∏ –ø–æ–ª—É—á–∞–µ–º –∏—Ö –¥–∞–Ω–Ω—ã–µ (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
            const authorIds = Array.from(new Set(messages.map(m => String(m.author_id))));
            let authorsMap = {};
            const now = Date.now();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—Å—Ç–∞—Ä–µ–ª –ª–∏ –∫—ç—à
            if (now - authorsCacheTime > CACHE_DURATION) {
                authorsCache = {};
                authorsCacheTime = now;
            }
            
            // –ë–µ—Ä—ë–º –∏–∑ –∫—ç—à–∞ —Ç–æ —á—Ç–æ –µ—Å—Ç—å
            const cachedIds = authorIds.filter(id => authorsCache[id]);
            const uncachedIds = authorIds.filter(id => !authorsCache[id]);
            
            // –ö–æ–ø–∏—Ä—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            cachedIds.forEach(id => { authorsMap[id] = authorsCache[id]; });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
            if (uncachedIds.length > 0) {
                try {
                    const { data: authors } = await _sb.from('drivers').select('user_id,likes_sum,is_trusted,avatar,avatar_url').in('user_id', uncachedIds);
                    if (authors) {
                        authors.forEach(a => {
                            const id = String(a.user_id);
                            authorsMap[id] = a;
                            authorsCache[id] = a; // –ö—ç—à–∏—Ä—É–µ–º
                        });
                    }
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–µ–π –∞–≤—Ç–æ—Ä–æ–≤:', e?.message || e);
                }
            }

            // –£—Ç–∏–ª–∏—Ç–∞: –ø–µ—Ä–µ–≤–æ–¥–∏–º likes_sum –≤ 0..5 –∑–≤—ë–∑–¥
            function likesToStars(likes) {
                const n = Number(likes) || 0;
                if (n <= 0) return 0;
                if (n >= 100) return 5;
                if (n >= 60) return 4;
                if (n >= 30) return 3;
                if (n >= 10) return 2;
                return 1;
            }

            // –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å –±–µ–π–¥–∂–∞–º–∏-–∑–≤—ë–∑–¥–∞–º–∏ —Ä—è–¥–æ–º —Å –∏–º–µ–Ω–µ–º
            container.innerHTML = '';
            messages.forEach(msg => {
                const isOwn = String(msg.author_id) === String(uid);
                const canDelete = isOwn || isAdmin;
                const messageEl = document.createElement('div');
                messageEl.className = `chat-message ${isOwn ? 'own' : 'other'}`;
                messageEl.style.position = 'relative';

                let photoHTML = '';
                if (msg.photo_url && msg.photo_url.trim()) {
                    photoHTML = `<img src="${msg.photo_url}" class="chat-message-photo" onclick="openPhotoViewer('${msg.photo_url}')" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è" style="display: block; margin-top: 8px; max-width: 100%;">`;
                }

                const timestamp = new Date(msg.created_at).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

                let deleteButtonHTML = '';
                if (canDelete) {
                    deleteButtonHTML = `<button class="chat-delete-btn" data-msg-id="${msg.id}" data-author-id="${msg.author_id}" style="position: absolute; top: 5px; right: 5px; background: #ff3b30; color: white; border: none; border-radius: 4px; padding: 2px 6px; font-size: 10px; cursor: pointer; transition: all 0.2s;" title="–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">‚ùå</button>`;
                }

                // –ë–µ–π–¥–∂ –∑–≤—ë–∑–¥
                const authorInfo = authorsMap[String(msg.author_id)] || {};
                const likesSum = authorInfo.likes_sum || 0;
                const isTrusted = !!authorInfo.is_trusted;
                const starsCount = likesToStars(likesSum);
                let starsHTML = '';
                for (let i = 0; i < 5; i++) starsHTML += (i < starsCount) ? '‚òÖ' : '‚òÜ';
                const starsBadge = `<span style="margin-left:8px; color: ${isTrusted ? '#b8860b' : '#f5c542'}; font-weight:700;">${starsHTML}</span>`;

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä (—Ñ–æ—Ç–æ –∏–ª–∏ emoji)
                let avatarHTML = '';
                if (authorInfo.avatar_url) {
                    avatarHTML = `<img src="${authorInfo.avatar_url}" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 6px; object-fit: cover;">`;
                } else {
                    const avatar = authorInfo.avatar || 'üë§';
                    avatarHTML = `<span style="margin-right: 6px; font-size: 16px;">${avatar}</span>`;
                }

                messageEl.innerHTML = `
                    ${deleteButtonHTML}
                    ${!isOwn ? `<div class="chat-message-author" style="display: flex; align-items: center; cursor: ${isAdmin ? 'pointer' : 'default'}; ${isAdmin ? 'padding: 4px 8px; border-radius: 6px; transition: all 0.2s; user-select: none;' : ''}" data-user-id="${msg.author_id}" data-user-name="${(msg.author_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å').replace(/"/g, '&quot;')}">${avatarHTML}<span>${msg.author_name || '–ê–Ω–æ–Ω–∏–º'}</span> ${starsBadge}</div>` : ''}
                    <div>${msg.text || ''}</div>
                    ${photoHTML}
                    <div class="chat-message-time">${timestamp}</div>
                `;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∏–º—è –¥–ª—è –∞–¥–º–∏–Ω–∞
                if (isAdmin && !isOwn) {
                    const authorDiv = messageEl.querySelector('.chat-message-author');
                    if (authorDiv) {
                        authorDiv.onclick = (e) => {
                            showUserModeratorMenu(msg.author_id, msg.author_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', e);
                        };
                        authorDiv.onmouseover = () => {
                            authorDiv.style.background = '#f0f0f5';
                            authorDiv.style.transform = 'scale(1.02)';
                        };
                        authorDiv.onmouseout = () => {
                            authorDiv.style.background = '';
                            authorDiv.style.transform = 'scale(1)';
                        };
                    }
                }
                container.appendChild(messageEl);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
                const deleteBtn = messageEl.querySelector('.chat-delete-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', async function(e) {
                        e.stopPropagation();
                        const msgId = this.dataset.msgId;
                        const authorId = this.dataset.authorId;
                        await deleteMessage(msgId, authorId);
                    });
                    deleteBtn.addEventListener('mouseover', function() {
                        this.style.background = '#d32f2b';
                        this.style.transform = 'scale(1.1)';
                    });
                    deleteBtn.addEventListener('mouseout', function() {
                        this.style.background = '#ff3b30';
                        this.style.transform = 'scale(1)';
                    });
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ (–µ—Å–ª–∏ –∞–¥–º–∏–Ω)
                if (isAdmin && !isOwn) {
                    messageEl.style.cursor = 'pointer';
                    messageEl.addEventListener('click', function(e) {
                        const author = this.querySelector('[data-user-id]');
                        if (author && !e.target.closest('.chat-delete-btn')) {
                            showChatContextMenu(e, msg, author.dataset.userId, author.dataset.userName);
                        }
                    });
                }
            });

            // –°–∫—Ä–æ–ª–∏–º –≤–Ω–∏–∑ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            container.scrollTop = container.scrollHeight;
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π:', e?.message || e);
            document.getElementById('chatMessages').innerHTML = '<div style="text-align: center; color: red; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–∂–∞—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ)
    async function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.7) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –±–æ–ª—å—à–µ –ª–∏–º–∏—Ç–∞
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = width * ratio;
                        height = height * ratio;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // –°–∂–∏–º–∞–µ–º –≤ JPEG —Å –Ω—É–∂–Ω—ã–º –∫–∞—á–µ—Å—Ç–≤–æ–º
                    canvas.toBlob((blob) => {
                        resolve(blob);
                    }, 'image/jpeg', quality);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
    async function sendChatMessage() {
        if (!currentDriver) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ Telegram');
            openRegistrationModal();
            return;
        }
        const messageText = document.getElementById('chatInput').value.trim();
        
        if (!messageText && !selectedChatPhoto) {
            alert('–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ');
            return;
        }

        let photoURL = null;

        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ Base64
        if (selectedChatPhoto) {
            try {
                // –°–∂–∏–º–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                const compressedBlob = await compressImage(selectedChatPhoto, 800, 800, 0.7);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ—Å–ª–µ —Å–∂–∞—Ç–∏—è (–º–∞–∫—Å–∏–º—É–º 2MB)
                if (compressedBlob.size > 2 * 1024 * 1024) {
                    alert('‚ùå –§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ –¥–∞–∂–µ –ø–æ—Å–ª–µ —Å–∂–∞—Ç–∏—è. –ú–∞–∫—Å–∏–º—É–º 2MB.');
                    selectedChatPhoto = null;
                    return;
                }

                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º blob –≤ Base64
                const reader = new FileReader();
                await new Promise((resolve, reject) => {
                    reader.onload = function(event) {
                        photoURL = event.target.result; // data:image/jpeg;base64,...
                        console.log('‚úÖ –§–æ—Ç–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–æ –≤ Base64, —Ä–∞–∑–º–µ—Ä:', photoURL.length);
                        resolve();
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(compressedBlob);
                });
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ:', e?.message || e);
                alert('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ: ' + (e?.message || e));
                selectedChatPhoto = null;
                return;
            }
        }

        // –í—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ë–î
        try {
            const messageData = {
                author_id: uid,
                author_name: currentDriver?.name || '–ê–Ω–æ–Ω–∏–º',
                text: messageText || '',
                created_at: new Date().toISOString()
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
            if (photoURL) {
                messageData.photo_url = photoURL;
            }
            
            const { error } = await _sb.from('messages').insert([messageData]);

            if (!error) {
                console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
                document.getElementById('chatInput').value = '';
                selectedChatPhoto = null;
                document.getElementById('chatPhotoPreview').innerHTML = '';
                await loadChatMessages();
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                console.error('–û—à–∏–±–∫–∞ –ë–î:', error);
            }
        } catch (e) {
            alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (e?.message || e));
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', e);
        }
    }

    // –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª–µ last_seen –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
    let presenceSupported = true;
    async function updateLastSeen() {
        if (!uid) return;
        if (!presenceSupported) return;
        try {
            const payload = { user_id: uid, last_seen: new Date().toISOString() };
            const { error } = await _sb.from('drivers').upsert([payload], { onConflict: 'user_id' });
            if (error) {
                // –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞, –≤–æ–∑–º–æ–∂–Ω–æ –∫–æ–ª–æ–Ω–∫–∏ –Ω–µ—Ç ‚Äî –æ—Ç–∫–ª—é—á–∞–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
                console.warn('updateLastSeen error:', error.message || error);
                presenceSupported = false;
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ updateLastSeen:', e?.message || e);
            presenceSupported = false;
        }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å last_seen –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 2 –º–∏–Ω—É—Ç
    async function loadOnlineCount() {
        const badge = document.getElementById('onlineCountBadge');
        if (!badge) return;
        if (!presenceSupported) {
            badge.textContent = '–û–Ω–ª–∞–π–Ω: N/A';
            return;
        }
        try {
            const threshold = new Date(Date.now() - 2*60*1000).toISOString();
            const res = await _sb.from('drivers').select('user_id', { count: 'exact' }).gte('last_seen', threshold);
            const count = res.count || (res.data ? res.data.length : 0);
            badge.textContent = `–û–Ω–ª–∞–π–Ω: ${count}`;
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ loadOnlineCount:', e?.message || e);
            badge.textContent = '–û–Ω–ª–∞–π–Ω: ?';
            presenceSupported = false;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è —á–∞—Ç–∞
    document.addEventListener('change', function(e) {
        if (e.target.id === 'chatPhotoInput') {
            const file = e.target.files[0];
            if (file) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
                if (!file.type.startsWith('image/')) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                    e.target.value = '';
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ä–∞–∑–º–µ—Ä (–º–∞–∫—Å–∏–º—É–º 20MB –¥–æ —Å–∂–∞—Ç–∏—è)
                if (file.size > 20 * 1024 * 1024) {
                    alert('–ò—Å—Ö–æ–¥–Ω–æ–µ —Ñ–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å–∏–º—É–º 20MB)');
                    e.target.value = '';
                    return;
                }
                
                selectedChatPhoto = file;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ
                const reader = new FileReader();
                reader.onload = (event) => {
                    const preview = document.getElementById('chatPhotoPreview');
                    preview.innerHTML = `
                        <div style="position: relative; display: inline-block;">
                            <img src="${event.target.result}" style="max-width: 100px; max-height: 100px; border-radius: 8px;">
                            <button onclick="selectedChatPhoto = null; document.getElementById('chatPhotoPreview').innerHTML = ''; document.getElementById('chatInput').focus();" 
                                style="position: absolute; top: -5px; right: -5px; background: red; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px;">‚úï</button>
                        </div>
                    `;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –∑–∞ –º–∞—Ä–∫–µ—Ä (–ª–∞–π–∫/–¥–∏–∑–ª–∞–π–∫)
    window.vote = async (id, isUp) => {
        try {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –º–∞—Ä–∫–µ—Ä –∏–∑ –ë–î
            const { data: current } = await _sb.from('markers').select('*').eq('id', id).single();
            if (!current) return;
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ª–∞–π–∫–æ–≤ –∏–ª–∏ –¥–∏–∑–ª–∞–π–∫–æ–≤
            const upd = isUp ? { votes_up: (current.votes_up || 0) + 1 } : { votes_down: (current.votes_down || 0) + 1 };
            await _sb.from('markers').update(upd).eq('id', id);

            // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ–º —Å—É–º–º–∞—Ä–Ω—ã–µ –ª–∞–π–∫–∏ –∞–≤—Ç–æ—Ä–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–∏–º –≤ drivers
            try {
                const authorId = current.author_id;
                const { data: authorMarkers } = await _sb.from('markers').select('votes_up').eq('author_id', authorId);
                let likesSum = 0;
                if (authorMarkers && authorMarkers.length) likesSum = authorMarkers.reduce((s, r) => s + (r.votes_up || 0), 0);
                const isTrusted = likesSum >= (typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20);
                // –ü—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å/–≤—Å—Ç–∞–≤–∏—Ç—å –≤ drivers (–≥—Ä–µ–π—Å—Ñ—É–ª ‚Äî –µ—Å–ª–∏ –∫–æ–ª–æ–Ω–æ–∫ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º)
                try {
                    await _sb.from('drivers').upsert([{ user_id: authorId, likes_sum: likesSum, is_trusted: isTrusted }], { onConflict: 'user_id' });
                } catch (err) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å drivers.likes_sum/is_trusted:', err?.message || err);
                }
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á—ë—Ç–µ –ª–∞–π–∫–æ–≤ –∞–≤—Ç–æ—Ä–∞:', e?.message || e);
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–∞—Ä–∫–µ—Ä–∞:', e?.message || e);
        }

        // –ü–µ—Ä–µ—Å—á—ë—Ç —Ä–µ–π—Ç–∏–Ω–≥–∞ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è (–∏–∑ —Ç–∞–±–ª–∏—Ü—ã markers)
        loadMarkers();
    };

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –º–µ—Ç–∫–∏ (–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ "–°—Ç–æ—è—Ç" –∏–ª–∏ "–£–µ—Ö–∞–ª–∏")
    window.confirmMarker = async (markerId, status) => {
        // status: 'stay' –∏–ª–∏ 'leave'
        if (!uid) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ Telegram');
            const overlay = document.getElementById('tgAuthOverlay'); if (overlay) overlay.style.display = 'flex';
            return;
        }

        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª –ª–∏ —É–∂–µ —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞ —ç—Ç—É –º–µ—Ç–∫—É
            const { data: existing } = await _sb.from('marker_confirmations')
                .select('id').eq('marker_id', markerId).eq('user_id', uid).maybeSingle();
            
            if (existing) {
                alert(`–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ —ç—Ç—É –º–µ—Ç–∫—É. –û–¥–∏–Ω –≥–æ–ª–æ—Å –Ω–∞ –º–µ—Ç–∫—É.`);
                return;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ–ª–æ—Å –≤ —Ç–∞–±–ª–∏—Ü—É marker_confirmations
            const { error: insertError } = await _sb.from('marker_confirmations').insert([{
                marker_id: markerId,
                user_id: uid,
                status: status,
                created_at: new Date().toISOString()
            }]);

            if (insertError && insertError.code === 'PGRST116') {
                // –¢–∞–±–ª–∏—Ü–∞ marker_confirmations –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—á—ë—Ç—á–∏–∫ –≤ markers
                console.warn('–¢–∞–±–ª–∏—Ü–∞ marker_confirmations –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π —Å—á—ë—Ç—á–∏–∫');
                const { data: marker } = await _sb.from('markers').select('leave_confirmations').eq('id', markerId).single();
                if (marker) {
                    const newCount = (status === 'leave') ? ((marker.leave_confirmations || 0) + 1) : (marker.leave_confirmations || 0);
                    await _sb.from('markers').update({ leave_confirmations: newCount }).eq('id', markerId);
                    
                    // –ï—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π - —É–¥–∞–ª—è–µ–º –º–µ—Ç–∫—É
                    if (newCount >= (typeof MARKER_LEAVE_THRESHOLD !== 'undefined' ? MARKER_LEAVE_THRESHOLD : 3)) {
                        await _sb.from('markers').delete().eq('id', markerId);
                        alert(`‚úÖ –ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞ - ${newCount} —á–µ–ª–æ–≤–µ–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ —á—Ç–æ –æ–±—ä–µ–∫—Ç —É–µ—Ö–∞–ª.`);
                        myMap.balloon.close();
                        loadMarkers();
                        return;
                    }
                }
            } else if (!insertError) {
                // –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–∏–ª–∏ –∑–∞–ø–∏—Å—å, —Å—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ "leave" –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
                const { data: confirmations } = await _sb.from('marker_confirmations')
                    .select('id').eq('marker_id', markerId).eq('status', 'leave');
                
                const leaveCount = (confirmations ? confirmations.length : 0);
                
                // –ï—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π - —É–¥–∞–ª—è–µ–º –º–µ—Ç–∫—É
                if (leaveCount >= (typeof MARKER_LEAVE_THRESHOLD !== 'undefined' ? MARKER_LEAVE_THRESHOLD : 3)) {
                    await _sb.from('markers').delete().eq('id', markerId);
                    alert(`‚úÖ –ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞ - ${leaveCount} —á–µ–ª–æ–≤–µ–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ —á—Ç–æ –æ–±—ä–µ–∫—Ç —É–µ—Ö–∞–ª.`);
                    myMap.balloon.close();
                    loadMarkers();
                    return;
                }
                
                // –ò–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å—á—ë—Ç—á–∏–∫
                alert(`‚úÖ –í–∞—à –≥–æ–ª–æ—Å —É—á—Ç—ë–Ω (${leaveCount}/${typeof MARKER_LEAVE_THRESHOLD !== 'undefined' ? MARKER_LEAVE_THRESHOLD : 3} –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è)`);
                loadMarkers(); // –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É —Å –Ω–æ–≤—ã–º —Å—á—ë—Ç—á–∏–∫–æ–º
            } else if (insertError) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏: ' + (insertError.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –º–µ—Ç–∫–∏:', e?.message || e);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏: ' + (e?.message || e));
        }
    };

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∞)
    window.delMarker = async (id) => {
        if (confirm("–£–¥–∞–ª–∏—Ç—å –≤–∞—à—É –º–µ—Ç–∫—É?")) {
            await _sb.from('markers').delete().eq('id', id);
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–∏–π –±–∞–ª—É–Ω
            myMap.balloon.close();
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–∞—Ä–∫–µ—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ
            loadMarkers();
        }
    };

    // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –º–æ–¥–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ window –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ balloonContent
    window.deleteAllUserMessages = deleteAllUserMessages;
    window.deleteAllUserMarkers = deleteAllUserMarkers;
    window.reportUser = reportUser;
    window.deleteMessage = deleteMessage;

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ª–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π
    async function openActivityModal() {
        const feed = document.getElementById('activityFeed');
        feed.innerHTML = '<div style="text-align: center; color: var(--gray);">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</div>';
        
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –º–∞—Ä–∫–µ—Ä—ã (—Å–æ–±—ã—Ç–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è)
            const { data: recentMarkers } = await _sb.from('markers').select('id,type,ts,author_id').order('ts', { ascending: false }).limit(20);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–æ–¥–∏—Ç–µ–ª—è—Ö (–∏–º—è, —Ä–µ–π—Ç–∏–Ω–≥) –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–≤—ë–∑–¥ –≤ –ª–µ–Ω—Ç–µ
            const { data: drivers } = await _sb.from('drivers').select('user_id,name,likes_sum,is_trusted');
            const driverMap = {};
            const driverInfoMap = {};
            if (drivers) {
                drivers.forEach(d => {
                    driverMap[d.user_id] = d.name || '–ê–Ω–æ–Ω–∏–º';
                    driverInfoMap[d.user_id] = {
                        name: d.name || '–ê–Ω–æ–Ω–∏–º',
                        likes_sum: (typeof d.likes_sum !== 'undefined' && d.likes_sum !== null) ? Number(d.likes_sum) : 0,
                        is_trusted: !!d.is_trusted
                    };
                });
            }

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ø–µ—Ä–µ–≤–æ–¥–∏–º likes_sum –≤ 0..5 –∑–≤—ë–∑–¥
            function likesToStars(n) {
                const v = Number(n) || 0;
                if (v <= 0) return 0;
                if (v >= 100) return 5;
                if (v >= 60) return 4;
                if (v >= 30) return 3;
                if (v >= 10) return 2;
                return 1;
            }
            
            let html = '';
            const typeNames = { dps: '–î–ü–°', patrol: '–†–µ–π–¥', camera: '–ö–∞–º–µ—Ä–∞', dtp: '–î–¢–ü', works: '–†–∞–±–æ—Ç—ã', sos: 'SOS' };
            const typeEmoji = { dps: 'üëÆ', patrol: 'üöî', camera: 'üì∏', dtp: 'üí•', works: 'üöß', sos: 'üÜò' };
            
            if (recentMarkers && recentMarkers.length > 0) {
                recentMarkers.forEach(marker => {
                    const driverName = driverMap[marker.author_id] || '–í–æ–¥–∏—Ç–µ–ª—å';
                    const authorInfo = driverInfoMap[marker.author_id] || { name: driverName, likes_sum: 0, is_trusted: false };
                    const typeName = typeNames[marker.type] || marker.type;
                    const icon = typeEmoji[marker.type] || 'üìç';
                    const time = new Date(marker.ts).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

                    // –†–µ–Ω–¥–µ—Ä–∏–º –∑–≤—ë–∑–¥—ã —Ä—è–¥–æ–º —Å –∏–º–µ–Ω–µ–º
                    const starsCount = likesToStars(authorInfo.likes_sum);
                    let starsHTML = '';
                    for (let i = 0; i < 5; i++) starsHTML += (i < starsCount) ? '‚òÖ' : '‚òÜ';
                    const starsBadge = `<span style="margin-left:8px; color: ${authorInfo.is_trusted ? '#b8860b' : '#f5c542'}; font-weight:700;">${starsHTML}</span>`;
                    const trustedMark = authorInfo.is_trusted ? '<span style="color:#b8860b; font-weight:800; margin-left:6px;">‚≠ê</span>' : '';

                    html += `
                        <div class="activity-item">
                            <div><span class="activity-icon">${icon}</span><strong>${driverName}</strong> ${trustedMark} ${starsBadge} –¥–æ–±–∞–≤–∏–ª ${typeName}</div>
                            <div class="activity-time">üïê ${time}</div>
                        </div>
                    `;
                });
            } else {
                html = '<div style="text-align: center; color: var(--gray); padding: 20px;">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π</div>';
            }
            
            feed.innerHTML = html;
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ª–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π:', e?.message || e);
            feed.innerHTML = '<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
        }
        
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'hidden';
        document.getElementById('activityModal').classList.add('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –ª–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π
    function closeActivityModal() {
        const target = document.querySelector('.target');
        if (target) target.style.visibility = 'visible';
        document.getElementById('activityModal').classList.remove('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –≤ –ø—Ä–æ—Ñ–∏–ª—å
    async function loadAchievements() {
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Ç–æ–∫ –∏ –ª–∞–π–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const { data: markers } = await _sb.from('markers').select('votes_up').eq('author_id', uid);
        
        let markersCount = 0;
        let totalLikes = 0;
        let totalVotes = 0;
        
        if (markers) {
            markersCount = markers.length;
            markers.forEach(m => {
                totalLikes += m.votes_up || 0;
                totalVotes += (m.votes_up || 0) + (m.votes_down || 0);
            });
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        const achievements = [];
        
        if (markersCount >= 1) achievements.push({ icon: 'üöó', title: '–ü–µ—Ä–≤–∞—è –º–µ—Ç–∫–∞', desc: markersCount });
        if (markersCount >= 10) achievements.push({ icon: 'üîü', title: '–î–µ—Å—è—Ç–æ–∫', desc: '10 –º–µ—Ç–æ–∫' });
        if (markersCount >= 50) achievements.push({ icon: 'üèÖ', title: '–ü–æ–ª–æ–≤–∏–Ω–∞ —Å–æ—Ç–Ω–∏', desc: '50 –º–µ—Ç–æ–∫' });
        if (markersCount >= 100) achievements.push({ icon: 'üíØ', title: '–°–æ—Ç–Ω—è', desc: '100 –º–µ—Ç–æ–∫' });
        
        if (totalLikes >= 10) achievements.push({ icon: 'üëç', title: '–ü–æ–ª–µ–∑–Ω–æ', desc: '10 –ª–∞–π–∫–æ–≤' });
        if (totalLikes >= 50) achievements.push({ icon: '‚≠ê', title: '–ó–≤–µ–∑–¥–∞', desc: '50 –ª–∞–π–∫–æ–≤' });
        if (totalLikes >= 100) achievements.push({ icon: 'üèÜ', title: '–õ–µ–≥–µ–Ω–¥–∞', desc: '100 –ª–∞–π–∫–æ–≤' });
        
        if (totalVotes >= 50) achievements.push({ icon: 'üìä', title: '–ì–æ–ª–æ—Å–∞', desc: '50 –≥–æ–ª–æ—Å–æ–≤' });
        if (totalVotes >= 200) achievements.push({ icon: 'üéØ', title: '–ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç', desc: '200 –≥–æ–ª–æ—Å–æ–≤' });
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º "–∑–≤–∞–Ω–∏–µ"
        let title = '–ù–æ–≤–∏—á–æ–∫';
        if (markersCount >= 50) title = '–û–ø—ã—Ç–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å';
        if (markersCount >= 100) title = '–ù–∞–≤–∏–≥–∞—Ç–æ—Ä-–ø—Ä–æ—Ñ–∏';
        if (totalLikes >= 50) title = '–®–µ—Ä–∏—Ñ –¥–æ—Ä–æ–≥';
        
        return { achievements, title, markersCount, totalLikes, totalVotes };
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    async function checkBanStatus() {
        try {
            const { data: banned, error } = await _sb.from('bans').select('*').eq('user_id', uid).maybeSingle();
            
            if (error) {
                console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –±–∞–Ω–∞:', error?.message);
                return false;
            }
            
            if (banned) {
                console.warn('‚õî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω:', uid);
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å—é –∫–∞—Ä—Ç—É –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
                document.getElementById('map').style.display = 'none';
                document.querySelectorAll('button').forEach(btn => btn.style.display = 'none');
                document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –±–∞–Ω–µ
                const banMessage = document.createElement('div');
                banMessage.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.95);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    flex-direction: column;
                    gap: 20px;
                `;
                banMessage.innerHTML = `
                    <div style="font-size: 60px; text-align: center;">üö´</div>
                    <div style="color: white; font-size: 24px; font-weight: bold; text-align: center;">–í–´ –ó–ê–ë–ê–ù–ï–ù–´</div>
                    <div style="color: #ccc; font-size: 14px; text-align: center; max-width: 300px;">
                        –ü—Ä–∏—á–∏–Ω–∞: ${banned.reason || '–±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è'}<br>
                        –ö–æ–Ω—Ç–∞–∫—Ç: @admin_easy_ride
                    </div>
                `;
                document.body.appendChild(banMessage);
                return true;
            }
            
            return false;
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–Ω—è:', e?.message || e);
            return false;
        }
    }

    ymaps.ready(async () => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–Ω–∞ –ü–ï–†–ï–î –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –∫–∞—Ä—Ç—ã
        const isBanned = await checkBanStatus();
        if (isBanned) return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –µ—Å–ª–∏ –∑–∞–±–∞–Ω–µ–Ω
        
        // –ï—Å–ª–∏ –Ω–µ –∑–∞–±–∞–Ω–µ–Ω - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å —Ü–µ–Ω—Ç—Ä–æ–º –∏ —É—Ä–æ–≤–Ω–µ–º –∑—É–º–∞
        myMap = new ymaps.Map("map", { center: [48.01, 37.80], zoom: 16, controls: [] });
        
        // –ì—Ä–∞–Ω–∏—Ü—ã –î–æ–Ω–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ (—Å–∫—Ä—ã—Ç—ã)
        // const donetskBoundary = new ymaps.Rectangle([
        //     [DONETSK_REGION.south, DONETSK_REGION.west],
        //     [DONETSK_REGION.north, DONETSK_REGION.east]
        // ], {}, {
        //     fillColor: '#0066ff33',
        //     strokeColor: '#007aff',
        //     strokeWidth: 2,
        //     strokeOpacity: 0.7
        // });
        // myMap.geoObjects.add(donetskBoundary);
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é –º–∞—Ä–∫–µ—Ä–æ–≤ ‚Äî –µ—ë –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ—á–∏—â–∞—Ç—å –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ—á–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤
        markersCollection = new ymaps.GeoObjectCollection();
        myMap.geoObjects.add(markersCollection);
        
        // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã –æ–±–Ω–æ–≤–ª—è–µ–º –∞–¥—Ä–µ—Å
        myMap.events.add('actionend', () => {
            ymaps.geocode(myMap.getCenter()).then(res => {
                const obj = res.geoObjects.get(0);
                document.getElementById('addr-text').innerText = obj ? obj.getAddressLine() : "–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ";
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤ –∫–∞–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ –Ω–∞—Ö–æ–¥–∏–º—Å—è
                const coords = myMap.getCenter();
                if (isInDonetskRegion(coords)) {
                    document.getElementById('addr-text').style.color = '#34c759';
                } else {
                    document.getElementById('addr-text').style.color = '#ff3b30';
                }
            });
        });
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–¥–≤–∏–≥–∞—Ç—å –∫–∞—Ä—Ç—É ‚Äî –æ—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
        myMap.events.add('actionstart', () => {
            autoFollow = false;
        });
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é)
        initApp();
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º GPS –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
        initGPS();
        // –û–±–Ω–æ–≤–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Å–ª–µ–∂–µ–Ω–∏—è
        try { updateFollowButton(); } catch(e) { /* ignore */ }
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
        loadMarkers();
        // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥ (–≤–º–µ—Å—Ç–æ 10) –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –±–∞—Ç–∞—Ä–µ–∏
        setInterval(loadMarkersDebounced, 20000);

        // –ï—Å–ª–∏ actionCard —Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–∫—Ä—ã—Ç–∏—è
        const openBtn = document.getElementById('openActionBtn');
        if (openBtn && !actionCardVisible) openBtn.classList.add('visible');
    });



    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –≤ –î–æ–Ω–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏
    function isInDonetskRegion(coords) {
        if (!coords || coords.length < 2) return false;
        const lat = coords[0];
        const lon = coords[1];
        
        return lat >= DONETSK_REGION.south && 
               lat <= DONETSK_REGION.north && 
               lon >= DONETSK_REGION.west && 
               lon <= DONETSK_REGION.east;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π —Ç–æ—á–∫–∏ (–º–∞—Ä–∫–µ—Ä–∞) –Ω–∞ –∫–∞—Ä—Ç—É
    async function addPoint() {
        if (!currentDriver) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é');
            openRegistrationModal();
            return;
        }

        // –ë–µ—Ä—ë–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã ‚Äî —Ç–∞–∫ –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–∫–∏ –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ
        // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–∫—É –∏–º–µ–Ω–Ω–æ –ø–æ GPS, —Å–Ω–∞—á–∞–ª–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–π—Ç–µ –∫–∞—Ä—Ç—É –Ω–∞ —Å–≤–æ—ë–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏
        const coords = myMap.getCenter();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ –î–æ–Ω–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ –î–ù–†
        if (!isInDonetskRegion(coords)) {
            alert('‚õî –ú–µ—Ç–∫–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –≤ –î–ù–†.\n\n–¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ' + coords[0].toFixed(2) + '¬∞N, ' + coords[1].toFixed(2) + '¬∞E');
            return;
        }

        // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä –≤ –ë–î
        try {
            const { error } = await _sb.from('markers').insert([{
                coords: coords, // –¶–µ–Ω—Ç—Ä —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç—ã
                ts: Date.now(), // –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
                exp: Date.now() + 7200000, // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –º–∞—Ä–∫–µ—Ä–∞ (2 —á–∞—Å–∞)
                type: selectedType, // –¢–∏–ø –º–∞—Ä–∫–µ—Ä–∞ (–î–ü–°, –†–µ–π–¥ –∏ —Ç.–¥.)
                comment: document.getElementById('m-comm').value, // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                author_id: uid // ID –∞–≤—Ç–æ—Ä–∞ –º–∞—Ä–∫–µ—Ä–∞
            }]);

            if (!error) {
                // –ü–æ–ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ drivers, –Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                try {
                    await _sb.from('drivers').update({ markers_count: (currentDriver.markers_count || 0) + 1 }).eq('user_id', uid);
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å markers_count –≤ drivers (–≤–æ–∑–º–æ–∂–Ω–æ, –∫–æ–ª–æ–Ω–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç):', e?.message || e);
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                currentDriver.markers_count = (currentDriver.markers_count || 0) + 1;

                // –ï—Å–ª–∏ –Ω–µ—Ç –æ—à–∏–±–∫–∏, –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã
                document.getElementById('m-comm').value = '';
                // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Å–¥–≤–∏–≥ GPS –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—á—Ç–æ–±—ã –∫–∞—Ä—Ç–∞ –Ω–µ –≤–µ—Ä–Ω—É–ª–∞—Å—å –∫ GPS –ø–æ—Å–ª–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –º–µ—Ç–∫–∏)
                disableAutoFollowOnce = true;
                alert('‚úÖ –ú–µ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                loadMarkers();
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–µ—Ç–∫–∏:', e?.message || e);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–µ—Ç–∫–∏: ' + (e?.message || e));
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ —Å –∫–∞—Ä—Ç—ã
    async function loadMarkers() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –∏—Å—Ç–µ–∫–ª–∏ (exp > —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è)
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –º–µ—Ç–∫–∏ –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∏—Ö –ø–æ exp –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ,
        // —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –ø–æ–ª—è exp (BIGINT –∏–ª–∏ TIMESTAMPTZ)
        const { data: markers } = await _sb.from('markers').select('*');
        if (!markers || !myMap) return;
        const now = Date.now();
        const activeMarkers = (markers || []).filter(m => {
            if (m.exp === null || typeof m.exp === 'undefined') return true;
            if (typeof m.exp === 'number') return m.exp > now;
            const parsed = Date.parse(m.exp);
            return !isNaN(parsed) ? parsed > now : true;
        });
        
        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –º–µ—Ç–∫–∏ –ø–æ —Ç–∏–ø–∞–º
        const typeCounts = {};
        activeMarkers.forEach(m => {
            typeCounts[m.type] = (typeCounts[m.type] || 0) + 1;
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ –≤ UI
        const counterEl = document.getElementById('markersCounter');
        if (counterEl) {
            const typeNames = { dps: '–î–ü–°', patrol: '–†–µ–π–¥', camera: '–ö–∞–º–µ—Ä–∞', dtp: '–î–¢–ü', works: '–†–∞–±–æ—Ç—ã', sos: 'SOS' };
            let counterHTML = '–ê–∫—Ç–∏–≤–Ω—ã–µ: ';
            let hasCounters = false;
            for (const [type, count] of Object.entries(typeCounts)) {
                if (count > 0) {
                    counterHTML += `<span class="counter-item"><span>${count}</span> ${typeNames[type] || type}</span>`;
                    hasCounters = true;
                }
            }
            if (!hasCounters) {
                counterHTML = '‚úÖ –û–ø–∞—Å–Ω–æ—Å—Ç–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
            }
            counterEl.innerHTML = counterHTML;
        }
        
        // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Ä–∫–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Ä–µ–Ω–¥–µ—Ä–∏–º (–Ω–µ —Ç—Ä–æ–≥–∞–µ–º userLocationMarker –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã)
        if (markersCollection) markersCollection.removeAll();
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã (—Ü–µ–Ω—Ç—Ä)
        const userCoords = myMap.getCenter();

        // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ –æ–± –∞–≤—Ç–æ—Ä–∞—Ö (–∏–º—è, likes_sum, is_trusted)
        const authorIds = Array.from(new Set(markers.map(m => String(m.author_id))));
        const authorsInfoMap = {}; // user_id -> { name, likes_sum, is_trusted }
        try {
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–º—è –∏ —Ä–µ–π—Ç–∏–Ω–≥ –∏–∑ drivers (–µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞/–∫–æ–ª–æ–Ω–∫–∏ –µ—Å—Ç—å)
            const { data: driversInfo } = await _sb.from('drivers').select('user_id,name,likes_sum,is_trusted').in('user_id', authorIds);
            if (driversInfo) {
                driversInfo.forEach(d => {
                    const id = String(d.user_id);
                    authorsInfoMap[id] = {
                        name: d.name || '–ê–Ω–æ–Ω–∏–º',
                        likes_sum: (typeof d.likes_sum !== 'undefined' && d.likes_sum !== null) ? Number(d.likes_sum) : 0,
                        is_trusted: !!d.is_trusted
                    };
                });
            }
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ drivers –¥–ª—è –∞–≤—Ç–æ—Ä–æ–≤ (–≤–æ–∑–º–æ–∂–Ω–æ, —Ç–∞–±–ª–∏—Ü–∞/–∫–æ–ª–æ–Ω–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç):', e?.message || e);
        }

        // –î–ª—è –∞–≤—Ç–æ—Ä–æ–≤ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥—Å—á–∏—Ç–∞–µ–º —Å—É–º–º–∞—Ä–Ω—ã–µ –ª–∞–π–∫–∏ –ø–æ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –º–µ—Ç–∫–∞–º
        const missingAuthors = authorIds.filter(id => !authorsInfoMap[id]);
        if (missingAuthors.length > 0) {
            try {
                const { data: allMarkers } = await _sb.from('markers').select('author_id,votes_up').in('author_id', missingAuthors);
                const sumMap = {};
                if (allMarkers) {
                    allMarkers.forEach(r => {
                        const id = String(r.author_id);
                        sumMap[id] = (sumMap[id] || 0) + (r.votes_up || 0);
                    });
                }
                missingAuthors.forEach(id => {
                    const likes = sumMap[id] || 0;
                    authorsInfoMap[id] = { name: '–ê–Ω–æ–Ω–∏–º', likes_sum: likes, is_trusted: likes >= (typeof TRUST_LIKES_THRESHOLD !== 'undefined' ? TRUST_LIKES_THRESHOLD : 20) };
                });
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Å—á–∏—Ç–∞—Ç—å —Å—É–º–º–∞—Ä–Ω—ã–µ –ª–∞–π–∫–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–æ–≤:', e?.message || e);
            }
        }

        // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞ —Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –Ω–∞ –∫–∞—Ä—Ç–µ
        activeMarkers.forEach(m => {
            // –ü–æ–ª—É—á–∞–µ–º ID –∞–≤—Ç–æ—Ä–∞ –≤ –Ω–∞—á–∞–ª–µ —Ü–∏–∫–ª–∞
            const authorId = String(m.author_id);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–æ–º –º–∞—Ä–∫–µ—Ä–∞
            const isOwner = String(m.author_id) === String(uid);
            
            // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π "—É–µ—Ö–∞–ª–∏" (–≥—Ä–µ–π—Å—Ñ—É–ª - –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –±–µ—Ä—ë–º –∏–∑ —Å—á—ë—Ç—á–∏–∫–∞ –≤ markers)
            let leaveCount = m.leave_confirmations || 0;
            const confirmThreshold = typeof MARKER_LEAVE_THRESHOLD !== 'undefined' ? MARKER_LEAVE_THRESHOLD : 3;
            const confirmationBar = leaveCount > 0 ? `<div style="margin-top: 8px; font-size: 11px; color: #666;">üöó –£–µ—Ö–∞–ª–∏: ${leaveCount}/${confirmThreshold}</div>` : '';
            
            // HTML –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –æ–∫–Ω–∞ –º–∞—Ä–∫–µ—Ä–∞
            const authorInfo = authorsInfoMap[authorId] || { name: '–ê–Ω–æ–Ω–∏–º', likes_sum: 0, is_trusted: false };
            // –ü–µ—Ä–µ–≤–æ–¥–∏–º likes_sum –≤ 0..5 –∑–≤—ë–∑–¥
            function likesToStarsLocal(likes) {
                const n = Number(likes) || 0;
                if (n <= 0) return 0;
                if (n >= 100) return 5;
                if (n >= 60) return 4;
                if (n >= 30) return 3;
                if (n >= 10) return 2;
                return 1;
            }
            const starsCountLocal = likesToStarsLocal(authorInfo.likes_sum);
            let starsHTMLLocal = '';
            for (let i = 0; i < 5; i++) starsHTMLLocal += (i < starsCountLocal) ? '‚òÖ' : '‚òÜ';
            const starsBadgeLocal = `<span style="margin-left:8px; color: ${authorInfo.is_trusted ? '#b8860b' : '#f5c542'}; font-weight:700;">${starsHTMLLocal}</span>`;

            const bHtml = `<div class="b-cont">
                <div style="font-size:13px; margin-bottom:6px; color:#222; cursor: ${window.isAdmin ? 'pointer' : 'default'}; padding: 4px; border-radius: 4px; transition: all 0.2s;" onmouseover="${window.isAdmin ? `this.style.background='#f0f0f5'; this.style.transform='scale(1.02)'` : ''}" onmouseout="${window.isAdmin ? `this.style.background=''; this.style.transform='scale(1)'` : ''}" onclick="${window.isAdmin ? `window.showUserModeratorMenuFromMarker(${m.author_id}, '${(authorInfo.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å').replace(/'/g, "\\'")}')` : ''}"><strong>${authorInfo.name || '–ê–Ω–æ–Ω–∏–º'}</strong> ${authorInfo.is_trusted ? '<span style="color:#b8860b; font-weight:800; margin-left:6px;">‚≠ê</span>' : ''} ${starsBadgeLocal}</div>
                <strong>${m.comment || '–ú–µ—Ç–∫–∞'}</strong>
                ${m.photo_url ? `<div style="margin-top: 8px; margin-bottom: 8px;"><img src="${m.photo_url}" style="max-width: 100%; border-radius: 8px; cursor: pointer; max-height: 250px;" onclick="openPhotoViewer('${m.photo_url}')" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è"></div>` : ''}
                <div class="b-poll">
                    <button class="b-poll-btn" onclick="window.vote(${m.id}, true)">üëç ${m.votes_up || 0}</button>
                    <button class="b-poll-btn" onclick="window.vote(${m.id}, false)">üëé ${m.votes_down || 0}</button>
                </div>
                <div style="margin-top: 8px; display: flex; gap: 5px;">
                    <button class="b-poll-btn" onclick="window.confirmMarker(${m.id}, 'stay')" style="flex: 1; background: #34c759; color: white; font-weight: bold;">‚úÖ –°—Ç–æ—è—Ç</button>
                    <button class="b-poll-btn" onclick="window.confirmMarker(${m.id}, 'leave')" style="flex: 1; background: #ff3b30; color: white; font-weight: bold;">üöó –£–µ—Ö–∞–ª–∏</button>
                </div>
                ${confirmationBar}
                ${isOwner ? `<button class="b-del" onclick="window.delMarker(${m.id})">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                <button class="b-del" style="background: #ff9500; color:white;" onclick="window.reportUser(${m.author_id}, '${(authorInfo.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å').replace(/'/g, "\\'")}')" title="–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –∞–≤—Ç–æ—Ä–∞ –º–µ—Ç–∫–∏">‚ö†Ô∏è –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</button>
            </div>`;
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ–≤–µ—Ä–∏–µ –∞–≤—Ç–æ—Ä–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∑–≤–µ–∑–¥–æ—á–∫—É –∫ –∏–∫–æ–Ω–∫–µ, –µ—Å–ª–∏ –æ–Ω –ø—Ä–æ–≤–µ—Ä–µ–Ω
            const isTrustedAuthor = authorInfo.is_trusted;
            const iconInner = `<div style="background:white; border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center; border:2px solid ${isTrustedAuthor ? '#b8860b' : 'var(--blue)'}; font-size:18px; position: relative;">${MAP_ICONS[m.type]}${isTrustedAuthor ? '<span style=\"position:absolute; top:-6px; right:-6px; font-size:12px;\">‚≠ê</span>' : ''}</div>`;
            // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä —Å –∏–∫–æ–Ω–∫–æ–π –∏ –±–∞–ª—É–Ω–æ–º
            const p = new ymaps.Placemark(m.coords, { balloonContent: bHtml, iconContent: iconInner }, 
            { iconLayout: 'default#imageWithContent', iconImageHref: '', iconImageSize: [30, 30], iconImageOffset: [-15, -15] });
            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é
            if (markersCollection) markersCollection.add(p);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –æ–ø–∞—Å–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ (–∫–∞–º–µ—Ä—ã –∏ –î–ü–°)
            if ((m.type === 'camera' || m.type === 'dps') && m.coords && Array.isArray(m.coords)) {
                const distance = calculateDistance(userCoords, m.coords);
                
                // –ï—Å–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–Ω—å—à–µ 500 –º–µ—Ç—Ä–æ–≤ –∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —Ä–∞–∑, –∏–∑–¥–∞–µ–º –∑–≤—É–∫
                if (distance < 500 && !notifiedMarkers.has(m.id)) {
                    notifiedMarkers.add(m.id);
                    playAlertSound();
                    console.log(`‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! ${m.type === 'camera' ? '–ö–∞–º–µ—Ä–∞' : '–î–ü–°'} –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ ${distance.toFixed(0)}–º`);
                }
            }
            
            // –û—á–∏—â–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –¥–∞–ª–µ–∫–æ (–±–æ–ª–µ–µ 1000–º)
            if (notifiedMarkers.has(m.id)) {
                const distance = calculateDistance(userCoords, m.coords);
                if (distance > 1000) {
                    notifiedMarkers.delete(m.id);
                }
            }
        });
    }
</script>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div id="moderatorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0;">–ú–æ–¥–µ—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                <button class="modal-close" onclick="closeModerationModal()">√ó</button>
            </div>
            <div id="moderatorModalContent">
                <div style="background: #f0f0f5; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: var(--gray); margin-bottom: 8px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</div>
                    <div id="modUserName" style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">‚Äî</div>
                    <div style="font-size: 12px; color: var(--gray);">
                        Telegram ID: <span id="modUserId" style="font-weight: 600; color: #000;">‚Äî</span>
                    </div>
                </div>
                
                <div class="moderation-section">
                    <div class="moderation-title">‚öôÔ∏è –î–µ–π—Å—Ç–≤–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏</div>
                    <div class="moderation-buttons">
                        <button class="mod-btn mod-btn-temp" onclick="openBanDurationModal()">
                            <span style="font-size: 18px;">‚è±Ô∏è</span>
                            –í—Ä–µ–º–µ–Ω–Ω—ã–π –±–∞–Ω
                        </button>
                        
                        <button class="mod-btn mod-btn-perm" onclick="banUser('permanent')">
                            <span style="font-size: 18px;">üö´</span>
                            –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –±–∞–Ω
                        </button>
                    </div>
                    
                    <div style="margin-top: 10px; padding: 12px; background: #fff3cd; border-radius: 8px; font-size: 12px; color: #856404;">
                        ‚ö†Ô∏è –ó–∞–±–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ —Å–º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–µ—Ç–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–∞–Ω–∞ -->
    <div id="banDurationModal" class="ban-duration-modal">
        <div class="ban-duration-content">
            <div class="ban-duration-title">‚è±Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–∞–Ω–∞</div>
            
            <div class="ban-options">
                <div class="ban-option" data-hours="1">
                    <span class="duration">1 —á–∞—Å</span>
                    <span class="label">–ë—ã—Å—Ç—Ä–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</span>
                </div>
                <div class="ban-option" data-hours="6">
                    <span class="duration">6 —á–∞—Å–æ–≤</span>
                    <span class="label">–°–µ—Ä—å—ë–∑–Ω–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ</span>
                </div>
                <div class="ban-option" data-hours="24">
                    <span class="duration">24 —á–∞—Å–∞</span>
                    <span class="label">–°—É—Ç–∫–∏</span>
                </div>
                <div class="ban-option" data-hours="72">
                    <span class="duration">3 –¥–Ω—è</span>
                    <span class="label">–î–ª–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ</span>
                </div>
                <div class="ban-option" data-hours="168">
                    <span class="duration">7 –¥–Ω–µ–π</span>
                    <span class="label">–ù–µ–¥–µ–ª—è</span>
                </div>
                <div class="ban-option" data-hours="720">
                    <span class="duration">30 –¥–Ω–µ–π</span>
                    <span class="label">–ú–µ—Å—è—Ü</span>
                </div>
            </div>
            
            <div class="ban-actions">
                <button class="ban-cancel-btn" onclick="closeBanDurationModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="ban-confirm-btn" onclick="confirmTempBan()">–ó–∞–±–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID —Ç–µ–∫—É—â–µ–≥–æ –º–æ–¥–µ—Ä–∏—Ä—É–µ–º–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let currentModeratingUserId = null;

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∏–º—è –∞–≤—Ç–æ—Ä–∞ –≤ –º–∞—Ä–∫–µ—Ä–µ)
        window.showUserModeratorMenuFromMarker = function(userId, userName) {
            if (!window.isAdmin) {
                console.warn('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω: —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤');
                return;
            }
            
            currentModeratingUserId = userId;
            document.getElementById('modUserName').textContent = userName || '–ê–Ω–æ–Ω–∏–º';
            document.getElementById('modUserId').textContent = userId;
            document.getElementById('moderatorModal').classList.add('active');
        };

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
        function closeModerationModal() {
            document.getElementById('moderatorModal').classList.remove('active');
            currentModeratingUserId = null;
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–∞–Ω–∞ (–≤ —á–∞—Å–∞—Ö)
        let selectedBanHours = 24; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 24 —á–∞—Å–∞

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–∞–Ω–∞
        function openBanDurationModal() {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
            document.getElementById('moderatorModal').classList.remove('active');
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            document.getElementById('banDurationModal').classList.add('active');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä
            document.querySelectorAll('.ban-option').forEach(opt => opt.classList.remove('selected'));
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –æ–ø—Ü–∏–∏
            document.querySelectorAll('.ban-option').forEach(option => {
                option.onclick = function() {
                    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –æ–ø—Ü–∏–π
                    document.querySelectorAll('.ban-option').forEach(opt => opt.classList.remove('selected'));
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –æ–ø—Ü–∏—é
                    this.classList.add('selected');
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤
                    selectedBanHours = parseInt(this.getAttribute('data-hours'));
                };
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–∞–Ω–∞
        function closeBanDurationModal() {
            document.getElementById('banDurationModal').classList.remove('active');
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –º–æ–¥–∞–ª—å–Ω–æ–º—É –æ–∫–Ω—É –º–æ–¥–µ—Ä–∞—Ü–∏–∏
            document.getElementById('moderatorModal').classList.add('active');
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –±–∞–Ω–∞
        async function confirmTempBan() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω–∞ –ª–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            const selectedOption = document.querySelector('.ban-option.selected');
            if (!selectedOption) {
                alert('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–∞–Ω–∞');
                return;
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            document.getElementById('banDurationModal').classList.remove('active');
            
            // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –±–∞–Ω–∞ —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
            await banUserWithDuration(selectedBanHours);
        }

        // –§—É–Ω–∫—Ü–∏—è –±–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é (–≤ —á–∞—Å–∞—Ö)
        async function banUserWithDuration(hours) {
            if (!currentModeratingUserId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏');
                return;
            }

            const userName = document.getElementById('modUserName').textContent;
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
            let durationText = '';
            if (hours < 24) {
                durationText = `${hours} ${hours === 1 ? '—á–∞—Å' : hours < 5 ? '—á–∞—Å–∞' : '—á–∞—Å–æ–≤'}`;
            } else if (hours < 168) {
                const days = Math.floor(hours / 24);
                durationText = `${days} ${days === 1 ? '–¥–µ–Ω—å' : days < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'}`;
            } else {
                const days = Math.floor(hours / 24);
                durationText = `${days} ${days === 1 ? '–¥–µ–Ω—å' : days < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'}`;
            }
            
            const confirmMessage = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –Ω–∞ ${durationText}?`;

            if (!confirm(confirmMessage)) {
                // –ï—Å–ª–∏ –æ—Ç–º–µ–Ω–∏–ª–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –º–æ–¥–∞–ª—å–Ω–æ–º—É –æ–∫–Ω—É –º–æ–¥–µ—Ä–∞—Ü–∏–∏
                document.getElementById('moderatorModal').classList.add('active');
                return;
            }

            try {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –±–∞–Ω–∞
                const bannedUntil = new Date(Date.now() + hours * 60 * 60 * 1000).toISOString();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å—å –æ –±–∞–Ω–µ
                const { data: existingBan } = await _sb
                    .from('bans')
                    .select('*')
                    .eq('user_id', currentModeratingUserId)
                    .single();

                if (existingBan) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±–∞–Ω
                    const { error } = await _sb
                        .from('bans')
                        .update({
                            banned_until: bannedUntil,
                            ban_type: 'temp',
                            updated_at: new Date().toISOString()
                        })
                        .eq('user_id', currentModeratingUserId);

                    if (error) throw error;
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –æ –±–∞–Ω–µ
                    const { error } = await _sb
                        .from('bans')
                        .insert({
                            user_id: currentModeratingUserId,
                            banned_until: bannedUntil,
                            ban_type: 'temp',
                            banned_by: uid,
                            created_at: new Date().toISOString()
                        });

                    if (error) throw error;
                }

                alert(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${userName}" –∑–∞–±–∞–Ω–µ–Ω –Ω–∞ ${durationText}`);
                currentModeratingUserId = null;

                // –£–¥–∞–ª—è–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã –∑–∞–±–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–∞—Ä—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–µ—Ç–∫–∏ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–∞—Ä—Ç—ã?')) {
                    const { error: deleteError } = await _sb
                        .from('markers')
                        .delete()
                        .eq('author_id', currentModeratingUserId);

                    if (deleteError) {
                        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫:', deleteError);
                    } else {
                        alert('‚úÖ –ú–µ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª–µ–Ω—ã');
                        await refreshMarkers(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
                    }
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–∞–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                alert('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –º–æ–¥–∞–ª—å–Ω–æ–º—É –æ–∫–Ω—É –º–æ–¥–µ—Ä–∞—Ü–∏–∏
                document.getElementById('moderatorModal').classList.add('active');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –±–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function banUser(banType) {
            if (!currentModeratingUserId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏');
                return;
            }

            const userName = document.getElementById('modUserName').textContent;
            const confirmMessage = banType === 'temp' 
                ? `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –Ω–∞ 24 —á–∞—Å–∞?`
                : `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ù–ê–í–°–ï–ì–î–ê –∑–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}"?`;

            if (!confirm(confirmMessage)) return;

            try {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –±–∞–Ω–∞
                const bannedUntil = banType === 'temp' 
                    ? new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString() // +24 —á–∞—Å–∞
                    : new Date('2099-12-31').toISOString(); // "–ù–∞–≤—Å–µ–≥–¥–∞"

                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º user_id –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å TEXT —Ç–∏–ø–æ–º –≤ –ë–î
                const userIdString = String(currentModeratingUserId);
                const adminIdString = String(uid);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å—å –æ –±–∞–Ω–µ
                const { data: existingBan, error: fetchError } = await _sb
                    .from('bans')
                    .select('*')
                    .eq('user_id', userIdString)
                    .maybeSingle(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º maybeSingle –≤–º–µ—Å—Ç–æ single –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–æ–∫

                if (fetchError && fetchError.code !== 'PGRST116') {
                    throw fetchError;
                }

                if (existingBan) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±–∞–Ω
                    const { error } = await _sb
                        .from('bans')
                        .update({
                            banned_until: bannedUntil,
                            ban_type: banType,
                            banned_by: adminIdString,
                            updated_at: new Date().toISOString()
                        })
                        .eq('user_id', userIdString);

                    if (error) throw error;
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –æ –±–∞–Ω–µ
                    const { error } = await _sb
                        .from('bans')
                        .insert({
                            user_id: userIdString,
                            banned_until: bannedUntil,
                            ban_type: banType,
                            banned_by: adminIdString,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });

                    if (error) throw error;
                }

                const successMessage = banType === 'temp'
                    ? `‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${userName}" –∑–∞–±–∞–Ω–µ–Ω –Ω–∞ 24 —á–∞—Å–∞`
                    : `‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${userName}" –∑–∞–±–∞–Ω–µ–Ω –Ω–∞–≤—Å–µ–≥–¥–∞`;

                alert(successMessage);
                closeModerationModal();

                // –£–¥–∞–ª—è–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã –∑–∞–±–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–∞—Ä—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–µ—Ç–∫–∏ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–∞—Ä—Ç—ã?')) {
                    const { error: deleteError } = await _sb
                        .from('markers')
                        .delete()
                        .eq('author_id', userIdString);

                    if (deleteError) {
                        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫:', deleteError);
                    } else {
                        alert('‚úÖ –ú–µ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª–µ–Ω—ã');
                        await refreshMarkers(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
                    }
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–∞–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –±–∞–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        }


        // ============================================
        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–ü–†–û–°–ê–ú–ò –ù–ê –†–ê–ó–ë–ê–ù
        // ============================================

        let currentFilter = 'all';
        let currentReviewRequestId = null;
        let allUnbanRequests = [];

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Ä–∞–∑–±–∞–Ω
        async function loadUnbanRequests() {
            try {
                const { data, error } = await _sb
                    .from('unban_requests')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allUnbanRequests = data || [];
                updateUnbanRequestsStats();
                displayUnbanRequests();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:', error);
                document.getElementById('unbanRequestsBody').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #dc3545;">
                            ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
                        </td>
                    </tr>
                `;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateUnbanRequestsStats() {
            const pending = allUnbanRequests.filter(r => r.status === 'pending').length;
            const approved = allUnbanRequests.filter(r => r.status === 'approved').length;
            const rejected = allUnbanRequests.filter(r => r.status === 'rejected').length;

            document.getElementById('pendingRequestsCount').textContent = pending;
            document.getElementById('approvedRequestsCount').textContent = approved;
            document.getElementById('rejectedRequestsCount').textContent = rejected;
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞
        function displayUnbanRequests() {
            const tbody = document.getElementById('unbanRequestsBody');
            
            let filteredRequests = allUnbanRequests;
            if (currentFilter !== 'all') {
                filteredRequests = allUnbanRequests.filter(r => r.status === currentFilter);
            }

            if (filteredRequests.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">
                            –ó–∞–ø—Ä–æ—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredRequests.map(request => {
                const createdAt = new Date(request.created_at).toLocaleString('ru-RU');
                
                let statusBadge;
                if (request.status === 'pending') {
                    statusBadge = '<span style="background: #fff3cd; color: #856404; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700;">‚è≥ –û–∂–∏–¥–∞–µ—Ç</span>';
                } else if (request.status === 'approved') {
                    statusBadge = '<span style="background: #d4edda; color: #155724; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700;">‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ</span>';
                } else {
                    statusBadge = '<span style="background: #f8d7da; color: #721c24; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700;">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>';
                }

                let actions;
                if (request.status === 'pending') {
                    actions = `
                        <button onclick="openReviewUnbanModal(${request.id})" 
                            class="delete-btn" 
                            style="background: var(--blue); padding: 6px 12px;">
                            üîç –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å
                        </button>
                    `;
                } else {
                    const reviewedAt = request.reviewed_at ? new Date(request.reviewed_at).toLocaleString('ru-RU') : '-';
                    actions = `<small style="color: var(--gray);">–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–æ: ${reviewedAt}</small>`;
                }

                return `
                    <tr>
                        <td>#${request.id}</td>
                        <td><strong>${request.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</strong></td>
                        <td><code>${request.user_id}</code></td>
                        <td>${createdAt}</td>
                        <td>${statusBadge}</td>
                        <td>${actions}</td>
                    </tr>
                `;
            }).join('');
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
        function filterUnbanRequests(filter) {
            currentFilter = filter;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                const borderColor = btn.style.borderColor;
                btn.style.background = 'white';
                btn.style.color = borderColor;
            });
            
            const activeBtn = document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                const borderColor = activeBtn.style.borderColor;
                activeBtn.style.background = borderColor;
                activeBtn.style.color = 'white';
            }
            
            displayUnbanRequests();
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
        async function refreshUnbanRequests() {
            await loadUnbanRequests();
        }

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è
        async function openReviewUnbanModal(requestId) {
            currentReviewRequestId = requestId;
            
            const request = allUnbanRequests.find(r => r.id === requestId);
            if (!request) return;

            document.getElementById('reviewUsername').textContent = request.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            document.getElementById('reviewUserId').textContent = request.user_id;
            document.getElementById('reviewCreatedAt').textContent = new Date(request.created_at).toLocaleString('ru-RU');
            document.getElementById('reviewComment').value = '';

            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–Ω–µ
            try {
                const { data: banData } = await _sb
                    .from('bans')
                    .select('*')
                    .eq('user_id', request.user_id)
                    .maybeSingle();

                if (banData) {
                    const bannedUntil = new Date(banData.banned_until);
                    const isPermanent = bannedUntil.getFullYear() > 2050;
                    const banInfo = isPermanent 
                        ? 'üö´ –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –±–∞–Ω' 
                        : `‚è∞ –î–æ ${bannedUntil.toLocaleString('ru-RU')}`;
                    document.getElementById('reviewBanInfo').innerHTML = `<span style="color: #dc3545; font-weight: 600;">${banInfo}</span>`;
                } else {
                    document.getElementById('reviewBanInfo').innerHTML = '<span style="color: #28a745;">‚úÖ –ë–∞–Ω —É–∂–µ —Å–Ω—è—Ç</span>';
                }
            } catch (error) {
                document.getElementById('reviewBanInfo').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏';
            }

            document.getElementById('reviewUnbanModal').classList.add('active');
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è
        function closeReviewUnbanModal() {
            document.getElementById('reviewUnbanModal').classList.remove('active');
            currentReviewRequestId = null;
        }

        // –û–¥–æ–±—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å
        async function approveUnbanRequest() {
            if (!currentReviewRequestId) return;

            const comment = document.getElementById('reviewComment').value.trim();
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–¥–æ–±—Ä–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å? –ë–∞–Ω –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω—è—Ç.')) {
                return;
            }

            try {
                const adminIdString = String(uid);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–ø—Ä–æ—Å–∞ (—Ç—Ä–∏–≥–≥–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–º–µ—Ç –±–∞–Ω)
                const { error } = await _sb
                    .from('unban_requests')
                    .update({
                        status: 'approved',
                        reviewed_at: new Date().toISOString(),
                        reviewed_by: adminIdString,
                        reviewer_comment: comment || '–ó–∞–ø—Ä–æ—Å –æ–¥–æ–±—Ä–µ–Ω'
                    })
                    .eq('id', currentReviewRequestId);

                if (error) throw error;

                alert('‚úÖ –ó–∞–ø—Ä–æ—Å –æ–¥–æ–±—Ä–µ–Ω! –ë–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω—è—Ç.');
                closeReviewUnbanModal();
                await loadUnbanRequests();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        }

        // –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å
        async function rejectUnbanRequest() {
            if (!currentReviewRequestId) return;

            const comment = document.getElementById('reviewComment').value.trim();
            
            if (!comment) {
                alert('‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏');
                return;
            }

            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å?')) {
                return;
            }

            try {
                const adminIdString = String(uid);

                const { error } = await _sb
                    .from('unban_requests')
                    .update({
                        status: 'rejected',
                        reviewed_at: new Date().toISOString(),
                        reviewed_by: adminIdString,
                        reviewer_comment: comment
                    })
                    .eq('id', currentReviewRequestId);

                if (error) throw error;

                alert('‚ùå –ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                closeReviewUnbanModal();
                await loadUnbanRequests();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        if (document.getElementById('reviewUnbanModal')) {
            document.getElementById('reviewUnbanModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeReviewUnbanModal();
                }
            });
        }


                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ –æ–±–ª–∞—Å—Ç–∏
        document.getElementById('moderatorModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModerationModal();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–∞–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ –æ–±–ª–∞—Å—Ç–∏
        document.getElementById('banDurationModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeBanDurationModal();
            }
        });
    
        // ============= –≠–ö–†–ê–ù –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø =============
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 12) return 'üåÖ –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ';
            if (hour >= 12 && hour < 17) return '‚òÄÔ∏è –î–æ–±—Ä—ã–π –¥–µ–Ω—å';
            if (hour >= 17 && hour < 22) return 'üåÜ –î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä';
            return 'üåô –î–æ–±—Ä–æ–π –Ω–æ—á–∏';
        }

        function showSplashScreen() {
            const splashScreen = document.getElementById('splashScreen');
            const greetingText = document.getElementById('greetingText');
            const usernameText = document.getElementById('usernameText');

            greetingText.textContent = getGreeting();
            usernameText.textContent = `–í–æ–¥–∏—Ç–µ–ª—å ${username}`;

            splashScreen.classList.remove('hidden');

            // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                splashScreen.classList.add('hidden');
            }, 3000);
        }

        // ============= –ü–†–û–í–ï–†–ö–ê –ë–ê–ù–ê =============
        let userBanStatus = null;
        let appInitialized = false;

        async function checkBanStatus() {
            try {
                const userIdString = String(uid);
                const { data, error } = await _sb
                    .from('bans')
                    .select('*')
                    .eq('user_id', userIdString)
                    .maybeSingle();

                if (error && error.code !== 'PGRST116') {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–Ω–∞:', error);
                    return null;
                }

                if (!data) return null;

                const bannedUntil = new Date(data.banned_until);
                const now = new Date();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å—Ç–µ–∫ –ª–∏ –±–∞–Ω
                if (now >= bannedUntil) {
                    // –ë–∞–Ω –∏—Å—Ç–µ–∫ - —É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å
                    await _sb.from('bans').delete().eq('user_id', userIdString);
                    return null;
                }

                return data;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–Ω–∞:', error);
                return null;
            }
        }

        function showBanNotice(banData) {
            const banNotice = document.getElementById('banNotice');
            const banMessage = document.getElementById('banMessage');
            const banTimeRemaining = document.getElementById('banTimeRemaining');

            const bannedUntil = new Date(banData.banned_until);
            const isPermanent = bannedUntil.getFullYear() > 2050;

            if (isPermanent) {
                banMessage.textContent = '–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞–≤—Å–µ–≥–¥–∞ –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª.';
                banTimeRemaining.textContent = '';
            } else {
                banMessage.textContent = '–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª.';
                updateBanTimer(bannedUntil);
            }

            banNotice.classList.add('active');
            
            // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –µ—Å–ª–∏ –æ–Ω –ø–æ–∫–∞–∑–∞–Ω
            document.getElementById('splashScreen').classList.add('hidden');
        }

        function updateBanTimer(bannedUntil) {
            const banTimeRemaining = document.getElementById('banTimeRemaining');

            function update() {
                const now = new Date();
                const diff = bannedUntil - now;

                if (diff <= 0) {
                    banTimeRemaining.textContent = '–ë–∞–Ω –∏—Å—Ç–µ–∫. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                    setTimeout(() => location.reload(), 2000);
                    return;
                }

                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                banTimeRemaining.textContent = `–û—Å—Ç–∞–ª–æ—Å—å: ${hours}—á ${minutes}–º ${seconds}—Å`;
            }

            update();
            setInterval(update, 1000);
        }

        async function requestUnban() {
            const btn = document.getElementById('unbanRequestBtn');
            const status = document.getElementById('unbanStatus');

            btn.disabled = true;
            btn.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';

            try {
                const userIdString = String(uid);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–ø—Ä–æ—Å
                const { data: existingRequest } = await _sb
                    .from('unban_requests')
                    .select('*')
                    .eq('user_id', userIdString)
                    .eq('status', 'pending')
                    .maybeSingle();

                if (existingRequest) {
                    status.textContent = '‚úÖ –í–∞—à –∑–∞–ø—Ä–æ—Å —É–∂–µ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏';
                    status.style.display = 'block';
                    btn.textContent = '‚úì –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω';
                    return;
                }

                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–∞–∑–±–∞–Ω
                const { error } = await _sb
                    .from('unban_requests')
                    .insert({
                        user_id: userIdString,
                        username: username,
                        status: 'pending',
                        created_at: new Date().toISOString()
                    });

                if (error) throw error;

                status.textContent = '‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º';
                status.style.display = 'block';
                btn.textContent = '‚úì –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω';

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞:', error);
                status.textContent = '‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞';
                status.style.color = '#ff3b30';
                status.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'üì® –ü–æ–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–∞–∑–±–∞–Ω';
            }
        }

        // ============= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –° –ü–†–û–í–ï–†–ö–û–ô –ë–ê–ù–ê =============
        const originalInit = initMap;
        
        async function initMapWithBanCheck() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
            showSplashScreen();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –±–∞–Ω–∞
            userBanStatus = await checkBanStatus();

            if (userBanStatus) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                showBanNotice(userBanStatus);
                return; // –ù–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
            }

            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–±–∞–Ω–µ–Ω - –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            appInitialized = true;
            originalInit();
        }

        // –ó–∞–º–µ–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
        window.initMap = initMapWithBanCheck;

</script>

    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–∏–∂–Ω–µ–≥–æ –≤–∏–¥–∂–µ—Ç–∞ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–æ–≥–¥–∞ –æ–Ω –∑–∞–∫—Ä—ã—Ç) -->
    <button id="openActionBtn" class="open-action-btn" onclick="toggleActionCard()">‚ñ≤</button>
</body>
</html>
